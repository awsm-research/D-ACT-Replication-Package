public final void onSuccess(final T result) { if (screen.isAttached()) { preDisplay(result); screen.display(); postDisplay(); } }
@java.lang.Override public int run() throws java.lang.Exception { com.google.gerrit.pgm.util.ErrorLogFile.errorOnlyConsole(); final com.google.gerrit.pgm.Init.SiteInit init = createSiteInit(); final java.util.List<com.google.gerrit.pgm.init.InitPlugins.PluginData> plugins = com.google.gerrit.pgm.init.InitPlugins.listPlugins(init.site); com.google.gerrit.pgm.util.ConsoleUI ui = com.google.gerrit.pgm.util.ConsoleUI.getInstance(false); verifyInstallPluginList(ui, plugins); if (listPlugins) { if (!(plugins.isEmpty())) { ui.message("Available plugins:\n"); for (com.google.gerrit.pgm.init.InitPlugins.PluginData plugin : plugins) { ui.message(" * %s version %s\n", plugin.name, plugin.version); } } else { ui.message("No plugins found.\n"); } return 0; } init.flags.autoStart = (!(noAutoStart)) && (init.site.isNew); final com.google.gerrit.pgm.Init.SiteRun run; try { init.initializer.run(); init.flags.deleteOnFailure = false; run = createSiteRun(init); run.upgradeSchema(); } catch (java.lang.Exception failure) { if (init.flags.deleteOnFailure) { com.google.gerrit.pgm.Init.recursiveDelete(getSitePath()); } throw failure; } catch (java.lang.Error failure) { if (init.flags.deleteOnFailure) { com.google.gerrit.pgm.Init.recursiveDelete(getSitePath()); } throw failure; } java.lang.System.err.println(("Initialized " + (getSitePath().getCanonicalPath()))); run.start(); return 0; }
public void doChangeMergedHook(final com.google.gerrit.reviewdb.Change change, final com.google.gerrit.reviewdb.Account account, final com.google.gerrit.reviewdb.PatchSet patchSet) { final com.google.gerrit.server.events.ChangeMergedEvent event = new com.google.gerrit.server.events.ChangeMergedEvent(); event.change = eventFactory.asChangeAttribute(change); event.submitter = eventFactory.asAccountAttribute(account); event.patchSet = eventFactory.asPatchSetAttribute(patchSet); fireEvent(change, event); final java.util.List<java.lang.String> args = new java.util.ArrayList<java.lang.String>(); args.add(changeMergedHook.getAbsolutePath()); args.add("--change"); args.add(event.change.id); args.add("--change-url"); args.add(event.change.url); args.add("--project"); args.add(event.change.project); args.add("--branch"); args.add(event.change.branch); args.add("--submitter"); args.add(getDisplayName(account)); args.add("--commit"); args.add(event.patchSet.revision); runHook(getRepo(change), args); }
@java.lang.Override protected void run() throws com.google.gerrit.sshd.commands.Failure, com.google.gwtorm.server.OrmException { try { com.google.gerrit.server.account.CreateGroupArgs args = new com.google.gerrit.server.account.CreateGroupArgs(); args.setGroupName(groupName); args.groupDescription = groupDescription; args.visibleToAll = visibleToAll; args.ownerGroupId = ownerGroupId; args.initialMembers = initialMembers; args.initialGroups = initialGroups; for (com.google.gerrit.server.validators.GroupCreationValidationListener l : groupCreationValidationListeners) { try { l.validateNewGroup(args); } catch (com.google.gerrit.server.validators.ValidationException e) { die(e); } } performCreateGroupFactory.create(args).createGroup(); } catch (com.google.gerrit.common.errors.PermissionDeniedException e) { throw die(e); } catch (com.google.gerrit.common.errors.NameAlreadyUsedException e) { throw die(e); } }
@java.lang.Override public void setStatus(java.lang.String status) throws com.google.gerrit.extensions.restapi.RestApiException { com.google.gerrit.extensions.api.accounts.StatusInput in = new com.google.gerrit.extensions.api.accounts.StatusInput(status); try { putStatus.apply(account, in); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot set status", e); } }
@java.lang.Override public com.google.gerrit.extensions.restapi.RestView<com.google.gerrit.server.change.ReviewerResource> list() throws com.google.gerrit.extensions.restapi.AuthException { return list; }
@com.google.gerrit.server.query.account.Operator public com.google.gerrit.server.query.Predicate<com.google.gerrit.server.account.AccountState> name(java.lang.String name) { return com.google.gerrit.server.query.account.AccountPredicates.equalsName(name); }
@org.junit.Test public void applyDeltaToNullWithNoNewMetaId() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Change c = com.google.gerrit.server.notedb.NoteDbChangeStateTest.newChange(); assertThat(c.getNoteDbState()).isNull(); com.google.gerrit.server.notedb.NoteDbChangeState.applyDelta(c, com.google.gerrit.server.notedb.NoteDbChangeState.Delta.create(c.getId(), com.google.gerrit.server.notedb.NoteDbChangeStateTest.noMetaId(), com.google.gerrit.server.notedb.NoteDbChangeStateTest.noDrafts())); assertThat(c.getNoteDbState()).isNull(); com.google.gerrit.server.notedb.NoteDbChangeState.applyDelta(c, com.google.gerrit.server.notedb.NoteDbChangeState.Delta.create(c.getId(), com.google.gerrit.server.notedb.NoteDbChangeStateTest.noMetaId(), com.google.gerrit.server.notedb.NoteDbChangeStateTest.drafts(new com.google.gerrit.reviewdb.client.Account.Id(1001), zeroId()))); assertThat(c.getNoteDbState()).isNull(); }
private static void chmod600(final java.io.File path) throws java.io.IOException { if ((!(path.exists())) && (!(path.createNewFile()))) { throw new java.io.IOException(("Cannot create " + path)); } path.setWritable(false, false); path.setReadable(false, false); path.setExecutable(false, false); path.setWritable(true, true); path.setReadable(true, true); if (path.isDirectory()) { path.setExecutable(true, true); } }
@java.lang.Override public com.google.gitiles.GitilesAccess forRequest(javax.servlet.http.HttpServletRequest req) { return new com.google.gitiles.GitilesAccess() { @java.lang.Override public java.util.Map<java.lang.String, com.google.gitiles.RepositoryDescription> listRepositories(java.util.Set<java.lang.String> branches) { return java.util.Collections.emptyMap(); } @java.lang.Override public java.lang.Object getUserKey() { return null; } @java.lang.Override public java.lang.String getRepositoryName() { return repoName; } @java.lang.Override public com.google.gitiles.RepositoryDescription getRepositoryDescription() { com.google.gitiles.RepositoryDescription d = new com.google.gitiles.RepositoryDescription(); d.name = getRepositoryName(); return d; } @java.lang.Override public org.eclipse.jgit.lib.Config getConfig() { return cfg; } }; }
public void setGroups(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.notedb.ChangeUpdate update, com.google.gerrit.reviewdb.client.PatchSet ps, java.lang.Iterable<java.lang.String> groups) throws com.google.gwtorm.server.OrmException { ps.setGroups(groups); update.setGroups(groups); db.patchSets().update(java.util.Collections.singleton(ps)); }
public void unstarAll(com.google.gerrit.reviewdb.client.Project.NameKey project, com.google.gerrit.reviewdb.client.Change.Id changeId) throws com.google.gerrit.server.project.NoSuchChangeException, com.google.gwtorm.server.OrmException { try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(allUsers);org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo)) { org.eclipse.jgit.lib.BatchRefUpdate batchUpdate = repo.getRefDatabase().newBatchUpdate(); batchUpdate.setAllowNonFastForwards(true); batchUpdate.setRefLogIdent(serverIdent); batchUpdate.setRefLogMessage(("Unstar change " + (changeId.get())), true); for (com.google.gerrit.reviewdb.client.Account.Id accountId : byChangeFromIndex(changeId)) { java.lang.String refName = com.google.gerrit.reviewdb.client.RefNames.refsStarredChanges(changeId, accountId); org.eclipse.jgit.lib.Ref ref = repo.getRefDatabase().getRef(refName); batchUpdate.addCommand(new org.eclipse.jgit.transport.ReceiveCommand(ref.getObjectId(), org.eclipse.jgit.lib.ObjectId.zeroId(), refName)); } batchUpdate.execute(rw, NullProgressMonitor.INSTANCE); for (org.eclipse.jgit.transport.ReceiveCommand command : batchUpdate.getCommands()) { if ((command.getResult()) != (ReceiveCommand.Result.OK)) { throw new java.io.IOException(java.lang.String.format("Unstar change %d failed, ref %s could not be deleted: %s", changeId.get(), command.getRefName(), command.getResult())); } } indexer.index(dbProvider.get(), project, changeId); } catch (java.io.IOException e) { throw new com.google.gwtorm.server.OrmException(java.lang.String.format("Unstar change %d failed", changeId.get()), e); } }
@org.junit.Test public void selfRevokedKeyIsRevoked() throws java.lang.Exception { assertProblems(selfRevokedKey(), "Key is revoked"); }
private void openWindow(java.lang.String token) { java.lang.String url = ((Window.Location.getPath()) + "#") + token; com.google.gwt.user.client.Window.open(url, "_blank", null); }
@java.lang.Override public void postUpdate(com.google.gerrit.server.git.BatchUpdate.Context ctx) throws java.lang.Exception { if (((addedReviewers) != null) || ((addedCCs) != null)) { if ((addedReviewers) == null) { addedReviewers = new java.util.ArrayList(); } if ((addedCCs) == null) { addedCCs = new java.util.ArrayList(); } emailReviewers(rsrc.getChange(), addedReviewers, addedCCs); if (!(addedReviewers.isEmpty())) { for (com.google.gerrit.reviewdb.client.PatchSetApproval psa : addedReviewers) { com.google.gerrit.reviewdb.client.Account account = accountCache.get(psa.getAccountId()).getAccount(); reviewerAdded.fire(rsrc.getChange(), patchSet, account, ctx.getAccount(), ctx.getWhen()); } } } }
static void call(com.google.gwt.user.client.ui.Button b, com.google.gerrit.reviewdb.client.Project.NameKey project) { b.setEnabled(false); com.google.gerrit.client.changes.ChangeApi.createChange(project.get(), RefNames.REFS_CONFIG, null, AdminConstants.I.editConfigMessage(), null, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.info.ChangeInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.info.ChangeInfo result) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.client.Dispatcher.toEditScreen(project, new com.google.gerrit.reviewdb.client.PatchSet.Id(result.legacyId(), 1), "project.config")); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { b.setEnabled(true); super.onFailure(caught); } }); }
@java.lang.Override public java.util.List<com.google.gerrit.extensions.api.projects.BranchInfo> apply(com.google.gerrit.server.project.ProjectResource rsrc) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.permissions.PermissionBackendException, java.io.IOException { rsrc.getProjectState().checkStatePermitsRead(); return new com.google.gerrit.server.project.RefFilter<com.google.gerrit.extensions.api.projects.BranchInfo>(org.eclipse.jgit.lib.Constants.R_HEADS).subString(matchSubstring).regex(matchRegex).start(start).limit(limit).filter(allBranches(rsrc)); }
protected void initHeaders(com.google.gerrit.common.data.PatchScript script, com.google.gerrit.common.data.PatchSetDetail detail) { com.google.gerrit.client.patches.PatchScreen.Type type = getPatchScreenType(); headerSideA = new com.google.gerrit.client.patches.PatchSetSelectBox(PatchSetSelectBox.Side.A, type); headerSideB = new com.google.gerrit.client.patches.PatchSetSelectBox(PatchSetSelectBox.Side.B, type); headerSideA.display(detail, script, patchKey, idSideA, idSideB); headerSideB.display(detail, script, patchKey, idSideA, idSideB); }
public static java.lang.String createCommit(org.eclipse.jgit.api.Git git, org.eclipse.jgit.lib.PersonIdent i, java.lang.String msg) throws java.io.IOException, org.eclipse.jgit.api.errors.GitAPIException { return com.google.gerrit.acceptance.git.ssh.GitUtil.createCommit(git, i, msg, true); }
public static com.google.gerrit.metrics.Field<java.lang.String> ofString(java.lang.String name) { return com.google.gerrit.metrics.Field.ofString(name, null); }
private void checkComments(java.util.Map<com.google.gerrit.reviewdb.client.RevId, com.google.gerrit.server.notedb.ChangeRevisionNote> existingNotes, java.util.Map<com.google.gerrit.reviewdb.client.RevId, com.google.gerrit.server.notedb.RevisionNoteBuilder> toUpdate) throws com.google.gwtorm.server.OrmException { java.util.Set<com.google.gerrit.reviewdb.client.Comment.Key> existing = new java.util.HashSet<>(); for (com.google.gerrit.server.notedb.ChangeRevisionNote rn : existingNotes.values()) { for (com.google.gerrit.reviewdb.client.Comment c : rn.getComments()) { existing.add(c.key); if ((draftUpdate) != null) { draftUpdate.deleteComment(c.revId, c.key); } } } for (com.google.gerrit.server.notedb.RevisionNoteBuilder b : toUpdate.values()) { for (com.google.gerrit.reviewdb.client.Comment c : b.put.values()) { if (existing.contains(c.key)) { throw new com.google.gwtorm.server.OrmException(("Cannot update existing published comment: " + c)); } } } }
void display(com.google.gerrit.client.projects.ConfigInfo result) { descTxt.setText(result.description()); setBool(contributorAgreements, result.use_contributor_agreements()); setBool(signedOffBy, result.use_signed_off_by()); setBool(contentMerge, result.use_content_merge()); setBool(newChangeForAllNotInTarget, result.create_new_change_for_all_not_in_target()); setBool(requireChangeID, result.require_change_id()); setSubmitType(result.submit_type()); setState(result.state()); maxObjectSizeLimit.setText(result.max_object_size_limit().configured_value()); if ((result.max_object_size_limit().inherited_value()) != null) { effectiveMaxObjectSizeLimit.setVisible(true); effectiveMaxObjectSizeLimit.setText(Util.M.effectiveMaxObjectSizeLimit(result.max_object_size_limit().value())); effectiveMaxObjectSizeLimit.setTitle(Util.M.globalMaxObjectSizeLimit(result.max_object_size_limit().inherited_value())); } else { effectiveMaxObjectSizeLimit.setVisible(false); } saveProject.setEnabled(false); initPluginOptions(result); initProjectActions(result); }
private void assertBadRequest(com.google.gerrit.extensions.api.projects.ProjectApi.ListRefsRequest<com.google.gerrit.extensions.api.projects.BranchInfo> req) throws java.lang.Exception { try { req.get(); fail("Expected BadRequestException"); } catch (com.google.gerrit.extensions.restapi.BadRequestException e) { } }
public static boolean includedInOne(final org.eclipse.jgit.lib.Repository repo, final org.eclipse.jgit.revwalk.RevWalk rw, final org.eclipse.jgit.revwalk.RevCommit commit, final java.util.Collection<org.eclipse.jgit.lib.Ref> refs) throws java.io.IOException { return new com.google.gerrit.server.change.IncludedInResolver(repo, rw, commit).includedInOne(refs); }
void schedule(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String ref, org.eclipse.jgit.transport.URIish uri, com.googlesource.gerrit.plugins.replication.ReplicationState state) { com.googlesource.gerrit.plugins.replication.Destination.repLog.info("scheduling replication {}:{} => {}", project, ref, uri); if (!(shouldReplicate(project, ref, state))) { return; } if (!(config.replicatePermissions())) { com.googlesource.gerrit.plugins.replication.PushOne e; synchronized(stateLock) { e = pending.get(uri); } if (e == null) { try (org.eclipse.jgit.lib.Repository git = gitManager.openRepository(project)) { try { org.eclipse.jgit.lib.Ref head = git.exactRef(Constants.HEAD); if (((head != null) && (head.isSymbolic())) && (RefNames.REFS_CONFIG.equals(head.getLeaf().getName()))) { return; } } catch (java.io.IOException err) { stateLog.error(java.lang.String.format("cannot check type of project %s", project), err, state); return; } } catch (java.io.IOException err) { stateLog.error(java.lang.String.format("source project %s not available", project), err, state); return; } } } synchronized(stateLock) { com.googlesource.gerrit.plugins.replication.PushOne e = pending.get(uri); if (e == null) { e = opFactory.create(project, uri); addRef(e, ref); pool.schedule(e, config.getDelay(), java.util.concurrent.TimeUnit.SECONDS); pending.put(uri, e); } else if (!(e.getRefs().contains(ref))) { addRef(e, ref); } state.increasePushTaskCount(project.get(), ref); e.addState(ref, state); com.googlesource.gerrit.plugins.replication.Destination.repLog.info("scheduled {}:{} => {} to run after {}s", project, ref, e, config.getDelay()); } }
public void setLastLoginExternalIdKey(com.google.gerrit.reviewdb.client.AccountExternalId.Key externalIdKey) { put(lastLoginExternalIdPropertyKey, externalIdKey); }
public boolean isMutedBy(com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.Account.Id accountId) throws com.google.gwtorm.server.OrmException { return byChange(change.getId(), com.google.gerrit.server.StarredChangesUtil.getMuteLabel(change)).contains(accountId); }
@java.lang.Override public void onSuccess(com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.diff.FileInfo> m) { files.set((base != null ? new com.google.gerrit.reviewdb.client.PatchSet.Id(changeId, base._number()) : null), new com.google.gerrit.reviewdb.client.PatchSet.Id(changeId, rev._number()), style, editMessage, reply, ((edit) != null)); files.setValue(m, myLastReply, comments.get(0), drafts.get(0), fileTableMode); }
public void onSuccess(com.google.gerrit.client.extensions.TopMenuList result) { java.util.List<com.google.gerrit.client.extensions.TopMenu> topMenuExtensions = com.google.gerrit.client.rpc.Natives.asList(result); for (com.google.gerrit.client.extensions.TopMenu menu : topMenuExtensions) { java.lang.String name = menu.getName(); com.google.gerrit.client.ui.LinkMenuBar existingBar = com.google.gerrit.client.Gerrit.menuBars.get(name); com.google.gerrit.client.ui.LinkMenuBar bar = (existingBar != null) ? existingBar : new com.google.gerrit.client.ui.LinkMenuBar(); if (GerritTopMenu.PROJECTS.menuName.equals(name)) { for (com.google.gerrit.client.extensions.TopMenuItem item : com.google.gerrit.client.rpc.Natives.asList(menu.getItems())) { com.google.gerrit.client.Gerrit.addProjectLink(bar, item); } } else { for (com.google.gerrit.client.extensions.TopMenuItem item : com.google.gerrit.client.rpc.Natives.asList(menu.getItems())) { com.google.gerrit.client.Gerrit.addExtensionLink(bar, item); } } if (existingBar == null) { com.google.gerrit.client.Gerrit.menuBars.put(name, bar); com.google.gerrit.client.Gerrit.menuLeft.add(bar, name); } } }
private java.util.Optional<com.googlesource.gerrit.plugins.manager.gson.SmartJson> fetchArtifactJson(com.googlesource.gerrit.plugins.manager.gson.SmartJson buildExecution, com.google.gson.JsonArray artifacts, java.lang.String artifactSuffix) { java.util.Optional<com.googlesource.gerrit.plugins.manager.gson.SmartJson> jsonArtifact = findArtifact(artifacts, artifactSuffix); return jsonArtifact.flatMap(( artifactJson) -> tryGetJson(java.lang.String.format("%s/artifact/%s", buildExecution.getString("url"), jsonArtifact.get().getString("relativePath")))); }
public com.google.gerrit.server.account.AccountState getAccount() throws java.io.IOException { return com.google.gerrit.server.account.AccountState.fromAccountConfig(allUsersName, externalIds, accountConfig, extIdNotes).get(); }
@org.junit.Test public void administratorCanSetUserChangePrivate() throws java.lang.Exception { org.eclipse.jgit.junit.TestRepository<org.eclipse.jgit.internal.storage.dfs.InMemoryRepository> userRepo = cloneProject(project, user); com.google.gerrit.acceptance.PushOneCommit.Result result = pushFactory.create(db, user.getIdent(), userRepo).to("refs/for/master"); java.lang.String changeId = result.getChangeId(); assertThat(gApi.changes().id(changeId).get().isPrivate).isNull(); gApi.changes().id(changeId).setPrivate(true, null); setApiUser(user); com.google.gerrit.extensions.common.ChangeInfo info = gApi.changes().id(changeId).get(); assertThat(info.isPrivate).isTrue(); }
void start() { if ((request.getQuery()) == null) { request.setQuery(""); } oracle.requestSuggestions(request, this); }
@java.lang.Override public boolean handles(java.io.File srcFile) { java.util.List<com.google.gerrit.server.plugins.ServerPluginProvider> providers = providersForHandlingPlugin(srcFile); switch (providers.size()) { case 1 : return true; case 0 : return false; default : throw new com.google.gerrit.server.plugins.MultipleProvidersForPluginException(srcFile, providers); } }
@org.junit.Test public void deleteEdit() throws java.lang.Exception { assertThat(modifier.createEdit(change, ps)).isEqualTo(RefUpdate.Result.NEW); assertThat(modifier.modifyFile(editUtil.byChange(change).get(), com.google.gerrit.acceptance.edit.ChangeEditIT.FILE_NAME, com.google.gerrit.acceptance.RestSession.newRawInput(com.google.gerrit.acceptance.edit.ChangeEditIT.CONTENT_NEW))).isEqualTo(RefUpdate.Result.FORCED); editUtil.delete(editUtil.byChange(change).get()); assertThat(editUtil.byChange(change).isPresent()).isFalse(); }
private static com.google.gerrit.server.query.change.ChangeData change(java.lang.String... files) { java.util.Arrays.sort(files); com.google.gerrit.server.query.change.ChangeData cd = com.google.gerrit.server.query.change.ChangeData.createForTest(new com.google.gerrit.reviewdb.client.Change.Id(1)); cd.setCurrentFilePaths(java.util.Arrays.asList(files)); return cd; }
public void run() { if (cm.hasActiveLine()) { cm.removeLineClass(cm.getActiveLine(), LineClassWhere.WRAP, DiffTable.style.activeLine()); cm.removeLineClass(cm.getActiveLine(), LineClassWhere.BACKGROUND, DiffTable.style.activeLineBg()); } if (other.hasActiveLine()) { other.removeLineClass(other.getActiveLine(), LineClassWhere.WRAP, DiffTable.style.activeLine()); other.removeLineClass(other.getActiveLine(), LineClassWhere.BACKGROUND, DiffTable.style.activeLineBg()); } net.codemirror.lib.CodeMirror.LineHandle handle = cm.getLineHandleVisualStart(cm.getCursor().getLine()); int line = cm.getLineNumber(handle); cm.setActiveLine(handle); if (cm.somethingSelected()) { return; } cm.addLineClass(line, LineClassWhere.WRAP, DiffTable.style.activeLine()); cm.addLineClass(line, LineClassWhere.BACKGROUND, DiffTable.style.activeLineBg()); com.google.gerrit.client.diff.LineMapper.LineOnOtherInfo info = mapper.lineOnOther((cm == (cmA) ? com.google.gerrit.common.changes.Side.PARENT : com.google.gerrit.common.changes.Side.REVISION), line); int oLine = info.getLine(); if (info.isAligned()) { other.setActiveLine(other.getLineHandle(oLine)); other.addLineClass(oLine, LineClassWhere.WRAP, DiffTable.style.activeLine()); other.addLineClass(oLine, LineClassWhere.BACKGROUND, DiffTable.style.activeLineBg()); } }
private void parseDelete(final org.eclipse.jgit.transport.ReceiveCommand cmd) { com.google.gerrit.server.project.RefControl ctl = projectControl.controlForRef(cmd.getRefName()); if (ctl.canDelete()) { batch.addCommand(cmd); } else { if (GitRepositoryManager.REF_CONFIG.equals(ctl.getRefName())) { reject(cmd, "cannot delete project configuration"); } else { errors.put(com.google.gerrit.server.git.ReceiveCommits.Error.DELETE, ctl.getRefName()); reject(cmd, "cannot delete references"); } } }
@java.lang.Override public int hashCode() { return org.eclipse.jgit.util.NB.decodeInt32(fp, 4); }
public boolean doTransition(java.lang.String issueKey, java.lang.String transition) throws com.googlesource.gerrit.plugins.its.base.its.InvalidTransitionException, java.io.IOException { com.googlesource.gerrit.plugins.its.jira.JiraClient.log.debug("Making transition to {} for {}", transition, issueKey); com.googlesource.gerrit.plugins.its.jira.restapi.JiraTransition.Item t = getTransitionByName(issueKey, transition); if (t == null) { throw new com.googlesource.gerrit.plugins.its.base.its.InvalidTransitionException(((("Action " + transition) + " not executable on issue ") + issueKey)); } com.googlesource.gerrit.plugins.its.jira.JiraClient.log.debug("Transition issue {} to '{}' ({})", issueKey, transition, t.getId()); return apiBuilder.getIssue().doPost((("/" + issueKey) + "/transitions"), gson.toJson(new com.googlesource.gerrit.plugins.its.jira.restapi.JiraTransition(t)), java.net.HttpURLConnection.HTTP_NO_CONTENT); }
private void addSubmitRecordLabels(SubmitRecord submitRecord, com.google.gerrit.server.data.SubmitRecordAttribute sa) { if (((submitRecord.labels) != null) && (!(submitRecord.labels.isEmpty()))) { sa.labels = new java.util.ArrayList(); for (SubmitRecord.Label lbl : submitRecord.labels) { com.google.gerrit.server.data.SubmitLabelAttribute la = new com.google.gerrit.server.data.SubmitLabelAttribute(); la.label = lbl.label; la.status = lbl.status.name(); if ((lbl.appliedBy) != null) { la.by = asAccountAttribute(lbl.appliedBy); } sa.labels.add(la); } } }
private void serveGwtUi() { serveRegex("^/gerrit_ui/(?!rpc/)(.*)$").with(com.google.inject.Key.get(javax.servlet.http.HttpServlet.class, com.google.inject.name.Names.named(com.google.gerrit.httpd.raw.StaticModule.GWT_UI_SERVLET))); if ((warFs) == null) { filter("/").through(new com.google.gerrit.httpd.raw.RecompileGwtUiFilter(buckOut, unpackedWar)); } }
private void initPluginOptions(com.google.gerrit.client.projects.ConfigInfo info) { pluginOptionsPanel.clear(); pluginConfigWidgets = new java.util.HashMap(); for (java.lang.String pluginName : info.pluginConfig().keySet()) { java.util.Map<java.lang.String, com.google.gwt.user.client.ui.FocusWidget> widgetMap = new java.util.HashMap<>(); pluginConfigWidgets.put(pluginName, widgetMap); com.google.gerrit.client.admin.ProjectInfoScreen.LabeledWidgetsGrid g = new com.google.gerrit.client.admin.ProjectInfoScreen.LabeledWidgetsGrid(); g.addHeader(new com.google.gerrit.client.ui.SmallHeading(Util.M.pluginProjectOptionsTitle(pluginName))); pluginOptionsPanel.add(g); com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.projects.ConfigInfo.ConfigParameterInfo> pluginConfig = info.pluginConfig(pluginName); pluginConfig.copyKeysIntoChildren("name"); for (com.google.gerrit.client.projects.ConfigInfo.ConfigParameterInfo param : com.google.gerrit.client.rpc.Natives.asList(pluginConfig.values())) { com.google.gwt.user.client.ui.FocusWidget w; switch (param.type()) { case "STRING" : case "INT" : case "LONG" : w = renderTextBox(g, param); break; case "BOOLEAN" : w = renderCheckBox(g, param); break; case "LIST" : w = renderListBox(g, param); break; case "ARRAY" : w = renderTextArea(g, param); break; default : throw new java.lang.UnsupportedOperationException("unsupported widget type"); } if (param.editable()) { widgetMap.put(param.name(), w); } else { w.setEnabled(false); } } } enableForm(); }
@org.junit.Test public void testGetJGroupsCluster() throws java.lang.Exception { assertThat(getConfiguration().jgroups().clusterName()).isEqualTo(com.ericsson.gerrit.plugins.highavailability.Configuration.DEFAULT_CLUSTER_NAME); globalPluginConfig.setString(com.ericsson.gerrit.plugins.highavailability.Configuration.JGROUPS_SECTION, null, com.ericsson.gerrit.plugins.highavailability.Configuration.CLUSTER_NAME_KEY, "foo"); assertThat(getConfiguration().jgroups().clusterName()).isEqualTo("foo"); }
static com.google.gerrit.extensions.common.GpgKeyInfo toJson(org.bouncycastle.openpgp.PGPPublicKeyRing keyRing) throws java.io.IOException { org.bouncycastle.openpgp.PGPPublicKey key = keyRing.getPublicKey(); com.google.gerrit.extensions.common.GpgKeyInfo info = new com.google.gerrit.extensions.common.GpgKeyInfo(); info.id = com.google.gerrit.server.git.gpg.PublicKeyStore.keyIdToString(key.getKeyID()); info.fingerprint = com.google.gerrit.server.git.gpg.PublicKeyStore.fingerprintToString(key.getFingerprint()); @java.lang.SuppressWarnings("unchecked") java.util.Iterator<java.lang.String> userIds = key.getUserIDs(); info.userIds = com.google.common.collect.ImmutableList.copyOf(userIds); try (java.io.ByteArrayOutputStream out = new java.io.ByteArrayOutputStream(4096);org.bouncycastle.bcpg.ArmoredOutputStream aout = new org.bouncycastle.bcpg.ArmoredOutputStream(out)) { key.encode(aout); info.key = new java.lang.String(out.toByteArray(), java.nio.charset.StandardCharsets.UTF_8); } return info; }
private <T> T execute(com.google.gerrit.server.update.RetryHelper.ActionType actionType, com.google.gerrit.server.update.RetryHelper.Action<T> action, com.google.gerrit.server.update.RetryHelper.Options opts, com.google.common.base.Predicate<java.lang.Throwable> exceptionPredicate) throws java.lang.Throwable { com.google.gerrit.server.update.RetryHelper.MetricListener listener = new com.google.gerrit.server.update.RetryHelper.MetricListener(); try { com.github.rholder.retry.RetryerBuilder<T> retryerBuilder = createRetryerBuilder(opts, exceptionPredicate); retryerBuilder.withRetryListener(listener); return execute(actionType, action, retryerBuilder.build()); } finally { metrics.attemptCounts.record(actionType, listener.getAttemptCount()); } }
private boolean isEditable(com.google.gerrit.client.diff.FileInfo info) { java.lang.String status = info.status(); return (status == null) || (!(ChangeType.DELETED.matches(status))); }
@java.lang.Override public synchronized void onGitReferenceUpdated(com.googlesource.gerrit.plugins.supermanifest.Event event) { if (event.getProjectName().equals(allProjectsName.get())) { if (event.getRefName().equals("refs/meta/config")) { updateConfiguration(); } return; } for (com.googlesource.gerrit.plugins.supermanifest.ConfigEntry c : config) { if (!(c.srcRepoKey.get().equals(event.getProjectName()))) { continue; } if (!((c.destBranch.equals("*")) || (c.srcRef.equals(event.getRefName())))) { continue; } if ((c.destBranch.equals("*")) && (!(event.getRefName().startsWith(com.googlesource.gerrit.plugins.supermanifest.REFS_HEADS)))) { continue; } try { com.googlesource.gerrit.plugins.supermanifest.SubModuleUpdater subModuleUpdater; switch (c.getToolType()) { case Repo : subModuleUpdater = new com.googlesource.gerrit.plugins.supermanifest.RepoUpdater(serverIdent, canonicalWebUrl); break; default : throw new org.eclipse.jgit.errors.ConfigInvalidException(java.lang.String.format("invalid toolType: %s", c.getToolType().name())); } try (com.googlesource.gerrit.plugins.supermanifest.SuperManifestRefUpdatedListener.GerritRemoteReader reader = new com.googlesource.gerrit.plugins.supermanifest.SuperManifestRefUpdatedListener.GerritRemoteReader()) { subModuleUpdater.update(reader, c, event.getRefName()); } } catch (java.lang.Exception e) { java.lang.StackTraceElement here = java.lang.Thread.currentThread().getStackTrace()[1]; e.setStackTrace(com.googlesource.gerrit.plugins.supermanifest.SuperManifestRefUpdatedListener.trimStack(e.getStackTrace(), here)); java.io.StringWriter sw = new java.io.StringWriter(); java.io.PrintWriter pw = new java.io.PrintWriter(sw); e.printStackTrace(pw); error("update for %s (ref %s) failed: %s", c.toString(), event.getRefName(), sw); } } }
public void testMultipleIndexPredicates() throws java.lang.Exception { com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> in = parse("file:a OR branch:b OR file:c OR branch:d"); com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> out = rewrite(in); assertSame(com.google.gerrit.server.query.OrPredicate.class, out.getClass()); assertEquals(com.google.common.collect.ImmutableList.of(in.getChild(1), in.getChild(3), wrap(com.google.gerrit.server.query.Predicate.or(in.getChild(0), in.getChild(2)))), out.getChildren()); }
public void merge(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.server.IdentifiedUser caller, boolean checkSubmitRules) throws com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gwtorm.server.OrmException { this.caller = caller; updateSubmissionId(change); this.db = db; logDebug("Beginning integration of {}", change); try { com.google.gerrit.server.git.ChangeSet cs = mergeSuperSet.completeChangeSet(db, change); com.google.gerrit.server.git.MergeOp.reloadChanges(cs); logDebug("Calculated to merge {}", cs); if (checkSubmitRules) { logDebug("Checking submit rules and state"); checkSubmitRulesAndState(cs); failFast(cs); } else { logDebug("Bypassing submit rules"); bypassSubmitRules(cs); } try { integrateIntoHistory(cs); } catch (com.google.gerrit.server.git.IntegrationException e) { logError("Merge Conflict", e); throw new com.google.gerrit.extensions.restapi.ResourceConflictException("Merge Conflict", e); } } catch (java.io.IOException e) { throw new com.google.gwtorm.server.OrmException(e); } }
@java.lang.Override protected void configure() { install(new com.google.gerrit.server.rules.PrologModule.EnvironmentModule()); bind(PrologEnvironment.Args.class); bind(com.google.gerrit.server.rules.PrologRule.class); factory(PrologRuleEvaluator.Factory.class); }
@org.junit.Test public void setParent() throws java.lang.Exception { java.lang.String parent = "parent"; com.google.gerrit.acceptance.GitUtil.createProject(sshSession, parent, null, true); com.google.gerrit.acceptance.RestResponse r = adminSession.put((("/projects/" + (project.get())) + "/parent"), newParentInput(parent)); assertThat(r.getStatusCode()).isEqualTo(HttpStatus.SC_OK); r.consume(); r = adminSession.get((("/projects/" + (project.get())) + "/parent")); assertThat(r.getStatusCode()).isEqualTo(HttpStatus.SC_OK); java.lang.String newParent = newGson().fromJson(r.getReader(), java.lang.String.class); assertThat(newParent).isEqualTo(parent); r.consume(); r = adminSession.put((("/projects/" + (project.get())) + "/parent"), newParentInput(null)); assertThat(r.getStatusCode()).isEqualTo(HttpStatus.SC_OK); r.consume(); r = adminSession.get((("/projects/" + (project.get())) + "/parent")); assertThat(r.getStatusCode()).isEqualTo(HttpStatus.SC_OK); newParent = newGson().fromJson(r.getReader(), java.lang.String.class); assertThat(newParent).isEqualTo(AllProjectsNameProvider.DEFAULT); r.consume(); }
@java.lang.Override protected void configure() { persist(com.googlesource.gerrit.plugins.xdocs.XDocLoader.Module.X_DOC_RESOURCES, java.lang.String.class, com.google.gerrit.httpd.resources.Resource.class).maximumWeight((2 << 20)).weigher(com.googlesource.gerrit.plugins.xdocs.XDocLoader.XDocResourceWeigher.class).loader(com.googlesource.gerrit.plugins.xdocs.XDocLoader.class); }
public java.util.List<com.google.gerrit.common.data.WebLinkInfoCommon> getFileHistoryLinks(java.lang.String project, java.lang.String revision, java.lang.String file) { return com.google.common.collect.FluentIterable.from(fileHistoryLinks).transform(( webLink) -> { com.google.gerrit.extensions.common.WebLinkInfo info = webLink.getFileHistoryWebLink(project, revision, file); if (info == null) { return null; } com.google.gerrit.common.data.WebLinkInfoCommon commonInfo = new com.google.gerrit.common.data.WebLinkInfoCommon(); commonInfo.name = info.name; commonInfo.imageUrl = info.imageUrl; commonInfo.url = info.url; commonInfo.target = info.target; return commonInfo; }).filter(com.google.gerrit.server.WebLinks.INVALID_WEBLINK_COMMON).toList(); }
@org.junit.Test public void rebaseNotAllowedForOwnerWithoutPushPermission() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result r = createChange(); testRepo.reset("HEAD~1"); com.google.gerrit.acceptance.PushOneCommit.Result r2 = createChange(); com.google.gerrit.extensions.api.changes.RevisionApi revision = gApi.changes().id(r.getChangeId()).current(); revision.review(com.google.gerrit.extensions.api.changes.ReviewInput.approve()); revision.submit(); block(Permission.PUSH, com.google.gerrit.acceptance.api.change.REGISTERED_USERS, "refs/for/*"); java.lang.String changeId = r2.getChangeId(); exception.expect(com.google.gerrit.extensions.restapi.AuthException.class); exception.expectMessage("rebase not permitted"); gApi.changes().id(changeId).rebase(); }
public void run() throws java.lang.Exception { ui.header("SSH Daemon"); java.lang.String hostname = "*"; int port = 29418; java.lang.String listenAddress = sshd.get("listenAddress"); if (com.google.gerrit.pgm.init.InitSshd.isOff(listenAddress)) { hostname = "off"; } else if ((listenAddress != null) && (!(listenAddress.isEmpty()))) { final java.net.InetSocketAddress addr = com.google.gerrit.server.util.SocketUtil.parse(listenAddress, port); hostname = com.google.gerrit.server.util.SocketUtil.hostname(addr); port = addr.getPort(); } hostname = ui.readString(hostname, "Listen on address"); if (com.google.gerrit.pgm.init.InitSshd.isOff(hostname)) { sshd.set("listenAddress", "off"); return; } port = ui.readInt(port, "Listen on port"); sshd.set("listenAddress", com.google.gerrit.server.util.SocketUtil.format(hostname, port)); if ((site.ssh_rsa.exists()) || (site.ssh_dsa.exists())) { libraries.bouncyCastleSSL.downloadRequired(); } else if (!(site.ssh_key.exists())) { libraries.bouncyCastleSSL.downloadOptional(); } generateSshHostKeys(); }
@org.junit.Test public void testValidPathSeparator() { for (char c : com.google.gerrit.server.config.GitwebConfigTest.VALID_CHARACTERS.toCharArray()) { assertTrue(("valid character rejected: " + c), com.google.gerrit.server.config.GitwebConfig.isValidPathSeparator(c)); } }
@java.lang.Override public void onRemoval(java.lang.String pluginName, java.lang.String cacheName, com.google.common.cache.RemovalNotification<K, V> notification) { if (((!(com.ericsson.gerrit.plugins.highavailability.forwarder.Context.isForwardedEvent())) && (!(notification.wasEvicted()))) && (isSynchronized(cacheName))) { executor.execute(new CacheEvictionTask(cacheName, notification.getKey())); } }
@java.lang.Override public void visibleProjects(final com.google.gwt.user.client.rpc.AsyncCallback<java.util.List<com.google.gerrit.reviewdb.Project>> callback) { visibleProjectsFactory.create().to(callback); }
private java.nio.file.Path resolvePath(javax.servlet.http.HttpServletRequest req) { return sitePaths.resolve(com.google.common.base.CharMatcher.is('/').trimLeadingFrom(((req.getServletPath()) + (req.getPathInfo())))); }
java.util.List<java.lang.String> getValues() { return t.getValues(); }
@java.lang.Override public void onSuccess(com.google.gwt.core.client.JsArray<com.google.gerrit.client.account.ProjectWatchInfo> watchedProjects) { remove(infos); }
@java.lang.Override public void onPreReceive(org.eclipse.jgit.transport.ReceivePack rp, java.util.Collection<org.eclipse.jgit.transport.ReceiveCommand> commands) { try { org.eclipse.jgit.transport.PushCertificate cert = rp.getPushCertificate(); if (cert == null) { return; } com.google.gerrit.server.git.gpg.PushCertificateChecker checker = new com.google.gerrit.server.git.gpg.PushCertificateChecker(new com.google.gerrit.server.git.gpg.PublicKeyChecker()) { @java.lang.Override protected org.eclipse.jgit.lib.Repository getRepository() throws java.io.IOException { return repoManager.openRepository(allUsers); } @java.lang.Override protected boolean shouldClose(org.eclipse.jgit.lib.Repository repo) { return true; } }; com.google.gerrit.server.git.gpg.CheckResult result = checker.check(cert); if (!(result.isOk())) { for (java.lang.String problem : result.getProblems()) { rp.sendMessage(problem); } com.google.gerrit.server.git.gpg.SignedPushPreReceiveHook.reject(commands, "invalid push cert"); } } catch (org.bouncycastle.openpgp.PGPException | java.io.IOException e) { com.google.gerrit.server.git.gpg.SignedPushPreReceiveHook.log.error("Error checking push certificate", e); com.google.gerrit.server.git.gpg.SignedPushPreReceiveHook.reject(commands, "push cert error"); } }
@java.lang.Override public java.lang.String apply(com.google.gerrit.server.account.AccountResource rsrc, com.google.gerrit.server.account.PutUsername.Input input) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.MethodNotAllowedException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.UnprocessableEntityException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { if (((self.get()) != (rsrc.getUser())) && (!(self.get().getCapabilities().canAdministrateServer()))) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed to set username"); } if (!(realm.allowsEdit(AccountFieldName.USER_NAME))) { throw new com.google.gerrit.extensions.restapi.MethodNotAllowedException("realm does not allow editing username"); } if (input == null) { input = new com.google.gerrit.server.account.PutUsername.Input(); } try { changeUserNameFactory.create(db.get(), rsrc.getUser(), input.username).call(); } catch (java.lang.IllegalStateException e) { if (ChangeUserName.USERNAME_CANNOT_BE_CHANGED.equals(e.getMessage())) { throw new com.google.gerrit.extensions.restapi.MethodNotAllowedException(e.getMessage()); } throw e; } catch (com.google.gerrit.server.account.InvalidUserNameException e) { throw new com.google.gerrit.extensions.restapi.UnprocessableEntityException("invalid username"); } catch (com.google.gerrit.common.errors.NameAlreadyUsedException e) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException("username already used"); } return input.username; }
private void exportInitJs() { try { if (scanner.getEntry(JavaScriptPlugin.STATIC_INIT_JS).isPresent()) { httpGen.export(JavaScriptPlugin.INIT_JS); } } catch (java.io.IOException e) { com.google.gerrit.server.plugins.AutoRegisterModules.log.warn(java.lang.String.format(("Cannot access %s from plugin %s: " + "JavaScript auto-discovered plugin will not be registered"), JavaScriptPlugin.STATIC_INIT_JS, pluginName), e); } }
void validateChanges(com.google.gerrit.server.git.ProjectConfig config, java.util.List<com.google.gerrit.common.data.AccessSection> removals, java.util.List<com.google.gerrit.common.data.AccessSection> additions) throws com.google.gerrit.common.errors.InvalidNameException, com.google.gerrit.extensions.restapi.BadRequestException { for (com.google.gerrit.common.data.AccessSection section : com.google.common.collect.Iterables.concat(additions, removals)) { boolean isGlobalCapabilities = AccessSection.GLOBAL_CAPABILITIES.equals(section.getName()); if (isGlobalCapabilities) { if (!(allProjects.equals(config.getName()))) { throw new com.google.gerrit.extensions.restapi.BadRequestException(("Cannot edit global capabilities for projects other than " + (allProjects.get()))); } } if ((isGroupsMutationDisallowed(config.getName())) && (section.getName().startsWith(RefNames.REFS_GROUPS))) { throw new com.google.gerrit.extensions.restapi.BadRequestException(java.lang.String.format("Permissions on %s is managed by Gerrit and cannot be modified", RefNames.REFS_GROUPS)); } } for (com.google.gerrit.common.data.AccessSection section : additions) { java.lang.String name = section.getName(); boolean isGlobalCapabilities = AccessSection.GLOBAL_CAPABILITIES.equals(name); if (!isGlobalCapabilities) { if (!(com.google.gerrit.common.data.AccessSection.isValid(name))) { throw new com.google.gerrit.extensions.restapi.BadRequestException("invalid section name"); } com.google.gerrit.server.project.RefPattern.validate(name); } else { for (com.google.gerrit.common.data.Permission p : section.getPermissions()) { if (!(com.google.gerrit.common.data.GlobalCapability.isCapability(p.getName()))) { throw new com.google.gerrit.extensions.restapi.BadRequestException((("Cannot add non-global capability " + (p.getName())) + " to global capabilities")); } } } } }
com.google.gerrit.reviewdb.client.PatchLineComment export(com.google.gerrit.reviewdb.client.PatchLineComment.Status status) { com.google.gerrit.reviewdb.client.PatchLineComment plc = new com.google.gerrit.reviewdb.client.PatchLineComment(key.export(), lineNbr, author.export(), parentUuid, writtenOn); plc.setSide(side); plc.setMessage(message); if ((range) != null) { plc.setRange(range.export()); } plc.setTag(tag); plc.setRevId(new com.google.gerrit.reviewdb.client.RevId(revId)); plc.setStatus(status); return plc; }
public <T extends com.google.gwt.core.client.JavaScriptObject> void get(com.google.gwt.user.client.rpc.AsyncCallback<T> cb) { get(com.google.gerrit.client.rpc.RestApi.wrap(cb)); }
private com.cisco.gerrit.plugins.slack.config.ProjectConfig getConfig(java.lang.String ignore, boolean publishOnPatchSetCreated, boolean ignoreUnchangedPatchSet) throws java.lang.Exception { com.google.gerrit.reviewdb.client.Project.NameKey projectNameKey; projectNameKey = Project.NameKey.parse(com.cisco.gerrit.plugins.slack.message.PatchSetCreatedMessageGeneratorTest.PROJECT_NAME); when(mockConfigFactory.getFromProjectConfigWithInheritance(projectNameKey, ProjectConfig.CONFIG_NAME)).thenReturn(mockPluginConfig); when(mockPluginConfig.getBoolean("enabled", false)).thenReturn(true); when(mockPluginConfig.getString("webhookurl", "")).thenReturn("https://webook/"); when(mockPluginConfig.getString("channel", "general")).thenReturn("testchannel"); when(mockPluginConfig.getString("username", "gerrit")).thenReturn("testuser"); when(mockPluginConfig.getString("ignore", "")).thenReturn(ignore); when(mockPluginConfig.getBoolean("publish-on-patch-set-created", true)).thenReturn(publishOnPatchSetCreated); when(mockPluginConfig.getBoolean("ignore-unchanged-patch-set", true)).thenReturn(ignoreUnchangedPatchSet); return new com.cisco.gerrit.plugins.slack.config.ProjectConfig(mockConfigFactory, com.cisco.gerrit.plugins.slack.message.PatchSetCreatedMessageGeneratorTest.PROJECT_NAME); }
@java.lang.Override public void onDeleteGroupsFromGroup(com.google.gerrit.reviewdb.client.Account.Id me, java.util.Collection<com.google.gerrit.reviewdb.client.AccountGroupById> removed) { final java.util.List<com.google.gerrit.reviewdb.client.AccountGroupByIdAud> auditUpdates = com.google.common.collect.Lists.newLinkedList(); try { com.google.gerrit.reviewdb.server.ReviewDb db = schema.open(); try { for (final com.google.gerrit.reviewdb.client.AccountGroupById g : removed) { com.google.gerrit.reviewdb.client.AccountGroupByIdAud audit = null; for (com.google.gerrit.reviewdb.client.AccountGroupByIdAud a : db.accountGroupByIdAud().byGroupInclude(g.getGroupId(), g.getIncludeUUID())) { if (a.isActive()) { audit = a; break; } } if (audit != null) { audit.removed(me, com.google.gerrit.common.TimeUtil.nowTs()); auditUpdates.add(audit); } } db.accountGroupByIdAud().update(auditUpdates); } finally { db.close(); } } catch (com.google.gwtorm.server.OrmException e) { logOrmExceptionForGroups("Cannot log delete groups from group event performed by user", me, removed, e); } }
@org.junit.Test public void getNonExistingCommit_NotFound() throws java.io.IOException { com.google.gerrit.acceptance.RestResponse r = adminSession.get(((("/projects/" + (project.get())) + "/commits/") + (org.eclipse.jgit.lib.ObjectId.zeroId().name()))); assertEquals(HttpStatus.SC_NOT_FOUND, r.getStatusCode()); }
public void removeReviewerByEmail(com.google.gerrit.server.mail.Address reviewer) { reviewersByEmail.put(reviewer, ReviewerStateInternal.REMOVED); }
protected void setTitleWest(final com.google.gwt.user.client.ui.Widget w) { header.setWidget(0, com.google.gerrit.client.ui.Screen.Cols.West.ordinal(), w); }
@java.lang.Override public int compare(com.google.gerrit.extensions.common.TagInfo a, com.google.gerrit.extensions.common.TagInfo b) { return a.ref.compareTo(b.ref); }
@org.junit.Test public void deleteNewChangeAsAdmin() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result changeResult = createChange(); java.lang.String changeId = changeResult.getChangeId(); gApi.changes().id(changeId).delete(); assertThat(query(changeId)).isEmpty(); }
private com.google.gerrit.server.change.PostReviewers.Addition putAccount(java.lang.String reviewer, com.google.gerrit.server.change.ReviewerResource rsrc, com.google.gerrit.extensions.client.ReviewerState state) { com.google.gerrit.reviewdb.client.Account member = rsrc.getReviewerUser().getAccount(); com.google.gerrit.server.project.ChangeControl control = rsrc.getReviewerControl(); if (isValidReviewer(member, control)) { return new com.google.gerrit.server.change.PostReviewers.Addition(reviewer, rsrc.getChangeResource(), com.google.common.collect.ImmutableMap.of(member.getId(), control), state); } return new com.google.gerrit.server.change.PostReviewers.Addition(reviewer); }
java.lang.String notMergeable();
@java.lang.Override public com.google.gerrit.server.index.Schema<com.google.gerrit.server.query.change.ChangeData> getSchema() { throw new java.lang.UnsupportedOperationException(); }
void appendRow(final com.google.gwtexpui.safehtml.client.SafeHtmlBuilder m, final com.google.gerrit.client.reviewdb.Patch p) { m.openTr(); m.openTd(); m.addStyleName(com.google.gerrit.client.changes.S_ICON_CELL); m.addStyleName("LeftMostCell"); m.nbsp(); m.closeTd(); m.openTd(); m.setStyleName("ChangeTypeCell"); m.append(p.getChangeType().getCode()); m.closeTd(); m.openTd(); m.addStyleName(com.google.gerrit.client.changes.S_DATA_CELL); m.addStyleName("FilePathCell"); m.closeTd(); m.openTd(); m.addStyleName(com.google.gerrit.client.changes.S_DATA_CELL); m.addStyleName("CommentCell"); appendCommentCount(m, p); m.closeTd(); switch (p.getPatchType()) { case UNIFIED : openlink(m, 2); m.closeTd(); break; case BINARY : { java.lang.String base = com.google.gwt.core.client.GWT.getHostPageBaseURL(); base += "cat/" + (com.google.gwtorm.client.KeyUtil.encode(p.getKey().toString())); switch (p.getChangeType()) { case DELETED : case MODIFIED : openlink(m, 1); m.openAnchor(); m.setAttribute("href", (base + "^1")); m.append(Util.C.patchTableDownloadPreImage()); closelink(m); break; default : emptycell(m, 1); break; } switch (p.getChangeType()) { case MODIFIED : case ADDED : openlink(m, 1); m.openAnchor(); m.setAttribute("href", (base + "^0")); m.append(Util.C.patchTableDownloadPostImage()); closelink(m); break; default : emptycell(m, 1); break; } break; } default : emptycell(m, 2); break; } openlink(m, 1); m.closeTd(); m.closeTr(); }
public void postEvent(com.google.gerrit.reviewdb.client.Branch.NameKey branchName, com.google.gerrit.server.events.Event event);
private java.util.List<java.io.File> scanJarsInPluginsDirectory() { if (((pluginsDir) == null) || (!(pluginsDir.exists()))) { return java.util.Collections.emptyList(); } java.io.File[] matches = pluginsDir.listFiles(new java.io.FileFilter() { @java.lang.Override public boolean accept(java.io.File pathname) { java.lang.String n = pathname.getName(); return ((n.endsWith(".jar")) || (n.endsWith(".jar.disabled"))) && (pathname.isFile()); } }); if (matches == null) { com.google.gerrit.server.plugins.PluginLoader.log.error(("Cannot list " + (pluginsDir.getAbsolutePath()))); return java.util.Collections.emptyList(); } return java.util.Arrays.asList(matches); }
@java.lang.Override public void evict(com.google.gerrit.reviewdb.client.Project p) throws java.io.IOException { evict(p.getNameKey()); }
public void run() { com.google.gerrit.client.rpc.CallbackGroup group = new com.google.gerrit.client.rpc.CallbackGroup(); commentManager.saveAllDrafts(group); group.done(); group.addListener(new com.google.gerrit.client.rpc.GerritCallback<java.lang.Void>() { @java.lang.Override public void onSuccess(java.lang.Void result) { java.lang.String b = ((base) != null) ? base.getId() : null; java.lang.String rev = revision.getId(); com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(changeId, b, rev), new com.google.gerrit.client.change.ChangeScreen2(changeId, b, rev, openReplyBox, FileTable.Mode.REVIEW)); } }); }
private boolean setPolyGerritCookie(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse res, com.google.gerrit.httpd.raw.StaticModule.UiPreference pref) { javax.servlet.http.Cookie cookie = new javax.servlet.http.Cookie(com.google.gerrit.httpd.raw.StaticModule.GERRIT_UI_COOKIE, pref.name().toLowerCase()); if ((options.enablePolyGerrit()) && (options.enableGwtUi())) { cookie.setPath("/"); cookie.setSecure(com.google.gerrit.httpd.raw.StaticModule.PolyGerritFilter.isSecure(req)); cookie.setMaxAge(com.google.gerrit.httpd.raw.StaticModule.GERRIT_UI_COOKIE_MAX_AGE); } else { cookie.setValue(""); cookie.setMaxAge(0); } res.addCookie(cookie); return pref == (com.google.gerrit.httpd.raw.StaticModule.UiPreference.POLYGERRIT); }
private void parseChangeMessage(org.eclipse.jgit.revwalk.RevCommit commit) { byte[] raw = commit.getRawBuffer(); int size = raw.length; java.nio.charset.Charset enc = org.eclipse.jgit.util.RawParseUtils.parseEncoding(raw); int subjectStart = org.eclipse.jgit.util.RawParseUtils.commitMessage(raw, 0); if ((subjectStart < 0) || (subjectStart >= size)) { return; } int subjectEnd = org.eclipse.jgit.util.RawParseUtils.endOfParagraph(raw, subjectStart); if (subjectEnd == size) { return; } int changeMessageStart; if ((raw[subjectEnd]) == '\n') { changeMessageStart = subjectEnd + 2; } else if ((raw[subjectEnd]) == '\r') { changeMessageStart = subjectEnd + 4; } else { return; } int ptr = size - 1; int changeMessageEnd = -1; while (ptr > changeMessageStart) { ptr = org.eclipse.jgit.util.RawParseUtils.prevLF(raw, ptr, '\r'); if (ptr == (-1)) { break; } if ((raw[ptr]) == '\n') { changeMessageEnd = ptr - 1; break; } else if ((raw[ptr]) == '\r') { changeMessageEnd = ptr - 3; break; } } if (ptr <= changeMessageStart) { return; } java.lang.String changeMessage = org.eclipse.jgit.util.RawParseUtils.decode(enc, raw, changeMessageStart, (changeMessageEnd + 1)); changeMessages.add(changeMessage); }
public com.google.gerrit.extensions.api.changes.IncludedInInfo apply(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String revisionId) throws com.google.gerrit.extensions.restapi.RestApiException, java.io.IOException { try (org.eclipse.jgit.lib.Repository r = repoManager.openRepository(project);org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(r)) { rw.setRetainBody(false); org.eclipse.jgit.revwalk.RevCommit rev; try { rev = rw.parseCommit(org.eclipse.jgit.lib.ObjectId.fromString(revisionId)); } catch (org.eclipse.jgit.errors.IncorrectObjectTypeException err) { throw new com.google.gerrit.extensions.restapi.BadRequestException(err.getMessage()); } catch (org.eclipse.jgit.errors.MissingObjectException err) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException(err.getMessage()); } com.google.gerrit.server.change.IncludedInResolver.Result d = com.google.gerrit.server.change.IncludedInResolver.resolve(r, rw, rev); com.google.common.collect.ListMultimap<java.lang.String, java.lang.String> external = com.google.common.collect.MultimapBuilder.hashKeys().arrayListValues().build(); for (com.google.gerrit.extensions.config.ExternalIncludedIn ext : externalIncludedIn) { com.google.common.collect.ListMultimap<java.lang.String, java.lang.String> extIncludedIns = ext.getIncludedIn(project.get(), rev.name(), d.getTags(), d.getBranches()); if (extIncludedIns != null) { external.putAll(extIncludedIns); } } return new com.google.gerrit.extensions.api.changes.IncludedInInfo(d.getBranches(), d.getTags(), (!(external.isEmpty()) ? external.asMap() : null)); } }
public java.util.SortedMap<java.lang.String, com.google.gerrit.extensions.common.PluginInfo> display(@com.google.gerrit.common.Nullable java.io.PrintWriter stdout) { java.util.SortedMap<java.lang.String, com.google.gerrit.extensions.common.PluginInfo> output = new java.util.TreeMap<>(); java.util.List<com.google.gerrit.server.plugins.Plugin> plugins = com.google.common.collect.Lists.newArrayList(pluginLoader.getPlugins(all)); java.util.Collections.sort(plugins, new java.util.Comparator<com.google.gerrit.server.plugins.Plugin>() { @java.lang.Override public int compare(com.google.gerrit.server.plugins.Plugin a, com.google.gerrit.server.plugins.Plugin b) { return a.getName().compareTo(b.getName()); } }); if (!(format.isJson())) { stdout.format("%-30s %-10s %-8s %s\n", "Name", "Version", "Status", "File"); stdout.print("-------------------------------------------------------------------------------\n"); } for (com.google.gerrit.server.plugins.Plugin p : plugins) { com.google.gerrit.extensions.common.PluginInfo info = com.google.gerrit.server.plugins.ListPlugins.toPluginInfo(p); if (format.isJson()) { output.put(p.getName(), info); } else { stdout.format("%-30s %-10s %-8s %s\n", p.getName(), com.google.common.base.Strings.nullToEmpty(info.version), (p.isDisabled() ? "DISABLED" : "ENABLED"), p.getSrcFile().getFileName()); } } if (stdout == null) { return output; } else if (format.isJson()) { format.newGson().toJson(output, new com.google.gson.reflect.TypeToken<java.util.Map<java.lang.String, com.google.gerrit.extensions.common.PluginInfo>>() {}.getType(), stdout); stdout.print('\n'); } stdout.flush(); return null; }
@java.lang.Override public com.google.gerrit.extensions.api.projects.ConfigInfo apply(com.google.gerrit.server.project.ProjectResource rsrc, com.google.gerrit.extensions.api.projects.ConfigInput input) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.permissions.PermissionBackendException { permissionBackend.user(user).project(rsrc.getNameKey()).check(ProjectPermission.WRITE_CONFIG); return apply(rsrc.getProjectState(), input); }
void render(int context, com.google.gerrit.client.diff.DiffInfo diff) { if (context == (com.google.gerrit.extensions.client.DiffPreferencesInfo.WHOLE_FILE_CONTEXT)) { return; } java.util.List<com.google.gerrit.client.patches.SkippedLine> skips = new java.util.ArrayList<>(); int lineA = 0; int lineB = 0; com.google.gwt.core.client.JsArray<com.google.gerrit.client.diff.DiffInfo.Region> regions = diff.content(); for (int i = 0; i < (regions.length()); i++) { com.google.gerrit.client.diff.DiffInfo.Region current = regions.get(i); if ((((current.ab()) != null) || (current.common())) || ((current.skip()) > 0)) { int len = ((current.skip()) > 0) ? current.skip() : ((current.ab()) != null ? current.ab() : current.b()).length(); if ((i == 0) && (len > (context + 1))) { skips.add(new com.google.gerrit.client.patches.SkippedLine(0, 0, (len - context))); } else if ((i == ((regions.length()) - 1)) && (len > (context + 1))) { skips.add(new com.google.gerrit.client.patches.SkippedLine((lineA + context), (lineB + context), (len - context))); } else if (len > ((2 * context) + 1)) { skips.add(new com.google.gerrit.client.patches.SkippedLine((lineA + context), (lineB + context), (len - (2 * context)))); } lineA += len; lineB += len; } else { lineA += ((current.a()) != null) ? current.a().length() : 0; lineB += ((current.b()) != null) ? current.b().length() : 0; } } skips = host.getCommentManager().splitSkips(context, skips); renderSkips(skips, lineA, lineB); }
java.util.List<java.lang.String> allowSshCommands() { return allowSshCommands; }
void onDelete(int idx) { java.lang.String path = list.get(idx).path(); com.google.gerrit.client.changes.ChangeEditApi.delete(project.get(), curr.getParentKey().get(), path, new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.VoidResult>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.VoidResult result) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChangeInEditMode(project, curr.getParentKey())); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { } }); }
@org.junit.Test public void atLeastOnePageIn() throws java.lang.Exception { java.util.List<org.eclipse.jgit.revwalk.RevCommit> commits = linearCommits(10); walk.markStart(commits.get(9)); com.google.gitiles.Paginator p = new com.google.gitiles.Paginator(walk, 3, commits.get(7)); assertEquals(com.google.common.collect.ImmutableList.of(commits.get(7), commits.get(6), commits.get(5)), com.google.common.collect.ImmutableList.copyOf(p)); assertEquals(commits.get(9), p.getPreviousStart()); assertEquals(commits.get(4), p.getNextStart()); }
public java.lang.String password(final java.lang.String username, final java.lang.String password) { final java.lang.String ov = getSecure(password); java.lang.String user = flags.sec.getString(section, subsection, username); if (user == null) { user = get(username); } if (user == null) { flags.sec.unset(section, subsection, password); return null; } if (ov != null) { if ((ui.isBatch()) || (!(ui.yesno(false, "Change %s's password", user)))) { return ov; } } final java.lang.String nv = ui.password("%s's password", user); if (!(com.google.gerrit.pgm.init.api.Section.eq(ov, nv))) { setSecure(password, nv); } return nv; }
private void index(com.google.gerrit.server.project.ProjectControl projectControl) { try { index.apply(new com.google.gerrit.server.project.ProjectResource(projectControl), null); } catch (java.lang.Exception e) { writeError("error", java.lang.String.format("Unable to index %s: %s", projectControl.getProject().getName(), e.getMessage())); } }
@org.junit.Test public void missingRepo() throws java.lang.Exception { assumeNoteDbDisabled(); com.google.gerrit.server.notedb.ChangeNotes notes = insertChange(); com.google.gerrit.reviewdb.client.Project.NameKey name = notes.getProjectName(); com.google.gerrit.server.project.ChangeControl ctl = controlForNotes(notes); ((com.google.gerrit.testutil.InMemoryRepositoryManager) (repoManager)).deleteRepository(name); assertThat(checker.check(ctl, null).problems()).containsExactly(com.google.gerrit.acceptance.server.change.ConsistencyCheckerIT.problem(("Destination repository not found: " + name))); }
public boolean matches(com.google.gerrit.server.account.ExternalId extId) { return matches(extId.key().get()); }
public void doDraftPublishedHook(final com.google.gerrit.reviewdb.client.Change change, final com.google.gerrit.reviewdb.client.PatchSet patchSet, final com.google.gerrit.reviewdb.server.ReviewDb db) throws com.google.gwtorm.server.OrmException { final com.google.gerrit.server.events.DraftPublishedEvent event = new com.google.gerrit.server.events.DraftPublishedEvent(); final com.google.gerrit.server.account.AccountState uploader = accountCache.get(patchSet.getUploader()); event.change = eventFactory.asChangeAttribute(change); event.patchSet = eventFactory.asPatchSetAttribute(patchSet); event.uploader = eventFactory.asAccountAttribute(uploader.getAccount()); fireEvent(change, event, db); final java.util.List<java.lang.String> args = new java.util.ArrayList<java.lang.String>(); addArg(args, "--change", event.change.id); addArg(args, "--change-url", event.change.url); addArg(args, "--project", event.change.project); addArg(args, "--branch", event.change.branch); addArg(args, "--topic", event.change.topic); addArg(args, "--uploader", getDisplayName(uploader.getAccount())); addArg(args, "--commit", event.patchSet.revision); addArg(args, "--patchset", event.patchSet.number); runHook(change.getProject(), draftPublishedHook, args); }
public void ensureLoaded(final com.google.gerrit.common.data.PatchSetDetail detail) { loadInfoTable(detail); loadActionPanel(detail); loadPatchTable(detail); }
private void attachSet(java.util.Map<com.google.inject.TypeLiteral<?>, com.google.gerrit.extensions.registration.DynamicSet<?>> sets, @javax.annotation.Nullable com.google.inject.Injector src, com.google.gerrit.server.plugins.Plugin plugin) { if (((src != null) && (sets != null)) && (!(sets.isEmpty()))) { for (java.util.Map.Entry<com.google.inject.TypeLiteral<?>, com.google.gerrit.extensions.registration.DynamicSet<?>> e : sets.entrySet()) { @java.lang.SuppressWarnings("unchecked") com.google.inject.TypeLiteral<java.lang.Object> type = ((com.google.inject.TypeLiteral<java.lang.Object>) (e.getKey())); @java.lang.SuppressWarnings("unchecked") com.google.gerrit.extensions.registration.DynamicSet<java.lang.Object> set = ((com.google.gerrit.extensions.registration.DynamicSet<java.lang.Object>) (e.getValue())); for (com.google.inject.Binding<java.lang.Object> b : com.google.gerrit.server.plugins.PluginGuiceEnvironment.bindings(src, type)) { plugin.add(set.add(b.getKey(), b.getProvider().get())); } } } }
@com.google.gwtorm.client.Query("WHERE open = true AND sortKeyDesc > ? ORDER BY sortKeyDesc LIMIT ?") com.google.gwtorm.client.ResultSet<com.google.gerrit.reviewdb.Change> allOpenNext(java.lang.String sortKey, int limit) throws com.google.gwtorm.client.OrmException;
@java.lang.Override public java.util.Collection<com.googlesource.gerrit.plugins.manager.repository.PluginInfo> load(com.googlesource.gerrit.plugins.manager.PluginsCentralLoader.ListKey all) throws java.lang.Exception { return repository.list(com.googlesource.gerrit.plugins.manager.PluginsCentralLoader.GERRIT_VERSION); }
@java.lang.Override public java.util.EnumSet<com.google.gerrit.server.query.change.ChangeData.NeededData> getNeededData() { return java.util.EnumSet.of(NeededData.APPROVALS, NeededData.CHANGE, NeededData.PROJECT_STATE); }
@java.lang.Override public void init(javax.servlet.FilterConfig filterConfig) throws javax.servlet.ServletException { javax.servlet.ServletContext servletContext = filterConfig.getServletContext(); showGitBlitBanner(); gerritGitblitContext.init(servletContext); try { super.init(new com.googlesource.gerrit.plugins.gitblit.GerritWicketFilter.CustomFilterConfig(filterConfig)); } catch (java.lang.Exception e) { throw new javax.servlet.ServletException(e); } }
private java.util.Map<java.lang.String, com.google.gerrit.extensions.common.ActionInfo> toActionMap(com.google.gerrit.server.project.ChangeControl ctl) { java.util.Map<java.lang.String, com.google.gerrit.extensions.common.ActionInfo> out = new java.util.LinkedHashMap<>(); if (!(ctl.getCurrentUser().isIdentifiedUser())) { return out; } com.google.inject.Provider<com.google.gerrit.server.CurrentUser> userProvider = com.google.inject.util.Providers.of(ctl.getCurrentUser()); for (com.google.gerrit.extensions.webui.UiAction.Description d : com.google.gerrit.server.extensions.webui.UiActions.from(changeViews, new com.google.gerrit.server.change.ChangeResource(ctl), userProvider)) { out.put(d.getId(), new com.google.gerrit.extensions.common.ActionInfo(d)); } if (ctl.getChange().getStatus().isOpen()) { com.google.gerrit.extensions.webui.UiAction.Description descr = new com.google.gerrit.extensions.webui.UiAction.Description(); com.google.gerrit.extensions.webui.PrivateInternals_UiActionDescription.setId(descr, "followup"); com.google.gerrit.extensions.webui.PrivateInternals_UiActionDescription.setMethod(descr, "POST"); descr.setTitle("Create follow-up change"); out.put(descr.getId(), new com.google.gerrit.extensions.common.ActionInfo(descr)); } return out; }
private <K, V> com.google.gerrit.server.cache.UnnamedCacheBinding<K, V> core(final com.google.inject.Key<com.google.gerrit.server.cache.Cache<K, V>> key, final com.google.inject.TypeLiteral<com.google.gerrit.server.cache.Cache<K, V>> type) { final boolean disk = false; final com.google.gerrit.server.cache.CacheProvider<K, V> b = new com.google.gerrit.server.cache.CacheProvider<K, V>(disk, this, type); bind(key).toProvider(b).in(Scopes.SINGLETON); return b; }
@org.junit.Test public void testWithSectionToOtherServer() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Project.NameKey p1 = createProject("a"); org.eclipse.jgit.lib.Config cfg = new org.eclipse.jgit.lib.Config(); cfg.fromText((((("" + (("[submodule \"a\"]" + "path = a") + "url = ssh://non-localhost/")) + (p1.get())) + "\n") + "branch = .")); com.google.gerrit.reviewdb.client.Branch.NameKey targetBranch = new com.google.gerrit.reviewdb.client.Branch.NameKey(new com.google.gerrit.reviewdb.client.Project.NameKey("project"), "master"); java.util.Set<com.google.gerrit.reviewdb.client.SubmoduleSubscription> res = new com.google.gerrit.server.util.SubmoduleSectionParser(cfg, com.google.gerrit.acceptance.git.SubmoduleSectionParserIT.THIS_SERVER, targetBranch).parseAllSections(); assertThat(res).isEmpty(); }
@java.lang.Override public void onSuccess(com.google.gerrit.client.info.ChangeInfo info) { info.init(); if ((project) == null) { project = info.projectNameKey(); } initCurrentRevision(info); final com.google.gerrit.client.info.ChangeInfo.RevisionInfo rev = info.revision(revision); com.google.gerrit.client.rpc.CallbackGroup group = new com.google.gerrit.client.rpc.CallbackGroup(); loadCommit(rev, group); group.addListener(new com.google.gerrit.client.rpc.GerritCallback<java.lang.Void>() { @java.lang.Override public void onSuccess(java.lang.Void result) { if ((base.isBase()) && (rev.isMerge())) { base = com.google.gerrit.client.DiffObject.parse(info.legacyId(), com.google.gerrit.client.Gerrit.getUserPreferences().defaultBaseForMerges().getBase()); } loadConfigInfo(info, base); com.google.gwt.core.client.JsArray<com.google.gerrit.client.info.ChangeInfo.MessageInfo> mAr = info.messages(); for (int i = 0; i < (mAr.length()); i++) { if ((mAr.get(i).tag()) != null) { hideTaggedComments.setVisible(true); break; } } } }); group.done(); }
com.google.gitiles.CommitJsonData.Commit toJsonData(javax.servlet.http.HttpServletRequest req, org.eclipse.jgit.revwalk.RevCommit c, java.util.Set<com.google.gitiles.CommitData.Field> fs, org.eclipse.jgit.util.GitDateFormatter df) throws java.io.IOException { com.google.gitiles.CommitData cd = new com.google.gitiles.CommitData.Builder().setRevWalk(walk).build(req, c, fs); com.google.gitiles.CommitJsonData.Commit result = new com.google.gitiles.CommitJsonData.Commit(); if ((cd.sha) != null) { result.commit = cd.sha.name(); } if ((cd.parents) != null) { result.parents = com.google.common.collect.Lists.newArrayListWithCapacity(cd.parents.size()); for (org.eclipse.jgit.revwalk.RevCommit parent : cd.parents) { result.parents.add(parent.name()); } } if ((cd.author) != null) { result.author = com.google.gitiles.CommitJsonData.toJsonData(cd.author, df); } if ((cd.committer) != null) { result.committer = com.google.gitiles.CommitJsonData.toJsonData(cd.committer, df); } if ((cd.message) != null) { result.message = cd.message; } if ((cd.diffEntries) != null) { result.treeDiff = com.google.gitiles.CommitJsonData.toJsonData(cd.diffEntries); } return result; }
public com.google.gerrit.server.git.CodeReviewCommit getFirstFastForward(final com.google.gerrit.server.git.CodeReviewCommit mergeTip, final org.eclipse.jgit.revwalk.RevWalk rw, final java.util.List<com.google.gerrit.server.git.CodeReviewCommit> toMerge) throws com.google.gerrit.server.git.IntegrationException { for (final java.util.Iterator<com.google.gerrit.server.git.CodeReviewCommit> i = toMerge.iterator(); i.hasNext();) { try { final com.google.gerrit.server.git.CodeReviewCommit n = i.next(); if ((mergeTip == null) || (rw.isMergedInto(mergeTip, n))) { i.remove(); return n; } } catch (java.io.IOException e) { throw new com.google.gerrit.server.git.IntegrationException("Cannot fast-forward test during merge", e); } } return mergeTip; }
private void write(final java.io.OutputStream out, final com.google.gerrit.prettify.common.BaseEdit e) throws java.io.IOException { writeVarInt32(out, e.getBeginA()); writeVarInt32(out, e.getEndA()); writeVarInt32(out, e.getBeginB()); writeVarInt32(out, e.getEndB()); }
@java.lang.Override public void onSuccess(com.google.gwtjsonrpc.client.VoidResult result) { com.google.gerrit.client.Gerrit.setAccountDiffPreference(diffPref); setEnabled(true); }
public void fire(com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.PatchSet ps, com.google.gerrit.reviewdb.client.Account abandoner, java.lang.String reason) { if (!(listeners.iterator().hasNext())) { return; } try { fire(util.changeInfo(change), util.revisionInfo(change.getProject(), ps), util.accountInfo(abandoner), reason); } catch (com.google.gerrit.server.patch.PatchListNotAvailableException | com.google.gerrit.server.GpgException | java.io.IOException | com.google.gwtorm.server.OrmException e) { com.google.gerrit.server.extensions.events.ChangeAbandoned.log.error("Couldn't fire event", e); } }
@java.lang.Override public void onSuccess(final com.google.gerrit.common.data.HostPageData result) { com.google.gwt.dom.client.Document.get().getElementById("gerrit_hostpagedata").removeFromParent(); com.google.gerrit.client.Gerrit.myConfig = result.config; com.google.gerrit.client.Gerrit.myTheme = result.theme; if ((result.account) != null) { com.google.gerrit.client.Gerrit.myAccount = result.account; com.google.gerrit.client.Gerrit.xGerritAuth = result.xGerritAuth; } if ((result.accountDiffPref) != null) { com.google.gerrit.client.Gerrit.myAccountDiffPref = result.accountDiffPref; com.google.gerrit.client.Gerrit.applyUserPreferences(); } onModuleLoad2(result); }
@java.lang.Override public java.lang.Void call() throws java.io.IOException { for (com.google.gerrit.server.index.change.ChangeIndex i : getWriteIndexes()) { i.delete(id); } com.google.gerrit.server.index.change.ChangeIndexer.log.info("Deleted change {} from index.", id.get()); fireChangeDeletedFromIndexEvent(id.get()); return null; }
void scheduleFullSync(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String urlMatch, com.googlesource.gerrit.plugins.replication.ReplicationState state, boolean now) { if (!(running)) { stateLog.warn("Replication plugin did not finish startup before event", state); return; } for (com.googlesource.gerrit.plugins.replication.Destination cfg : config.getDestinations(FilterType.ALL)) { if (cfg.wouldPushProject(project)) { for (org.eclipse.jgit.transport.URIish uri : cfg.getURIs(project, urlMatch)) { cfg.schedule(project, PushOne.ALL_REFS, uri, state, now); } } } }
static java.util.Set<java.lang.String> extractTags(java.util.Set<java.lang.String> input) throws com.google.gerrit.server.change.HashtagsUtil.InvalidHashtagException { if (input == null) { return java.util.Collections.emptySet(); } java.util.HashSet<java.lang.String> result = new java.util.HashSet<>(); for (java.lang.String hashtag : input) { if (hashtag.contains(",")) { throw com.google.gerrit.server.change.HashtagsUtil.InvalidHashtagException.hashtagsMayNotContainCommas(); } hashtag = com.google.gerrit.server.change.HashtagsUtil.cleanupHashtag(hashtag); if (!(hashtag.isEmpty())) { result.add(hashtag); } } return result; }
public java.util.Set<com.google.gerrit.reviewdb.AccountGeneralPreferences.DownloadScheme> getDownloadSchemes() { return downloadSchemes; }
public void setReviewedByCurrentUser(boolean reviewed) { if ((fileList) != null) { fileList.updateReviewedStatus(patchKey, reviewed); } com.google.gerrit.reviewdb.client.PatchSet.Id ps = patchKey.getParentKey(); com.google.gerrit.client.rpc.RestApi api = new com.google.gerrit.client.rpc.RestApi("/changes/").id(ps.getParentKey().get()).view("revisions").id(ps.get()).view("files").id(patchKey.getFileName()).view("reviewed"); com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.VoidResult> cb = new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.VoidResult>() { @java.lang.Override public void onFailure(java.lang.Throwable arg0) { } @java.lang.Override public void onSuccess(com.google.gerrit.client.VoidResult result) { } }; if (reviewed) { api.put(cb); } else { api.delete(cb); } }
private void getImpl(final java.lang.String name, final com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.projects.ConfigInfoCache.Entry> cb) { com.google.gerrit.client.projects.ConfigInfoCache.Entry e = cache.get(name); if (e != null) { cb.onSuccess(e); return; } com.google.gerrit.client.projects.ProjectApi.getConfig(new com.google.gerrit.reviewdb.client.Project.NameKey(name), new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.projects.ConfigInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.projects.ConfigInfo result) { com.google.gerrit.client.projects.ConfigInfoCache.Entry e = new com.google.gerrit.client.projects.ConfigInfoCache.Entry(result); cache.put(name, e); cb.onSuccess(e); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { cb.onFailure(caught); } }); }
@org.junit.Test public void testChildrenUnmodifiable() { final com.google.gerrit.server.query.OrPredicateTest.TestPredicate a = com.google.gerrit.server.query.OrPredicateTest.f("author", "alice"); final com.google.gerrit.server.query.OrPredicateTest.TestPredicate b = com.google.gerrit.server.query.OrPredicateTest.f("author", "bob"); final com.google.gerrit.server.query.Predicate<java.lang.String> n = com.google.gerrit.server.query.Predicate.or(a, b); exception.expect(java.lang.UnsupportedOperationException.class); n.getChildren().clear(); com.google.gerrit.server.query.OrPredicateTest.assertChildren("clear", n, of(a, b)); exception.expect(java.lang.UnsupportedOperationException.class); n.getChildren().remove(0); com.google.gerrit.server.query.OrPredicateTest.assertChildren("remove(0)", n, of(a, b)); exception.expect(java.lang.UnsupportedOperationException.class); n.getChildren().iterator().remove(); com.google.gerrit.server.query.OrPredicateTest.assertChildren("remove(0)", n, of(a, b)); }
@java.lang.Override protected void onRequestSuggestions(com.google.gerrit.client.ui.Request request, com.google.gerrit.client.ui.Callback done) { java.lang.String query = request.getQuery().toLowerCase(); java.util.LinkedList<com.google.gerrit.client.ui.RebaseDialog.ChangeSuggestion> suggestions = new java.util.LinkedList<>(); for (final com.google.gerrit.client.changes.ChangeInfo ci : changes) { if (changeId.equals(ci.legacy_id())) { continue; } java.lang.String id = java.lang.String.valueOf(ci.legacy_id().get()); if ((id.contains(query)) || (ci.subject().toLowerCase().contains(query))) { suggestions.add(new com.google.gerrit.client.ui.RebaseDialog.ChangeSuggestion(ci)); if ((suggestions.size()) >= 50) { break; } } } done.onSuggestionsReady(request, new com.google.gerrit.client.ui.Response(suggestions)); }
private java.util.List<com.google.gerrit.common.data.PermissionRule> access(java.lang.String permissionName, boolean isChangeOwner) { java.util.List<com.google.gerrit.common.data.PermissionRule> rules = effective.get(permissionName); if (rules != null) { return rules; } rules = relevant.getPermission(permissionName); if (rules.isEmpty()) { effective.put(permissionName, rules); return rules; } if ((rules.size()) == 1) { if (!(projectControl.match(rules.get(0), isChangeOwner))) { rules = java.util.Collections.emptyList(); } effective.put(permissionName, rules); return rules; } java.util.List<com.google.gerrit.common.data.PermissionRule> mine = new java.util.ArrayList<com.google.gerrit.common.data.PermissionRule>(rules.size()); for (com.google.gerrit.common.data.PermissionRule rule : rules) { if (projectControl.match(rule, isChangeOwner)) { mine.add(rule); } } if (mine.isEmpty()) { mine = java.util.Collections.emptyList(); } effective.put(permissionName, mine); return mine; }
@org.junit.Test @com.google.gerrit.acceptance.Sandboxed public void blockReviewDbUpdatesOnGroupUpdate() throws java.lang.Exception { assume().that(groupsInNoteDb()).isFalse(); java.lang.String group1 = gApi.groups().create(name("foo")).get().id; java.lang.String group2 = gApi.groups().create(name("bar")).get().id; cfg.setBoolean("user", null, "blockReviewDbGroupUpdates", true); try { gApi.groups().id(group1).addGroups(group2); fail("Expected RestApiException: Updates to groups in ReviewDb are blocked"); } catch (com.google.gerrit.extensions.restapi.RestApiException e) { assertWriteGroupToReviewDbBlockedException(e); } }
com.google.gerrit.server.query.change.ChangeQueryBuilder.Arguments asUser(com.google.gerrit.server.CurrentUser otherUser) { return new com.google.gerrit.server.query.change.ChangeQueryBuilder.Arguments(db, queryProvider, rewriter, opFactories, hasOperands, userFactory, com.google.inject.util.Providers.of(otherUser), permissionBackend, capabilityControlFactory, changeControlGenericFactory, notesFactory, changeDataFactory, fillArgs, commentsUtil, accountResolver, groupBackend, allProjectsName, allUsersName, patchListCache, repoManager, projectCache, listChildProjects, submitDryRun, conflictsCache, trackingFooters, index, indexConfig, listMembers, starredChangesUtil, accountCache, allowsDrafts, notesMigration); }
@java.lang.Override public synchronized void init(javax.servlet.FilterConfig config) throws javax.servlet.ServletException { super.init(config); setDefaultFields(config); for (com.google.gitiles.GitilesView.Type type : GitilesView.Type.values()) { if (!(servlets.containsKey(type))) { servlets.put(type, getDefaultHandler(type)); } } javax.servlet.Filter repositoryFilter = new com.google.gitiles.RepositoryFilter(resolver); javax.servlet.Filter viewFilter = new com.google.gitiles.ViewFilter(accessFactory, urls, visibilityCache); javax.servlet.Filter dispatchFilter = new com.google.gitiles.GitilesFilter.DispatchFilter(filters, servlets); org.eclipse.jgit.http.server.glue.ServletBinder root = serveRegex(com.google.gitiles.GitilesFilter.ROOT_REGEX).through(viewFilter); if ((gitwebRedirect) != null) { root.through(gitwebRedirect); } root.through(dispatchFilter); serveRegex(com.google.gitiles.GitilesFilter.REPO_REGEX).through(repositoryFilter).through(viewFilter).through(dispatchFilter); serveRegex(com.google.gitiles.GitilesFilter.REPO_PATH_REGEX).through(repositoryFilter).through(viewFilter).through(dispatchFilter); initialized = true; }
public final native int start_character();
private static com.google.gerrit.extensions.client.GeneralPreferencesInfo nullify(com.google.gerrit.extensions.client.GeneralPreferencesInfo p) { p.showSiteHeader = com.google.gerrit.server.account.GetPreferences.b(p.showSiteHeader); p.useFlashClipboard = com.google.gerrit.server.account.GetPreferences.b(p.useFlashClipboard); p.relativeDateInChangeTable = com.google.gerrit.server.account.GetPreferences.b(p.relativeDateInChangeTable); p.legacycidInChangeTable = com.google.gerrit.server.account.GetPreferences.b(p.legacycidInChangeTable); p.muteCommonPathPrefixes = com.google.gerrit.server.account.GetPreferences.b(p.muteCommonPathPrefixes); p.sizeBarInChangeTable = com.google.gerrit.server.account.GetPreferences.b(p.sizeBarInChangeTable); return p; }
private com.google.gerrit.client.ui.PatchLink createLink(int index, com.google.gerrit.client.patches.PatchScreen.Type patchType, com.google.gwtexpui.safehtml.client.SafeHtml before, com.google.gwtexpui.safehtml.client.SafeHtml after) { com.google.gerrit.reviewdb.client.Patch patch = patchList.get(index); com.google.gerrit.reviewdb.client.Patch.Key thisKey = patch.getKey(); com.google.gerrit.client.ui.PatchLink link; if ((patchType == (PatchScreen.Type.SIDE_BY_SIDE)) && ((patch.getPatchType()) == (com.google.gerrit.reviewdb.client.Patch.PatchType.UNIFIED))) { link = new com.google.gerrit.client.ui.PatchLink.SideBySide("", base, thisKey, index, detail, this); } else { link = new com.google.gerrit.client.ui.PatchLink.Unified("", base, thisKey, index, detail, this); } com.google.gwtexpui.safehtml.client.SafeHtmlBuilder text = new com.google.gwtexpui.safehtml.client.SafeHtmlBuilder(); text.append(before); text.append(com.google.gerrit.client.changes.PatchTable.getFileNameOnly(patch)); text.append(after); com.google.gwtexpui.safehtml.client.SafeHtml.set(link, text); return link; }
private java.util.List<com.google.gerrit.reviewdb.RefRight> getLocalRights(com.google.gerrit.reviewdb.ApprovalCategory.Id actionId) { return filter(projectControl.getProjectState().getLocalRights(), actionId); }
@java.lang.Override public java.lang.Boolean call() { try (com.google.gerrit.reviewdb.server.ReviewDb db = unwrapDb(schemaFactory.open())) { return rebuilder.rebuildProject(db, changesByProject, project, allUsersRepo); } catch (java.lang.Exception e) { com.google.gerrit.pgm.RebuildNoteDb.log.error(("Error rebuilding project " + project), e); return false; } }
public void onPreMerge(org.eclipse.jgit.lib.Repository repo, com.google.gerrit.server.git.CodeReviewCommit commit, com.google.gerrit.server.project.ProjectState destProject, com.google.gerrit.reviewdb.client.Branch.NameKey destBranch, com.google.gerrit.reviewdb.client.PatchSet.Id patchSetId) throws com.google.gerrit.server.git.validators.MergeValidationException;
@org.junit.Test public void submitWithCherryPickIfFastForwardPossible() throws java.lang.Exception { org.eclipse.jgit.revwalk.RevCommit initialHead = getRemoteHead(); com.google.gerrit.acceptance.PushOneCommit.Result change = createChange(); submit(change.getChangeId()); assertCherryPick(testRepo, false); org.eclipse.jgit.revwalk.RevCommit newHead = getRemoteHead(); assertThat(newHead.getParent(0)).isEqualTo(change.getCommit().getParent(0)); assertRefUpdatedEvents(initialHead, newHead); assertChangeMergedEvents(change.getChangeId(), newHead.name()); }
@org.junit.Test public void readPluginConfigGroupReference() throws java.lang.Exception { org.eclipse.jgit.revwalk.RevCommit rev = tr.commit().add("groups", com.google.gerrit.server.git.ProjectConfigTest.group(developers)).add("project.config", ("[plugin \"somePlugin\"]\nkey1 = " + (developers.toConfigValue()))).create(); update(rev); com.google.gerrit.server.git.ProjectConfig cfg = read(rev); com.google.gerrit.server.config.PluginConfig pluginCfg = cfg.getPluginConfig("somePlugin"); assertThat(pluginCfg.getNames().size()).isEqualTo(1); assertThat(pluginCfg.getGroupReference("key1")).isEqualTo(developers); }
private void grantAllCapabilities() throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { com.google.gerrit.server.git.MetaDataUpdate md = metaDataUpdateFactory.create(allProjects); md.setMessage("Make super user"); com.google.gerrit.server.git.ProjectConfig config = com.google.gerrit.server.git.ProjectConfig.read(md); com.google.gerrit.common.data.AccessSection s = config.getAccessSection(AccessSection.GLOBAL_CAPABILITIES); for (java.lang.String c : com.google.gerrit.common.data.GlobalCapability.getAllNames()) { if ((com.google.gerrit.acceptance.rest.account.ADMINISTRATE_SERVER.equals(c)) || (com.google.gerrit.acceptance.rest.account.PRIORITY.equals(c))) { continue; } com.google.gerrit.common.data.Permission p = s.getPermission(c, true); com.google.gerrit.common.data.PermissionRule rule = new com.google.gerrit.common.data.PermissionRule(config.resolve(com.google.gerrit.server.group.SystemGroupBackend.getGroup(SystemGroupBackend.REGISTERED_USERS))); if (com.google.gerrit.common.data.GlobalCapability.hasRange(c)) { com.google.gerrit.common.data.PermissionRange.WithDefaults range = com.google.gerrit.common.data.GlobalCapability.getRange(c); if (range != null) { rule.setRange(range.getDefaultMin(), range.getDefaultMax()); } } p.add(rule); } config.commit(md); projectCache.evict(config.getProject()); }
java.lang.String projectFilterLabel();
@com.google.gwt.uibinder.client.UiHandler("viewport") void onMouseDown(com.google.gwt.event.dom.client.MouseDownEvent e) { if ((cmB) != null) { dragging = true; ratio = ratio(cmB.getScrollInfo()); startY = e.getY(); viewport.addStyleName(style.viewportDrag()); com.google.gwt.user.client.DOM.setCapture(viewport.getElement()); e.preventDefault(); e.stopPropagation(); } }
private void addMessage(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx, com.google.gerrit.server.notedb.ChangeUpdate update) throws com.google.gwtorm.server.OrmException { java.lang.StringBuilder msg = new java.lang.StringBuilder(); appendHashtagMessage(msg, "added", toAdd); appendHashtagMessage(msg, "removed", toRemove); com.google.gerrit.reviewdb.client.ChangeMessage cmsg = com.google.gerrit.server.ChangeMessagesUtil.newMessage(ctx, msg.toString(), ChangeMessagesUtil.TAG_SET_HASHTAGS); cmUtil.addChangeMessage(ctx.getDb(), update, cmsg); }
public com.google.gwtjsonrpc.client.VoidResult run(com.google.gerrit.client.reviewdb.ReviewDb db) throws com.google.gerrit.server.patch.Failure, com.google.gwtorm.client.OrmException { final com.google.gerrit.client.reviewdb.PatchLineComment comment = db.patchComments().get(commentKey); if (comment == null) { throw new com.google.gerrit.server.patch.Failure(new com.google.gerrit.client.rpc.NoSuchEntityException()); } if (!(com.google.gerrit.client.rpc.Common.getAccountId().equals(comment.getAuthor()))) { throw new com.google.gerrit.server.patch.Failure(new com.google.gerrit.client.rpc.NoSuchEntityException()); } if ((comment.getStatus()) != (PatchLineComment.Status.DRAFT)) { throw new com.google.gerrit.server.patch.Failure(new java.lang.IllegalStateException("Comment published")); } db.patchComments().delete(java.util.Collections.singleton(comment)); return com.google.gwtjsonrpc.client.VoidResult.INSTANCE; }
public static java.lang.Module module() { return new com.google.gerrit.server.cache.CacheModule() { @java.lang.Override protected void configure() { final com.google.inject.TypeLiteral<com.google.gerrit.server.cache.Cache<com.google.gerrit.reviewdb.Account.Id, com.google.gerrit.server.account.AccountState>> byIdType = new com.google.inject.TypeLiteral<com.google.gerrit.server.cache.Cache<com.google.gerrit.reviewdb.Account.Id, com.google.gerrit.server.account.AccountState>>() {}; core(byIdType, com.google.gerrit.server.account.AccountCacheImpl.BYID_NAME).populateWith(com.google.gerrit.server.account.AccountCacheImpl.ByIdLoader.class); final com.google.inject.TypeLiteral<com.google.gerrit.server.cache.Cache<com.google.gerrit.reviewdb.Account.Username, com.google.gerrit.reviewdb.Account.Id>> byUsernameType = new com.google.inject.TypeLiteral<com.google.gerrit.server.cache.Cache<com.google.gerrit.reviewdb.Account.Username, com.google.gerrit.reviewdb.Account.Id>>() {}; core(byUsernameType, com.google.gerrit.server.account.AccountCacheImpl.BYUSER_NAME).populateWith(com.google.gerrit.server.account.AccountCacheImpl.ByNameLoader.class); bind(com.google.gerrit.server.account.AccountCacheImpl.class); bind(com.google.gerrit.server.account.AccountCache.class).to(com.google.gerrit.server.account.AccountCacheImpl.class); } }; }
private static java.lang.String toCoreScheme(java.lang.String s) { try { java.lang.reflect.Field f = com.google.gerrit.reviewdb.client.CoreDownloadSchemes.class.getField(s.toUpperCase()); int m = ((java.lang.reflect.Modifier.PUBLIC) | (java.lang.reflect.Modifier.STATIC)) | (java.lang.reflect.Modifier.FINAL); if ((((f.getModifiers()) & m) == m) && ((f.getType()) == (java.lang.String.class))) { return ((java.lang.String) (f.get(null))); } else { return null; } } catch (java.lang.NoSuchFieldException | java.lang.SecurityException | java.lang.IllegalArgumentException | java.lang.IllegalAccessException e) { return null; } }
@java.lang.Override protected void onLoad(com.google.gerrit.server.notedb.LoadHandle handle) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { org.eclipse.jgit.lib.ObjectId rev = handle.id(); if (rev == null) { loadDefaults(); return; } com.google.gerrit.server.notedb.ChangeNotesCache.Value v = args.cache.get().get(getProjectName(), getChangeId(), rev, handle.walk()); state = v.state(); state.copyColumnsTo(change); revisionNoteMap = v.revisionNoteMap(); }
com.google.gerrit.server.api.projects.CommitApiImpl create(com.google.gerrit.server.project.CommitResource r);
@org.junit.Test public void get() throws com.google.gerrit.extensions.restapi.RestApiException, java.io.IOException, org.eclipse.jgit.api.errors.GitAPIException { com.google.gerrit.acceptance.PushOneCommit.Result r = createChange(); java.lang.String triplet = "p~master~" + (r.getChangeId()); com.google.gerrit.extensions.common.ChangeInfo c = gApi.changes().id(triplet).get(java.util.EnumSet.noneOf(com.google.gerrit.extensions.common.ListChangesOption.class)); assertEquals(triplet, c.id); assertEquals("p", c.project); assertEquals("master", c.branch); assertEquals(ChangeStatus.NEW, c.status); assertEquals("test commit", c.subject); assertEquals(true, c.mergeable); assertEquals(r.getChangeId(), c.changeId); assertEquals(c.created, c.updated); }
public void dispatchAddMembers(com.google.gerrit.reviewdb.client.Account.Id actor, com.google.gerrit.reviewdb.client.AccountGroup.UUID updatedGroup, com.google.common.collect.ImmutableSet<com.google.gerrit.reviewdb.client.Account.Id> addedMembers, java.sql.Timestamp addedOn) { for (com.google.gerrit.server.audit.group.GroupAuditListener auditListener : groupAuditListeners) { try { com.google.gerrit.server.audit.group.GroupMemberAuditEvent event = com.google.gerrit.server.audit.group.GroupMemberAuditEvent.create(actor, updatedGroup, addedMembers, addedOn); auditListener.onAddMembers(event); } catch (java.lang.RuntimeException e) { com.google.gerrit.server.audit.AuditService.log.error("failed to log add accounts to group event", e); } } }
@java.lang.Override public java.util.Set<com.google.gerrit.reviewdb.Project.NameKey> getWatchedProjects() { if ((watchedProjects) == null) { if ((dbProvider) == null) { throw new com.google.inject.OutOfScopeException("Not in request scoped user"); } final java.util.Set<com.google.gerrit.reviewdb.Project.NameKey> h = new java.util.HashSet<com.google.gerrit.reviewdb.Project.NameKey>(); try { for (com.google.gerrit.reviewdb.AccountProjectWatch projectWatch : dbProvider.get().accountProjectWatches().byAccount(getAccountId())) { h.add(projectWatch.getProjectNameKey()); } } catch (com.google.gwtorm.client.OrmException e) { com.google.gerrit.server.IdentifiedUser.log.warn("Cannot query project watches of a user", e); } watchedProjects = java.util.Collections.unmodifiableSet(h); } return watchedProjects; }
@org.junit.Test public void wrongProjectInProjectChangeNumberReturnsNotFound() throws java.lang.Exception { exception.expect(com.google.gerrit.extensions.restapi.ResourceNotFoundException.class); exception.expectMessage(("Not found: unknown~" + (changeInfo._number))); gApi.changes().id("unknown", changeInfo._number); }
private static com.google.gerrit.server.account.externalids.ExternalId remove(org.eclipse.jgit.revwalk.RevWalk rw, org.eclipse.jgit.notes.NoteMap noteMap, com.google.gerrit.server.account.externalids.ExternalId.Key extIdKey, com.google.gerrit.reviewdb.client.Account.Id expectedAccountId) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { org.eclipse.jgit.lib.ObjectId noteId = extIdKey.sha1(); if (!(noteMap.contains(noteId))) { return null; } org.eclipse.jgit.lib.ObjectId noteDataId = noteMap.get(noteId); byte[] raw = com.google.gerrit.server.account.externalids.ExternalIdNotes.readNoteData(rw, noteDataId); com.google.gerrit.server.account.externalids.ExternalId extId = com.google.gerrit.server.account.externalids.ExternalId.parse(noteId.name(), raw, noteDataId); if (expectedAccountId != null) { checkState(expectedAccountId.equals(extId.accountId()), ("external id %s should be removed for account %s," + " but external id belongs to account %s"), extIdKey.get(), expectedAccountId.get(), extId.accountId().get()); } noteMap.remove(noteId); return extId; }
@org.junit.Test public void nonexistentEmail() throws java.lang.Exception { exception.expect(com.google.gerrit.extensions.restapi.UnprocessableEntityException.class); exception.expectMessage("cannot find account doesnotexist@invalid.com"); gApi.projects().name(normalProject.get()).checkAccess(new com.google.gerrit.extensions.api.config.AccessCheckInput("doesnotexist@invalid.com", null)); }
public java.lang.String getChangeMessageThreadId() throws com.google.gerrit.server.mail.EmailException { return velocify(("<gerrit.${change.createdOn.time}.$change.key.get()" + "@$email.gerritHost>")); }
@java.lang.Override public java.util.List<com.google.gerrit.extensions.common.ProjectInfo> apply(com.google.gerrit.server.project.ProjectResource rsrc) throws com.google.gerrit.server.permissions.PermissionBackendException { if (recursive) { return childProjects.list(rsrc.getNameKey()); } return directChildProjects(rsrc.getNameKey()); }
private static java.util.TreeMap<java.lang.Integer, com.google.gerrit.reviewdb.client.PatchSet> getPatchSets(com.google.gerrit.server.query.change.ChangeData cd) throws com.google.gwtorm.server.OrmException { java.util.Collection<com.google.gerrit.reviewdb.client.PatchSet> patchSets = cd.patches(); java.util.TreeMap<java.lang.Integer, com.google.gerrit.reviewdb.client.PatchSet> result = com.google.common.collect.Maps.newTreeMap(); for (com.google.gerrit.reviewdb.client.PatchSet ps : patchSets) { result.put(ps.getId().get(), ps); } return result; }
void doSave(com.googlesource.gerrit.plugins.reviewers.client.Action action, com.googlesource.gerrit.plugins.reviewers.client.ReviewersScreen.ReviewerEntry entry) { com.googlesource.gerrit.plugins.reviewers.client.ChangeReviewersInput in = com.googlesource.gerrit.plugins.reviewers.client.ChangeReviewersInput.create(); in.setAction(action); in.setFilter(entry.filter); in.setReviewer(entry.reviewer); reset(); new com.google.gerrit.plugin.client.rpc.RestApi("projects").id(projectName).view("reviewers").put(in, new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gwt.core.client.JsArray<com.googlesource.gerrit.plugins.reviewers.client.ReviewerFilterSection>>() { @java.lang.Override public void onSuccess(com.google.gwt.core.client.JsArray<com.googlesource.gerrit.plugins.reviewers.client.ReviewerFilterSection> result) { display(result); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { } }); }
@org.junit.Test public void indexingUpdatesTheIndex() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Account.Id accountId = createAccount("foo"); java.lang.String preferredEmail = "foo@example.com"; updateAccountWithoutCacheOrIndex(accountId, com.google.gerrit.acceptance.api.accounts.AccountIndexerIT.newAccountUpdate().setPreferredEmail(preferredEmail).build()); assertThat(accountQueryProvider.get().byPreferredEmail(preferredEmail)).isEmpty(); accountIndexer.index(accountId); java.util.List<com.google.gerrit.server.account.AccountState> matchedAccountStates = accountQueryProvider.get().byPreferredEmail(preferredEmail); assertThat(matchedAccountStates).hasSize(1); assertThat(matchedAccountStates.get(0).getAccount().getId()).isEqualTo(accountId); }
public <T> T execute(com.google.gerrit.server.update.RetryHelper.ActionType actionType, com.google.gerrit.server.update.RetryHelper.Action<T> action, com.google.gerrit.server.update.RetryHelper.Options opts, com.google.common.base.Predicate<java.lang.Throwable> exceptionPredicate) throws java.lang.Exception { try { return executeWithAttemptAndTimeoutCount(actionType, action, opts, exceptionPredicate); } catch (java.lang.Throwable t) { com.google.common.base.Throwables.throwIfUnchecked(t); com.google.common.base.Throwables.throwIfInstanceOf(t, java.lang.Exception.class); throw new java.lang.IllegalStateException(t); } }
public java.lang.String myUrl() { return myUrl; }
private void loadConfigInfo(final com.google.gerrit.client.changes.ChangeInfo info, final java.lang.String base) { info.revisions().copyKeysIntoChildren("name"); final com.google.gerrit.client.changes.ChangeInfo.RevisionInfo rev = resolveRevisionToDisplay(info); com.google.gerrit.client.rpc.CallbackGroup group = new com.google.gerrit.client.rpc.CallbackGroup(); loadDiff(info.revisions().get(base), rev, com.google.gerrit.client.change.ChangeScreen2.myLastReply(info), group); loadCommit(rev, group); if (loaded) { group.done(); return; } com.google.gerrit.client.changes.RevisionInfoCache.add(changeId, rev); com.google.gerrit.client.projects.ConfigInfoCache.add(info); com.google.gerrit.client.projects.ConfigInfoCache.get(info.project_name_key(), group.addFinal(new com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gerrit.client.projects.ConfigInfoCache.Entry>(this) { @java.lang.Override protected void preDisplay(com.google.gerrit.client.projects.ConfigInfoCache.Entry result) { loaded = true; commentLinkProcessor = result.getCommentLinkProcessor(); setTheme(result.getTheme()); renderChangeInfo(info); } })); }
public java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> validate(com.google.gerrit.server.events.CommitReceivedEvent receiveEvent) throws com.google.gerrit.server.git.validators.CommitValidationException { java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> messages = new java.util.LinkedList<>(); try { for (com.google.gerrit.server.git.validators.CommitValidationListener commitValidator : validators) { messages.addAll(commitValidator.onCommitReceived(receiveEvent)); } } catch (com.google.gerrit.server.git.validators.CommitValidationException e) { messages.addAll(e.getMessages()); throw new com.google.gerrit.server.git.validators.CommitValidationException(e.getMessage(), messages); } return messages; }
private void beforeTest(org.eclipse.jgit.lib.Config cfg) throws java.lang.Exception { server = com.google.gerrit.acceptance.GerritServer.start(cfg); server.getTestInjector().injectMembers(this); }
@java.lang.Override protected void configure() { cache(com.google.gerrit.server.account.AccountCacheImpl.BYID_NAME, Account.Id.class, com.google.gerrit.server.account.AccountState.class).loader(com.google.gerrit.server.account.AccountCacheImpl.ByIdLoader.class); cache(com.google.gerrit.server.account.AccountCacheImpl.BYUSER_NAME, java.lang.String.class, new com.google.inject.TypeLiteral<java.util.Optional<com.google.gerrit.reviewdb.client.Account.Id>>() {}).loader((useReviewdb ? com.google.gerrit.server.account.AccountCacheImpl.ByNameReviewDbLoader.class : com.google.gerrit.server.account.AccountCacheImpl.ByNameLoader.class)); bind(com.google.gerrit.server.account.AccountCacheImpl.class); bind(com.google.gerrit.server.account.AccountCache.class).to(com.google.gerrit.server.account.AccountCacheImpl.class); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<?> apply(com.google.gerrit.server.change.ChangeResource rsrc, com.google.gerrit.server.change.RebaseChangeEdit.Rebase.Input in) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.server.project.InvalidChangeOperationException, com.google.gwtorm.server.OrmException, java.io.IOException { com.google.common.base.Optional<com.google.gerrit.server.edit.ChangeEdit> edit = editUtil.byChange(rsrc.getChange()); if (!(edit.isPresent())) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException(java.lang.String.format("no edit exists for change %s", rsrc.getChange().getChangeId())); } com.google.gerrit.reviewdb.client.PatchSet current = psUtil.current(db.get(), rsrc.getNotes()); if (current.getId().equals(edit.get().getBasePatchSet().getId())) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException(java.lang.String.format("edit for change %s is already on latest patch set: %s", rsrc.getChange().getChangeId(), current.getId())); } editModifier.rebaseEdit(edit.get(), current); return com.google.gerrit.extensions.restapi.Response.none(); }
private java.lang.Runnable maybeNextVimSearch(final net.codemirror.lib.CodeMirror cm) { return new java.lang.Runnable() { @java.lang.Override public void run() { if (cm.hasVimSearchHighlight()) { net.codemirror.lib.CodeMirror.handleVimKey(cm, "n"); } else { diffChunkNav(cm, Direction.NEXT).run(); } } }; }
java.lang.String globalMaxObjectSizeLimit(java.lang.String globalMaxObjectSizeLimit);
@java.lang.Override public void replace(com.google.gerrit.server.query.change.ChangeData cd) throws java.io.IOException { writer.updateDocument(intTerm(com.google.gerrit.lucene.FIELD_CHANGE, cd.getId().get()), toDocument(cd)); commit(); }
@java.lang.Override protected void doPost(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse rsp) throws java.io.IOException, javax.servlet.ServletException { rsp.setContentType("text/plain"); rsp.setCharacterEncoding(java.nio.charset.StandardCharsets.UTF_8.name()); java.lang.String path = req.getPathInfo(); java.lang.String accountGroupId = path.substring(((path.lastIndexOf('/')) + 1)); com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid = AccountGroup.UUID.parse(accountGroupId); try { com.ericsson.gerrit.plugins.highavailability.forwarder.Context.setForwardedEvent(true); index(uuid); rsp.setStatus(com.ericsson.gerrit.plugins.highavailability.forwarder.rest.SC_NO_CONTENT); } catch (java.io.IOException e) { com.ericsson.gerrit.plugins.highavailability.forwarder.rest.IndexGroupRestApiServlet.sendError(rsp, com.ericsson.gerrit.plugins.highavailability.forwarder.rest.SC_CONFLICT, e.getMessage()); com.ericsson.gerrit.plugins.highavailability.forwarder.rest.IndexGroupRestApiServlet.logger.error("Unable to update account index", e); } finally { com.ericsson.gerrit.plugins.highavailability.forwarder.Context.unsetForwardedEvent(); } }
public com.google.gerrit.rules.PrologEnvironment newPrologEnvironment() throws com.googlecode.prolog_cafe.compiler.CompileException { if ((ruleLoader) != null) { return envFactory.create(ruleLoader); } com.google.gerrit.rules.PrologEnvironment env = envFactory.create(getClass().getClassLoader()); java.lang.String rules = getConfig().getPrologRules(); if (rules != null) { java.io.PushbackReader in = new java.io.PushbackReader(new java.io.StringReader(rules), com.googlecode.prolog_cafe.lang.Prolog.PUSHBACK_SIZE); com.googlecode.prolog_cafe.lang.JavaObjectTerm streamObject = new com.googlecode.prolog_cafe.lang.JavaObjectTerm(in); if (!(env.execute(Prolog.BUILTIN, "consult_stream", com.googlecode.prolog_cafe.lang.SymbolTerm.intern("rules.pl"), streamObject))) { throw new com.googlecode.prolog_cafe.compiler.CompileException(((("Cannot consult rules.pl " + (getProject().getName())) + " ") + (getConfig().getRevision()))); } } return env; }
void onDelete() { if ((popup) != null) { popup.hide(); return; } if ((deleteBox) == null) { deleteBox = new com.google.gerrit.client.change.DeleteFileBox(changeId, revision); } deleteBox.clearPath(); final com.google.gwtexpui.user.client.PluginSafePopupPanel p = new com.google.gwtexpui.user.client.PluginSafePopupPanel(true); p.setStyleName(style.replyBox()); p.addAutoHidePartner(deleteButton.getElement()); p.addCloseHandler(new com.google.gwt.event.logical.shared.CloseHandler<com.google.gwt.user.client.ui.PopupPanel>() { @java.lang.Override public void onClose(com.google.gwt.event.logical.shared.CloseEvent<com.google.gwt.user.client.ui.PopupPanel> event) { if ((popup) == p) { popup = null; } } }); p.add(deleteBox); p.showRelativeTo(deleteButton); com.google.gwtexpui.globalkey.client.GlobalKey.dialog(p); deleteBox.setFocus(true); popup = p; }
@org.junit.Test public void simpleInlineComments() { com.google.gerrit.server.mail.receive.MailMessage.Builder b = newMailMessageBuilder(); b.htmlContent(newHtmlBody("Looks good to me", "I have a comment on this.", null, "Also have a comment here.", null, null, null)); java.util.List<com.google.gerrit.reviewdb.client.Comment> comments = defaultComments(); java.util.List<com.google.gerrit.server.mail.receive.MailComment> parsedComments = com.google.gerrit.server.mail.receive.HtmlParser.parse(b.build(), comments, changeURL); assertThat(parsedComments).hasSize(3); assertChangeMessage("Looks good to me", parsedComments.get(0)); assertInlineComment("I have a comment on this.", parsedComments.get(1), comments.get(1)); assertInlineComment("Also have a comment here.", parsedComments.get(2), comments.get(3)); }
@com.google.common.annotations.VisibleForTesting public void start() throws java.io.IOException { if ((dbInjector) == null) { dbInjector = createDbInjector(true, com.google.gerrit.pgm.MULTI_USER); } cfgInjector = createCfgInjector(); config = cfgInjector.getInstance(com.google.inject.Key.get(org.eclipse.jgit.lib.Config.class, com.google.gerrit.server.config.GerritServerConfig.class)); if (!(slave)) { initIndexType(); } sysInjector = createSysInjector(); sysInjector.getInstance(com.google.gerrit.server.plugins.PluginGuiceEnvironment.class).setDbCfgInjector(dbInjector, cfgInjector); manager.add(dbInjector, cfgInjector, sysInjector); if (!(consoleLog)) { manager.add(com.google.gerrit.pgm.util.ErrorLogFile.start(getSitePath(), config)); } sshd &= !(sshdOff()); if (sshd) { initSshd(); } if (com.google.common.base.MoreObjects.firstNonNull(httpd, true)) { initHttpd(); } manager.start(); }
private java.util.Map<com.google.gerrit.reviewdb.client.Change.Id, com.google.gerrit.reviewdb.client.Branch.NameKey> visibleChangesByScan() { com.google.gerrit.reviewdb.client.Project.NameKey project = projectCtl.getProject().getNameKey(); try { java.util.Map<com.google.gerrit.reviewdb.client.Change.Id, com.google.gerrit.reviewdb.client.Branch.NameKey> visibleChanges = new java.util.HashMap<>(); for (com.google.gerrit.server.notedb.ChangeNotes.Factory.ChangeNotesResult r : ((java.lang.Iterable<com.google.gerrit.server.notedb.ChangeNotes.Factory.ChangeNotesResult>) (changeNotesFactory.scan(git, db.get(), project)::iterator))) { if (r.error().isPresent()) { throw new com.google.gwtorm.server.OrmException(r.error().get()); } com.google.gerrit.server.notedb.ChangeNotes cn = r.notes(); if (permissionBackend.user(user).change(cn).database(db).test(ChangePermission.READ)) { visibleChanges.put(cn.getChangeId(), cn.getChange().getDest()); } } return visibleChanges; } catch (java.io.IOException | com.google.gwtorm.server.OrmException | com.google.gerrit.server.permissions.PermissionBackendException e) { com.google.gerrit.server.git.VisibleRefFilter.log.error((("Cannot load changes for project " + project) + ", assuming no changes are visible"), e); return java.util.Collections.emptyMap(); } }
@java.lang.Override public boolean isEmpty() { return (((((((((((((((((((((((commitSubject) == null) && (approvals.isEmpty())) && ((changeMessage) == null)) && (comments.isEmpty())) && (reviewers.isEmpty())) && (reviewersByEmail.isEmpty())) && ((changeId) == null)) && ((branch) == null)) && ((status) == null)) && ((submissionId) == null)) && ((submitRecords) == null)) && ((assignee) == null)) && ((hashtags) == null)) && ((topic) == null)) && ((commit) == null)) && ((psState) == null)) && ((groups) == null)) && ((tag) == null)) && ((psDescription) == null)) && (!(currentPatchSet))) && ((readOnlyUntil) == null)) && ((isPrivate) == null)) && ((workInProgress) == null); }
@org.junit.Test public void noRescheduleOnSuccess() throws java.io.IOException { when(session.post(eq(remote), eq(content))).thenReturn(com.googlesource.gerrit.plugins.webhooks.PostTaskTest.OK_RESULT); task.run(); verifyZeroInteractions(executor); }
static com.google.gerrit.server.notedb.RevisionNoteMap<com.google.gerrit.server.notedb.ChangeRevisionNote> parse(com.google.gerrit.server.notedb.ChangeNoteUtil noteUtil, com.google.gerrit.reviewdb.client.Change.Id changeId, org.eclipse.jgit.lib.ObjectReader reader, org.eclipse.jgit.notes.NoteMap noteMap, com.google.gerrit.reviewdb.client.PatchLineComment.Status status) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { java.util.Map<com.google.gerrit.reviewdb.client.RevId, com.google.gerrit.server.notedb.ChangeRevisionNote> result = new java.util.HashMap<>(); for (org.eclipse.jgit.notes.Note note : noteMap) { com.google.gerrit.server.notedb.ChangeRevisionNote rn = new com.google.gerrit.server.notedb.ChangeRevisionNote(noteUtil, changeId, reader, note.getData(), status); rn.parse(); result.put(new com.google.gerrit.reviewdb.client.RevId(note.name()), rn); } return new com.google.gerrit.server.notedb.RevisionNoteMap(noteMap, com.google.common.collect.ImmutableMap.copyOf(result)); }
java.util.Optional<com.googlesource.gerrit.plugins.lfs.locks.LfsLock> getLock(java.lang.String lockId) { return java.util.Optional.ofNullable(locks.getIfPresent(lockId)); }
public java.lang.String getContentType(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String revstr, java.lang.String path) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, java.io.IOException { org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(project); try { org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo); org.eclipse.jgit.lib.ObjectReader reader = repo.newObjectReader(); try { org.eclipse.jgit.revwalk.RevCommit commit = rw.parseCommit(repo.resolve(revstr)); org.eclipse.jgit.treewalk.TreeWalk tw = org.eclipse.jgit.treewalk.TreeWalk.forPath(rw.getObjectReader(), path, commit.getTree().getId()); if (tw == null) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } org.eclipse.jgit.lib.ObjectLoader blobLoader = reader.open(tw.getObjectId(0), com.google.gerrit.server.change.OBJ_BLOB); byte[] raw = (blobLoader.isLarge()) ? null : blobLoader.getCachedBytes(); return registry.getMimeType(path, raw).toString(); } finally { reader.release(); rw.release(); } } finally { repo.close(); } }
@org.junit.Test public void addOtherUsersGpgKey_Conflict() throws java.lang.Exception { addExternalIdEmail(admin, "test5@example.com"); externalIdsUpdate.insert(db, com.google.gerrit.server.account.ExternalId.create("foo", "myId", user.getId())); com.google.gerrit.gpg.testutil.TestKey key = validKeyWithSecondUserId(); addGpgKey(key.getPublicKeyArmored()); setApiUser(user); exception.expect(com.google.gerrit.extensions.restapi.ResourceConflictException.class); exception.expectMessage("GPG key already associated with another account"); addGpgKey(key.getPublicKeyArmored()); }
@org.junit.Test(expected = com.ericsson.gerrit.plugins.eventslog.ServiceUnavailableException.class) public void throwSQLExceptionIfNotOnline() throws java.lang.Exception { com.ericsson.gerrit.plugins.eventslog.SQLStoreTest.MockEvent mockEvent = new com.ericsson.gerrit.plugins.eventslog.SQLStoreTest.MockEvent(); setUpClientMock(); eventsDb.createDBIfNotCreated(); expectLastCall().andThrow(new java.sql.SQLException(new java.net.ConnectException())).once(); eventsDb.queryOne(); expectLastCall().andThrow(new java.sql.SQLException()); easyMock.replayAll(); store = new com.ericsson.gerrit.plugins.eventslog.SQLStore(pcFactoryMock, userProviderMock, cfgMock, eventsDb, localEventsDb, poolMock); store.start(); store.storeEvent(mockEvent); store.queryChangeEvents(com.ericsson.gerrit.plugins.eventslog.SQLStoreTest.GENERIC_QUERY); easyMock.verifyAll(); }
public abstract int getEndB();
public void onSuccess(final com.google.gerrit.common.auth.userpass.LoginResult result) { if (result.success) { java.lang.String to = token; if (!(to.startsWith("/"))) { to = "/" + to; } if ((result.isNew) && (!(token.startsWith(((com.google.gerrit.common.PageLinks.REGISTER) + "/"))))) { to = (com.google.gerrit.common.PageLinks.REGISTER) + to; } com.google.gwt.user.client.Window.Location.replace((((com.google.gwt.user.client.Window.Location.getPath()) + "login") + to)); } else { final java.lang.String message; switch (result.getError()) { case AUTHENTICATION_UNAVAILABLE : message = Util.M.authenticationUnavailable(result.getAuthType()); break; case INVALID_LOGIN : default : message = Util.C.invalidLogin(); } showError(message); enable(true); password.selectAll(); com.google.gwt.core.client.Scheduler.get().scheduleDeferred(new com.google.gwt.core.client.Scheduler.ScheduledCommand() { @java.lang.Override public void execute() { password.setFocus(true); } }); } }
@java.lang.Override protected void configureServlets() { install(new com.google.gerrit.server.config.FactoryModule() { @java.lang.Override protected void configure() { factory(EditCommitMessageHandler.Factory.class); factory(RestoreChangeHandler.Factory.class); factory(RevertChange.Factory.class); factory(RebaseChangeHandler.Factory.class); factory(ChangeDetailFactory.Factory.class); factory(IncludedInDetailFactory.Factory.class); factory(PatchSetDetailFactory.Factory.class); factory(PatchSetPublishDetailFactory.Factory.class); factory(SubmitAction.Factory.class); factory(PublishAction.Factory.class); factory(DeleteDraftChange.Factory.class); } }); rpc(com.google.gerrit.httpd.rpc.changedetail.ChangeDetailServiceImpl.class); rpc(com.google.gerrit.httpd.rpc.changedetail.ChangeManageServiceImpl.class); }
public static java.lang.Module module() { return new com.google.gerrit.server.cache.CacheModule() { @java.lang.Override protected void configure() { cache(com.google.gerrit.server.account.ExternalIdCacheImpl.CACHE_NAME, com.google.gerrit.server.account.ExternalIdCacheImpl.AllKey.class, new com.google.inject.TypeLiteral<com.google.common.collect.ImmutableSetMultimap<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.reviewdb.client.AccountExternalId>>() {}).maximumWeight(1).loader(com.google.gerrit.server.account.ExternalIdCacheImpl.Loader.class); bind(com.google.gerrit.server.account.ExternalIdCacheImpl.class); bind(com.google.gerrit.server.account.ExternalIdCache.class).to(com.google.gerrit.server.account.ExternalIdCacheImpl.class); } }; }
@org.junit.Test public void repeatedHashtag() throws java.lang.Exception { java.lang.String commitMessage = "#Subject\n\n#Hashtag1\n\n#Hashtag2\n\n#Hashtag1"; assertThat(com.google.gerrit.server.change.HashtagsUtil.extractTags(commitMessage)).containsExactlyElementsIn(com.google.common.collect.Sets.newHashSet("Subject", "Hashtag1", "Hashtag2")); }
public static com.google.gerrit.server.group.db.GroupConfig loadForGroupSnapshot(org.eclipse.jgit.lib.Repository repository, com.google.gerrit.reviewdb.client.AccountGroup.UUID groupUuid, org.eclipse.jgit.lib.ObjectId commitId) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { com.google.gerrit.server.group.db.GroupConfig groupConfig = new com.google.gerrit.server.group.db.GroupConfig(groupUuid); groupConfig.load(repository, commitId); return groupConfig; }
@java.lang.SuppressWarnings("unchecked") private static <K, V> com.google.common.cache.CacheBuilder<K, V> newCacheBuilder() { return ((com.google.common.cache.CacheBuilder<K, V>) (com.google.common.cache.CacheBuilder.newBuilder())); }
public static void main(java.lang.String[] argv) throws com.googlecode.prolog_cafe.exceptions.CompileException, java.io.IOException { int i = 0; BuckPrologCompiler.tmpdir = new File(argv[(i++)]); File out = new File(argv[(i++)]); File java = BuckPrologCompiler.tmpdir("java"); for (; i < (argv.length); i++) { new java.lang.Compiler().prologToJavaSource(argv[i], java.getPath()); } BuckPrologCompiler.jar(out, java); }
public void setDownloadSchemes(final java.util.Set<com.google.gerrit.reviewdb.AccountGeneralPreferences.DownloadScheme> s) { downloadSchemes = s; }
private void writeEvents() { int processed = 0; while (processed < (com.google.gerrit.sshd.commands.StreamEvents.BATCH_SIZE)) { if ((java.lang.Thread.interrupted()) || (stdout.checkError())) { source.removeEventListener(listener); flush(); onExit(0); return; } if (dropped) { write(com.google.gerrit.sshd.commands.StreamEvents.droppedOutputEvent); dropped = false; } final com.google.gerrit.server.events.Event event = poll(); if (event == null) { break; } write(event); processed++; } flush(); if ((com.google.gerrit.sshd.commands.StreamEvents.BATCH_SIZE) <= processed) { synchronized(taskLock) { task = pool.submit(writer); } } }
@java.lang.Override public com.google.gerrit.server.change.ChangeResource parse(com.google.gerrit.extensions.restapi.TopLevelResource root, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gerrit.server.permissions.PermissionBackendException, com.google.gwtorm.server.OrmException { java.util.List<com.google.gerrit.server.project.ChangeControl> ctls = changeFinder.find(id.encoded(), user.get()); if (ctls.isEmpty()) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } else if ((ctls.size()) != 1) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(("Multiple changes found for " + id)); } com.google.gerrit.server.project.ChangeControl ctl = ctls.get(0); if (!(canRead(ctl))) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } return changeResourceFactory.create(ctl); }
private static com.google.gerrit.sshd.commands.UnloggedFailure error(java.lang.String msg) { return new com.google.gerrit.sshd.commands.UnloggedFailure(1, msg); }
private static java.lang.Iterable<byte[]> storedSubmitRecords(com.google.gerrit.server.query.change.ChangeData cd, com.google.gerrit.server.project.SubmitRuleOptions opts) throws com.google.gwtorm.server.OrmException { return com.google.gerrit.server.index.change.ChangeField.storedSubmitRecords(cd.submitRecords(opts)); }
private void submit(com.google.gerrit.server.project.ChangeControl changeCtl, com.google.gerrit.reviewdb.client.PatchSet ps) throws com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.server.change.Submit submit = submitProvider.get(); com.google.gerrit.server.change.RevisionResource rsrc = new com.google.gerrit.server.change.RevisionResource(changes.parse(changeCtl), ps); java.util.List<com.google.gerrit.reviewdb.client.Change> changes; try { changes = submit.submit(rsrc, currentUser, true); } catch (com.google.gerrit.extensions.restapi.ResourceConflictException e) { throw new java.io.IOException(e); } addMessage(""); for (com.google.gerrit.reviewdb.client.Change c : changes) { try { mergeFactory.create(c.getDest()).merge(); } catch (com.google.gerrit.server.git.MergeException | com.google.gerrit.server.project.NoSuchChangeException e) { throw new com.google.gwtorm.server.OrmException(e); } c = db.changes().get(c.getId()); switch (c.getStatus()) { case SUBMITTED : addMessage((("Change " + (c.getChangeId())) + " submitted.")); break; case MERGED : addMessage((("Change " + (c.getChangeId())) + " merged.")); break; case NEW : com.google.gerrit.reviewdb.client.ChangeMessage msg = submit.getConflictMessage(rsrc); if (msg != null) { addMessage(((("Change " + (c.getChangeId())) + ": ") + (msg.getMessage()))); break; } default : addMessage(((("change " + (c.getChangeId())) + " is ") + (c.getStatus().name().toLowerCase()))); } } }
@com.google.gwt.uibinder.client.UiHandler("save") void onSave(com.google.gwt.event.dom.client.ClickEvent e) { com.google.gerrit.client.changes.ChangeApi.message(changeId.get(), revision, message.getText().trim(), new com.google.gerrit.client.rpc.GerritCallback<com.google.gwt.core.client.JavaScriptObject>() { @java.lang.Override public void onSuccess(com.google.gwt.core.client.JavaScriptObject msg) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange2(changeId)); hide(); } }); }
public void abandonInactiveOpenChanges() { if ((cfg.getAbandonAfter()) <= 0) { return; } try { java.lang.String query = ("status:new age:" + (java.util.concurrent.TimeUnit.MILLISECONDS.toMinutes(cfg.getAbandonAfter()))) + "m"; if (!(cfg.getAbandonIfMergeable())) { query += " -is:mergeable"; } java.util.List<com.google.gerrit.server.query.change.ChangeData> changesToAbandon = queryProcessor.enforceVisibility(false).queryChanges(queryBuilder.parse(query)).changes(); int count = 0; for (com.google.gerrit.server.query.change.ChangeData cd : changesToAbandon) { try { if (noNeedToAbandon(cd, query)) { com.google.gerrit.server.change.AbandonUtil.log.debug(("Change data \"{}\" does not satisfy the query \"{}\" any" + " more, hence skipping it in clean up"), cd, query); continue; } abandon.abandon(changeControl(cd), cfg.getAbandonMessage(), null); count++; } catch (com.google.gerrit.extensions.restapi.ResourceConflictException e) { } catch (java.lang.Throwable e) { com.google.gerrit.server.change.AbandonUtil.log.error(java.lang.String.format("Failed to auto-abandon inactive open change %d.", cd.getId().get()), e); } } com.google.gerrit.server.change.AbandonUtil.log.info(java.lang.String.format("Auto-Abandoned %d of %d changes.", count, changesToAbandon.size())); } catch (com.google.gerrit.server.query.QueryParseException | com.google.gwtorm.server.OrmException e) { com.google.gerrit.server.change.AbandonUtil.log.error("Failed to query inactive open changes for auto-abandoning.", e); } }
private boolean inProject(com.google.gerrit.reviewdb.Change change) { if ((projectControl) != null) { return projectControl.getProject().getNameKey().equals(change.getProject()); } else { return true; } }
public static com.google.gerrit.reviewdb.client.ChangeMessage newMessage(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.reviewdb.client.PatchSet.Id psId, com.google.gerrit.server.CurrentUser user, java.sql.Timestamp when, java.lang.String body, @com.google.gerrit.common.Nullable java.lang.String tag) throws com.google.gwtorm.server.OrmException { checkNotNull(psId); com.google.gerrit.reviewdb.client.Account.Id accountId = (user.isInternalUser()) ? null : user.getAccountId(); com.google.gerrit.reviewdb.client.ChangeMessage m = new com.google.gerrit.reviewdb.client.ChangeMessage(new com.google.gerrit.reviewdb.client.ChangeMessage.Key(psId.getParentKey(), com.google.gerrit.server.ChangeUtil.messageUUID(db)), accountId, when, psId); m.setMessage(body); m.setTag(tag); user.updateRealAccountId(m::setRealAuthor); return m; }
public static GeneralPreferencesInfo loadFromAllUsers(GeneralPreferencesInfo r, com.google.gerrit.server.account.VersionedAccountPreferences v, org.eclipse.jgit.lib.Repository allUsers) { r.my = com.google.gerrit.server.account.GetPreferences.my(v); if ((r.my.isEmpty()) && (!(v.isDefaults()))) { try { com.google.gerrit.server.account.VersionedAccountPreferences d = com.google.gerrit.server.account.VersionedAccountPreferences.forDefault(); d.load(allUsers); r.my = com.google.gerrit.server.account.GetPreferences.my(d); } catch (org.eclipse.jgit.errors.ConfigInvalidException | java.io.IOException e) { com.google.gerrit.server.account.GetPreferences.log.warn("cannot read default preferences", e); } } if (r.my.isEmpty()) { r.my.add(new com.google.gerrit.extensions.client.MenuItem("Changes", "#/dashboard/self", null)); r.my.add(new com.google.gerrit.extensions.client.MenuItem("Drafts", "#/q/owner:self+is:draft", null)); r.my.add(new com.google.gerrit.extensions.client.MenuItem("Draft Comments", "#/q/has:draft", null)); r.my.add(new com.google.gerrit.extensions.client.MenuItem("Edits", "#/q/has:edit", null)); r.my.add(new com.google.gerrit.extensions.client.MenuItem("Watched Changes", "#/q/is:watched+is:open", null)); r.my.add(new com.google.gerrit.extensions.client.MenuItem("Starred Changes", "#/q/is:starred", null)); r.my.add(new com.google.gerrit.extensions.client.MenuItem("Groups", "#/groups/self", null)); } r.urlAliases = com.google.gerrit.server.account.GetPreferences.urlAliases(v); return r; }
private com.google.gerrit.common.data.PermissionRule rule(com.google.gerrit.server.git.ProjectConfig config, com.google.gerrit.reviewdb.AccountGroup group) { return new com.google.gerrit.common.data.PermissionRule(config.resolve(group)); }
static final void post(com.google.gerrit.client.rpc.RestApi api, com.google.gwt.core.client.JavaScriptObject in, com.google.gwt.core.client.JavaScriptObject cb) { api.post(in, com.google.gerrit.client.api.ActionContext.wrap(cb)); }
public com.google.gerrit.server.diff.IntraLineDiff.Status getStatus() { return status; }
@java.lang.Override protected void onLoad() { super.onLoad(); com.google.gerrit.client.account.AccountApi.getAgreements("self", new com.google.gerrit.client.rpc.GerritCallback<com.google.gwt.core.client.JsArray<com.google.gerrit.client.info.AgreementInfo>>() { @java.lang.Override public void onSuccess(com.google.gwt.core.client.JsArray<com.google.gerrit.client.info.AgreementInfo> result) { if (isAttached()) { mySigned = new java.util.HashSet<>(); for (com.google.gerrit.client.info.AgreementInfo info : com.google.gerrit.client.rpc.Natives.asList(result)) { mySigned.add(info.name()); } postRPC(); } } }); available = com.google.gerrit.client.Gerrit.info().auth().contributorAgreements(); postRPC(); }
@java.lang.Override public com.google.gerrit.server.change.Description getDescription(com.google.gerrit.server.change.ChangeResource rsrc) { return new com.google.gerrit.extensions.webui.UiAction.Description().setLabel("Mark Reviewed").setTitle("Mark the change as reviewed to unhighlight it in the dashboard").setVisible((!(isReviewed(rsrc)))); }
public java.util.Collection<com.google.gerrit.reviewdb.client.SubmoduleSubscription> superProjectSubscriptionsForSubmoduleBranch(com.google.gerrit.reviewdb.client.Branch.NameKey branch, com.google.gerrit.server.git.MergeOpRepoManager orm) throws java.io.IOException { logDebug(("Calculating possible superprojects for " + branch)); java.util.Collection<com.google.gerrit.reviewdb.client.SubmoduleSubscription> ret = new java.util.ArrayList<>(); com.google.gerrit.reviewdb.client.Project.NameKey project = branch.getParentKey(); com.google.gerrit.server.git.ProjectConfig cfg = projectCache.get(project).getConfig(); for (com.google.gerrit.common.data.SubscribeSection s : projectStateFactory.create(cfg).getSubscribeSections(branch)) { logDebug(("Checking subscribe section " + s)); java.util.Collection<com.google.gerrit.reviewdb.client.Branch.NameKey> branches = getDestinationBranches(branch, s, orm); for (com.google.gerrit.reviewdb.client.Branch.NameKey targetBranch : branches) { com.google.gerrit.server.git.GitModules m = gitmodulesFactory.create(targetBranch, updateId, orm); m.load(); for (com.google.gerrit.reviewdb.client.SubmoduleSubscription ss : m.subscribedTo(branch)) { logDebug(("Checking SubmoduleSubscription " + ss)); if ((projectCache.get(ss.getSubmodule().getParentKey())) != null) { logDebug(("Adding SubmoduleSubscription " + ss)); ret.add(ss); } } } } logDebug(((("Calculated superprojects for " + branch) + " are ") + ret)); return ret; }
@com.google.common.annotations.VisibleForTesting protected static java.lang.String getShortProjectName(java.lang.String projectName) { int lastIndexSlash = projectName.lastIndexOf("/"); if (lastIndexSlash == 0) { return projectName.substring(1); } return "..." + (projectName.substring((lastIndexSlash + 1))); }
public void start(com.google.gerrit.server.plugins.PluginGuiceEnvironment env) throws java.lang.Exception { com.google.inject.Injector root = newRootInjector(env); manager = new com.google.gerrit.lifecycle.LifecycleManager(); if ((sysModule) != null) { sysInjector = root.createChildInjector(root.getInstance(sysModule)); manager.add(sysInjector); } else { sysInjector = root; } if (((sshModule) != null) && (env.hasSshModule())) { sshInjector = sysInjector.createChildInjector(env.getSshModule(), sysInjector.getInstance(sshModule)); manager.add(sshInjector); } manager.start(); env.onStartPlugin(this); }
@java.lang.Override public void postUpdate(com.google.gerrit.server.git.BatchUpdate.Context ctx) throws com.google.gwtorm.server.OrmException { if (sendMail) { try { com.google.gerrit.server.mail.ReplacePatchSetSender cm = replacePatchSetFactory.create(ctx.getProject(), change.getId()); cm.setFrom(ctx.getUser().getAccountId()); cm.setPatchSet(patchSet, patchSetInfo); cm.setChangeMessage(changeMessage); cm.addReviewers(oldReviewers.byState(com.google.gerrit.server.change.REVIEWER)); cm.addExtraCC(oldReviewers.byState(com.google.gerrit.server.change.CC)); cm.send(); } catch (java.lang.Exception err) { com.google.gerrit.server.change.PatchSetInserter.log.error(("Cannot send email for new patch set on change " + (change.getId())), err); } } if (runHooks) { revisionCreated.fire(change, patchSet, ctx.getUser().getAccountId()); } }
@org.junit.Test public void addReviewerToReviewableChangeInNoteDbNotifyOwnerReviewers() throws java.lang.Exception { assume().that(notesMigration.readChanges()).isTrue(); forAll(( adder) -> { com.google.gerrit.acceptance.server.mail.StagedChange sc = stageReviewableChange(); com.google.gerrit.acceptance.TestAccount reviewer = accountCreator.create("added", "added@example.com", "added"); addReviewer(adder, sc.changeId, sc.owner, reviewer.email, com.google.gerrit.acceptance.server.mail.OWNER_REVIEWERS); assertThat(sender).sent("newchange", sc).to(reviewer).cc(sc.reviewer).cc(sc.reviewerByEmail, sc.ccerByEmail).noOneElse(); }); }
private <T extends com.google.gerrit.extensions.api.changes.ReviewInput.CommentInput> void checkComments(com.google.gerrit.server.change.RevisionResource revision, java.util.Map<java.lang.String, java.util.List<T>> commentsPerPath) throws com.google.gerrit.extensions.restapi.BadRequestException, com.google.gwtorm.server.OrmException { java.util.Set<java.lang.String> revisionFilePaths = getAffectedFilePaths(revision); for (java.util.Map.Entry<java.lang.String, java.util.List<T>> entry : commentsPerPath.entrySet()) { java.lang.String path = entry.getKey(); com.google.gerrit.reviewdb.client.PatchSet.Id patchSetId = revision.getChange().currentPatchSetId(); ensurePathRefersToAvailableOrMagicFile(path, revisionFilePaths, patchSetId); java.util.List<T> comments = entry.getValue(); for (T comment : comments) { ensureLineIsNonNegative(comment.line, path); ensureCommentNotOnMagicFilesOfAutoMerge(path, comment); ensureRangeIsValid(path, comment.range); } } }
@org.junit.Test public void testGroupOptions() throws java.io.IOException { com.google.gerrit.reviewdb.client.AccountGroup.NameKey adminGroupName = new com.google.gerrit.reviewdb.client.AccountGroup.NameKey("Administrators"); com.google.gerrit.reviewdb.client.AccountGroup adminGroup = groupCache.get(adminGroupName); java.lang.String url = ("/groups/" + (adminGroup.getGroupUUID().get())) + "/options"; com.google.gerrit.acceptance.RestResponse r = session.get(url); com.google.gerrit.server.group.GroupOptionsInfo options = newGson().fromJson(r.getReader(), com.google.gerrit.server.group.GroupOptionsInfo.class); assertEquals(HttpStatus.SC_OK, r.getStatusCode()); assertEquals(adminGroup.isVisibleToAll(), com.google.gerrit.acceptance.rest.group.GroupAssert.toBoolean(options.visibleToAll)); r.consume(); com.google.gerrit.server.group.PutOptions.Input in = new com.google.gerrit.server.group.PutOptions.Input(); in.visibleToAll = !(adminGroup.isVisibleToAll()); r = session.put(url, in); com.google.gerrit.server.group.GroupOptionsInfo newOptions = newGson().fromJson(r.getReader(), com.google.gerrit.server.group.GroupOptionsInfo.class); assertEquals(HttpStatus.SC_OK, r.getStatusCode()); assertEquals(in.visibleToAll, com.google.gerrit.acceptance.rest.group.GroupAssert.toBoolean(newOptions.visibleToAll)); adminGroup = groupCache.get(adminGroupName); assertEquals(in.visibleToAll, adminGroup.isVisibleToAll()); r.consume(); }
private Change.Id insertPatchSet(org.eclipse.jgit.lib.Repository git, org.eclipse.jgit.revwalk.RevWalk revWalk, com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.PatchSet.Id patchSetId, org.eclipse.jgit.revwalk.RevCommit cherryPickCommit, com.google.gerrit.server.project.RefControl refControl) throws com.google.gerrit.server.project.InvalidChangeOperationException, com.google.gerrit.server.project.NoSuchChangeException, com.google.gwtorm.server.OrmException, java.io.IOException { patchSetInserterFactory.create(git, revWalk, refControl, change, cherryPickCommit).setMessage(buildChangeMessage(patchSetId, change)).insert(); return change.getId(); }
@java.lang.Override public void onFocus(com.google.gwt.event.dom.client.FocusEvent event) { focusHint(); prevText = getText(); isFocused = true; }
private void addReviewerToReviewableChangeInNoteDbByOwnerCcingSelfNotifyOwner(com.google.gerrit.acceptance.server.mail.AddReviewerSenderIT.Adder adder) throws java.lang.Exception { assume().that(notesMigration.readChanges()).isTrue(); com.google.gerrit.acceptance.server.mail.StagedChange sc = stageReviewableChange(); com.google.gerrit.acceptance.TestAccount reviewer = accountCreator.create("added", "added@example.com", "added"); addReviewer(adder, sc.changeId, sc.owner, reviewer.email, com.google.gerrit.acceptance.server.mail.CC_ON_OWN_COMMENTS, com.google.gerrit.acceptance.server.mail.OWNER); assertThat(sender).notSent(); }
private com.google.gerrit.client.diff.PaddingManager.LineWidgetElementPair addPaddingWidget(net.codemirror.lib.CodeMirror cm, java.lang.String style, int line, int height, com.google.gwt.dom.client.Style.Unit unit, java.lang.Integer index) { com.google.gwt.dom.client.Element div = com.google.gwt.user.client.DOM.createDiv(); div.setClassName(style); div.getStyle().setHeight(height, unit); net.codemirror.lib.Configuration config = net.codemirror.lib.Configuration.create().set("coverGutter", true).set("above", (line == (-1))); if (index != null) { config = config.set("insertAt", index); } net.codemirror.lib.LineWidget widget = cm.addLineWidget((line == (-1) ? 0 : line), div, config); return new com.google.gerrit.client.diff.PaddingManager.LineWidgetElementPair(widget, div); }
private boolean isMergeable(com.google.gerrit.reviewdb.Change c) throws com.google.gwtorm.client.OrmException { final com.google.gerrit.server.git.CodeReviewCommit commit = commits.get(c.getId()); final com.google.gerrit.server.git.CommitMergeStatus s = (commit != null) ? commit.statusCode : null; boolean isMergeable = false; if ((s != null) && (((s.equals(CommitMergeStatus.CLEAN_MERGE)) || (s.equals(CommitMergeStatus.CLEAN_PICK))) || (s.equals(CommitMergeStatus.ALREADY_MERGED)))) { isMergeable = true; } return isMergeable; }
@java.lang.Override public void deleteVote(java.lang.String label) throws com.google.gerrit.extensions.restapi.RestApiException { try { deleteVote.apply(new com.google.gerrit.server.change.VoteResource(reviewer, label), null); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot delete vote", e); } }
@java.lang.Override public void onSuccess(final com.google.gerrit.client.info.ChangeInfo info) { info.init(); addExtensionPoints(info, initCurrentRevision(info)); final com.google.gerrit.client.info.ChangeInfo.RevisionInfo rev = info.revision(revision); com.google.gerrit.client.rpc.CallbackGroup group = new com.google.gerrit.client.rpc.CallbackGroup(); loadCommit(rev, group); group.addListener(new com.google.gerrit.client.rpc.GerritCallback<java.lang.Void>() { @java.lang.Override public void onSuccess(java.lang.Void result) { if ((base.isBaseOrAutoMerge()) && (rev.isMerge())) { base = com.google.gerrit.client.DiffObject.parse(info.legacyId(), com.google.gerrit.client.Gerrit.getUserPreferences().defaultBaseForMerges().getBase()); } loadConfigInfo(info, base); com.google.gwt.core.client.JsArray<com.google.gerrit.client.info.ChangeInfo.MessageInfo> mAr = info.messages(); for (int i = 0; i < (mAr.length()); i++) { if ((mAr.get(i).tag()) != null) { hideTaggedComments.setVisible(true); break; } } } }); group.done(); }
@java.lang.Override protected void set(java.lang.String newValue) { filter = newValue; }
@java.lang.Override public com.google.gerrit.extensions.common.RobotCommentInfo apply(com.google.gerrit.server.change.RobotCommentResource rsrc) throws com.google.gwtorm.server.OrmException { return commentJson.get().newRobotCommentFormatter().format(rsrc.getComment()); }
public static void get(com.google.gerrit.reviewdb.client.PatchSet.Id id, java.lang.String path, boolean base, com.google.gerrit.client.rpc.HttpCallback<com.google.gerrit.client.rpc.NativeString> cb) { com.google.gerrit.client.rpc.RestApi api; if ((id.get()) != 0) { api = com.google.gerrit.client.changes.ChangeApi.revision(id).view("files").id(path).view("content"); } else if (Patch.COMMIT_MSG.equals(path)) { api = com.google.gerrit.client.changes.ChangeEditApi.editMessage(id.getParentKey().get()).addParameter("base", base); } else { api = com.google.gerrit.client.changes.ChangeEditApi.editFile(id.getParentKey().get(), path).addParameter("base", base); } api.get(cb); }
protected com.google.gerrit.server.notedb.ChangeNotes newNotes(com.google.gerrit.reviewdb.client.Change c) throws com.google.gwtorm.server.OrmException { return new com.google.gerrit.server.notedb.ChangeNotes(repoManager, com.google.gerrit.server.notedb.AbstractChangeNotesTest.MIGRATION, allUsers, c).load(); }
@java.lang.Override public void onTimeout(org.eclipse.jetty.continuation.Continuation self) { future.cancel(true); }
private void parse(org.eclipse.jgit.revwalk.RevCommit commit) throws org.eclipse.jgit.errors.ConfigInvalidException { createdOn = com.google.gerrit.server.notedb.ChangeNotesParser.getCommitTime(commit); if ((lastUpdatedOn) == null) { lastUpdatedOn = com.google.gerrit.server.notedb.ChangeNotesParser.getCommitTime(commit); } if ((status) == null) { status = parseStatus(commit); } com.google.gerrit.reviewdb.client.PatchSet.Id psId = parsePatchSetId(commit); com.google.gerrit.reviewdb.client.Account.Id accountId = parseIdent(commit); parseChangeMessage(psId, accountId, commit); if ((topic) == null) { topic = parseTopic(commit); } parseHashtags(commit); if (submitRecords.isEmpty()) { parseSubmitRecords(commit.getFooterLines(com.google.gerrit.server.notedb.ChangeNoteUtil.FOOTER_SUBMITTED_WITH)); } for (java.lang.String line : commit.getFooterLines(com.google.gerrit.server.notedb.ChangeNoteUtil.FOOTER_LABEL)) { parseApproval(psId, accountId, commit, line); } for (com.google.gerrit.server.notedb.ReviewerStateInternal state : com.google.gerrit.server.notedb.ReviewerStateInternal.values()) { for (java.lang.String line : commit.getFooterLines(state.getFooterKey())) { parseReviewer(state, line); } } }
@org.junit.Test public void reviewAndStartReview() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result r = createWorkInProgressChange(); r.assertOkStatus(); assertThat(r.getChange().change().isWorkInProgress()).isTrue(); com.google.gerrit.extensions.api.changes.ReviewInput in = com.google.gerrit.extensions.api.changes.ReviewInput.noScore().setWorkInProgress(false); gApi.changes().id(r.getChangeId()).revision("current").review(in); com.google.gerrit.extensions.common.ChangeInfo info = gApi.changes().id(r.getChangeId()).get(); assertThat(info.workInProgress).isNull(); }
private com.google.gerrit.server.diff.ComparisonType getComparisonType(org.eclipse.jgit.revwalk.RevObject a, org.eclipse.jgit.revwalk.RevCommit b) { for (int i = 0; i < (b.getParentCount()); i++) { if (b.getParent(i).equals(a)) { return com.google.gerrit.server.diff.ComparisonType.againstParent((i + 1)); } } if (((key.getOldId()) == null) && ((b.getParentCount()) > 0)) { return com.google.gerrit.server.diff.ComparisonType.againstAutoMerge(); } return com.google.gerrit.server.diff.ComparisonType.againstOtherPatchSet(); }
private java.util.Map<java.lang.String, java.lang.String> getSubmodules(com.googlesource.gerrit.plugins.repositoryuse.RefUpdate event, com.google.gerrit.reviewdb.client.Project.NameKey project) throws java.io.IOException, org.eclipse.jgit.errors.RepositoryNotFoundException { java.util.HashMap<java.lang.String, java.lang.String> submodules = new java.util.HashMap<>(); try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(project)) { try (org.eclipse.jgit.revwalk.RevWalk walk = new org.eclipse.jgit.revwalk.RevWalk(repo);org.eclipse.jgit.submodule.SubmoduleWalk sw = new org.eclipse.jgit.submodule.SubmoduleWalk(repo)) { org.eclipse.jgit.revwalk.RevCommit commit = walk.parseCommit(repo.resolve(event.getNewObjectId())); sw.setTree(commit.getTree()); sw.setRootTree(commit.getTree()); while (sw.next()) { submodules.put(normalizePath(event.getProjectName(), sw.getModulesUrl(), false), sw.getObjectId().name()); } } catch (org.eclipse.jgit.errors.ConfigInvalidException e) { com.googlesource.gerrit.plugins.repositoryuse.RefUpdateHandlerImpl.log.warn(("Invalid .gitmodules configuration while parsing " + (event.getProjectName()))); } } return submodules; }
public java.util.List<com.google.gerrit.server.project.ChangeControl> findChanges(com.google.gerrit.reviewdb.client.Change.Id id, com.google.gerrit.server.CurrentUser user) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.query.change.InternalChangeQuery query = queryProvider.get().setRequestedFields(com.google.common.collect.ImmutableSet.<java.lang.String>of()); return asChangeControls(query.byLegacyChangeId(id), user); }
private java.util.List<java.util.List<com.google.gerrit.extensions.common.ChangeInfo>> query() throws com.google.gerrit.server.query.QueryParseException, com.google.gwtorm.server.OrmException { if (imp.isDisabled()) { throw new com.google.gerrit.server.query.QueryParseException("query disabled"); } if (((queries) == null) || (queries.isEmpty())) { queries = java.util.Collections.singletonList("status:open"); } else if ((queries.size()) > 10) { throw new com.google.gerrit.server.query.QueryParseException("limit of 10 queries"); } int cnt = queries.size(); java.util.List<com.google.gerrit.server.query.QueryResult<com.google.gerrit.server.query.change.ChangeData>> results = imp.query(qb.parse(queries)); boolean requireLazyLoad = (com.google.gerrit.server.query.change.QueryChanges.containsAnyOf(options, com.google.common.collect.ImmutableSet.of(com.google.gerrit.server.query.change.DETAILED_LABELS, com.google.gerrit.server.query.change.LABELS))) && (!(qb.getArgs().getSchema().hasField(ChangeField.STORED_SUBMIT_RECORD_LENIENT))); com.google.gerrit.server.change.ChangeJson cjson = json.create(options); cjson.setPluginDefinedAttributesFactory(this.imp); java.util.List<java.util.List<com.google.gerrit.extensions.common.ChangeInfo>> res = cjson.lazyLoad((requireLazyLoad || (com.google.gerrit.server.query.change.QueryChanges.containsAnyOf(options, ChangeJson.REQUIRE_LAZY_LOAD)))).formatQueryResults(results); for (int n = 0; n < cnt; n++) { java.util.List<com.google.gerrit.extensions.common.ChangeInfo> info = res.get(n); if (results.get(n).more()) { info.get(((info.size()) - 1))._moreChanges = true; } } return res; }
private void assertEmptyCommit(java.lang.String projectName, java.lang.String... refs) throws java.io.IOException, org.eclipse.jgit.errors.RepositoryNotFoundException { com.google.gerrit.reviewdb.client.Project.NameKey projectKey = new com.google.gerrit.reviewdb.client.Project.NameKey(projectName); try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(projectKey);org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo);org.eclipse.jgit.treewalk.TreeWalk tw = new org.eclipse.jgit.treewalk.TreeWalk(rw.getObjectReader())) { for (java.lang.String ref : refs) { org.eclipse.jgit.revwalk.RevCommit commit = rw.lookupCommit(repo.getRef(ref).getObjectId()); rw.parseBody(commit); tw.addTree(commit.getTree()); assertThat(tw.next()).isFalse(); tw.reset(); } } }
public static void submit(@com.google.gerrit.common.Nullable java.lang.String project, int id, java.lang.String commit, com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.changes.SubmitInfo> cb) { com.google.gwt.core.client.JavaScriptObject in = com.google.gwt.core.client.JavaScriptObject.createObject(); com.google.gerrit.client.changes.ChangeApi.call(project, id, commit, "submit").post(in, cb); }
@java.lang.Override public com.google.gerrit.server.patch.IntraLineDiff load(final com.google.gerrit.server.patch.IntraLineDiffKey key) throws java.lang.Exception { java.util.concurrent.Future<com.google.gerrit.server.patch.IntraLineDiff> result = diffExecutor.submit(new java.util.concurrent.Callable<com.google.gerrit.server.patch.IntraLineDiff>() { @java.lang.Override public com.google.gerrit.server.patch.IntraLineDiff call() throws java.lang.Exception { return com.google.gerrit.server.patch.IntraLineLoader.compute(key); } }); try { return result.get(timeoutMillis, java.util.concurrent.TimeUnit.MILLISECONDS); } catch (java.lang.InterruptedException | java.util.concurrent.TimeoutException e) { com.google.gerrit.server.patch.IntraLineLoader.log.warn(((((((((((((timeoutMillis) + " ms timeout reached for IntraLineDiff") + " in project ") + (key.getProject().get())) + " on commit ") + (key.getCommit().name())) + " for path ") + (key.getPath())) + " comparing ") + (key.getBlobA().name())) + "..") + (key.getBlobB().name()))); result.cancel(true); return new com.google.gerrit.server.patch.IntraLineDiff(IntraLineDiff.Status.TIMEOUT); } catch (java.util.concurrent.ExecutionException e) { com.google.common.base.Throwables.propagateIfInstanceOf(e.getCause(), java.lang.Exception.class); throw new java.lang.Exception(e.getMessage(), e.getCause()); } }
private static org.eclipse.jgit.diff.RawTextComparator comparatorFor(com.google.gerrit.reviewdb.client.AccountDiffPreference.Whitespace ws) { switch (ws) { case IGNORE_ALL : return org.eclipse.jgit.diff.RawTextComparator.WS_IGNORE_ALL; case IGNORE_TRAILING : return org.eclipse.jgit.diff.RawTextComparator.WS_IGNORE_TRAILING; case IGNORE_LEADING_AND_TRAILING : return org.eclipse.jgit.diff.RawTextComparator.WS_IGNORE_CHANGE; case IGNORE_NONE : default : return org.eclipse.jgit.diff.RawTextComparator.DEFAULT; } }
public java.lang.String getNameEmailFor(com.google.gerrit.reviewdb.client.Account.Id accountId) { java.util.Optional<com.google.gerrit.reviewdb.client.Account> account = args.accountCache.maybeGet(accountId).map(AccountState::getAccount); if (account.isPresent()) { java.lang.String name = account.get().getFullName(); java.lang.String email = account.get().getPreferredEmail(); if ((name != null) && (email != null)) { return ((name + " <") + email) + ">"; } else if (name != null) { return name; } else if (email != null) { return email; } } return ((args.anonymousCowardName) + " #") + accountId; }
@org.junit.Test public void listNoChildren() throws java.lang.Exception { com.google.gerrit.acceptance.RestResponse r = GET((("/projects/" + (allProjects.get())) + "/children/")); assertThat(r.getStatusCode()).isEqualTo(HttpStatus.SC_OK); java.util.List<com.google.gerrit.extensions.common.ProjectInfo> projectInfoList = com.google.gerrit.acceptance.rest.project.ListChildProjectsIT.toProjectInfoList(r); assertThat(projectInfoList).hasSize(2); }
@java.lang.Override public org.eclipse.jgit.transport.ReceivePack create(javax.servlet.http.HttpServletRequest req, org.eclipse.jgit.lib.Repository db) throws org.eclipse.jgit.transport.resolver.ServiceNotAuthorizedException { final com.google.gerrit.server.project.ProjectControl pc = ((com.google.gerrit.server.project.ProjectControl) (req.getAttribute(com.google.gerrit.httpd.GitOverHttpServlet.ATT_CONTROL))); if (!((pc.getCurrentUser()) instanceof com.google.gerrit.server.IdentifiedUser)) { throw new org.eclipse.jgit.transport.resolver.ServiceNotAuthorizedException(); } final com.google.gerrit.server.IdentifiedUser user = ((com.google.gerrit.server.IdentifiedUser) (pc.getCurrentUser())); final com.google.gerrit.server.git.ReceiveCommits rc = factory.create(pc, db); rc.getReceivePack().setRefLogIdent(user.newRefLogIdent()); req.setAttribute(com.google.gerrit.httpd.GitOverHttpServlet.ATT_RC, rc); session.get().setAccessPath(AccessPath.GIT); return rc.getReceivePack(); }
public com.google.gerrit.client.reviewdb.Account run(com.google.gerrit.client.reviewdb.ReviewDb db) throws com.google.gerrit.server.Failure, com.google.gwtorm.client.OrmException { final com.google.gerrit.client.reviewdb.Account me = db.accounts().get(com.google.gerrit.client.rpc.Common.getAccountId()); me.setFullName(fullName); me.setPreferredEmail(emailAddr); if (com.google.gerrit.client.rpc.Common.getGerritConfig().isUseContactInfo()) { if ((com.google.gerrit.client.reviewdb.ContactInformation.hasAddress(info)) || ((me.isContactFiled()) && (com.google.gerrit.client.reviewdb.ContactInformation.hasData(info)))) { me.setContactFiled(); } if (com.google.gerrit.client.reviewdb.ContactInformation.hasData(info)) { try { com.google.gerrit.server.EncryptedContactStore.store(me, info); } catch (ContactInformationStoreException e) { throw new com.google.gerrit.server.Failure(e); } } } db.accounts().update(java.util.Collections.singleton(me)); com.google.gerrit.client.rpc.Common.getAccountCache().invalidate(me.getId()); return me; }
@java.lang.Override protected void configure() { com.google.gerrit.extensions.registration.DynamicMap.mapOf(binder(), com.google.gerrit.extensions.config.CapabilityDefinition.class); bind(com.google.gerrit.extensions.config.CapabilityDefinition.class).annotatedWith(com.google.gerrit.extensions.annotations.Exports.named("printHello")).toInstance(new com.google.gerrit.extensions.config.CapabilityDefinition() { @java.lang.Override public java.lang.String getDescription() { return "Print Hello"; } }); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<?> apply(com.google.gerrit.server.account.AccountResource.StarredChange rsrc, com.google.gerrit.server.account.StarredChanges.EmptyInput in) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gwtorm.server.OrmException { if ((self.get()) != (rsrc.getUser())) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed remove starred change"); } dbProvider.get().starredChanges().delete(java.util.Collections.singleton(new com.google.gerrit.reviewdb.client.StarredChange(new com.google.gerrit.reviewdb.client.StarredChange.Key(rsrc.getUser().getAccountId(), rsrc.getChange().getId())))); return com.google.gerrit.extensions.restapi.Response.none(); }
public java.util.List<com.google.gerrit.reviewdb.client.PatchLineComment> draftByChange(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.notedb.ChangeNotes notes) throws com.google.gwtorm.server.OrmException { if (!(migration.readChanges())) { return com.google.gerrit.server.PatchLineCommentsUtil.sort(com.google.gerrit.server.PatchLineCommentsUtil.byCommentStatus(db.patchComments().byChange(notes.getChangeId()), Status.DRAFT)); } java.util.List<com.google.gerrit.reviewdb.client.PatchLineComment> comments = com.google.common.collect.Lists.newArrayList(); for (java.lang.String refSuffix : getDraftRefs(notes.getChangeId()).keySet()) { com.google.gerrit.reviewdb.client.Account.Id account = Account.Id.fromRefPart(refSuffix); if (account != null) { comments.addAll(draftByChangeAuthor(db, notes, account)); } } return com.google.gerrit.server.PatchLineCommentsUtil.sort(comments); }
public com.google.gerrit.testutil.InMemoryDatabase create() throws com.google.gwtorm.client.OrmException { if (!(created)) { created = true; final com.google.gerrit.reviewdb.ReviewDb c = open(); try { try { new com.google.gerrit.server.schema.SchemaCreator(new java.io.File("."), schemaVersion, null, new org.eclipse.jgit.lib.PersonIdent("name", "email@site")).create(c); } catch (java.io.IOException e) { throw new com.google.gwtorm.client.OrmException("Cannot create in-memory database", e); } catch (org.eclipse.jgit.errors.ConfigInvalidException e) { throw new com.google.gwtorm.client.OrmException("Cannot create in-memory database", e); } } finally { c.close(); } } return this; }
@com.google.gwt.uibinder.client.UiHandler("followUp") void onFollowUp(com.google.gwt.event.dom.client.ClickEvent e) { if ((followUpAction) == null) { followUpAction = new com.google.gerrit.client.change.FollowUpAction(followUp, project, branch, key); } followUpAction.show(); }
@java.lang.Override protected void configure() { bind(java.lang.String.class).annotatedWith(com.google.gerrit.extensions.annotations.PluginName.class).toInstance(pluginName); }
protected abstract java.util.List<T> parse(byte[] raw, int offset) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException;
@java.lang.Override public Change.Id apply(java.lang.String changeId) { return Change.Id.parse(changeId); }
static void postSignIn(final boolean success) { final com.google.gerrit.client.SignInDialog d = com.google.gerrit.client.SignInDialog.current; assert d != null; if (success) { com.google.gerrit.client.Gerrit.postSignIn(); d.hide(); final com.google.gwt.user.client.rpc.AsyncCallback<?> ac = d.callback; if (ac != null) { com.google.gwt.user.client.DeferredCommand.addCommand(new com.google.gwt.user.client.Command() { public void execute() { ac.onSuccess(null); } }); } } else { d.hide(); } }
@java.lang.Override public void onGitReferenceUpdated(final com.googlesource.gerrit.plugins.refprotection.Event event) { if (isRelevantRef(event)) { com.google.gerrit.reviewdb.client.Project.NameKey nameKey = new com.google.gerrit.reviewdb.client.Project.NameKey(event.getProjectName()); try { com.google.gerrit.server.project.ProjectResource project = new com.google.gerrit.server.project.ProjectResource(projectControl.controlFor(nameKey, user)); if ((isRefDeleted(event)) || (isNonFastForwardUpdate(event, project))) { backupRef.createBackup(event, project); } } catch (com.google.gerrit.server.project.NoSuchProjectException | java.io.IOException e) { com.googlesource.gerrit.plugins.refprotection.RefUpdateListener.log.error(e.getMessage(), e); } } }
boolean isSingleProjectMatch() { boolean ret = (projects.length) == 1; if (ret) { java.lang.String projectMatch = projects[0]; if ((com.googlesource.gerrit.plugins.replication.ReplicationFilter.getPatternType(projectMatch)) != (ReplicationFilter.PatternType.EXACT_MATCH)) { ret = false; } } return ret; }
@java.lang.Override public com.google.gerrit.extensions.client.EditPreferencesInfo apply(com.google.gerrit.server.account.AccountResource rsrc, com.google.gerrit.extensions.client.EditPreferencesInfo input) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.permissions.PermissionBackendException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException, org.eclipse.jgit.errors.RepositoryNotFoundException { if ((self.get()) != (rsrc.getUser())) { permissionBackend.user(self).check(GlobalPermission.MODIFY_ACCOUNT); } if (input == null) { throw new com.google.gerrit.extensions.restapi.BadRequestException("input must be provided"); } com.google.gerrit.reviewdb.client.Account.Id id = rsrc.getUser().getAccountId(); return accountsUpdateProvider.get().update("Set Edit Preferences via API", id, ( u) -> u.setEditPreferences(input)).map(AccountState::getEditPreferences).orElseThrow(() -> new com.google.gerrit.extensions.restapi.ResourceNotFoundException(com.google.gerrit.extensions.restapi.IdString.fromDecoded(id.toString()))); }
@org.junit.Test public void treeDiffLog() throws java.lang.Exception { java.lang.String contents1 = "foo\n"; java.lang.String contents2 = "foo\ncontents\n"; org.eclipse.jgit.revwalk.RevCommit c1 = repo.update("master", repo.commit().add("foo", contents1)); org.eclipse.jgit.revwalk.RevCommit c2 = repo.update("master", repo.commit().parent(c1).add("foo", contents2)); Log response = buildJson("/repo/+log/master", com.google.gitiles.LogServletTest.LOG, "&name-status=1"); assertThat(response.log).hasSize(2); Commit jc2 = response.log.get(0); verifyJsonCommit(jc2, c2); assertThat(jc2.treeDiff).hasSize(1); assertThat(jc2.treeDiff.get(0).type).isEqualTo("modify"); assertThat(jc2.treeDiff.get(0).oldPath).isEqualTo("foo"); assertThat(jc2.treeDiff.get(0).newPath).isEqualTo("foo"); Commit jc1 = response.log.get(1); verifyJsonCommit(jc1, c1); assertThat(jc1.treeDiff).hasSize(1); assertThat(jc1.treeDiff.get(0).type).isEqualTo("add"); assertThat(jc1.treeDiff.get(0).oldPath).isEqualTo("/dev/null"); assertThat(jc1.treeDiff.get(0).newPath).isEqualTo("foo"); }
com.google.gerrit.server.query.change.ChangeQueryBuilder.Arguments asUser(com.google.gerrit.server.CurrentUser otherUser) { return new com.google.gerrit.server.query.change.ChangeQueryBuilder.Arguments(db, queryProvider, rewriter, opFactories, hasOperands, userFactory, com.google.inject.util.Providers.of(otherUser), permissionBackend, notesFactory, changeDataFactory, commentsUtil, accountResolver, groupBackend, allProjectsName, allUsersName, patchListCache, repoManager, projectCache, childProjects, submitDryRun, conflictsCache, index, indexConfig, listMembers, starredChangesUtil, accountCache, allowsDrafts, notesMigration); }
static java.lang.Module module() { return new com.google.gerrit.server.cache.CacheModule() { protected void configure() { persist(com.googlesource.gerrit.plugins.quota.MaxRepositorySizeQuota.REPO_SIZE_CACHE, Project.NameKey.class, java.util.concurrent.atomic.AtomicLong.class).loader(com.googlesource.gerrit.plugins.quota.MaxRepositorySizeQuota.Loader.class).expireAfterWrite(1, java.util.concurrent.TimeUnit.DAYS); } }; }
com.google.gerrit.client.diff.LineMapper.LineOnOtherInfo lineOnOther(com.google.gerrit.client.diff.DisplaySide side, int line) { return getChunkManager().lineMapper.lineOnOther(side, line); }
@java.lang.Override protected void onLoad() throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { org.eclipse.jgit.lib.ObjectId rev = getRevision(); if (rev == null) { loadDefaults(); return; } org.eclipse.jgit.revwalk.RevWalk walk = new org.eclipse.jgit.revwalk.RevWalk(reader); try (com.google.gerrit.server.notedb.ChangeNotesParser parser = new com.google.gerrit.server.notedb.ChangeNotesParser(change, rev, walk, repoManager)) { parser.parseAll(); if ((parser.status) != null) { change.setStatus(parser.status); } approvals = parser.buildApprovals(); changeMessages = parser.buildMessages(); commentsForBase = com.google.common.collect.ImmutableListMultimap.copyOf(parser.commentsForBase); commentsForPS = com.google.common.collect.ImmutableListMultimap.copyOf(parser.commentsForPs); noteMap = parser.commentNoteMap; if ((parser.hashtags) != null) { hashtags = com.google.common.collect.ImmutableSet.copyOf(parser.hashtags); } else { hashtags = com.google.common.collect.ImmutableSet.of(); } ImmutableSetMultimap.Builder<com.google.gerrit.server.notedb.ReviewerState, com.google.gerrit.reviewdb.client.Account.Id> reviewers = com.google.common.collect.ImmutableSetMultimap.builder(); for (java.util.Map.Entry<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.server.notedb.ReviewerState> e : parser.reviewers.entrySet()) { reviewers.put(e.getValue(), e.getKey()); } this.reviewers = reviewers.build(); this.allPastReviewers = com.google.common.collect.ImmutableList.copyOf(parser.allPastReviewers); submitRecords = com.google.common.collect.ImmutableList.copyOf(parser.submitRecords); } catch (java.text.ParseException e1) { throw new java.io.IOException(e1); } finally { walk.release(); } }
@java.lang.Override public com.google.gerrit.extensions.api.accounts.AccountApi id(java.lang.String id) throws com.google.gerrit.extensions.restapi.RestApiException { try { return api.create(accounts.parse(TopLevelResource.INSTANCE, com.google.gerrit.extensions.restapi.IdString.fromDecoded(id))); } catch (com.google.gwtorm.server.OrmException e) { throw new com.google.gerrit.extensions.restapi.RestApiException("Cannot parse change", e); } }
@org.junit.Test @com.google.gerrit.acceptance.GerritConfig(name = "suggest.maxSuggestedReviewers", value = "2") public void suggestReviewersMaxNbrSuggestions() throws java.lang.Exception { java.lang.String changeId = createChange().getChangeId(); java.util.List<com.google.gerrit.extensions.common.SuggestedReviewerInfo> reviewers = suggestReviewers(changeId, "user", 5); assertThat(reviewers).hasSize(2); }
com.google.common.util.concurrent.CheckedFuture<com.google.gerrit.reviewdb.client.PatchSet.Id, com.google.gerrit.server.git.InsertException> insertPatchSet() throws java.io.IOException { rp.getRevWalk().parseBody(newCommit); final java.lang.Thread caller = java.lang.Thread.currentThread(); com.google.common.util.concurrent.ListenableFuture<com.google.gerrit.reviewdb.client.PatchSet.Id> future = changeUpdateExector.submit(requestScopePropagator.wrap(new java.util.concurrent.Callable<com.google.gerrit.reviewdb.client.PatchSet.Id>() { @java.lang.Override public PatchSet.Id call() throws com.google.gerrit.server.project.NoSuchChangeException, com.google.gwtorm.server.OrmException, java.io.IOException { try { if (magicBranch.edit) { return upsertEdit(); } else if (caller == (java.lang.Thread.currentThread())) { return insertPatchSet(db); } else { com.google.gerrit.reviewdb.server.ReviewDb db = schemaFactory.open(); try { return insertPatchSet(db); } finally { db.close(); } } } finally { synchronized(replaceProgress) { replaceProgress.update(1); } } } })); return com.google.common.util.concurrent.Futures.makeChecked(future, com.google.gerrit.server.git.ReceiveCommits.INSERT_EXCEPTION); }
private java.util.List<com.google.gerrit.client.reviewdb.Change> changesCreatedBy(final com.google.gerrit.client.reviewdb.ReviewDb db, final java.lang.String userName) throws com.google.gwtorm.client.OrmException { final java.util.List<com.google.gerrit.client.reviewdb.Change> resultChanges = new java.util.ArrayList<com.google.gerrit.client.reviewdb.Change>(); for (com.google.gerrit.client.reviewdb.Account.Id account : com.google.gerrit.client.changes.ChangeListServiceImpl.getAccountSources(db, userName)) { for (com.google.gerrit.client.reviewdb.Change change : db.changes().byOwnerOpen(account)) { resultChanges.add(change); } for (com.google.gerrit.client.reviewdb.Change change : db.changes().byOwnerClosedAll(account)) { resultChanges.add(change); } } return resultChanges; }
@java.lang.Override public void postUpdate(com.google.gerrit.server.update.Context ctx) throws java.lang.Exception { emailReviewers(rsrc.getChange(), com.google.common.collect.Lists.transform(addedReviewers, ( r) -> r.getAccountId()), ((addedCCs) == null ? com.google.common.collect.ImmutableList.of() : addedCCs), reviewersByEmail, addedCCsByEmail, notify, accountsToNotify); if (!(addedReviewers.isEmpty())) { java.util.List<com.google.gerrit.reviewdb.client.Account> reviewers = com.google.common.collect.Lists.transform(addedReviewers, ( psa) -> com.google.gerrit.server.change.accountCache.get(psa.getAccountId()).getAccount()); reviewerAdded.fire(rsrc.getChange(), patchSet, reviewers, ctx.getAccount(), ctx.getWhen()); } }
private static java.lang.StringBuilder addFooter(java.lang.StringBuilder sb, org.eclipse.jgit.revwalk.FooterKey footer) { return sb.append(footer.getName()).append(": "); }
private static java.util.jar.Manifest getPluginManifest(com.google.gerrit.server.plugins.PluginContentScanner scanner) throws com.google.gerrit.server.plugins.InvalidPluginException { try { return scanner.getManifest(); } catch (java.io.IOException e) { throw new com.google.gerrit.server.plugins.InvalidPluginException("Cannot get plugin manifest", e); } }
private boolean matchCriteria(com.google.gerrit.server.config.PluginConfig config, java.lang.String criteria, @com.google.gerrit.common.Nullable java.lang.String value, boolean allowRegex, boolean refMatcher) { java.lang.String[] c = config.getStringList(criteria); if ((c.length) == 0) { return true; } if (value == null) { return false; } if (allowRegex) { return java.util.Arrays.stream(c).anyMatch(( s) -> com.googlesource.gerrit.plugins.uploadvalidator.ValidatorConfig.match(value, s, refMatcher)); } return java.util.Arrays.asList(c).contains(value); }
@org.junit.Test public void noConflictingChanges() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result change = createChange(git, true); createChange(git, false); java.util.Set<java.lang.String> changes = queryConflictingChanges(change); assertThat(((java.lang.Iterable<?>) (changes))).isEmpty(); }
@java.lang.Override public boolean deleteChangeFromIndex(final int changeId) { return new com.ericsson.gerrit.plugins.highavailability.forwarder.rest.RestForwarder.Request("delete change", changeId) { @java.lang.Override com.ericsson.gerrit.plugins.highavailability.forwarder.rest.HttpResponseHandler.HttpResult send() throws java.io.IOException { return httpSession.delete(buildIndexEndpoint(changeId)); } }.execute(); }
private void savePluginSections(org.eclipse.jgit.lib.Config rc) { java.util.List<java.lang.String> existing = com.google.common.collect.Lists.newArrayList(rc.getSubsections(com.google.gerrit.server.git.ProjectConfig.PLUGIN)); for (java.lang.String name : existing) { rc.unsetSection(com.google.gerrit.server.git.ProjectConfig.PLUGIN, name); } for (java.util.Map.Entry<java.lang.String, org.eclipse.jgit.lib.Config> e : pluginConfigs.entrySet()) { java.lang.String plugin = e.getKey(); org.eclipse.jgit.lib.Config pluginConfig = e.getValue(); for (java.lang.String name : pluginConfig.getNames(com.google.gerrit.server.git.ProjectConfig.PLUGIN, plugin)) { rc.setStringList(com.google.gerrit.server.git.ProjectConfig.PLUGIN, plugin, name, java.util.Arrays.asList(pluginConfig.getStringList(com.google.gerrit.server.git.ProjectConfig.PLUGIN, plugin, name))); } } }
@java.lang.Override public java.lang.String[] getList(java.lang.String section, java.lang.String subsection, java.lang.String name) { return com.google.common.collect.FluentIterable.from(java.util.Arrays.asList(sec.getStringList(section, subsection, name))).transform(codec.decodeFun).toArray(java.lang.String.class); }
void createNotes(java.util.List<com.google.gerrit.server.notedb.ChangeNotes> notes, org.eclipse.jgit.lib.ProgressMonitor monitor) throws com.google.gwtorm.server.OrmException, java.io.IOException { try (org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(git)) { if (monitor == null) { monitor = org.eclipse.jgit.lib.NullProgressMonitor.INSTANCE; } for (com.google.gerrit.server.notedb.ChangeNotes cn : notes) { monitor.update(1); com.google.gerrit.reviewdb.client.PatchSet ps = reviewDb.patchSets().get(cn.getChange().currentPatchSetId()); org.eclipse.jgit.lib.ObjectId commitId = org.eclipse.jgit.lib.ObjectId.fromString(ps.getRevision().get()); org.eclipse.jgit.revwalk.RevCommit commit = rw.parseCommit(commitId); getNotes().set(commitId, createNoteContent(cn, ps)); getMessage().append("* ").append(commit.getShortMessage()).append("\n"); } } }
@java.lang.Override public com.google.gerrit.extensions.common.ChangeInfo apply(com.google.gerrit.server.change.ChangeResource rsrc) { java.util.List<com.google.gerrit.extensions.common.ProblemInfo> problems = checkerProvider.get().check(rsrc.getChange()); com.google.gerrit.extensions.common.ChangeInfo result; try { result = json.format(rsrc); } catch (com.google.gwtorm.server.OrmException e) { com.google.gerrit.extensions.common.ProblemInfo p = new com.google.gerrit.extensions.common.ProblemInfo(); p.message = "Error rendering final ChangeInfo"; com.google.gerrit.server.change.Check.log.warn(p.message, e); problems.add(p); result = com.google.gerrit.server.change.Check.basicChangeInfo(rsrc.getChange()); } result.problems = problems; return result; }
public static com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> create(java.lang.String label, com.google.gerrit.common.data.SubmitRecord.Label.Status status, java.util.Set<com.google.gerrit.reviewdb.client.Account.Id> accounts) { java.lang.String lowerLabel = label.toLowerCase(); if ((accounts == null) || (accounts.isEmpty())) { return new com.google.gerrit.server.query.change.SubmitRecordPredicate((((status.name()) + ',') + lowerLabel)); } return com.google.gerrit.server.query.Predicate.or(accounts.stream().map(( a) -> new com.google.gerrit.server.query.change.SubmitRecordPredicate((((((status.name()) + ',') + lowerLabel) + ',') + (a.get())))).collect(java.util.stream.Collectors.toList())); }
private static void checkCommitMessageForBlockedKeywords(com.google.common.collect.ImmutableCollection<java.util.regex.Pattern> blockedKeywordPatterns, java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> messages, java.lang.String commitMessage) { int line = 0; for (java.lang.String l : commitMessage.split("[\r\n]+")) { line++; com.googlesource.gerrit.plugins.uploadvalidator.BlockedKeywordValidator.checkLineForBlockedKeywords(blockedKeywordPatterns, messages, Patch.COMMIT_MSG, line, l); } }
@java.lang.Override public java.lang.Iterable<com.google.gerrit.sshd.SshKeyCacheEntry> load(java.lang.String username) throws java.lang.Exception { try (com.google.gerrit.reviewdb.server.ReviewDb db = schema.open()) { com.google.gerrit.reviewdb.client.AccountExternalId.Key key = new com.google.gerrit.reviewdb.client.AccountExternalId.Key(SCHEME_USERNAME, username); com.google.gerrit.reviewdb.client.AccountExternalId user = db.accountExternalIds().get(key); if (user == null) { return com.google.gerrit.sshd.SshKeyCacheImpl.NO_SUCH_USER; } java.util.List<com.google.gerrit.sshd.SshKeyCacheEntry> kl = new java.util.ArrayList<>(4); for (com.google.gerrit.reviewdb.client.AccountSshKey k : authorizedKeys.getKeys(user.getAccountId())) { if (k.isValid()) { add(kl, k); } } if (kl.isEmpty()) { return com.google.gerrit.sshd.SshKeyCacheImpl.NO_KEYS; } return java.util.Collections.unmodifiableList(kl); } }
@java.lang.Override public com.google.gerrit.extensions.api.projects.ProjectApi create(com.google.gerrit.extensions.api.projects.ProjectInput in) throws com.google.gerrit.extensions.restapi.RestApiException { throw new com.google.gerrit.extensions.restapi.NotImplementedException(); }
@java.lang.Override public com.google.gerrit.extensions.common.WebLinkInfo getProjectWeblink(java.lang.String projectName) { return new com.google.gerrit.extensions.common.WebLinkInfo(name, null, java.lang.String.format("%s/%s", baseUrl, projectName), target); }
private void checkLabels(com.google.gerrit.server.change.RevisionResource rsrc, com.google.gerrit.common.data.LabelTypes labelTypes, java.util.Map<java.lang.String, java.lang.Short> labels) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.BadRequestException, com.google.gerrit.server.permissions.PermissionBackendException { com.google.gerrit.server.permissions.PermissionBackend.ForChange perm = rsrc.permissions(); java.util.Iterator<java.util.Map.Entry<java.lang.String, java.lang.Short>> itr = labels.entrySet().iterator(); while (itr.hasNext()) { java.util.Map.Entry<java.lang.String, java.lang.Short> ent = itr.next(); com.google.gerrit.common.data.LabelType lt = labelTypes.byLabel(ent.getKey()); if (lt == null) { throw new com.google.gerrit.extensions.restapi.BadRequestException(java.lang.String.format("label \"%s\" is not a configured label", ent.getKey())); } if (((ent.getValue()) == null) || ((ent.getValue()) == 0)) { continue; } if ((lt.getValue(ent.getValue())) == null) { throw new com.google.gerrit.extensions.restapi.BadRequestException(java.lang.String.format("label \"%s\": %d is not a valid value", ent.getKey(), ent.getValue())); } short val = ent.getValue(); try { perm.check(new com.google.gerrit.server.permissions.LabelPermission.WithValue(lt, val)); } catch (com.google.gerrit.extensions.restapi.AuthException e) { throw new com.google.gerrit.extensions.restapi.AuthException(java.lang.String.format("Applying label \"%s\": %d is restricted", lt.getName(), val)); } } }
com.googlesource.gerrit.plugins.webhooks.PostTask create(com.google.gerrit.server.events.ProjectEvent event, com.googlesource.gerrit.plugins.webhooks.RemoteConfig remote);
public com.google.gerrit.server.notedb.NoteDbChangeState.PrimaryStorage getPrimaryStorage() { return primaryStorage; }
@java.lang.Override protected void configure() { bind(com.google.gerrit.server.index.ChangeIndexer.class).to(com.google.gerrit.server.index.ChangeIndexerImpl.class); bind(com.google.gerrit.server.query.change.ChangeQueryRewriter.class).to(com.google.gerrit.server.index.IndexRewriteImpl.class); bind(IndexRewriteImpl.BasicRewritesImpl.class); bind(com.google.gerrit.server.index.IndexCollection.class); listener().to(com.google.gerrit.server.index.IndexCollection.class); }
public static com.google.gerrit.reviewdb.client.RevId setCommentRevId(com.google.gerrit.reviewdb.client.PatchLineComment c, com.google.gerrit.server.patch.PatchListCache cache, com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.PatchSet ps) throws com.google.gwtorm.server.OrmException { if ((c.getRevId()) == null) { try { com.google.gerrit.server.patch.PatchList patchList = cache.get(change, ps); c.setRevId(((c.getSide()) == ((short) (0)) ? new com.google.gerrit.reviewdb.client.RevId(org.eclipse.jgit.lib.ObjectId.toString(patchList.getOldId())) : new com.google.gerrit.reviewdb.client.RevId(org.eclipse.jgit.lib.ObjectId.toString(patchList.getNewId())))); } catch (com.google.gerrit.server.patch.PatchListNotAvailableException e) { throw new com.google.gwtorm.server.OrmException(e); } } return c.getRevId(); }
public com.google.gerrit.common.data.AccountProjectWatchInfo run(com.google.gerrit.reviewdb.ReviewDb db) throws com.google.gerrit.common.errors.InvalidQueryException, com.google.gerrit.server.project.NoSuchProjectException, com.google.gwtorm.client.OrmException { final com.google.gerrit.reviewdb.Project.NameKey nameKey = new com.google.gerrit.reviewdb.Project.NameKey(projectName); final com.google.gerrit.server.project.ProjectControl ctl = projectControlFactory.validateFor(nameKey); if (filter != null) { try { com.google.gerrit.server.query.change.ChangeQueryBuilder builder = queryBuilder.create(currentUser.get()); builder.setAllowFile(true); builder.parse(filter); } catch (QueryParseException badFilter) { throw new com.google.gerrit.common.errors.InvalidQueryException(badFilter.getMessage(), filter); } } com.google.gerrit.reviewdb.AccountProjectWatch watch = new com.google.gerrit.reviewdb.AccountProjectWatch(new com.google.gerrit.reviewdb.AccountProjectWatch.Key(((com.google.gerrit.server.IdentifiedUser) (ctl.getCurrentUser())).getAccountId(), nameKey, filter)); try { db.accountProjectWatches().insert(java.util.Collections.singleton(watch)); } catch (OrmDuplicateKeyException alreadyHave) { watch = db.accountProjectWatches().get(watch.getKey()); } return new com.google.gerrit.common.data.AccountProjectWatchInfo(watch, ctl.getProject()); }
private void listen(com.google.gerrit.server.plugins.AutoRegisterModules.ClassData def) throws com.google.gerrit.server.plugins.InvalidPluginException { java.lang.Class<?> clazz; try { clazz = java.lang.Class.forName(def.className, false, classLoader); } catch (java.lang.ClassNotFoundException err) { throw new com.google.gerrit.server.plugins.InvalidPluginException(java.lang.String.format("Cannot load %s with @Listen", def.className), err); } com.google.gerrit.extensions.annotations.Listen listen = clazz.getAnnotation(com.google.gerrit.extensions.annotations.Listen.class); if (listen != null) { listen(clazz, clazz); } else { PluginLoader.log.warn(java.lang.String.format("In plugin %s asm incorrectly parsed %s with @Listen", pluginName, clazz.getName())); } }
private static java.io.File url2file(final java.lang.String urlString) throws java.io.IOException { final java.net.URL url = new java.net.URL(urlString); try { return new java.io.File(url.toURI()); } catch (java.net.URISyntaxException e) { return new java.io.File(url.getPath()); } }
private static void addAvatar(com.google.gerrit.server.avatar.AvatarProvider provider, com.google.gerrit.extensions.common.AccountInfo account, com.google.gerrit.server.IdentifiedUser user, int size) { java.lang.String url = provider.getUrl(user, size); if (url != null) { com.google.gerrit.extensions.common.AvatarInfo avatar = new com.google.gerrit.extensions.common.AvatarInfo(); avatar.url = url; avatar.height = size; account.avatars.add(avatar); } }
java.lang.Runnable maybeNextVimSearch(final net.codemirror.lib.CodeMirror cm) { return new java.lang.Runnable() { @java.lang.Override public void run() { if (cm.vim().hasSearchHighlight()) { cm.vim().handleKey("n"); } else { getChunkManager().diffChunkNav(cm, Direction.NEXT).run(); } } }; }
@java.lang.Override public void delete() throws com.google.gerrit.extensions.restapi.RestApiException { try { deleteBranch.apply(resource(), new com.google.gerrit.server.project.DeleteBranch.Input()); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot delete branch", e); } }
private com.google.gerrit.server.events.CommitReceivedEvent newCommitReceivedEvent(org.eclipse.jgit.transport.ReceiveCommand command, com.google.gerrit.reviewdb.client.Project project, java.lang.String refName, org.eclipse.jgit.revwalk.RevCommit commit, com.google.gerrit.server.IdentifiedUser user) { com.google.gerrit.server.events.CommitReceivedEvent event = createMock(com.google.gerrit.server.events.CommitReceivedEvent.class); event.command = command; event.project = project; event.refName = refName; event.commit = commit; event.user = user; expect(event.getProjectNameKey()).andReturn(project.getNameKey()).anyTimes(); expect(event.getRefName()).andReturn(null).anyTimes(); return event; }
protected com.google.gerrit.acceptance.StandaloneSiteTest.ServerContext startServer() throws java.lang.Exception { return new com.google.gerrit.acceptance.StandaloneSiteTest.ServerContext(startImpl()); }
private static <T> void diffColumnsExcluding(java.util.List<java.lang.String> diffs, java.lang.Class<T> clazz, java.lang.String desc, com.google.gerrit.server.notedb.ChangeBundle bundleA, T a, com.google.gerrit.server.notedb.ChangeBundle bundleB, T b, java.lang.String... exclude) { java.util.Set<java.lang.String> toExclude = com.google.common.collect.Sets.newLinkedHashSet(java.util.Arrays.asList(exclude)); for (java.lang.reflect.Field f : clazz.getDeclaredFields()) { com.google.gwtorm.client.Column col = f.getAnnotation(com.google.gwtorm.client.Column.class); if (col == null) { continue; } else if (toExclude.remove(f.getName())) { continue; } f.setAccessible(true); try { if (java.sql.Timestamp.class.isAssignableFrom(f.getType())) { com.google.gerrit.server.notedb.ChangeBundle.diffTimestamps(diffs, desc, bundleA, a, bundleB, b, f.getName()); } else { com.google.gerrit.server.notedb.ChangeBundle.diffValues(diffs, desc, f.get(a), f.get(b), f.getName()); } } catch (java.lang.IllegalAccessException e) { throw new java.lang.IllegalArgumentException(e); } } checkArgument(toExclude.isEmpty(), "requested columns to exclude not present in %s: %s", clazz.getSimpleName(), toExclude); }
void setSyntaxHighlighting(boolean b) { net.codemirror.mode.ModeInfo modeInfo = net.codemirror.mode.ModeInfo.findMode(content.getContentType(), path); final java.lang.String mode = (modeInfo != null) ? modeInfo.mime() : null; if ((b && (mode != null)) && (!(mode.isEmpty()))) { injectMode(mode, new com.google.gwt.user.client.rpc.AsyncCallback<java.lang.Void>() { @java.lang.Override public void onSuccess(java.lang.Void result) { cmBase.setOption("mode", mode); cmEdit.setOption("mode", mode); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { prefs.syntaxHighlighting(false); } }); } else { cmBase.setOption("mode", ((java.lang.String) (null))); cmEdit.setOption("mode", ((java.lang.String) (null))); } }
@java.lang.Override public void onClick(com.google.gwt.event.dom.client.ClickEvent event) { setOpen((!(isOpen()))); }
private void initUI() { addStyleName("gerrit-ChangeScreen"); descriptionBlock = new com.google.gerrit.client.changes.ChangeDescriptionBlock(); add(descriptionBlock); dependencies = new com.google.gerrit.client.changes.ChangeTable(); dependsOn = new com.google.gerrit.client.changes.ChangeTable.Section(Util.C.changeScreenDependsOn()); neededBy = new com.google.gerrit.client.changes.ChangeTable.Section(Util.C.changeScreenNeededBy()); dependencies.addSection(dependsOn); dependencies.addSection(neededBy); dependenciesPanel = new com.google.gwt.user.client.ui.DisclosurePanel(Util.C.changeScreenDependencies()); dependenciesPanel.setContent(dependencies); dependenciesPanel.setWidth("95%"); add(dependenciesPanel); approvals = new com.google.gerrit.client.changes.ApprovalTable(); approvalsPanel = new com.google.gwt.user.client.ui.DisclosurePanel(Util.C.changeScreenApprovals()); approvalsPanel.setContent(com.google.gerrit.client.changes.ChangeScreen.wrap(approvals)); dependenciesPanel.setWidth("95%"); add(approvalsPanel); patchSetPanels = new com.google.gwt.user.client.ui.FlowPanel(); add(patchSetPanels); messagesContent = new com.google.gwt.user.client.ui.FlowPanel(); messagesContent.setStyleName("gerrit-ChangeMessages"); messagesPanel = new com.google.gwt.user.client.ui.DisclosurePanel(Util.C.changeScreenMessages()); messagesPanel.setContent(messagesContent); add(messagesPanel); }
@org.junit.Test @com.google.gerrit.acceptance.GerritConfig(name = "receiveemail.filter.mode", value = "BLACKLIST") @com.google.gerrit.acceptance.GerritConfig(name = "receiveemail.filter.patterns", values = { ".+@example\\.com", "a@b\\.com" }) public void listFilterBlacklistFiltersListedUser() throws java.lang.Exception { com.google.gerrit.extensions.common.ChangeInfo changeInfo = createChangeAndReplyByEmail(); java.util.Collection<com.google.gerrit.extensions.common.ChangeMessageInfo> messages = gApi.changes().id(changeInfo.id).get().messages; assertThat(messages).hasSize(2); }
public com.google.gerrit.server.account.AuthResult unlink(com.google.gerrit.reviewdb.client.Account.Id from, com.google.gerrit.server.account.AuthRequest who) throws com.google.gerrit.server.account.AccountException, com.google.gwtorm.server.OrmException, java.io.IOException { try (com.google.gerrit.reviewdb.server.ReviewDb db = schema.open()) { com.google.gerrit.reviewdb.client.AccountExternalId.Key key = com.google.gerrit.server.account.AccountManager.id(who); com.google.gerrit.reviewdb.client.AccountExternalId extId = getAccountExternalId(key); if (extId != null) { if (!(extId.getAccountId().equals(from))) { throw new com.google.gerrit.server.account.AccountException((("Identity '" + (key.get())) + "' in use by another account")); } db.accountExternalIds().delete(java.util.Collections.singleton(extId)); externalIdCache.onRemove(extId); if ((who.getEmailAddress()) != null) { com.google.gerrit.reviewdb.client.Account a = db.accounts().get(from); if (((a.getPreferredEmail()) != null) && (a.getPreferredEmail().equals(who.getEmailAddress()))) { a.setPreferredEmail(null); db.accounts().update(java.util.Collections.singleton(a)); } byEmailCache.evict(who.getEmailAddress()); byIdCache.evict(from); } } else { throw new com.google.gerrit.server.account.AccountException((("Identity '" + (key.get())) + "' not found")); } return new com.google.gerrit.server.account.AuthResult(from, key, false); } }
static java.lang.String computeCanonicalPath(java.lang.String canonicalURL) throws java.net.URISyntaxException { java.net.URI uri = new java.net.URI(canonicalURL); return uri.getPath().replaceAll("/$", ""); }
@java.lang.Override public java.util.Set<com.google.gerrit.reviewdb.AccountGroup.ExternalNameKey> lookupGroups(java.lang.String name) { final java.util.Set<com.google.gerrit.reviewdb.AccountGroup.ExternalNameKey> out; final java.util.Map<java.lang.String, java.lang.String> params = java.util.Collections.<java.lang.String, java.lang.String>emptyMap(); out = new java.util.HashSet<com.google.gerrit.reviewdb.AccountGroup.ExternalNameKey>(); try { final javax.naming.directory.DirContext ctx = helper.open(); try { final com.google.gerrit.server.auth.ldap.Helper.LdapSchema schema = helper.getSchema(ctx); final com.google.gerrit.common.data.ParameterizedString filter = com.google.gerrit.common.data.ParameterizedString.asis(schema.groupPattern.replace(com.google.gerrit.server.auth.ldap.LdapRealm.GROUPNAME, name).toString()); for (java.lang.String groupBase : schema.groupBases) { final com.google.gerrit.server.auth.ldap.LdapQuery query = new com.google.gerrit.server.auth.ldap.LdapQuery(groupBase, schema.groupScope, filter, java.util.Collections.<java.lang.String>emptySet()); for (com.google.gerrit.server.auth.ldap.LdapQuery.Result res : query.query(ctx, params)) { out.add(new com.google.gerrit.reviewdb.AccountGroup.ExternalNameKey(res.getDN())); } } } finally { try { ctx.close(); } catch (javax.naming.NamingException e) { com.google.gerrit.server.auth.ldap.LdapRealm.log.warn("Cannot close LDAP query handle", e); } } } catch (javax.naming.NamingException e) { com.google.gerrit.server.auth.ldap.LdapRealm.log.warn("Cannot query LDAP for groups matching requested name", e); } return out; }
public static java.lang.String toPatch(@com.google.gerrit.common.Nullable com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String type, com.google.gerrit.client.DiffObject diffBase, com.google.gerrit.reviewdb.client.Patch.Key id) { return com.google.gerrit.client.Dispatcher.toPatch(type, project, diffBase, id.getParentKey(), id.get(), null, 0); }
private void addReviewerToReviewableChangeInNoteDbNotifyOwnerReviewers(com.google.gerrit.acceptance.server.mail.AddReviewerSenderIT.Adder adder) throws java.lang.Exception { assume().that(notesMigration.readChanges()).isTrue(); com.google.gerrit.acceptance.server.mail.StagedChange sc = stageReviewableChange(); com.google.gerrit.acceptance.TestAccount reviewer = accountCreator.create("added", "added@example.com", "added"); addReviewer(adder, sc.changeId, sc.owner, reviewer.email, com.google.gerrit.acceptance.server.mail.OWNER_REVIEWERS); assertThat(sender).sent("newchange", sc).to(reviewer).cc(sc.reviewer).cc(sc.reviewerByEmail, sc.ccerByEmail).noOneElse(); }
public void dispatchDeleteGroupsFromGroup(com.google.gerrit.reviewdb.client.Account.Id actor, java.util.Collection<com.google.gerrit.reviewdb.client.AccountGroupById> removed, java.sql.Timestamp removedOn) { for (com.google.gerrit.server.audit.GroupMemberAuditListener auditListener : groupMemberAuditListeners) { try { auditListener.onDeleteGroupsFromGroup(actor, removed, removedOn); } catch (java.lang.RuntimeException e) { com.google.gerrit.server.audit.AuditService.log.error("failed to log delete groups from group event", e); } } }
private com.google.gerrit.reviewdb.client.AccountSshKey addKey(java.lang.String pub) throws com.google.gerrit.common.errors.InvalidSshKeyException { checkLoaded(); for (com.google.common.base.Optional<com.google.gerrit.reviewdb.client.AccountSshKey> key : keys) { if ((key.isPresent()) && (key.get().getSshPublicKey().trim().equals(pub.trim()))) { return key.get(); } } int seq = (keys.size()) + 1; com.google.gerrit.reviewdb.client.AccountSshKey.Id keyId = new com.google.gerrit.reviewdb.client.AccountSshKey.Id(accountId, seq); com.google.gerrit.reviewdb.client.AccountSshKey key = sshKeyCreator.create(keyId, pub); keys.add(com.google.common.base.Optional.of(key)); return key; }
private void insertChange(com.google.gerrit.reviewdb.server.ReviewDb db) throws com.google.gwtorm.server.OrmException { final com.google.gerrit.reviewdb.client.PatchSet ps = ins.getPatchSet(); final com.google.gerrit.reviewdb.client.Account.Id me = currentUser.getAccountId(); final java.util.List<org.eclipse.jgit.revwalk.FooterLine> footerLines = commit.getFooterLines(); final com.google.gerrit.server.mail.MailUtil.MailRecipients recipients = new com.google.gerrit.server.mail.MailUtil.MailRecipients(); if ((magicBranch) != null) { recipients.add(magicBranch.getMailRecipients()); } recipients.add(getRecipientsFromFooters(accountResolver, ps, footerLines)); recipients.remove(me); ins.setReviewers(recipients.getReviewers()).setSendMail(false).insert(); created = true; workQueue.getDefaultQueue().submit(requestScopePropagator.wrap(new java.lang.Runnable() { @java.lang.Override public void run() { try { com.google.gerrit.server.mail.CreateChangeSender cm = createChangeSenderFactory.create(change); cm.setFrom(me); cm.setPatchSet(ps, ins.getPatchSetInfo()); cm.addReviewers(recipients.getReviewers()); cm.addExtraCC(recipients.getCcOnly()); cm.send(); } catch (java.lang.Exception e) { com.google.gerrit.server.git.ReceiveCommits.log.error(("Cannot send email for new change " + (change.getId())), e); } } @java.lang.Override public java.lang.String toString() { return "send-email newchange"; } })); if (((magicBranch) != null) && (magicBranch.isSubmit())) { submit(projectControl.controlFor(change), ps); } }
public void setReportBugText(java.lang.String t) { reportBugText = t; }
@java.lang.Override public com.google.gwtorm.server.ResultSet<com.google.gerrit.reviewdb.client.AccountGroupName> iterateAllEntities() { throw new java.lang.UnsupportedOperationException(com.google.gerrit.reviewdb.server.DisallowReadFromGroupsReviewDbWrapper.MSG); }
@java.lang.Override public com.google.common.base.Optional<com.google.gerrit.reviewdb.client.AccountGroup> load(java.lang.String name) throws java.lang.Exception { final com.google.gerrit.reviewdb.server.ReviewDb db = schema.open(); try { com.google.gerrit.reviewdb.client.AccountGroup.NameKey key = new com.google.gerrit.reviewdb.client.AccountGroup.NameKey(name); com.google.gerrit.reviewdb.client.AccountGroupName r = db.accountGroupNames().get(key); if (r != null) { return com.google.common.base.Optional.fromNullable(db.accountGroups().get(r.getId())); } return com.google.common.base.Optional.absent(); } finally { db.close(); } }
public void setRefPattern(java.lang.String refPattern) { this.refPattern = refPattern; }
public static void replyError(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse res, int statusCode, java.lang.String msg, com.google.gerrit.extensions.restapi.CacheControl c, @com.google.gerrit.common.Nullable java.lang.Throwable err) throws java.io.IOException { if (err != null) { com.google.gerrit.util.http.RequestUtil.setErrorTraceAttribute(req, err); } com.google.gerrit.httpd.restapi.RestApiServlet.configureCaching(req, res, null, null, c); res.setStatus(statusCode); com.google.gerrit.httpd.restapi.RestApiServlet.replyText(req, res, msg); }
@java.lang.Override public void close() { try { super.close(); } finally { repo.close(); } }
@java.lang.Override protected void doGetJson(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse res) throws java.io.IOException { com.google.gitiles.GitilesAccess access = getAccess(req); com.google.gitiles.RepositoryDescription desc = access.getRepositoryDescription(); renderJson(req, res, desc, new com.google.gson.reflect.TypeToken<com.google.gitiles.RepositoryDescription>() {}.getType()); }
public java.util.List<java.util.Map<java.lang.String, java.lang.String>> linkify(java.lang.String input) { java.util.List<java.util.Map<java.lang.String, java.lang.String>> parsed = com.google.common.collect.Lists.newArrayList(); java.util.regex.Matcher m = pattern.matcher(input); int last = 0; while (m.find()) { com.google.gitiles.CommentLinkInfo.addText(parsed, input.substring(last, m.start())); java.lang.String text = m.group(0); com.google.gitiles.CommentLinkInfo.addLink(parsed, text, pattern.matcher(text).replaceAll(link)); last = m.end(); } com.google.gitiles.CommentLinkInfo.addText(parsed, input.substring(last)); return com.google.common.collect.ImmutableList.copyOf(parsed); }
private void parseUpdate(final org.eclipse.jgit.transport.ReceiveCommand cmd) { com.google.gerrit.server.project.RefControl ctl = projectControl.controlForRef(cmd.getRefName()); if (ctl.canUpdate()) { if ((com.google.gerrit.server.git.ReceiveCommits.isHead(cmd)) && (!(isCommit(cmd)))) { return; } validateNewCommits(ctl, cmd); cmd.execute(rp); } else { if (GitRepositoryManager.REF_CONFIG.equals(ctl.getRefName())) { errors.put(com.google.gerrit.server.git.ReceiveCommits.Error.CONFIG_UPDATE, GitRepositoryManager.REF_CONFIG); } else { errors.put(com.google.gerrit.server.git.ReceiveCommits.Error.UPDATE, ctl.getRefName()); } reject(cmd, "can not update the reference as a fast forward"); } }
private static java.lang.String shortenSubject(java.lang.String subject) { if ((subject.length()) < 73) { return subject; } else { return (subject.substring(0, 69)) + "..."; } }
@java.lang.Override public com.google.gerrit.server.project.ProjectState next() { com.google.gerrit.server.project.ProjectState n = next; if (n == null) { throw new java.util.NoSuchElementException(); } next = computeNext(n); return n; }
protected void add(com.google.gerrit.extensions.api.changes.RecipientType rt, com.google.gerrit.reviewdb.client.UserIdentity who) { add(rt, who, false); }
@java.lang.Override public int run() throws java.lang.Exception { mustHaveValidSite(); dbInjector = createDbInjector(com.google.gerrit.pgm.MULTI_USER); limitThreads(); if ((version) == null) { version = com.google.gerrit.server.index.ChangeSchemas.getLatest().getVersion(); } com.google.gerrit.lifecycle.LifecycleManager dbManager = new com.google.gerrit.lifecycle.LifecycleManager(); dbManager.add(dbInjector); dbManager.start(); sysInjector = createSysInjector(); com.google.gerrit.lifecycle.LifecycleManager sysManager = new com.google.gerrit.lifecycle.LifecycleManager(); sysManager.add(sysInjector); sysManager.start(); index = sysInjector.getInstance(com.google.gerrit.server.index.IndexCollection.class).getSearchIndex(); index.markReady(false); index.deleteAll(); int result = indexAll(); index.markReady(true); sysManager.stop(); dbManager.stop(); return result; }
@org.junit.Test public void byLabelGroup() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Account.Id user1 = createAccount("user1"); createAccount("user2"); org.eclipse.jgit.junit.TestRepository<com.google.gerrit.testing.InMemoryRepositoryManager.Repo> repo = createProject("repo"); java.lang.String g1 = createGroup("group1", "Administrators"); java.lang.String g2 = createGroup("group2", "Administrators"); gApi.groups().id(g1).addMembers("user1"); gApi.groups().id(g2).addMembers("user2"); com.google.gerrit.reviewdb.client.Change change1 = insert(repo, newChange(repo), user1); requestContext.setContext(newRequestContext(user1)); gApi.changes().id(change1.getId().get()).current().review(new com.google.gerrit.extensions.api.changes.ReviewInput().label("Code-Review", 1)); requestContext.setContext(newRequestContext(userId)); assertQuery("label:Code-Review=+1,group1", change1); assertQuery("label:Code-Review=+1,group=group1", change1); assertQuery("label:Code-Review=+1,user=user1", change1); assertQuery("label:Code-Review=+1,user=user2"); assertQuery("label:Code-Review=+1,group=group2"); }
boolean canPerform(com.google.gerrit.reviewdb.ApprovalCategory.Id actionId, short level) { final java.util.Set<com.google.gerrit.reviewdb.AccountGroup.Id> groups = getCurrentUser().getEffectiveGroups(); int val = java.lang.Integer.MIN_VALUE; java.util.List<com.google.gerrit.reviewdb.RefRight> allRights = new java.util.ArrayList<com.google.gerrit.reviewdb.RefRight>(); allRights.addAll(getLocalRights(actionId)); if (actionId.canInheritFromWildProject()) { allRights.addAll(getInheritedRights(actionId)); } java.util.SortedMap<java.lang.String, com.google.gerrit.server.project.RefControl.RefRightsForPattern> perPatternRights = com.google.gerrit.server.project.RefControl.sortedRightsByPattern(allRights); for (com.google.gerrit.server.project.RefControl.RefRightsForPattern right : perPatternRights.values()) { val = java.lang.Math.max(val, right.allowedValueForRef(groups)); if ((val >= level) || (right.containsExclusive())) { return val >= level; } } return val >= level; }
@org.junit.Test public void testInalidPathSeparator() { for (char c : com.google.gerrit.server.config.GitwebConfigTest.SOME_INVALID_CHARACTERS.toCharArray()) { assertFalse(("invalid character accepted: " + c), com.google.gerrit.server.config.GitwebConfig.isValidPathSeparator(c)); } }
com.google.gerrit.metrics.Timer1<F1> timer() { return new com.google.gerrit.metrics.Timer1<F1>() { @java.lang.Override public void record(F1 field1, long value, java.util.concurrent.TimeUnit unit) { total.record(value, unit); forceCreate(field1).record(value, unit); } @java.lang.Override public void remove() { doRemove(); } }; }
private com.google.gerrit.reviewdb.client.PatchLineComment newComment() { com.google.gerrit.reviewdb.client.PatchLineComment newComment = new com.google.gerrit.reviewdb.client.PatchLineComment(new com.google.gerrit.reviewdb.client.PatchLineComment.Key(comment.getKey().getParentKey(), null), comment.getLine(), com.google.gerrit.client.Gerrit.getUserAccount().getId(), comment.getKey().get(), new java.sql.Timestamp(java.lang.System.currentTimeMillis())); newComment.setSide(comment.getSide()); return newComment; }
private static void checkConfig(org.eclipse.jgit.lib.Config cfg) { java.util.Set<java.lang.String> keys = new java.util.HashSet<>(); for (com.google.gerrit.server.notedb.NoteDbTable t : com.google.gerrit.server.notedb.NoteDbTable.values()) { keys.add(t.key()); } for (java.lang.String t : cfg.getSubsections(com.google.gerrit.server.notedb.ConfigNotesMigration.NOTE_DB)) { checkArgument(keys.contains(t.toLowerCase()), "invalid NoteDb table: %s", t); for (java.lang.String key : cfg.getNames(com.google.gerrit.server.notedb.ConfigNotesMigration.NOTE_DB, t)) { java.lang.String lk = key.toLowerCase(); checkArgument(((lk.equals(com.google.gerrit.server.notedb.ConfigNotesMigration.WRITE)) || (lk.equals(com.google.gerrit.server.notedb.ConfigNotesMigration.READ))), "invalid NoteDb key: %s.%s", t, key); } } }
com.google.gerrit.extensions.auth.oauth.OAuthUserInfo login(java.lang.String username, java.lang.String secret) throws java.io.IOException;
@java.lang.Override protected java.util.List<com.google.gerrit.reviewdb.client.Comment> parse(byte[] raw, int offset) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { org.eclipse.jgit.util.MutableInteger p = new org.eclipse.jgit.util.MutableInteger(); p.value = offset; if (com.google.gerrit.server.notedb.ChangeRevisionNote.isJson(raw, p.value)) { com.google.gerrit.server.notedb.RevisionNoteData data = parseJson(noteUtil, raw, p.value); if ((status) == (PatchLineComment.Status.PUBLISHED)) { pushCert = data.pushCert; } else { pushCert = null; } return data.comments; } if ((status) == (PatchLineComment.Status.PUBLISHED)) { pushCert = com.google.gerrit.server.notedb.ChangeRevisionNote.parsePushCert(changeId, raw, p); trimLeadingEmptyLines(raw, p); } else { pushCert = null; } return noteUtil.parseNote(raw, p, changeId); }
@org.junit.Test public void getDiffPreferences() throws java.lang.Exception { com.google.gerrit.extensions.client.DiffPreferencesInfo result = gApi.config().server().getDefaultDiffPreferences(); assertPrefsEqual(result, com.google.gerrit.extensions.client.DiffPreferencesInfo.defaults()); }
private boolean shouldPost(com.google.gerrit.server.events.ProjectEvent projectEvent, java.lang.String[] wantedEvents) { if ((wantedEvents.length) == 0) { return true; } for (java.lang.String type : wantedEvents) { if ((!(com.google.common.base.Strings.isNullOrEmpty(type))) && (type.equals(projectEvent.getType()))) { return true; } } return false; }
@java.lang.Override public com.google.gerrit.reviewdb.client.Change update(com.google.gerrit.reviewdb.client.Change c) { if ((c.getStatus().isOpen()) && (ps.getId().equals(c.currentPatchSetId()))) { c.setMergeable(mergeable); c.setLastSha1MergeTested(com.google.gerrit.server.change.Mergeable.toRevId(ref)); return c; } else { return null; } }
private void displayReadOnly(com.google.gerrit.common.data.ProjectAccess access) { this.access = access; java.util.Map<java.lang.String, java.lang.String> allCapabilities = new java.util.HashMap<java.lang.String, java.lang.String>(); for (com.google.gerrit.client.config.CapabilityInfo c : com.google.gerrit.client.rpc.Natives.asList(capabilityMap.values())) { allCapabilities.put(c.id(), c.name()); } this.access.setCapabilities(allCapabilities); accessEditor.setEditing(false); com.google.gwt.user.client.ui.UIObject.setVisible(editTools, ((!(access.getOwnerOf().isEmpty())) || (access.canUpload()))); edit.setEnabled(((!(access.getOwnerOf().isEmpty())) || (access.canUpload()))); cancel1.setVisible(false); com.google.gwt.user.client.ui.UIObject.setVisible(commitTools, false); driver.edit(access); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<com.google.gerrit.extensions.restapi.BinaryResult> apply(com.google.gerrit.server.change.ChangeEditResource rsrc) throws java.io.IOException { try { com.google.gerrit.server.edit.ChangeEdit edit = rsrc.getChangeEdit(); return com.google.gerrit.extensions.restapi.Response.ok(fileContentUtil.getContent(rsrc.getControl().getProjectControl().getProjectState(), (base ? org.eclipse.jgit.lib.ObjectId.fromString(edit.getBasePatchSet().getRevision().get()) : edit.getEditCommit()), rsrc.getPath(), null)); } catch (com.google.gerrit.extensions.restapi.ResourceNotFoundException | com.google.gerrit.extensions.restapi.BadRequestException e) { return com.google.gerrit.extensions.restapi.Response.none(); } }
public static com.google.gwt.safehtml.shared.SafeUri getAddonScriptUri(java.lang.String addon) { return net.codemirror.addon.AddonInjector.addonUris.get(addon); }
@org.junit.Test public void lookUpByEmail() throws java.lang.Exception { assertEmail(emails.getAccountFor(admin.email), admin); java.lang.String email = "foo.bar@example.com"; externalIdsUpdateFactory.create().insert(com.google.gerrit.server.account.externalids.ExternalId.createWithEmail(ExternalId.Key.parse("foo:bar"), admin.id, email)); assertEmail(emails.getAccountFor(email), admin); assertThat(emails.getAccountFor(admin.email.toUpperCase(java.util.Locale.US))).isEmpty(); assertThat(emails.getAccountFor(admin.email.substring(0, admin.email.indexOf('@')))).isEmpty(); assertThat(emails.getAccountFor("non-existing@example.com")).isEmpty(); com.google.common.collect.ImmutableSetMultimap<java.lang.String, com.google.gerrit.reviewdb.client.Account.Id> byEmails = emails.getAccountsFor(admin.email, user.email); assertEmail(byEmails.get(admin.email), admin); assertEmail(byEmails.get(user.email), user); }
public com.google.gerrit.server.notedb.ChangeNotes create(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.reviewdb.client.Project.NameKey project, com.google.gerrit.reviewdb.client.Change.Id changeId) throws com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.client.Change change = db.changes().get(changeId); return new com.google.gerrit.server.notedb.ChangeNotes(repoManager, migration, allUsersProvider, project, change); }
private void preDisplay(final com.google.gerrit.common.data.PatchSetPublishDetail pubDetail, final com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gerrit.common.data.PatchSetPublishDetail> origCb) { com.google.gerrit.client.projects.ConfigInfoCache.get(pubDetail.getChange().getProject(), new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.projects.ConfigInfoCache.Entry>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.projects.ConfigInfoCache.Entry result) { commentLinkProcessor = result.getCommentLinkProcessor(); display(pubDetail); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { origCb.onFailure(caught); } }); }
public boolean hasAnyAccount() throws java.io.IOException { try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(allUsersName)) { return com.google.gerrit.server.account.Accounts.hasAnyAccount(repo); } }
@java.lang.Override protected void onLoad() { super.onLoad(); if ((patchSetDetail) == null) { Util.DETAIL_SVC.patchSetDetail(idSideB, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.common.data.PatchSetDetail>() { @java.lang.Override public void onSuccess(com.google.gerrit.common.data.PatchSetDetail result) { patchSetDetail = result; if ((fileList) == null) { fileList = new com.google.gerrit.client.changes.PatchTable(prefs); fileList.display(result); patchIndex = fileList.indexOf(patchKey); } refresh(true); } }); } else { refresh(true); } }
public void setEmailStrategy(com.google.gerrit.reviewdb.client.AccountGeneralPreferences.EmailStrategy strategy) { this.emailStrategy = strategy.name(); }
@com.google.gwtorm.client.Relation(id = 1) com.google.gwtorm.data.PersonAccess people();
public java.util.Map<java.lang.String, java.util.List<T>> format(java.lang.Iterable<F> comments) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.account.AccountLoader loader = (fillAccounts) ? accountLoaderFactory.create(true) : null; java.util.Map<java.lang.String, java.util.List<T>> out = new java.util.TreeMap<>(); for (F c : comments) { T o = toInfo(c, loader); java.util.List<T> list = out.get(o.path); if (list == null) { list = new java.util.ArrayList<>(); out.put(o.path, list); } o.path = null; list.add(o); } for (java.util.List<T> list : out.values()) { java.util.Collections.sort(list, com.google.gerrit.server.CommentsUtil.COMMENT_INFO_ORDER); } if (loader != null) { loader.fill(); } return out; }
@com.google.gwt.uibinder.client.UiHandler("deleteRevision") void onDeleteRevision(@java.lang.SuppressWarnings("unused") com.google.gwt.event.dom.client.ClickEvent e) { if (com.google.gwt.user.client.Window.confirm(Resources.C.deleteDraftRevision())) { com.google.gerrit.client.change.ChangeActions.delete(getProject(), changeId, revision, publish, deleteRevision); } }
@java.lang.Override public java.util.List<com.google.gerrit.server.notedb.ChangeNotes> setValue(java.util.List<com.google.gerrit.server.notedb.ChangeNotes> value) { throw new java.lang.UnsupportedOperationException(); }
private static java.util.SortedMap<java.lang.String, com.google.gerrit.server.project.RefControl.RefRightsForPattern> sortedRightsByPattern(java.util.List<com.google.gerrit.reviewdb.RefRight> actionRights) { java.util.SortedMap<java.lang.String, com.google.gerrit.server.project.RefControl.RefRightsForPattern> rights = new java.util.TreeMap<java.lang.String, com.google.gerrit.server.project.RefControl.RefRightsForPattern>(com.google.gerrit.server.project.RefControl.DESCENDING_SORT); for (com.google.gerrit.reviewdb.RefRight actionRight : actionRights) { com.google.gerrit.server.project.RefControl.RefRightsForPattern patternRights = rights.get(actionRight.getRefPattern()); if (patternRights == null) { patternRights = new com.google.gerrit.server.project.RefControl.RefRightsForPattern(); rights.put(actionRight.getRefPattern(), patternRights); } patternRights.addRight(actionRight); } return rights; }
public final org.eclipse.jgit.notes.NoteMap commitNewNotes(org.eclipse.jgit.notes.NoteMap notes, java.lang.String notesBranch, org.eclipse.jgit.lib.PersonIdent commitAuthor, java.lang.String commitMessage) throws java.io.IOException { this.overwrite = false; commitNotes(notes, notesBranch, commitAuthor, commitMessage); org.eclipse.jgit.notes.NoteMap newlyCreated = org.eclipse.jgit.notes.NoteMap.newEmptyMap(); for (org.eclipse.jgit.notes.Note n : notes) { if (((base) == null) || (!(base.contains(n)))) { newlyCreated.set(n, n.getData()); } } return newlyCreated; }
public final boolean isEmpty() { return (size()) == 0; }
@org.junit.Test public void pushAccountConfigToUserBranchIsRejected() throws java.lang.Exception { org.eclipse.jgit.junit.TestRepository<org.eclipse.jgit.internal.storage.dfs.InMemoryRepository> allUsersRepo = cloneProject(allUsers); com.google.gerrit.acceptance.GitUtil.fetch(allUsersRepo, ((com.google.gerrit.reviewdb.client.RefNames.refsUsers(admin.id)) + ":userRef")); allUsersRepo.reset("userRef"); org.eclipse.jgit.lib.Config ac = getAccountConfig(allUsersRepo); ac.setString(AccountConfig.ACCOUNT, null, AccountConfig.KEY_STATUS, "OOO"); com.google.gerrit.acceptance.PushOneCommit.Result r = pushFactory.create(db, admin.getIdent(), allUsersRepo, "Update account config", AccountConfig.ACCOUNT_CONFIG, ac.toText()).to(RefNames.REFS_USERS_SELF); r.assertErrorStatus("account update not allowed"); }
@java.lang.Override public com.google.gerrit.server.patch.PatchList get(com.google.gerrit.server.patch.PatchListKey key, com.google.gerrit.reviewdb.client.Project.NameKey project) throws com.google.gerrit.server.patch.PatchListNotAvailableException { try { return fileCache.get(key, fileLoaderFactory.create(key, project)); } catch (java.util.concurrent.ExecutionException e) { PatchListLoader.log.warn(("Error computing " + key), e); throw new com.google.gerrit.server.patch.PatchListNotAvailableException(e); } catch (com.google.common.util.concurrent.UncheckedExecutionException e) { if ((e.getCause()) instanceof org.eclipse.jgit.errors.LargeObjectException) { PatchListLoader.log.warn(("Error computing " + key), e); throw new com.google.gerrit.server.patch.PatchListNotAvailableException(e); } throw e; } }
private void init_sendemail(final org.eclipse.jgit.lib.Config cfg, final org.eclipse.jgit.lib.Config sec) { ui.header("Email Delivery"); java.lang.String def_port = "(default)"; java.lang.String smtpserver = ui.readString("localhost", "SMTP server hostname"); java.lang.String port = ui.readString(def_port, "SMTP server port"); com.google.gerrit.server.mail.SmtpEmailSender.Encryption enc = ui.readEnum(Encryption.NONE, "SMTP encryption"); java.lang.String username = null; if ((enc != (com.google.gerrit.server.mail.SmtpEmailSender.Encryption.NONE)) || (!(com.google.gerrit.pgm.Init.isLocal(smtpserver)))) { username = com.google.gerrit.pgm.Init.username(); } username = ui.readString(username, "SMTP username"); java.lang.String password = (username != null) ? ui.password("%s's password", username) : null; set(cfg, "sendemail", "smtpServer", smtpserver); set(cfg, "sendemail", "smtpServerPort", (port != def_port ? port : null)); set(cfg, "sendemail", "smtpEncryption", enc, Encryption.NONE); set(cfg, "sendemail", "smtpUser", username); set(sec, "sendemail", "smtpPass", password); }
private com.cisco.gerrit.plugins.slack.config.ProjectConfig getConfig(boolean publishOnCommentAdded) throws java.lang.Exception { com.google.gerrit.reviewdb.client.Project.NameKey projectNameKey; projectNameKey = Project.NameKey.parse(com.cisco.gerrit.plugins.slack.message.CommentAddedMessageGeneratorTest.PROJECT_NAME); when(mockConfigFactory.getFromProjectConfigWithInheritance(projectNameKey, ProjectConfig.CONFIG_NAME)).thenReturn(mockPluginConfig); when(mockPluginConfig.getBoolean("enabled", false)).thenReturn(true); when(mockPluginConfig.getString("webhookurl", "")).thenReturn("https://webook/"); when(mockPluginConfig.getString("channel", "general")).thenReturn("testchannel"); when(mockPluginConfig.getString("username", "gerrit")).thenReturn("testuser"); when(mockPluginConfig.getString("ignore", "")).thenReturn("^WIP.*"); when(mockPluginConfig.getBoolean("publish-on-comment-added", true)).thenReturn(publishOnCommentAdded); return new com.cisco.gerrit.plugins.slack.config.ProjectConfig(mockConfigFactory, com.cisco.gerrit.plugins.slack.message.CommentAddedMessageGeneratorTest.PROJECT_NAME); }
protected Project.NameKey createProject(java.lang.String nameSuffix) throws com.google.gerrit.extensions.restapi.RestApiException { return createProject(nameSuffix, null); }
@org.junit.Test public void testNestedQuotes1() { java.lang.String comment = " > > prior\n > \n > next\n"; java.util.List<com.google.gerrit.server.mail.send.CommentFormatter.Block> result = com.google.gerrit.server.mail.send.CommentFormatter.parse(comment); assertThat(result).hasSize(1); assertQuoteBlock(result, 0, 2); assertQuoteBlock(result.get(0).quotedBlocks, 0, 1); assertBlock(result.get(0).quotedBlocks.get(0).quotedBlocks, 0, BlockType.PARAGRAPH, "prior"); assertBlock(result.get(0).quotedBlocks, 1, BlockType.PARAGRAPH, "next\n"); }
public static java.lang.String nameEmail(com.google.gerrit.client.account.AccountInfo info) { java.lang.String name = info.name(); if ((name == null) || (name.trim().isEmpty())) { name = com.google.gerrit.client.Gerrit.info().user().anonymousCowardName(); } java.lang.StringBuilder b = new java.lang.StringBuilder().append(name); if ((info.email()) != null) { b.append(" <").append(info.email()).append(">"); } else if ((info._accountId()) > 0) { b.append(" (").append(info._accountId()).append(")"); } return b.toString(); }
@java.lang.Override public com.google.gerrit.server.config.CacheResource parse(com.google.gerrit.server.config.ConfigResource parent, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceNotFoundException { com.google.gerrit.server.CurrentUser user = self.get(); if (user instanceof com.google.gerrit.server.AnonymousUser) { throw new com.google.gerrit.extensions.restapi.AuthException("Authentication required"); } else if (!(user.isIdentifiedUser())) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } else if (!(user.getCapabilities().canViewCaches())) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed to view caches"); } java.lang.String cacheName = id.get(); java.lang.String pluginName = "gerrit"; int i = cacheName.lastIndexOf('-'); if (i != (-1)) { pluginName = cacheName.substring(0, i); cacheName = ((cacheName.length()) > (i + 1)) ? cacheName.substring((i + 1)) : ""; } com.google.inject.Provider<com.google.common.cache.Cache<?, ?>> cacheProvider = cacheMap.byPlugin(pluginName).get(cacheName); if (cacheProvider == null) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } return new com.google.gerrit.server.config.CacheResource(pluginName, cacheName, cacheProvider); }
public boolean canRead(com.google.gerrit.server.project.ProjectState state, org.eclipse.jgit.lib.Repository repo, org.eclipse.jgit.revwalk.RevCommit commit) { com.google.gerrit.reviewdb.client.Project.NameKey project = state.getNameKey(); try { java.util.List<com.google.gerrit.server.query.change.ChangeData> changes = queryProvider.get().enforceVisibility(true).byProjectCommit(project, commit); if (!(changes.isEmpty())) { return true; } } catch (com.google.gwtorm.server.OrmException e) { com.google.gerrit.server.restapi.project.CommitsCollection.log.error(((("Cannot look up change for commit " + (commit.name())) + " in ") + project), e); } return reachable.fromRefs(state, repo, commit, repo.getAllRefs()); }
@java.lang.Override public org.eclipse.jgit.lib.Ref getRef(java.lang.String name) throws java.io.IOException { org.eclipse.jgit.lib.Ref ref = git.getRefDatabase().getRef(name); if (ref == null) { return null; } try { return perm.filter(com.google.common.collect.ImmutableMap.of(ref.getName(), ref), git, com.google.gerrit.server.permissions.PermissionBackend.RefFilterOptions.builder().setFilterTagsSeparately(true).build()).get(ref.getName()); } catch (com.google.gerrit.server.permissions.PermissionBackendException e) { throw new java.io.IOException(e); } }
@org.junit.Before public void setup() { when(remote.getRetryInterval()).thenReturn(com.googlesource.gerrit.plugins.webhooks.PostTaskTest.RETRY_INTERVAL); when(remote.getMaxTries()).thenReturn(com.googlesource.gerrit.plugins.webhooks.PostTaskTest.MAX_TRIES); when(remote.getUrl()).thenReturn(com.googlesource.gerrit.plugins.webhooks.PostTaskTest.WEBHOOK_URL); when(processor.process(eq(projectCreated), eq(remote))).thenReturn(java.util.Optional.of(content)); task = new com.googlesource.gerrit.plugins.webhooks.PostTask(executor, session, processor, projectCreated, remote); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<?> apply(com.google.gerrit.server.change.ChangeResource rsrc, com.google.gerrit.server.change.PublishDraftPatchSet.Input input) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.git.UpdateException { return publish.apply(rsrc.getControl().getUser(), rsrc.getChange(), rsrc.getChange().currentPatchSetId(), null); }
@java.lang.Override protected void configure() { install(new com.googlesource.gerrit.plugins.xdocs.XDocLoader.Module()); com.google.gerrit.extensions.registration.DynamicSet.bind(binder(), com.google.gerrit.extensions.webui.ProjectWebLink.class).to(com.googlesource.gerrit.plugins.xdocs.XDocWebLink.class); com.google.gerrit.extensions.registration.DynamicSet.bind(binder(), com.google.gerrit.extensions.webui.BranchWebLink.class).to(com.googlesource.gerrit.plugins.xdocs.XDocWebLink.class); com.google.gerrit.extensions.registration.DynamicSet.bind(binder(), com.google.gerrit.extensions.webui.FileWebLink.class).to(com.googlesource.gerrit.plugins.xdocs.XDocPatchWebLink.class); com.google.gerrit.extensions.registration.DynamicSet.bind(binder(), com.google.gerrit.extensions.webui.TopMenu.class).toInstance(new com.google.gerrit.extensions.webui.TopMenu() { @java.lang.Override public java.util.List<com.googlesource.gerrit.plugins.xdocs.MenuEntry> getEntries() { java.lang.StringBuilder url = new java.lang.StringBuilder(); url.append("/plugins/"); url.append(pluginName); url.append(XDocServlet.PATH_PREFIX); url.append("${projectName}/README.md"); return com.google.common.collect.Lists.newArrayList(new com.googlesource.gerrit.plugins.xdocs.MenuEntry(com.google.gerrit.extensions.webui.GerritTopMenu.PROJECTS, com.google.common.collect.Lists.newArrayList(new com.googlesource.gerrit.plugins.xdocs.MenuItem("Readme", url.toString())))); } }); }
@org.junit.Test public void preconditionsFail() throws java.lang.Exception { java.util.List<com.google.gerrit.reviewdb.client.Change.Id> cs = com.google.common.collect.ImmutableList.of(new com.google.gerrit.reviewdb.client.Change.Id(1)); java.util.List<com.google.gerrit.reviewdb.client.Project.NameKey> ps = com.google.common.collect.ImmutableList.of(new com.google.gerrit.reviewdb.client.Project.NameKey("p")); assertMigrationException("Cannot rebuild without noteDb.changes.write=true", ( b) -> b, NoteDbMigrator::rebuild); assertMigrationException("Cannot set both changes and projects", ( b) -> b.setChanges(cs).setProjects(ps), ( m) -> { }); assertMigrationException("Cannot set changes or projects during auto-migration", ( b) -> b.setChanges(cs), NoteDbMigrator::migrate); assertMigrationException("Cannot set changes or projects during auto-migration", ( b) -> b.setProjects(ps), NoteDbMigrator::migrate); setNotesMigrationState(com.google.gerrit.acceptance.server.notedb.READ_WRITE_WITH_SEQUENCE_REVIEW_DB_PRIMARY); assertMigrationException("Migration has already progressed past the endpoint of the \"trial mode\" state", ( b) -> b.setTrialMode(true), NoteDbMigrator::migrate); setNotesMigrationState(com.google.gerrit.acceptance.server.notedb.READ_WRITE_WITH_SEQUENCE_NOTE_DB_PRIMARY); assertMigrationException("Cannot force rebuild changes; NoteDb is already the primary storage for some changes", ( b) -> b.setForceRebuild(true), NoteDbMigrator::migrate); }
@java.lang.Override public com.google.gerrit.extensions.client.GeneralPreferencesInfo apply(com.google.gerrit.server.account.AccountResource rsrc) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { if (((self.get()) != (rsrc.getUser())) && (!(self.get().getCapabilities().canAdministrateServer()))) { throw new com.google.gerrit.extensions.restapi.AuthException("restricted to administrator"); } com.google.gerrit.reviewdb.client.Account.Id accountId = rsrc.getUser().getAccountId(); return readFromGit ? com.google.gerrit.server.account.GetPreferences.readFromGit(accountId, gitMgr, allUsersName, null) : readFromDb(accountId); }
final org.eclipse.jgit.lib.ObjectId apply(org.eclipse.jgit.revwalk.RevWalk rw, org.eclipse.jgit.lib.ObjectInserter ins, org.eclipse.jgit.lib.ObjectId curr) throws com.google.gwtorm.server.OrmException, java.io.IOException { if (isEmpty()) { return null; } org.eclipse.jgit.lib.ObjectId z = org.eclipse.jgit.lib.ObjectId.zeroId(); org.eclipse.jgit.lib.CommitBuilder cb = applyImpl(rw, ins, curr); if (cb == null) { result = z; return z; } else if (cb == (com.google.gerrit.server.notedb.AbstractChangeUpdate.NO_OP_UPDATE)) { return null; } cb.setAuthor(authorIdent); cb.setCommitter(new org.eclipse.jgit.lib.PersonIdent(serverIdent, when)); if (!(curr.equals(z))) { cb.setParentId(curr); } else { cb.setParentIds(); } if ((cb.getTreeId()) == null) { if (curr.equals(z)) { cb.setTreeId(com.google.gerrit.server.notedb.AbstractChangeUpdate.emptyTree(ins)); } else { org.eclipse.jgit.revwalk.RevCommit p = rw.parseCommit(curr); cb.setTreeId(p.getTree()); } } result = ins.insert(cb); return result; }
@java.lang.SuppressWarnings("unchecked") @java.lang.Override protected void run() { java.util.Map<java.lang.String, java.lang.String> logs = new java.util.TreeMap<>(); for (java.util.Enumeration<org.apache.log4j.Logger> logger = org.apache.log4j.LogManager.getCurrentLoggers(); logger.hasMoreElements();) { org.apache.log4j.Logger log = logger.nextElement(); if (((name) == null) || (log.getName().contains(name))) { logs.put(log.getName(), log.getEffectiveLevel().toString()); } } for (java.util.Map.Entry<java.lang.String, java.lang.String> e : logs.entrySet()) { stdout.println((((e.getKey()) + ": ") + (e.getValue()))); } }
public com.google.gerrit.server.diff.PatchListKey toPatchListKey() { return new com.google.gerrit.server.diff.PatchListKey(oldId, parentNum, newId, whitespace, PatchListKey.Algorithm.OPTIMIZED_DIFF); }
@java.lang.Override protected void onLoad() { super.onLoad(); com.google.gerrit.client.rpc.CallbackGroup cbs = new com.google.gerrit.client.rpc.CallbackGroup(); com.google.gerrit.client.config.ConfigServerApi.capabilities(cbs.add(new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.config.CapabilityInfo>>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.config.CapabilityInfo> result) { capabilityMap = result; } @java.lang.Override public void onFailure(java.lang.Throwable caught) { } })); Util.PROJECT_SVC.projectAccess(getProjectKey(), cbs.addGwtjsonrpc(new com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gerrit.common.data.ProjectAccess>(this) { @java.lang.Override public void preDisplay(com.google.gerrit.common.data.ProjectAccess access) { displayReadOnly(access); } })); savedPanel = ACCESS; }
byte[] toByteArray(com.google.gerrit.reviewdb.client.Project.NameKey project) { byte[] a = ((((project.toString()) + ':') + (ref())) + ':').getBytes(java.nio.charset.StandardCharsets.UTF_8); byte[] b = new byte[(a.length) + (org.eclipse.jgit.lib.Constants.OBJECT_ID_STRING_LENGTH)]; java.lang.System.arraycopy(a, 0, b, 0, a.length); id().copyTo(b, a.length); return b; }
@org.junit.Test @com.google.gerrit.acceptance.GerritConfig(name = "change.privateByDefault", value = "true") public void pushWithPrivateByDefaultEnabled() throws java.lang.Exception { assertThat(createChange().getChange().change().isPrivate()).isEqualTo(true); }
@java.lang.Override public java.lang.Void call() throws java.lang.Exception { com.google.gerrit.reviewdb.server.ReviewDb db = sysInjector.getInstance(com.google.gerrit.reviewdb.server.ReviewDb.class); com.google.gerrit.server.git.GitRepositoryManager mgr = sysInjector.getInstance(com.google.gerrit.server.git.GitRepositoryManager.class); repo = mgr.openRepository(project); try { java.util.Map<java.lang.String, org.eclipse.jgit.lib.Ref> refs = repo.getAllRefs(); for (com.google.gerrit.reviewdb.client.Change c : db.changes().byProject(project)) { org.eclipse.jgit.lib.Ref r = refs.get(c.currentPatchSetId().toRefName()); if (r != null) { byId.put(r.getObjectId(), new com.google.gerrit.server.query.change.ChangeData(c)); } } walk(); } finally { repo.close(); org.eclipse.jgit.lib.RepositoryCache.close(repo); } return null; }
@java.lang.Override public void onSuccess(com.google.gerrit.client.projects.ConfigInfoCache.Entry result) { commentLinkProcessor = result.getCommentLinkProcessor(); contentTable.setCommentLinkProcessor(commentLinkProcessor); }
private void renderRow(com.google.gwtexpui.safehtml.client.SafeHtmlBuilder sb) { sb.openDiv().setStyleName(RelatedChanges.R.css().row()); sb.openSpan().setStyleName(RelatedChanges.R.css().pointer()); sb.append(com.google.gerrit.client.change.RelatedChangesTab.POINTER_HTML); sb.closeSpan(); sb.openSpan().setStyleName(RelatedChanges.R.css().subject()); java.lang.String url = url(); if (url != null) { sb.openAnchor().setAttribute("href", url); if (url.startsWith("#")) { sb.setAttribute("onclick", com.google.gerrit.client.change.RelatedChangesTab.OPEN); } if (showBranches) { sb.append(info.branch()).append(": "); } sb.append(info.commit().subject()); sb.closeAnchor(); } else { sb.append(info.commit().subject()); } sb.closeSpan(); sb.openSpan(); com.google.gerrit.client.GitwebLink gw = com.google.gerrit.client.Gerrit.getGitwebLink(); if ((gw != null) && ((!(info.has_change_number())) || (!(info.has_revision_number())))) { sb.setStyleName(RelatedChanges.R.css().gitweb()); sb.setAttribute("title", gw.getLinkName()); sb.append('\u25cf'); } else if (notConnected) { sb.setStyleName(RelatedChanges.R.css().indirect()); sb.setAttribute("title", Resources.C.indirectAncestor()); sb.append('~'); } else if (((info.has_current_revision_number()) && (info.has_revision_number())) && ((info._current_revision_number()) != (info._revision_number()))) { sb.setStyleName(RelatedChanges.R.css().notCurrent()); sb.setAttribute("title", Util.C.notCurrent()); sb.append('\u25cf'); } else { sb.setStyleName(RelatedChanges.R.css().current()); } sb.closeSpan(); sb.closeDiv(); }
private static void checkNothingHappens(com.google.gerrit.common.data.LabelFunction function) { com.google.gerrit.common.data.SubmitRecord.Label myLabel = function.check(com.google.gerrit.common.data.LabelFunctionTest.VERIFIED_LABEL, com.google.common.collect.ImmutableList.of()); assertThat(myLabel.status).isEqualTo(SubmitRecord.Label.Status.MAY); assertThat(myLabel.appliedBy).isNull(); }
@java.lang.Override public void create() throws com.google.gerrit.extensions.restapi.RestApiException { try { changeEditsPost.apply(changeResource, null); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot create change edit", e); } }
public java.util.List<java.util.List<com.google.gerrit.server.change.ChangeJson.ChangeInfo>> formatList2(java.util.List<java.util.List<com.google.gerrit.server.query.change.ChangeData>> in) throws com.google.gwtorm.server.OrmException { accountLoader = accountLoaderFactory.create(has(com.google.gerrit.server.change.DETAILED_ACCOUNTS)); java.lang.Iterable<com.google.gerrit.server.query.change.ChangeData> all = com.google.common.collect.Iterables.concat(in); com.google.gerrit.server.query.change.ChangeData.ensureChangeLoaded(all); if (has(com.google.gerrit.server.change.ALL_REVISIONS)) { com.google.gerrit.server.query.change.ChangeData.ensureAllPatchSetsLoaded(all); } else { com.google.gerrit.server.query.change.ChangeData.ensureCurrentPatchSetLoaded(all); } java.util.Set<com.google.gerrit.reviewdb.client.Change.Id> reviewed = com.google.common.collect.Sets.newHashSet(); if (has(com.google.gerrit.server.change.REVIEWED)) { reviewed = loadReviewed(all); } com.google.gerrit.server.query.change.ChangeData.ensureCurrentApprovalsLoaded(all); java.util.List<java.util.List<com.google.gerrit.server.change.ChangeJson.ChangeInfo>> res = com.google.common.collect.Lists.newArrayListWithCapacity(in.size()); java.util.Map<com.google.gerrit.reviewdb.client.Change.Id, com.google.gerrit.server.change.ChangeJson.ChangeInfo> out = com.google.common.collect.Maps.newHashMap(); for (java.util.List<com.google.gerrit.server.query.change.ChangeData> changes : in) { res.add(toChangeInfo(out, changes, reviewed)); } accountLoader.fill(); return res; }
private void startPoller() { if ((com.google.gerrit.client.Gerrit.isSignedIn()) && (0 < (com.google.gerrit.client.Gerrit.info().change().updateDelay()))) { updateCheck = new com.google.gerrit.client.change.UpdateCheckTimer(this); updateCheck.schedule(); handlers.add(com.google.gerrit.client.ui.UserActivityMonitor.addValueChangeHandler(updateCheck)); } }
private static java.util.List<java.util.Map<java.lang.String, java.lang.Object>> getRefsSoyData(org.eclipse.jgit.lib.RefDatabase refdb, com.google.gitiles.GitilesView view, java.lang.String prefix, com.google.common.collect.Ordering<org.eclipse.jgit.lib.Ref> ordering, @javax.annotation.Nullable org.eclipse.jgit.lib.Ref headLeaf, int limit) throws java.io.IOException { java.util.Collection<org.eclipse.jgit.lib.Ref> refs = refdb.getRefs(prefix).values(); refs = ordering.leastOf(refs, (limit > 0 ? com.google.common.primitives.Ints.saturatedCast((limit + 1L)) : refs.size())); java.util.List<java.util.Map<java.lang.String, java.lang.Object>> result = com.google.common.collect.Lists.newArrayListWithCapacity(refs.size()); for (org.eclipse.jgit.lib.Ref ref : refs) { java.lang.String name = ref.getName().substring(prefix.length()); org.eclipse.jgit.lib.Ref refForName = refdb.getRef(name); if (refForName != null) { boolean needPrefix = !(ref.getName().equals(refForName.getName())); java.util.Map<java.lang.String, java.lang.Object> value = com.google.common.collect.Maps.newHashMapWithExpectedSize(3); value.put("url", com.google.gitiles.GitilesView.revision().copyFrom(view).setRevision(com.google.gitiles.Revision.unpeeled((needPrefix ? ref.getName() : name), ref.getObjectId())).toUrl()); value.put("name", name); if (headLeaf != null) { value.put("isHead", headLeaf.equals(ref)); } result.add(value); } } return result; }
public void doChangeRestoredHook(final com.google.gerrit.reviewdb.client.Change change, final com.google.gerrit.reviewdb.client.Account account, final java.lang.String reason, final com.google.gerrit.reviewdb.server.ReviewDb db) throws com.google.gwtorm.server.OrmException { final com.google.gerrit.server.events.ChangeRestoredEvent event = new com.google.gerrit.server.events.ChangeRestoredEvent(); event.change = eventFactory.asChangeAttribute(change); event.restorer = eventFactory.asAccountAttribute(account); event.reason = reason; fireEvent(change, event, db); final java.util.List<java.lang.String> args = new java.util.ArrayList<java.lang.String>(); addArg(args, "--change", event.change.id); addArg(args, "--change-url", event.change.url); addArg(args, "--project", event.change.project); addArg(args, "--branch", event.change.branch); addArg(args, "--topic", event.change.topic); addArg(args, "--restorer", getDisplayName(account)); addArg(args, "--reason", (reason == null ? "" : reason)); runHook(change.getProject(), changeRestoredHook, args); }
public void dispatchAddAccountsToGroup(com.google.gerrit.reviewdb.client.Account.Id actor, java.util.Collection<com.google.gerrit.reviewdb.client.AccountGroupMember> added, java.sql.Timestamp addedOn) { for (com.google.gerrit.server.audit.GroupMemberAuditListener auditListener : groupMemberAuditListeners) { try { auditListener.onAddAccountsToGroup(actor, added, addedOn); } catch (java.lang.RuntimeException e) { com.google.gerrit.server.audit.AuditService.log.error("failed to log add accounts to group event", e); } } }
@java.lang.Override public boolean markReviewed(com.google.gerrit.reviewdb.client.PatchSet.Id psId, com.google.gerrit.reviewdb.client.Account.Id accountId, java.lang.String path) throws com.google.gwtorm.server.OrmException { try (java.sql.Connection con = java.sql.DriverManager.getConnection(url);java.sql.PreparedStatement stmt = con.prepareStatement(("INSERT INTO ACCOUNT_PATCH_REVIEWS " + ("(ACCOUNT_ID, CHANGE_ID, PATCH_SET_ID, FILE_NAME) VALUES " + "(?, ?, ?, ?)")))) { stmt.setInt(1, accountId.get()); stmt.setInt(2, psId.getParentKey().get()); stmt.setInt(3, psId.get()); stmt.setString(4, path); stmt.executeUpdate(); return true; } catch (java.sql.SQLException e) { com.google.gwtorm.server.OrmException ormException = com.google.gerrit.server.schema.H2AccountPatchReviewStore.convertError("insert", e); if (ormException instanceof com.google.gwtorm.server.OrmDuplicateKeyException) { return false; } throw ormException; } }
void appendHeader(final com.google.gwtexpui.safehtml.client.SafeHtmlBuilder m) { m.openTr(); m.openTd(); m.addStyleName(com.google.gerrit.client.changes.S_ICON_HEADER); m.addStyleName("LeftMostCell"); m.nbsp(); m.closeTd(); m.openTd(); m.setStyleName(com.google.gerrit.client.changes.S_ICON_HEADER); m.nbsp(); m.closeTd(); m.openTd(); m.setStyleName(com.google.gerrit.client.changes.S_DATA_HEADER); m.append(Util.C.patchTableColumnName()); m.closeTd(); m.openTd(); m.setStyleName(com.google.gerrit.client.changes.S_DATA_HEADER); m.append(Util.C.patchTableColumnComments()); m.closeTd(); m.openTd(); m.setStyleName(com.google.gerrit.client.changes.S_DATA_HEADER); m.setAttribute("colspan", 3); m.append(Util.C.patchTableColumnDiff()); m.closeTd(); if (com.google.gerrit.client.Gerrit.isSignedIn()) { m.openTd(); m.setStyleName(com.google.gerrit.client.changes.S_ICON_HEADER); m.append(Util.C.reviewed()); m.closeTd(); } m.closeTr(); }
private java.util.Map<java.lang.String, com.google.gerrit.extensions.common.ActionInfo> toActionMap(com.google.gerrit.server.change.RevisionResource rsrc) { java.util.Map<java.lang.String, com.google.gerrit.extensions.common.ActionInfo> out = new java.util.LinkedHashMap<>(); if (rsrc.getControl().getCurrentUser().isIdentifiedUser()) { com.google.inject.Provider<com.google.gerrit.server.CurrentUser> userProvider = com.google.inject.util.Providers.of(rsrc.getControl().getCurrentUser()); for (com.google.gerrit.extensions.webui.UiAction.Description d : com.google.gerrit.server.extensions.webui.UiActions.from(revisions, rsrc, userProvider)) { out.put(d.getId(), new com.google.gerrit.extensions.common.ActionInfo(d)); } } return out; }
private com.google.gerrit.server.account.AccountSshKey createSshKey(com.google.gerrit.reviewdb.client.Account.Id id, java.lang.String keyFile) throws java.io.IOException { java.nio.file.Path p = java.nio.file.Paths.get(keyFile); if (!(java.nio.file.Files.exists(p))) { throw new java.io.IOException(java.lang.String.format("Cannot add public SSH key: %s is not a file", keyFile)); } java.lang.String content = new java.lang.String(java.nio.file.Files.readAllBytes(p), java.nio.charset.StandardCharsets.UTF_8); return com.google.gerrit.server.account.AccountSshKey.create(id, 1, content); }
@java.lang.Override public void updateRepo(com.google.gerrit.server.git.BatchUpdate.RepoContext ctx) throws java.lang.Exception { changeKind = changeKindCache.getChangeKind(projectControl.getProject().getNameKey(), ctx.getRepository(), priorCommit, commit); if (checkMergedInto) { org.eclipse.jgit.lib.Ref mergedInto = findMergedInto(ctx, dest.get(), commit); if (mergedInto != null) { mergedByPushOp = mergedByPushOpFactory.create(requestScopePropagator, patchSetId, mergedInto.getName()); } } if (updateRef) { ctx.addRefUpdate(new org.eclipse.jgit.transport.ReceiveCommand(org.eclipse.jgit.lib.ObjectId.zeroId(), commit, patchSetId.toRefName())); } }
private com.google.gerrit.server.git.BatchUpdate.ChangeContext newChangeContext(com.google.gerrit.reviewdb.client.Change.Id id) throws java.lang.Exception { com.google.gerrit.reviewdb.client.Change c = newChanges.get(id); if (c == null) { c = db.changes().get(id); } com.google.gerrit.server.notedb.ChangeNotes notes = changeNotesFactory.createForNew(c); com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx = new com.google.gerrit.server.git.BatchUpdate.ChangeContext(changeControlFactory.controlFor(notes, user), new com.google.gerrit.server.git.BatchUpdateReviewDb(db)); if (notesMigration.readChanges()) { ctx.getNotes().load(); } return ctx; }
@com.google.gwtorm.client.Relation(id = 20) com.google.gerrit.reviewdb.ChangeAccess changes();
public boolean canCherryPick(final com.google.gerrit.server.git.MergeSorter mergeSorter, final org.eclipse.jgit.lib.Repository repo, final com.google.gerrit.server.git.CodeReviewCommit mergeTip, final org.eclipse.jgit.revwalk.RevWalk rw, final com.google.gerrit.server.git.CodeReviewCommit toMerge) throws com.google.gerrit.server.git.MergeException { if (mergeTip == null) { return true; } if ((toMerge.getParentCount()) == 0) { return false; } if ((toMerge.getParentCount()) == 1) { try { org.eclipse.jgit.merge.ThreeWayMerger m = newThreeWayMerger(repo, com.google.gerrit.server.git.MergeUtil.createDryRunInserter(repo)); m.setBase(toMerge.getParent(0)); return m.merge(false, mergeTip, toMerge); } catch (java.io.IOException e) { throw new com.google.gerrit.server.git.MergeException(("Cannot merge " + (toMerge.name())), e); } } return (canFastForward(mergeSorter, mergeTip, rw, toMerge)) || (canMerge(mergeSorter, repo, mergeTip, toMerge)); }
@java.lang.Override protected void preDisplay(java.lang.String content) { initEditor(content); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<?> apply(com.google.gerrit.server.group.MemberResource resource, com.google.gerrit.server.restapi.group.AddMembers.Input input) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.MethodNotAllowedException, com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gerrit.extensions.restapi.UnprocessableEntityException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { com.google.gerrit.server.restapi.group.AddMembers.Input in = new com.google.gerrit.server.restapi.group.AddMembers.Input(); in._oneMember = resource.getMember().getAccountId().toString(); return delete.get().apply(resource, in); }
@java.lang.Override public com.google.gerrit.extensions.common.CommentInfo get() throws com.google.gerrit.extensions.restapi.RestApiException { try { return getDraft.apply(draft); } catch (com.google.gwtorm.server.OrmException e) { throw new com.google.gerrit.extensions.restapi.RestApiException("Cannot retrieve draft", e); } }
private void cleanUpReferences(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx, com.google.gerrit.reviewdb.client.Change.Id id, java.util.Collection<com.google.gerrit.reviewdb.client.PatchSet> patchSets) throws com.google.gerrit.server.project.NoSuchChangeException, com.google.gwtorm.server.OrmException { for (com.google.gerrit.reviewdb.client.PatchSet ps : patchSets) { accountPatchReviewStore.get().clearReviewed(ps.getId()); } starredChangesUtil.unstarAll(ctx.getChange().getProject(), id); }
public static com.google.gerrit.client.info.AccountPreferencesInfo getUserPreferences() { return com.google.gerrit.client.Gerrit.myPrefs; }
private com.google.gerrit.common.data.SubmitTypeRecord typeError(java.lang.String err, java.lang.Exception e) { if (logErrors) { if (e == null) { com.google.gerrit.server.project.SubmitRuleEvaluator.log.error(err); } else { com.google.gerrit.server.project.SubmitRuleEvaluator.log.error(err, e); } return com.google.gerrit.server.project.SubmitRuleEvaluator.defaultTypeError(); } else { return com.google.gerrit.server.project.SubmitRuleEvaluator.createTypeError(err); } }
private static java.util.Map<java.lang.String, java.lang.String> getParameters(javax.servlet.http.HttpServletRequest req) { final java.util.Map<java.lang.String, java.lang.String> params = new java.util.HashMap<>(); for (java.lang.String pair : com.google.common.base.Splitter.on(com.google.common.base.CharMatcher.anyOf("&;")).split(req.getQueryString())) { final int eq = pair.indexOf('='); if (0 < eq) { java.lang.String name = pair.substring(0, eq); java.lang.String value = pair.substring((eq + 1)); name = com.google.gerrit.extensions.restapi.Url.decode(name); value = com.google.gerrit.extensions.restapi.Url.decode(value); params.put(name, value); } } return params; }
public void deleteComment(com.google.gerrit.reviewdb.client.PatchLineComment c) { verifyComment(c); checkArgument(draftNotes.containsComment(c), ("Cannot delete this comment" + " because it didn't previously exist as a draft")); deleteComments.add(c); }
@org.junit.Test @com.google.gerrit.acceptance.TestProjectInput(cloneAs = "user") public void deleteAbandonedChangeAsNormalUser() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result changeResult = pushFactory.create(db, user.getIdent(), testRepo).to("refs/for/master"); java.lang.String changeId = changeResult.getChangeId(); com.google.gerrit.reviewdb.client.Change.Id id = changeResult.getChange().getId(); setApiUser(user); gApi.changes().id(changeId).abandon(); exception.expect(com.google.gerrit.extensions.restapi.AuthException.class); exception.expectMessage(java.lang.String.format("Deleting change %s is not permitted", id)); gApi.changes().id(changeId).delete(); }
private java.lang.String readAbandonMessage(org.eclipse.jgit.lib.Config cfg, java.lang.String webUrl) { java.lang.String abandonMessage = cfg.getString(com.google.gerrit.server.config.ChangeCleanupConfig.SECTION, null, com.google.gerrit.server.config.ChangeCleanupConfig.KEY_ABANDON_MESSAGE); if (com.google.common.base.Strings.isNullOrEmpty(abandonMessage)) { abandonMessage = com.google.gerrit.server.config.ChangeCleanupConfig.DEFAULT_ABANDON_MESSAGE; } abandonMessage = abandonMessage.replaceAll("\\$\\{URL\\}", webUrl); return abandonMessage; }
void visibleProjects(com.google.gwt.user.client.rpc.AsyncCallback<java.util.List<com.google.gerrit.reviewdb.Project>> callback);
public java.util.Set<com.google.gerrit.common.data.GroupReference> getGroups() { return groups; }
@java.lang.Override public com.google.gerrit.extensions.restapi.RestView<com.google.gerrit.server.group.GroupResource> list() throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceNotFoundException { return list.get(); }
private void deliverToMembers(com.google.gerrit.server.mail.send.ProjectWatch.Watchers.List matching, com.google.gerrit.reviewdb.client.AccountGroup.UUID startUUID) throws com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.server.ReviewDb db = args.db.get(); java.util.Set<com.google.gerrit.reviewdb.client.AccountGroup.UUID> seen = new java.util.HashSet<>(); java.util.List<com.google.gerrit.reviewdb.client.AccountGroup.UUID> q = new java.util.ArrayList<>(); seen.add(startUUID); q.add(startUUID); while (!(q.isEmpty())) { com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid = q.remove(((q.size()) - 1)); com.google.gerrit.common.data.GroupDescription.Basic group = args.groupBackend.get(uuid); if (!(com.google.common.base.Strings.isNullOrEmpty(group.getEmailAddress()))) { matching.emails.add(new com.google.gerrit.server.mail.Address(group.getEmailAddress())); continue; } com.google.gerrit.reviewdb.client.AccountGroup ig = com.google.gerrit.common.data.GroupDescriptions.toAccountGroup(group); if (ig == null) { continue; } args.groups.getMembers(db, ig.getGroupUUID()).forEach(matching.accounts::add); for (com.google.gerrit.reviewdb.client.AccountGroup.UUID m : args.groupIncludes.subgroupsOf(uuid)) { if (seen.add(m)) { q.add(m); } } } }
public java.util.concurrent.ScheduledThreadPoolExecutor createQueue(int poolsize, java.lang.String prefix, int threadPriority) { com.google.gerrit.server.git.WorkQueue.Executor executor = new com.google.gerrit.server.git.WorkQueue.Executor(poolsize, prefix); executor.setContinueExistingPeriodicTasksAfterShutdownPolicy(false); executor.setExecuteExistingDelayedTasksAfterShutdownPolicy(true); queues.add(executor); if (threadPriority != (java.lang.Thread.NORM_PRIORITY)) { java.util.concurrent.ThreadFactory parent = executor.getThreadFactory(); executor.setThreadFactory(( task) -> { java.lang.Thread t = parent.newThread(task); t.setPriority(threadPriority); return t; }); } return executor; }
public final void addLineClass(net.codemirror.lib.CodeMirror.LineHandle line, net.codemirror.lib.CodeMirror.LineClassWhere where, java.lang.String className) { addLineClassNative(line, where.value(), className); }
@java.lang.Override public com.google.gerrit.common.data.ProjectAccess call() throws com.google.gerrit.server.project.NoSuchProjectException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { pc = open(); com.google.gerrit.server.git.ProjectConfig config; com.google.gerrit.server.git.MetaDataUpdate md = metaDataUpdateFactory.create(projectName); try { config = com.google.gerrit.server.git.ProjectConfig.read(md); if (config.updateGroupNames(groupCache)) { md.setMessage("Update group names\n"); if (config.commit(md)) { projectCache.evict(config.getProject()); pc = open(); } } else if (((config.getRevision()) != null) && (!(config.getRevision().equals(pc.getProjectState().getConfig().getRevision())))) { projectCache.evict(config.getProject()); pc = open(); } } finally { md.close(); } java.util.List<com.google.gerrit.common.data.AccessSection> local = new java.util.ArrayList<com.google.gerrit.common.data.AccessSection>(); java.util.Set<java.lang.String> ownerOf = new java.util.HashSet<java.lang.String>(); for (com.google.gerrit.common.data.AccessSection section : config.getAccessSections()) { com.google.gerrit.server.project.RefControl rc = pc.controlForRef(section.getRefPattern()); if (rc.isOwner()) { local.add(section); ownerOf.add(section.getRefPattern()); } else if (rc.isVisible()) { local.add(section); } } final com.google.gerrit.common.data.ProjectAccess detail = new com.google.gerrit.common.data.ProjectAccess(); detail.setRevision(config.getRevision().name()); detail.setLocal(local); detail.setOwnerOf(ownerOf); if (projectName.equals(wildProject)) { detail.setInheritsFrom(null); } else if ((config.getProject().getParent()) != null) { detail.setInheritsFrom(config.getProject().getParent()); } else { detail.setInheritsFrom(wildProject); } return detail; }
com.google.gerrit.client.diff.PaddingManager getPaddingManager() { return widgetManager; }
public static com.google.gerrit.extensions.events.LifecycleListener start(java.nio.file.Path sitePath) throws java.io.IOException { java.nio.file.Path logdir = com.google.gerrit.common.FileUtil.mkdirsOrDie(new com.google.gerrit.server.config.SitePaths(sitePath).logs_dir, "Cannot create log directory"); if (com.google.gerrit.server.util.SystemLog.shouldConfigure()) { com.google.gerrit.pgm.util.GarbageCollectionLogFile.initLogSystem(logdir); } return new com.google.gerrit.extensions.events.LifecycleListener() { @java.lang.Override public void start() { } @java.lang.Override public void stop() { org.apache.log4j.LogManager.getLogger(GarbageCollection.LOG_NAME).removeAllAppenders(); } }; }
public final com.google.gerrit.extensions.client.GeneralPreferencesInfo.TimeFormat timeFormat() { java.lang.String s = timeFormatRaw(); return s != null ? com.google.gerrit.extensions.client.GeneralPreferencesInfo.TimeFormat.valueOf(s) : null; }
private void assertPushToGroupBranch(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String groupRefName, java.lang.String expectedErrorOnUpdate) throws java.lang.Exception { grant(project, ((com.google.gerrit.reviewdb.client.RefNames.REFS_GROUPS) + "*"), Permission.CREATE, false, com.google.gerrit.acceptance.api.group.REGISTERED_USERS); grant(project, ((com.google.gerrit.reviewdb.client.RefNames.REFS_GROUPS) + "*"), Permission.PUSH, false, com.google.gerrit.acceptance.api.group.REGISTERED_USERS); grant(project, ((com.google.gerrit.reviewdb.client.RefNames.REFS_DELETED_GROUPS) + "*"), Permission.CREATE, false, com.google.gerrit.acceptance.api.group.REGISTERED_USERS); grant(project, ((com.google.gerrit.reviewdb.client.RefNames.REFS_DELETED_GROUPS) + "*"), Permission.PUSH, false, com.google.gerrit.acceptance.api.group.REGISTERED_USERS); grant(project, RefNames.REFS_GROUPNAMES, Permission.PUSH, false, com.google.gerrit.acceptance.api.group.REGISTERED_USERS); org.eclipse.jgit.junit.TestRepository<org.eclipse.jgit.internal.storage.dfs.InMemoryRepository> repo = cloneProject(project); com.google.gerrit.acceptance.GitUtil.fetch(repo, (groupRefName + ":groupRef")); repo.reset("groupRef"); com.google.gerrit.acceptance.PushOneCommit.Result r = pushFactory.create(db, admin.getIdent(), repo, "Update group config", GroupConfig.GROUP_CONFIG_FILE, "some content").to(groupRefName); if (expectedErrorOnUpdate != null) { r.assertErrorStatus(expectedErrorOnUpdate); } else { r.assertOkStatus(); } }
public com.google.gerrit.server.project.ChangeControl controlFor(com.google.gerrit.server.notedb.ChangeNotes notes, com.google.gerrit.server.CurrentUser user) throws com.google.gerrit.server.project.NoSuchChangeException { try { return projectControl.controlFor(notes.getProjectName(), user).controlFor(notes); } catch (com.google.gerrit.server.project.NoSuchProjectException | java.io.IOException e) { throw new com.google.gerrit.server.project.NoSuchChangeException(notes.getChangeId(), e); } }
public void testUnblockRange() { com.google.gerrit.server.project.Util.grant(local, ((LABEL) + "Code-Review"), (-1), (+1), com.google.gerrit.server.project.Util.ANONYMOUS, "refs/heads/*").setBlock(); com.google.gerrit.server.project.Util.grant(local, ((LABEL) + "Code-Review"), (-2), (+2), com.google.gerrit.server.project.Util.DEVS, "refs/heads/*"); com.google.gerrit.server.project.ProjectControl u = util.user(local, com.google.gerrit.server.project.Util.DEVS); com.google.gerrit.common.data.PermissionRange range = u.controlForRef("refs/heads/master").getRange(((LABEL) + "Code-Review")); assertTrue("u can vote -2", range.contains((-2))); assertTrue("u can vote +2", range.contains(2)); }
@com.google.inject.Provides @com.google.inject.Singleton com.google.gerrit.httpd.raw.FontsDevServlet getFontsServlet(@com.google.inject.name.Named(com.google.gerrit.httpd.raw.StaticModule.CACHE) com.google.common.cache.Cache<java.nio.file.Path, com.google.gerrit.httpd.raw.ResourceServlet.Resource> cache) throws java.io.IOException { return getPaths().isDev() ? new com.google.gerrit.httpd.raw.FontsDevServlet(cache, getPaths().builder) : null; }
@java.lang.Override public com.googlecode.prolog_cafe.lang.Operation exec(com.googlecode.prolog_cafe.lang.Prolog engine) throws com.googlecode.prolog_cafe.exceptions.PrologException { engine.cont = cont; engine.setB0(); com.googlecode.prolog_cafe.lang.Term a1 = arg1.dereference(); if (a1 instanceof com.googlecode.prolog_cafe.lang.VariableTerm) { throw new com.googlecode.prolog_cafe.exceptions.PInstantiationException(this, 1); } if (!(a1 instanceof com.googlecode.prolog_cafe.lang.SymbolTerm)) { throw new com.googlecode.prolog_cafe.exceptions.IllegalTypeException(this, 1, "symbol", a1); } java.util.regex.Pattern regex = java.util.regex.Pattern.compile(a1.name()); engine.r1 = new com.googlecode.prolog_cafe.lang.JavaObjectTerm(regex); engine.r2 = arg2; engine.r3 = arg3; engine.r4 = arg4; com.google.gerrit.server.diff.PatchList pl = StoredValues.PATCH_LIST.get(engine); java.util.Iterator<com.google.gerrit.server.diff.PatchListEntry> iter = pl.getPatches().iterator(); engine.r5 = new com.googlecode.prolog_cafe.lang.JavaObjectTerm(iter); return engine.jtry5(gerrit.PRED_commit_delta_4.commit_delta_check, gerrit.PRED_commit_delta_4.commit_delta_next); }
public long getSizeDelta() { return sizeDelta; }
public static com.google.common.collect.SetMultimap<com.google.gerrit.reviewdb.client.Project.NameKey, com.google.gerrit.server.index.change.StalenessChecker.RefState> parseStates(java.lang.Iterable<byte[]> states) { com.google.gerrit.server.index.change.StalenessChecker.RefState.check((states != null), null); com.google.common.collect.SetMultimap<com.google.gerrit.reviewdb.client.Project.NameKey, com.google.gerrit.server.index.change.StalenessChecker.RefState> result = com.google.common.collect.HashMultimap.create(); for (byte[] b : states) { com.google.gerrit.server.index.change.StalenessChecker.RefState.check((b != null), null); java.lang.String s = new java.lang.String(b, java.nio.charset.StandardCharsets.UTF_8); java.util.List<java.lang.String> parts = com.google.common.base.Splitter.on(':').splitToList(s); com.google.gerrit.server.index.change.StalenessChecker.RefState.check(((((parts.size()) == 3) && (!(parts.get(0).isEmpty()))) && (!(parts.get(1).isEmpty()))), s); result.put(new com.google.gerrit.reviewdb.client.Project.NameKey(parts.get(0)), com.google.gerrit.server.index.change.StalenessChecker.RefState.create(parts.get(1), parts.get(2))); } return result; }
protected void setApiHeaders(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse res, java.lang.String contentType) throws java.io.IOException { if (!(com.google.common.base.Strings.isNullOrEmpty(contentType))) { res.setContentType(contentType); } res.setCharacterEncoding(java.nio.charset.StandardCharsets.UTF_8.name()); res.setHeader(HttpHeaders.CONTENT_DISPOSITION, "attachment"); com.google.gitiles.GitilesAccess access = getAccess(req); java.lang.String[] allowOrigin = access.getConfig().getStringList("gitiles", null, "allowOriginRegex"); if ((allowOrigin.length) > 0) { java.lang.String origin = req.getHeader(HttpHeaders.ORIGIN); java.util.regex.Pattern allowOriginPattern = java.util.regex.Pattern.compile(com.google.common.base.Joiner.on("|").join(allowOrigin)); if ((!(com.google.common.base.Strings.isNullOrEmpty(origin))) && (allowOriginPattern.matcher(origin).matches())) { res.setHeader(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, origin); } } else { res.setHeader(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, "*"); } setCacheHeaders(res); }
public void setHintText(java.lang.String text) { if (text == null) { if ((hintText) == null) { return; } hintFocusHandler.removeHandler(); hintFocusHandler = null; hintBlurHandler.removeHandler(); hintBlurHandler = null; keyDownHandler.removeHandler(); keyDownHandler = null; hintText = null; focusHint(); return; } if ((hintText) == null) { hintText = text; hintFocusHandler = addFocusHandler(new com.google.gwt.event.dom.client.FocusHandler() { @java.lang.Override public void onFocus(com.google.gwt.event.dom.client.FocusEvent event) { focusHint(); prevText = getText(); isFocused = true; } }); hintBlurHandler = addBlurHandler(new com.google.gwt.event.dom.client.BlurHandler() { @java.lang.Override public void onBlur(com.google.gwt.event.dom.client.BlurEvent event) { blurHint(); isFocused = false; } }); keyDownHandler = addKeyDownHandler(new com.google.gwt.event.dom.client.KeyDownHandler() { @java.lang.Override public void onKeyDown(final com.google.gwt.event.dom.client.KeyDownEvent event) { onKey(event.getNativeKeyCode()); } }); } else { focusHint(); hintText = text; } if (!(isFocused)) { blurHint(); } }
@java.lang.Override public void onSuccess(com.google.gerrit.client.info.ChangeInfo result) { sent = true; hide(); com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(project, result.legacyId())); }
@org.junit.Test public void reindexPermissions() throws java.lang.Exception { com.google.gerrit.acceptance.TestAccount groupOwner = accountCreator.user2(); com.google.gerrit.extensions.api.groups.GroupInput in = new com.google.gerrit.extensions.api.groups.GroupInput(); in.name = name("group"); in.members = java.util.Collections.singleton(groupOwner).stream().map(( u) -> u.id.toString()).collect(java.util.stream.Collectors.toList()); in.visibleToAll = true; com.google.gerrit.extensions.common.GroupInfo group = gApi.groups().create(in).get(); setApiUser(admin); gApi.groups().id(group.id).index(); setApiUser(groupOwner); gApi.groups().id(group.id).index(); setApiUser(user); exception.expect(com.google.gerrit.extensions.restapi.AuthException.class); exception.expectMessage("not allowed to index group"); gApi.groups().id(group.id).index(); }
@java.lang.Override public java.util.Optional<com.google.gerrit.extensions.restapi.BinaryResult> getFile(java.lang.String filePath) { throw new com.google.gerrit.extensions.restapi.NotImplementedException(); }
public static com.google.gerrit.server.project.SubmitRuleOptions.Builder builder() { return com.google.gerrit.server.project.SubmitRuleOptions.defaults.toBuilder(); }
@java.lang.Override public void onFailure(java.lang.Throwable caught) { enableOnFailure.setEnabled(true); }
public com.google.gerrit.server.config.PluginConfig getPluginConfig(java.lang.String pluginName) { org.eclipse.jgit.lib.Config pluginConfig = pluginConfigs.get(pluginName); if (pluginConfig == null) { pluginConfig = new org.eclipse.jgit.lib.Config(); pluginConfigs.put(pluginName, pluginConfig); } return new com.google.gerrit.server.config.PluginConfig(pluginName, pluginConfig, this); }
@java.lang.Override protected void onInitUI() { super.onInitUI(); setPageTitle(Util.C.projectListTitle()); createProjectLinkPanel = new com.google.gwt.user.client.ui.VerticalPanel(); createProjectLinkPanel.setStyleName(Gerrit.RESOURCES.css().createProjectLink()); createProjectLinkPanel.add(new com.google.gerrit.client.ui.Hyperlink(Util.C.headingCreateProject(), com.google.gerrit.common.PageLinks.ADMIN_CREATE_PROJECT)); add(createProjectLinkPanel); projects = new com.google.gerrit.client.ui.ProjectsTable() { @java.lang.Override protected void onOpenRow(final int row) { com.google.gwt.user.client.History.newItem(link(getRowItem(row))); } private java.lang.String link(final com.google.gerrit.client.projects.ProjectInfo item) { return com.google.gerrit.client.Dispatcher.toProjectAdmin(item.name_key(), ProjectScreen.INFO); } @java.lang.Override protected void populate(final int row, final com.google.gerrit.client.projects.ProjectInfo k) { table.setWidget(row, 1, new com.google.gerrit.client.ui.Hyperlink(k.name(), link(k))); table.setText(row, 2, k.description()); setRowItem(row, k); } }; projects.setSavePointerId(PageLinks.ADMIN_PROJECTS); add(projects); }
@java.lang.Override public java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> onCommitReceived(com.google.gerrit.server.events.CommitReceivedEvent receiveEvent) throws com.google.gerrit.server.git.validators.CommitValidationException { try { com.google.gerrit.server.config.PluginConfig cfg = cfgFactory.getFromProjectConfig(receiveEvent.project.getNameKey(), pluginName); if (!(com.googlesource.gerrit.plugins.uploadvalidator.SubmoduleValidator.isActive(cfg))) { return java.util.Collections.emptyList(); } try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(receiveEvent.project.getNameKey())) { java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> messages = com.googlesource.gerrit.plugins.uploadvalidator.SubmoduleValidator.performValidation(repo, receiveEvent.commit); if (!(messages.isEmpty())) { throw new com.google.gerrit.server.git.validators.CommitValidationException("contains submodules", messages); } } } catch (com.google.gerrit.server.project.NoSuchProjectException | java.io.IOException e) { throw new com.google.gerrit.server.git.validators.CommitValidationException("failed to check on submodules", e); } return java.util.Collections.emptyList(); }
private void assertGroupOwnerPermissions(java.lang.String groupUuid, java.lang.String expectedOwnerUuid) throws com.google.gerrit.extensions.restapi.RestApiException { com.google.gerrit.extensions.api.access.PermissionInfo newPermissionInfo = new com.google.gerrit.extensions.api.access.PermissionInfo(null, null); newPermissionInfo.rules = com.google.common.collect.ImmutableMap.of(expectedOwnerUuid, new com.google.gerrit.extensions.api.access.PermissionRuleInfo(com.google.gerrit.extensions.api.access.PermissionRuleInfo.Action.ALLOW, false)); ProjectAccessInfo access = gApi.projects().name(allUsers.get()).access(); java.lang.String groupRef = com.google.gerrit.reviewdb.client.RefNames.refsGroups(AccountGroup.UUID.parse(groupUuid)); assertThat(access.local).containsKey(groupRef); assertThat(access.local.get(groupRef).permissions).containsExactly(Permission.PUSH, newPermissionInfo, Permission.READ, newPermissionInfo); }
private com.google.gerrit.reviewdb.client.Account parse(org.eclipse.jgit.lib.Config cfg) { com.google.gerrit.reviewdb.client.Account account = new com.google.gerrit.reviewdb.client.Account(accountId, registeredOn); account.setActive(cfg.getBoolean(com.google.gerrit.server.account.AccountConfig.ACCOUNT, null, com.google.gerrit.server.account.AccountConfig.KEY_ACTIVE, true)); account.setFullName(com.google.gerrit.server.account.AccountConfig.get(cfg, com.google.gerrit.server.account.AccountConfig.KEY_FULL_NAME)); java.lang.String preferredEmail = com.google.gerrit.server.account.AccountConfig.get(cfg, com.google.gerrit.server.account.AccountConfig.KEY_PREFERRED_EMAIL); account.setPreferredEmail(preferredEmail); if (((emailValidator) != null) && (!(emailValidator.isValid(preferredEmail)))) { error(new com.google.gerrit.server.git.ValidationError(com.google.gerrit.server.account.AccountConfig.ACCOUNT_CONFIG, java.lang.String.format("Invalid preferred email: %s", preferredEmail))); } account.setStatus(com.google.gerrit.server.account.AccountConfig.get(cfg, com.google.gerrit.server.account.AccountConfig.KEY_STATUS)); return account; }
@org.junit.Test public void changeNumberReturnsChange() throws java.lang.Exception { com.google.gerrit.extensions.api.changes.ChangeApi cApi = gApi.changes().id(changeInfo._number); assertThat(cApi.get().changeId).isEqualTo(changeInfo.changeId); }
private static com.google.gerrit.common.data.PermissionRule deny(com.google.gerrit.common.data.GroupReference group) { com.google.gerrit.common.data.PermissionRule rule = com.google.gerrit.server.schema.Schema_53.rule(group); rule.setDeny(); return rule; }
private void postDeletion(com.google.gerrit.server.project.ProjectResource project, org.eclipse.jgit.transport.ReceiveCommand cmd) { referenceUpdated.fire(project.getNameKey(), cmd, identifiedUser.get().getAccount()); }
@java.lang.Override public com.google.gerrit.extensions.common.CommentInfo update(com.google.gerrit.extensions.api.changes.DraftInput in) throws com.google.gerrit.extensions.restapi.RestApiException { try { return putDraft.apply(draft, in).value(); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot update draft", e); } }
@com.google.gwtorm.server.Query("WHERE age > ? ORDER BY name DESC") com.google.gwtorm.server.ResultSet<com.google.gwtorm.data.Person> olderThanDescByName(int age) throws com.google.gwtorm.server.OrmException;
@java.lang.Override public com.google.gerrit.server.project.CommitResource parse(com.google.gerrit.server.project.ProjectResource parent, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, java.io.IOException { org.eclipse.jgit.lib.ObjectId objectId; try { objectId = org.eclipse.jgit.lib.ObjectId.fromString(id.get()); } catch (java.lang.IllegalArgumentException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(parent.getNameKey());org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo)) { org.eclipse.jgit.revwalk.RevCommit commit = rw.parseCommit(objectId); rw.parseBody(commit); if (!(canRead(parent.getProjectState(), repo, commit))) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } for (int i = 0; i < (commit.getParentCount()); i++) { rw.parseBody(rw.parseCommit(commit.getParent(i))); } return new com.google.gerrit.server.project.CommitResource(parent, commit); } catch (org.eclipse.jgit.errors.MissingObjectException | org.eclipse.jgit.errors.IncorrectObjectTypeException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } }
public static org.eclipse.jgit.lib.ObjectId writeLabels(org.eclipse.jgit.lib.Repository repo, java.util.SortedSet<java.lang.String> labels) throws java.io.IOException { java.util.SortedSet<java.lang.String> invalidLabels = com.google.gerrit.server.StarredChangesUtil.validateLabels(labels); if (!(invalidLabels.isEmpty())) { throw new java.lang.IllegalArgumentException(java.lang.String.format("Invalid star labels: %s", com.google.common.base.Joiner.on(", ").join(labels))); } try (org.eclipse.jgit.lib.ObjectInserter oi = repo.newObjectInserter()) { org.eclipse.jgit.lib.ObjectId id = oi.insert(Constants.OBJ_BLOB, com.google.common.base.Joiner.on("\n").join(labels).getBytes(java.nio.charset.StandardCharsets.UTF_8)); oi.flush(); return id; } }
public static boolean hasNonTrivialSortKeyAfter(com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> p) { com.google.gerrit.server.query.change.SortKeyPredicate after = ((com.google.gerrit.server.query.change.SortKeyPredicate) (find(p, com.google.gerrit.server.query.change.SortKeyPredicate.class, "sortkey_after"))); return (after != null) && ((after.getMaxValue()) > 0); }
private static final native com.google.gwt.core.client.JavaScriptObject get(java.lang.String id);
@org.junit.BeforeClass public static void setTimeForTesting() { final long clockStepMs = java.util.concurrent.TimeUnit.MILLISECONDS.convert(1, java.util.concurrent.TimeUnit.SECONDS); final java.util.concurrent.atomic.AtomicLong clockMs = new java.util.concurrent.atomic.AtomicLong(new org.joda.time.DateTime(2009, 9, 30, 17, 0, 0).getMillis()); org.joda.time.DateTimeUtils.setCurrentMillisProvider(new org.joda.time.DateTimeUtils.MillisProvider() { @java.lang.Override public long getMillis() { return clockMs.getAndAdd(clockStepMs); } }); }
@java.lang.Override public void onAddMembers(com.google.gerrit.server.audit.group.GroupMemberAuditEvent event) { java.util.Optional<com.google.gerrit.server.group.InternalGroup> updatedGroup = groupCache.get(event.getUpdatedGroup()); if (!(updatedGroup.isPresent())) { logFailToLoadUpdatedGroup(event); return; } com.google.gerrit.server.group.InternalGroup group = updatedGroup.get(); try (com.google.gerrit.reviewdb.server.ReviewDb db = unwrapDb(schema.open())) { db.accountGroupMembersAudit().insert(com.google.gerrit.server.group.DbGroupAuditListener.toAccountGroupMemberAudits(event, group.getId())); } catch (com.google.gwtorm.server.OrmException e) { logOrmException("Cannot log add accounts to group event performed by user", event, group.getName(), e); } }
@com.google.gerrit.server.query.change.Operator public com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> projects(java.lang.String name) throws com.google.gerrit.server.query.QueryParseException { if (!(com.google.gerrit.server.query.change.ChangeQueryBuilder.schema(args.indexes).hasField(ChangeField.PROJECTS))) { throw new com.google.gerrit.server.query.QueryParseException(("Unsupported operator: " + (com.google.gerrit.server.query.change.ChangeQueryBuilder.FIELD_PROJECTS))); } return new com.google.gerrit.server.query.change.ProjectPrefixPredicate(name); }
private static com.google.gerrit.common.data.PermissionRule rule(com.google.gerrit.common.data.GroupReference group) { return new com.google.gerrit.common.data.PermissionRule(group); }
public com.google.gerrit.server.project.ChangeControl forUser(final com.google.gerrit.server.CurrentUser who) { if (getCurrentUser().equals(who)) { return this; } return new com.google.gerrit.server.project.ChangeControl(changeDataFactory, getRefControl().forUser(who), notes); }
@java.lang.Override public java.lang.Object apply(com.google.gerrit.server.change.CommentResource rsrc) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.account.AccountInfo.Loader accountLoader = accountLoaderFactory.create(true); com.google.gerrit.server.change.CommentInfo ci = new com.google.gerrit.server.change.CommentInfo(rsrc.getComment(), accountLoader); accountLoader.fill(); return ci; }
@java.lang.Override protected void configure() { boolean configEnableSignedPush = cfg.getBoolean("receive", null, "enableSignedPush", false); boolean havePgp = com.google.gerrit.gpg.BouncyCastleUtil.havePGP(); boolean enableSignedPush = configEnableSignedPush && havePgp; bindConstant().annotatedWith(com.google.gerrit.server.EnableSignedPush.class).to(enableSignedPush); if (configEnableSignedPush && (!havePgp)) { com.google.gerrit.gpg.GpgModule.log.info(("Bouncy Castle PGP not installed; signed push verification is" + " disabled")); } if (!enableSignedPush) { bind(com.google.gerrit.server.api.accounts.GpgApiAdapter.class).to(com.google.gerrit.gpg.GpgModule.NoGpgApi.class); return; } install(new com.google.gerrit.gpg.SignedPushModule()); bind(com.google.gerrit.server.api.accounts.GpgApiAdapter.class).to(com.google.gerrit.gpg.api.GpgApiAdapterImpl.class); factory(GpgKeyApiImpl.Factory.class); com.google.gerrit.extensions.registration.DynamicMap.mapOf(binder(), com.google.gerrit.gpg.GPG_KEY_KIND); child(com.google.gerrit.gpg.ACCOUNT_KIND, "gpgkeys").to(com.google.gerrit.gpg.server.GpgKeys.class); post(com.google.gerrit.gpg.ACCOUNT_KIND, "gpgkeys").to(com.google.gerrit.gpg.server.PostGpgKeys.class); get(com.google.gerrit.gpg.GPG_KEY_KIND).to(GpgKeys.Get.class); delete(com.google.gerrit.gpg.GPG_KEY_KIND).to(com.google.gerrit.gpg.server.DeleteGpgKey.class); }
private java.lang.String getStorageDir() { final java.nio.file.Path tmp = java.nio.file.Paths.get(java.lang.System.getProperty("java.io.tmpdir")).resolve(com.googlesource.gerrit.plugins.javamelody.GerritMonitoringFilter.JavamelodyFilter.JAVAMELODY_PREFIX); if (java.nio.file.Files.isDirectory(tmp)) { com.googlesource.gerrit.plugins.javamelody.GerritMonitoringFilter.log.warn("Javamelody data exists in 'tmp' [{}]. Configuration (if any) will be ignored.", tmp); return tmp.toString(); } java.nio.file.Path storageDir = java.util.Optional.ofNullable(cfg.getString(com.googlesource.gerrit.plugins.javamelody.GerritMonitoringFilter.JavamelodyFilter.STORAGE_DIR)).map(java.nio.file.Paths::get).orElse(defaultDataDir); if (!(java.nio.file.Files.isDirectory(storageDir))) { try { java.nio.file.Files.createDirectories(storageDir); } catch (java.io.IOException e) { com.googlesource.gerrit.plugins.javamelody.GerritMonitoringFilter.log.error("Creation of javamelody data dir [{}] failed.", storageDir, e); throw new java.lang.RuntimeException(e); } } return storageDir.toString(); }
@java.lang.Override public void start() { com.google.gerrit.server.config.ScheduleConfig scheduleConfig = gcConfig.getScheduleConfig(); scheduleConfig.schedule().ifPresent(( s) -> { @java.lang.SuppressWarnings("unused") Future<?> possiblyIgnoredError = queue.getDefaultQueue().scheduleAtFixedRate(gcRunner, s.initialDelay(), s.interval(), TimeUnit.MILLISECONDS); }); }
@org.junit.Test public void remoteUrlUndefinedTaskNotScheduled() { when(config.getSubsections(eq(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.REMOTE))).thenReturn(com.google.common.collect.ImmutableSet.of(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.FOO)); eventHandler.onEvent(projectCreated); verifyZeroInteractions(taskFactory); verifyZeroInteractions(postTask); }
com.google.gerrit.server.change.PostReviewersOp create(com.google.gerrit.server.change.ChangeResource rsrc, java.util.Map<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.server.project.ChangeControl> reviewers, java.util.Collection<com.google.gerrit.server.mail.Address> reviewersByEmail, com.google.gerrit.extensions.client.ReviewerState state, @com.google.gerrit.common.Nullable com.google.gerrit.extensions.api.changes.NotifyHandling notify, com.google.common.collect.ListMultimap<com.google.gerrit.extensions.api.changes.RecipientType, com.google.gerrit.reviewdb.client.Account.Id> accountsToNotify);
@com.google.inject.Provides @com.google.gerrit.server.GerritPersonIdent org.eclipse.jgit.lib.PersonIdent getServerIdent() { return serverIdentProvider.get(); }
protected com.google.gerrit.reviewdb.client.Change newChange() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Change c = com.google.gerrit.testutil.TestChanges.newChange(project, changeOwner.getAccountId()); com.google.gerrit.server.notedb.ChangeUpdate u = newUpdate(c, changeOwner); u.setChangeId(c.getKey().get()); u.setBranch(c.getDest().get()); u.commit(); return c; }
public void setStartCharacter(int sc) { startCharacter = sc; }
@java.lang.Override void send(java.lang.String message) { com.google.gerrit.client.changes.ChangeApi.createChange(project, branch, topic, message, base, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.info.ChangeInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.info.ChangeInfo result) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(result.projectNameKey(), result.legacyId())); hide(); } }); }
public void waitFor(final java.util.concurrent.Future<?> workerFuture) throws java.util.concurrent.ExecutionException { waitFor(workerFuture, 0, null); }
void setReady(java.lang.String indexName, int version, boolean ready) { cfg.setBoolean(com.google.gerrit.lucene.GerritIndexStatus.SECTION, com.google.gerrit.lucene.GerritIndexStatus.indexDirName(indexName, version), com.google.gerrit.lucene.GerritIndexStatus.KEY_READY, ready); }
@java.lang.Override protected void doPost(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse resp) throws java.io.IOException, javax.servlet.ServletException { com.googlesource.gerrit.plugins.lfs.locks.LfsLocksServlet.Action action = new com.googlesource.gerrit.plugins.lfs.locks.LfsLocksServlet.Action(req, resp); java.util.regex.Matcher matcher = com.googlesource.gerrit.plugins.lfs.locks.LfsLocksServlet.LFS_LOCKS_URL_PATTERN.matcher(action.path); if (matcher.matches()) { java.lang.String project = matcher.group(1); java.lang.String lockId = matcher.group(2); if (com.google.common.base.Strings.isNullOrEmpty(lockId)) { createLock(project, action); } else { deleteLock(project, lockId, action); } return; } matcher = com.googlesource.gerrit.plugins.lfs.locks.LfsLocksServlet.LFS_VERIFICATION_URL_PATTERN.matcher(action.path); if (matcher.matches()) { verifyLocks(matcher.group(1), action); return; } action.sendError(com.googlesource.gerrit.plugins.lfs.locks.SC_INTERNAL_SERVER_ERROR, java.lang.String.format("Unsupported path %s was provided", action.path)); }
public com.google.gerrit.server.notedb.rebuild.NoteDbMigrator.Builder setSequenceGap(int sequenceGap) { this.sequenceGap = sequenceGap; return this; }
@org.junit.Test public void createTagForExistingCommit() throws java.lang.Exception { for (com.google.gerrit.acceptance.rest.project.PushTagIT.TagType tagType : com.google.gerrit.acceptance.rest.project.PushTagIT.TagType.values()) { pushTagForExistingCommit(tagType, Status.REJECTED_OTHER_REASON); allowTagCreation(tagType); pushTagForExistingCommit(tagType, Status.OK); allowPushOnRefsTags(); pushTagForExistingCommit(tagType, Status.OK); removePushFromRefsTags(); } }
static java.lang.String getTitle(org.pegdown.ast.Node node) { if (node instanceof org.pegdown.ast.HeaderNode) { if ((((org.pegdown.ast.HeaderNode) (node)).getLevel()) == 1) { return com.google.gitiles.doc.MarkdownHelper.getInnerText(node); } return null; } for (org.pegdown.ast.Node child : node.getChildren()) { java.lang.String title = com.google.gitiles.doc.MarkdownHelper.getTitle(child); if (title != null) { return title; } } return null; }
@java.lang.Override public void start() { com.google.gerrit.server.config.ScheduleConfig scheduleConfig = cfg.getScheduleConfig(); long interval = scheduleConfig.getInterval(); long delay = scheduleConfig.getInitialDelay(); if ((delay == (MISSING_CONFIG)) && (interval == (MISSING_CONFIG))) { com.google.gerrit.server.change.ChangeCleanupRunner.log.info("Ignoring missing changeCleanup schedule configuration"); } else if ((delay < 0) || (interval <= 0)) { com.google.gerrit.server.change.ChangeCleanupRunner.log.warn(java.lang.String.format("Ignoring invalid changeCleanup schedule configuration: %s", scheduleConfig)); } else { queue.getDefaultQueue().scheduleAtFixedRate(runner, delay, interval, java.util.concurrent.TimeUnit.MILLISECONDS); } }
protected Project.NameKey createProject(java.lang.String nameSuffix, com.google.gerrit.reviewdb.client.Project.NameKey parent, com.google.gerrit.extensions.client.SubmitType submitType) throws com.google.gerrit.extensions.restapi.RestApiException { return createProject(nameSuffix, parent, true, submitType); }
@org.junit.Test public void addReviewerByEmailToReviewableChangeInReviewDbBatch() throws java.lang.Exception { addReviewerByEmailToReviewableChangeInReviewDb(batch()); }
@org.junit.Test public void blameJson() throws java.lang.Exception { java.lang.String contents1 = "foo\n"; java.lang.String contents2 = "foo\ncontents\n"; org.eclipse.jgit.revwalk.RevCommit c1 = repo.update("master", repo.commit().add("foo", contents1)); org.eclipse.jgit.revwalk.RevCommit c2 = repo.update("master", repo.commit().tick(10).parent(c1).add("foo", contents2)); java.util.Map<java.lang.String, java.util.List<com.google.gitiles.blame.BlameServletTest.RegionJsonData>> result = getBlameJson((("/test/+blame/" + (c2.name())) + "/foo")); assertEquals("regions", com.google.common.collect.Iterables.getOnlyElement(result.keySet())); java.util.List<com.google.gitiles.blame.BlameServletTest.RegionJsonData> regions = result.get("regions"); assertEquals(2, regions.size()); com.google.gitiles.blame.BlameServletTest.RegionJsonData r1 = regions.get(0); assertEquals(1, r1.start); assertEquals(1, r1.count); assertEquals("foo", r1.path); assertEquals(c1.name(), r1.commit); assertEquals("J. Author", r1.author.name); assertEquals("jauthor@example.com", r1.author.email); assertEquals("2009-03-13 17:29:48 -0330", r1.author.time); com.google.gitiles.blame.BlameServletTest.RegionJsonData r2 = regions.get(1); assertEquals(2, r2.start); assertEquals(1, r2.count); assertEquals("foo", r2.path); assertEquals(c2.name(), r2.commit); assertEquals("J. Author", r2.author.name); assertEquals("jauthor@example.com", r2.author.email); assertEquals("2009-03-13 17:29:58 -0330", r2.author.time); }
public void testOneColumn() { final com.google.gerrit.server.ioutil.ColumnFormatterTest.PrintWriterComparator comparator = new com.google.gerrit.server.ioutil.ColumnFormatterTest.PrintWriterComparator(); final com.google.gerrit.server.ioutil.ColumnFormatter formatter = new com.google.gerrit.server.ioutil.ColumnFormatter(comparator.getPrintWriter(), '\t'); formatter.addColumn("foo"); formatter.nextLine(); formatter.finish(); comparator.assertEquals("foo\n"); }
private com.google.gerrit.server.plugins.Plugin runPlugin(java.lang.String name, java.io.File jar, com.google.gerrit.server.plugins.Plugin oldPlugin) throws com.google.gerrit.server.plugins.PluginInstallException { org.eclipse.jgit.storage.file.FileSnapshot snapshot = org.eclipse.jgit.storage.file.FileSnapshot.save(jar); try { com.google.gerrit.server.plugins.Plugin newPlugin = loadPlugin(name, jar, snapshot); boolean reload = ((oldPlugin != null) && (oldPlugin.canReload())) && (newPlugin.canReload()); if ((!reload) && (oldPlugin != null)) { oldPlugin.stop(); running.remove(name); } if (!(newPlugin.isDisabled())) { newPlugin.start(env); } if (reload) { env.onReloadPlugin(oldPlugin, newPlugin); oldPlugin.stop(); } else if (!(newPlugin.isDisabled())) { env.onStartPlugin(newPlugin); } if (!(newPlugin.isDisabled())) { running.put(name, newPlugin); } else { disabled.put(name, newPlugin); } broken.remove(name); return newPlugin; } catch (java.lang.Throwable err) { broken.put(name, snapshot); throw new com.google.gerrit.server.plugins.PluginInstallException(err); } }
private com.googlesource.gerrit.plugins.quota.Publisher.UsageDataEvent createRepoSizeEvent() throws java.util.concurrent.ExecutionException { com.googlesource.gerrit.plugins.quota.Publisher.UsageDataEvent event = new com.googlesource.gerrit.plugins.quota.Publisher.UsageDataEvent(com.googlesource.gerrit.plugins.quota.Publisher.REPO_SIZE); for (com.google.gerrit.reviewdb.client.Project.NameKey p : projectCache.all()) { long size = repoSizeCache.get(p).get(); event.addData(size, p.get()); } return event; }
@org.junit.Test public void testOwnerGroupsForStarFilter() { com.google.common.collect.ImmutableList<java.lang.String> ownerGroups = com.google.common.collect.ImmutableList.of("group1", "group2"); configureOwnerGroups("*", ownerGroups); assertThat(repoCfg.getOwnerGroups(new com.google.gerrit.reviewdb.client.Project.NameKey("someProject"))).containsExactlyElementsIn(ownerGroups); }
private void reportGroupsAction(java.lang.String action, com.google.gerrit.server.group.GroupResource group, java.util.List<com.google.gerrit.reviewdb.client.AccountGroup.UUID> groupUuidList) throws java.io.IOException, java.io.UnsupportedEncodingException { out.write(java.lang.String.format("Groups %s group %s: %s\n", action, group.getName(), com.google.common.base.Joiner.on(", ").join(com.google.common.collect.Iterables.transform(groupUuidList, new com.google.common.base.Function<com.google.gerrit.reviewdb.client.AccountGroup.UUID, java.lang.String>() { @java.lang.Override public java.lang.String apply(com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid) { return groupCache.get(uuid).getName(); } }))).getBytes(com.google.gerrit.sshd.commands.ENC)); }
public com.google.gerrit.server.change.ChangeJson create(com.google.gerrit.extensions.client.ListChangesOption first, com.google.gerrit.extensions.client.ListChangesOption... rest) { return create(com.google.common.collect.Sets.immutableEnumSet(first, rest)); }
private void threadSummary() { java.util.List<java.lang.String> prefixes = java.util.Arrays.asList("HTTP", "IntraLineDiff", "ReceiveCommits", "SSH git-receive-pack", "SSH git-upload-pack", "SSH-Interactive-Worker", "SSH-Stream-Worker", "SshCommandStart"); java.lang.String other = "Other"; java.lang.Runtime r = java.lang.Runtime.getRuntime(); java.lang.management.ThreadMXBean threadMXBean = java.lang.management.ManagementFactory.getThreadMXBean(); stdout.format("Threads: %d CPUs available, %d threads\n", r.availableProcessors(), threadMXBean.getThreadCount()); if (showThreads) { com.google.common.collect.Table<java.lang.String, java.lang.Thread.State, java.lang.Integer> count = com.google.common.collect.HashBasedTable.create(); for (long id : threadMXBean.getAllThreadIds()) { java.lang.management.ThreadInfo info = threadMXBean.getThreadInfo(id); if (info == null) { continue; } java.lang.String name = info.getThreadName(); java.lang.Thread.State state = info.getThreadState(); java.lang.String group = other; for (java.lang.String p : prefixes) { if (name.startsWith(p)) { group = p; break; } } java.lang.Integer c = count.get(group, state); count.put(group, state, (c != null ? c + 1 : 1)); } stdout.print(java.lang.String.format(" %22s", "")); for (java.lang.Thread.State s : java.lang.Thread.State.values()) { stdout.print(java.lang.String.format(" %14s", s.name())); } stdout.print('\n'); for (java.lang.String p : prefixes) { printThreadCounts(p, count.row(p)); } printThreadCounts(other, count.row(other)); } stdout.print('\n'); }
@org.junit.Test public void testDenyOwnerProject() { com.google.gerrit.server.project.Util.allow(local, com.google.gerrit.server.project.OWNER, com.google.gerrit.server.project.Util.ADMIN, "refs/*"); com.google.gerrit.server.project.Util.deny(local, com.google.gerrit.server.project.OWNER, com.google.gerrit.server.project.Util.DEVS, "refs/*"); assertAdminsAreOwnersAndDevsAreNot(); }
public void testReplaceToLowerCase() { final com.google.gerrit.common.data.ParameterizedString p = new com.google.gerrit.common.data.ParameterizedString("${a.toLowerCase}"); assertEquals(1, p.getParameterNames().size()); assertTrue(p.getParameterNames().contains("a")); final java.util.Map<java.lang.String, java.lang.String> a = new java.util.HashMap<java.lang.String, java.lang.String>(); a.put("a", "foo"); assertNotNull(p.bind(a)); assertEquals(1, p.bind(a).length); assertEquals("foo", p.bind(a)[0]); assertEquals("foo", p.replace(a)); a.put("a", "FOO"); assertNotNull(p.bind(a)); assertEquals(1, p.bind(a).length); assertEquals("foo", p.bind(a)[0]); assertEquals("foo", p.replace(a)); }
private static com.google.gerrit.client.ui.Screen mine(final java.lang.String token) { if (com.google.gerrit.client.Gerrit.isSignedIn()) { return new com.google.gerrit.client.changes.AccountDashboardScreen(com.google.gerrit.client.Gerrit.getUserAccount().getId()); } else { com.google.gerrit.client.ui.Screen r = new com.google.gerrit.client.changes.AccountDashboardScreen(null); r.setRequiresSignIn(true); return r; } }
public java.util.Optional<com.google.gerrit.reviewdb.client.Comment> getPublished(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.notedb.ChangeNotes notes, com.google.gerrit.reviewdb.client.Comment.Key key) throws com.google.gwtorm.server.OrmException { if (!(migration.readChanges())) { return getReviewDb(db, notes, key); } return publishedByChange(db, notes).stream().filter(( c) -> key.equals(c.key)).findFirst(); }
@java.lang.Override protected <T> java.util.concurrent.Callable<T> wrapImpl(java.util.concurrent.Callable<T> callable) { java.util.Map<com.google.inject.Key<?>, java.lang.Object> seedMap = com.google.common.collect.Maps.newHashMap(); java.lang.String url = urlProvider.get(); seedMap.put(com.google.inject.Key.get(typeOfProvider(java.lang.String.class), com.google.gerrit.server.config.CanonicalWebUrl.class), com.google.inject.util.Providers.of(url)); seedMap.put(com.google.inject.Key.get(java.lang.String.class, com.google.gerrit.server.config.CanonicalWebUrl.class), url); java.net.SocketAddress peer = remotePeerProvider.get(); seedMap.put(com.google.inject.Key.get(typeOfProvider(java.net.SocketAddress.class), com.google.gerrit.server.RemotePeer.class), com.google.inject.util.Providers.of(peer)); seedMap.put(com.google.inject.Key.get(java.net.SocketAddress.class, com.google.gerrit.server.RemotePeer.class), peer); com.google.gerrit.server.CurrentUser user = currentUserProvider.get(); seedMap.put(com.google.inject.Key.get(typeOfProvider(com.google.gerrit.server.CurrentUser.class)), com.google.inject.util.Providers.of(user)); seedMap.put(com.google.inject.Key.get(com.google.gerrit.server.CurrentUser.class), user); return com.google.inject.servlet.ServletScopes.continueRequest(callable, seedMap); }
public com.googlesource.gerrit.plugins.supermanifest.JiriManifest.Import[] getImports() { return imports; }
@java.lang.Override public void onChangeRestored(com.google.gerrit.extensions.events.ChangeRestoredListener.Event ev) { try { com.google.gerrit.server.notedb.ChangeNotes notes = getNotes(ev.getChange()); hooks.doChangeRestoredHook(notes.getChange(), getAccount(ev.getRestorer()), getPatchSet(notes, ev.getRevision()), ev.getReason(), db.get()); } catch (com.google.gwtorm.server.OrmException e) { com.google.gerrit.common.ChangeHookApiListener.log.error(("ChangeRestored hook failed to run " + (ev.getChange()._number)), e); } }
public static void updateDraft(@com.google.gerrit.common.Nullable java.lang.String project, com.google.gerrit.reviewdb.client.PatchSet.Id id, java.lang.String draftId, com.google.gerrit.client.changes.CommentInfo content, com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.changes.CommentInfo> cb) { CommentApi.revision(project, id, "drafts").id(draftId).put(content, cb); }
void setShowTabs(boolean show) { cmBase.extras().showTabs(show); cmEdit.extras().showTabs(show); }
public void execute() { java.lang.String t = com.google.gwt.user.client.History.getToken(); if (t == null) { t = ""; } com.google.gerrit.client.Gerrit.doSignIn(((com.google.gerrit.common.PageLinks.REGISTER) + t)); }
@java.lang.Override public void onClick(com.google.gwt.event.dom.client.ClickEvent event) { boolean checked = ((com.google.gwt.user.client.ui.CheckBox) (event.getSource())).getValue(); if (checked) { com.google.gerrit.client.changes.ChangeList.next((((("project:" + project) + " AND branch:") + branch) + " AND is:open NOT age:90d"), 0, 1000, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.changes.ChangeList>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.changes.ChangeList result) { changes = com.google.gerrit.client.rpc.Natives.asList(result); base.setEnabled(true); } }); } else { base.setEnabled(false); } }
private com.google.gerrit.reviewdb.client.ChangeMessage message(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx, com.google.gerrit.server.git.CodeReviewCommit commit, com.google.gerrit.server.git.strategy.CommitMergeStatus s) { checkNotNull(s, "CommitMergeStatus may not be null"); java.lang.String txt = s.getMessage(); if (s == (CommitMergeStatus.CLEAN_MERGE)) { return message(ctx, commit.getPatchsetId(), (txt + (getByAccountName()))); } else if ((s == (CommitMergeStatus.CLEAN_REBASE)) || (s == (CommitMergeStatus.CLEAN_PICK))) { return message(ctx, commit.getPatchsetId(), (((txt + " as ") + (commit.name())) + (getByAccountName()))); } else if (s == (CommitMergeStatus.SKIPPED_IDENTICAL_TREE)) { return message(ctx, commit.getPatchsetId(), txt); } else if (s == (CommitMergeStatus.ALREADY_MERGED)) { switch (args.submitType) { case FAST_FORWARD_ONLY : case MERGE_ALWAYS : case MERGE_IF_NECESSARY : return message(ctx, commit, CommitMergeStatus.CLEAN_MERGE); case CHERRY_PICK : return message(ctx, commit, CommitMergeStatus.CLEAN_PICK); case REBASE_IF_NECESSARY : return message(ctx, commit, CommitMergeStatus.CLEAN_REBASE); default : throw new java.lang.IllegalStateException(((("unexpected submit type " + (args.submitType.toString())) + " for change ") + (commit.change().getId()))); } } else { throw new java.lang.IllegalStateException((((("unexpected status " + s) + " for change ") + (commit.change().getId())) + "; expected to previously fail fast")); } }
public com.google.gerrit.acceptance.TestAccount admin() throws java.lang.Exception { return create("admin", "admin@example.com", "Administrator", "Administrators"); }
com.googlesource.gerrit.plugins.findowners.OwnersDb get(com.google.gerrit.server.account.AccountCache accountCache, com.google.gerrit.server.account.Accounts accounts, org.eclipse.jgit.lib.Repository repository, com.google.gerrit.server.query.change.ChangeData changeData, int patchset) throws com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.client.Project.NameKey project = changeData.change().getProject(); java.lang.String branch = changeData.change().getDest().get(); java.lang.String dbKey = com.googlesource.gerrit.plugins.findowners.Cache.makeKey(changeData.getId().get(), patchset, branch); return get(accountCache, accounts, dbKey, repository, project, branch, changeData.currentFilePaths()); }
@java.lang.Override public synchronized void startup(com.google.gerrit.server.git.WorkQueue workQueue) { currentConfig.startup(workQueue); }
@java.lang.Override public void onSuccess(com.google.gwt.core.client.JavaScriptObject in) { com.google.gerrit.client.api.DefaultActions.UiResult result = asUiResult(in); if (result == null) { com.google.gerrit.client.Gerrit.display(target); return; } if ((result.alert()) != null) { com.google.gwt.user.client.Window.alert(result.alert()); } if (((result.redirectUrl()) != null) && (result.openWindow())) { com.google.gwt.user.client.Window.open(result.redirectUrl(), "_blank", null); } else if ((result.redirectUrl()) != null) { com.google.gwt.user.client.Window.Location.assign(result.redirectUrl()); } else { com.google.gerrit.client.Gerrit.display(target); } }
@org.junit.Test public void noCopyMinScoreOnRework() throws java.lang.Exception { java.lang.String subject = "test commit"; java.lang.String file = "a.txt"; com.google.gerrit.acceptance.PushOneCommit push = pushFactory.create(db, user.getIdent(), subject, file, "first contents"); com.google.gerrit.acceptance.PushOneCommit.Result r = push.to(git, "refs/for/master"); revision(r).review(com.google.gerrit.extensions.api.changes.ReviewInput.reject()); assertApproval(r, (-2)); push = pushFactory.create(db, user.getIdent(), subject, file, "second contents", r.getChangeId()); r = push.to(git, "refs/for/master"); assertApproval(r, 0); }
protected void assertRebase(org.eclipse.jgit.junit.TestRepository<?> testRepo, boolean contentMerge) throws java.lang.Exception { org.eclipse.jgit.lib.Repository repo = testRepo.getRepository(); org.eclipse.jgit.revwalk.RevCommit localHead = getHead(repo); org.eclipse.jgit.revwalk.RevCommit remoteHead = getRemoteHead(); assertThat(localHead.getId()).isNotEqualTo(remoteHead.getId()); assertThat(remoteHead.getParentCount()).isEqualTo(1); if (!contentMerge) { assertThat(getLatestRemoteDiff()).isEqualTo(getLatestDiff(repo)); } assertThat(remoteHead.getShortMessage()).isEqualTo(localHead.getShortMessage()); }
private void rejectImplicitMerges(java.util.Set<org.eclipse.jgit.revwalk.RevCommit> mergedParents) throws java.io.IOException, org.eclipse.jgit.errors.IncorrectObjectTypeException, org.eclipse.jgit.errors.MissingObjectException { if (!(mergedParents.isEmpty())) { org.eclipse.jgit.lib.Ref targetRef = allRefs.get(magicBranch.ctl.getRefName()); if (targetRef != null) { org.eclipse.jgit.revwalk.RevWalk rw = rp.getRevWalk(); org.eclipse.jgit.revwalk.RevCommit tip = rw.parseCommit(targetRef.getObjectId()); boolean containsImplicitMerges = true; for (org.eclipse.jgit.revwalk.RevCommit p : mergedParents) { containsImplicitMerges &= !(rw.isMergedInto(p, tip)); } if (containsImplicitMerges) { rw.reset(); for (org.eclipse.jgit.revwalk.RevCommit p : mergedParents) { rw.markStart(p); } rw.markUninteresting(tip); org.eclipse.jgit.revwalk.RevCommit c; while ((c = rw.next()) != null) { rw.parseBody(c); messages.add(new com.google.gerrit.server.git.validators.CommitValidationMessage(((("ERROR: Implicit Merge of " + (c.abbreviate(7).name())) + " ") + (c.getShortMessage())), false)); } reject(magicBranch.cmd, "implicit merges detected"); } } } }
private com.google.gerrit.server.git.MergeTip preMerge(com.google.gerrit.server.git.strategy.SubmitStrategy strategy, java.util.List<com.google.gerrit.server.query.change.ChangeData> submitted, com.google.gerrit.server.git.CodeReviewCommit branchTip) throws com.google.gerrit.server.git.IntegrationException, com.google.gwtorm.server.OrmException { logDebug("Running submit strategy {} for {} commits {}", strategy.getClass().getSimpleName(), submitted.size(), submitted); java.util.List<com.google.gerrit.server.git.CodeReviewCommit> toMerge = new java.util.ArrayList(submitted.size()); for (com.google.gerrit.server.query.change.ChangeData cd : submitted) { com.google.gerrit.server.git.CodeReviewCommit commit = commits.get(cd.change().getId()); checkState((commit != null), "commit for %s not found by validateChangeList", cd.change().getId()); toMerge.add(commit); } com.google.gerrit.server.git.MergeTip mergeTip = strategy.run(branchTip, toMerge); refLogIdent = strategy.getRefLogIdent(); logDebug("Produced {} new commits", strategy.getNewCommits().size()); commits.putAll(strategy.getNewCommits()); return mergeTip; }
private void initProjectActions(com.google.gerrit.client.projects.ConfigInfo info) { actionsGrid.clear(true); actionsGrid.removeAllRows(); com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.actions.ActionInfo> actions = info.actions(); if ((actions == null) || (actions.isEmpty())) { return; } actions.copyKeysIntoChildren("id"); actionsGrid.addHeader(new com.google.gerrit.client.ui.SmallHeading(Util.C.headingProjectCommands())); com.google.gwt.user.client.ui.FlowPanel actionsPanel = new com.google.gwt.user.client.ui.FlowPanel(); actionsPanel.setStyleName(Gerrit.RESOURCES.css().projectActions()); actionsPanel.setVisible(true); actionsGrid.add(Util.C.headingCommands(), actionsPanel); for (java.lang.String id : actions.keySet()) { actionsPanel.add(new com.google.gerrit.client.actions.ActionButton(getProjectKey(), actions.get(id))); } }
private void doPerformAction(final java.lang.String issueKey, final java.lang.String actionName) throws com.googlesource.gerrit.plugins.its.base.its.InvalidTransitionException, java.io.IOException { log.debug(((("Trying to perform action: " + actionName) + " on issue ") + issueKey)); boolean ret = client().doTransition(issueKey, actionName); if (ret) { log.debug(((("Action " + actionName) + " successful on Issue ") + issueKey)); } else { log.debug("Action {} on Issue {} not possible", actionName, issueKey); } }
@java.lang.Override public java.util.List<com.google.gerrit.reviewdb.Project> call() throws java.lang.Exception { return suggestParentCandidates.getProjects(); }
@java.lang.Override public boolean reindexIfStale(com.google.gerrit.reviewdb.client.Account.Id id) throws java.io.IOException { if (stalenessChecker.isStale(id)) { index(id); return true; } return false; }
private java.lang.String getEncodedPath(javax.servlet.http.HttpServletRequest req) { java.lang.String path = req.getRequestURI(); java.lang.String prefix = "/plugins/" + (pluginName); if (path.startsWith(prefix)) { path = path.substring(prefix.length()); } return path; }
@org.junit.Test public void checkTrustChainUsingCheckerWithoutExpectedKey() throws java.lang.Exception { com.google.gerrit.gpg.testutil.TestKey keyA = add(keyA(), user); com.google.gerrit.gpg.testutil.TestKey keyB = add(keyB(), addUser("userB")); com.google.gerrit.gpg.testutil.TestKey keyC = add(keyC(), addUser("userC")); com.google.gerrit.gpg.testutil.TestKey keyD = add(keyD(), addUser("userD")); com.google.gerrit.gpg.testutil.TestKey keyE = add(keyE(), addUser("userE")); com.google.gerrit.gpg.GerritPublicKeyChecker checker = checkerFactory.create(); assertNoProblems(checker.check(keyA.getPublicKey(), store)); assertProblems(checker.check(keyB.getPublicKey(), store), Status.BAD, "Key is expired"); assertNoProblems(checker.check(keyC.getPublicKey(), store)); assertNoProblems(checker.check(keyD.getPublicKey(), store)); assertProblems(checker.check(keyE.getPublicKey(), store), Status.BAD, "Key is expired", "No path to a trusted key"); }
private boolean canSkipValidation(com.google.gerrit.server.config.PluginConfig config, java.lang.String validatorOp) { return matchCriteria(config, "skipValidation", validatorOp, false); }
@java.lang.Override public void start() { queue.start(); if (((srvInfo.getState()) == (ServerInformation.State.STARTUP)) && (queue.replicateAllOnPluginStart)) { com.googlesource.gerrit.plugins.replication.ReplicationState state = new com.googlesource.gerrit.plugins.replication.ReplicationState(ReplicationType.STARTUP); pushAllFuture.set(pushAll.create(null, state).schedule(30, java.util.concurrent.TimeUnit.SECONDS)); } }
private com.google.gerrit.server.plugins.PluginEntry resourceOf(java.util.jar.JarEntry jarEntry) throws java.io.IOException { return new com.google.gerrit.server.plugins.PluginEntry(jarEntry.getName(), jarEntry.getTime(), jarEntry.getSize(), attributesOf(jarEntry)); }
boolean shouldProcessMessage(com.google.gerrit.server.mail.receive.MailMessage message);
@org.junit.Test public void branchAlreadyExists_Conflict() throws java.lang.Exception { assertCreateSucceeds(testBranch); assertCreateFails(testBranch, com.google.gerrit.extensions.restapi.ResourceConflictException.class); }
public boolean isFileOrCommitMessage() { return !((((side) == (com.google.gerrit.client.patches.PatchSetSelectBox.Side.A)) && (0 >= (script.getA().size()))) || (((side) == (com.google.gerrit.client.patches.PatchSetSelectBox.Side.B)) && (0 >= (script.getB().size())))); }
private com.googlesource.gerrit.plugins.github.notification.WebhookEventHandler<?> getWebhookHandler(java.lang.String name) { if (name == null) { com.googlesource.gerrit.plugins.github.notification.WebhookServlet.logger.error("Null event name: cannot find any handler for it"); return null; } com.googlesource.gerrit.plugins.github.notification.WebhookEventHandler<?> handler = handlerByName.get(name); if (handler != null) { return handler; } try { java.lang.String className = eventClassName(name); java.lang.Class<?> clazz = java.lang.Class.forName(className); handler = ((com.googlesource.gerrit.plugins.github.notification.WebhookEventHandler<?>) (injector.getInstance(clazz))); handlerByName.put(name, handler); com.googlesource.gerrit.plugins.github.notification.WebhookServlet.logger.info("Loaded {}", clazz.getName()); } catch (java.lang.ClassNotFoundException e) { com.googlesource.gerrit.plugins.github.notification.WebhookServlet.logger.error((("Handler '" + name) + "' not found. Skipping"), e); } return handler; }
private static boolean isUnreasonableName(java.lang.String name) { return ((((((name.length()) < 1) || (name.contains("\\"))) || (name.startsWith("../"))) || (name.contains("/../"))) || (name.contains("/./"))) || (name.contains("//")); }
@java.lang.Override protected void configure() { listener().to(JettyServer.Lifecycle.class); }
private void createWidgets(final java.lang.String popupText, final java.lang.String currentPageLink) { projectsTab = new com.google.gerrit.client.ui.ProjectsTable() { @java.lang.Override protected void movePointerTo(final int row, final boolean scroll) { super.movePointerTo(row, scroll); onMovePointerTo(getRowItem(row).name()); } @java.lang.Override protected void onOpenRow(final int row) { super.onOpenRow(row); openRow(getRowItem(row).name()); } }; projectsTab.setSavePointerId(currentPageLink); close = new com.google.gwt.user.client.ui.Button(Util.C.projectsClose()); close.addClickHandler(new com.google.gwt.event.dom.client.ClickHandler() { @java.lang.Override public void onClick(final com.google.gwt.event.dom.client.ClickEvent event) { closePopup(); } }); popup = new com.google.gwtexpui.user.client.PluginSafeDialogBox(); popup.setModal(false); popup.setText(popupText); }
public void configureProject(org.eclipse.jgit.lib.ProgressMonitor progress) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException, org.eclipse.jgit.errors.RepositoryNotFoundException { com.google.gerrit.server.git.MetaDataUpdate md = metaDataUpdateFactory.create(getProjectNameKey()); try { config = com.google.gerrit.server.git.ProjectConfig.read(md); progress.beginTask("Configure Gerrit project", 2); setProjectSettings(); progress.update(1); setProjectPermissions(); progress.update(1); md.setMessage(("Imported from " + (sourceUri))); config.commit(md); projectCache.onCreateProject(getProjectNameKey()); } finally { md.close(); progress.endTask(); } }
@java.lang.Override public void setPredicate(java.lang.String pkg, java.lang.String functor, com.googlecode.prolog_cafe.lang.Term... args) { init(); super.setPredicate(pkg, functor, args); }
public void addComment(java.lang.String issueKey, com.atlassian.jira.rest.client.api.domain.Comment comment) throws com.atlassian.jira.rest.client.api.RestClientException, java.net.URISyntaxException { com.googlesource.gerrit.plugins.its.jira.JiraClient.log.debug(("Trying to add comment for issue " + issueKey)); com.atlassian.jira.rest.client.api.domain.Issue issue = getIssue(issueKey); java.net.URI issueUri; issueUri = new java.net.URI(((issue.getSelf().toString()) + "/comment/")); com.atlassian.jira.rest.client.api.IssueRestClient issueClient = client.getIssueClient(); com.atlassian.util.concurrent.Promise<java.lang.Void> promise = issueClient.addComment(issueUri, comment); promise.claim(); com.googlesource.gerrit.plugins.its.jira.JiraClient.log.debug(("Comment added to issue " + issueKey)); }
private java.lang.Runnable maybeNextVimSearch(final net.codemirror.lib.CodeMirror cm) { return new java.lang.Runnable() { @java.lang.Override public void run() { if (cm.hasVimSearchHighlight()) { net.codemirror.lib.CodeMirror.handleVimKey(cm, "n"); } else { chunkManager.diffChunkNav(cm, Direction.NEXT).run(); } } }; }
@org.junit.Test public void testOwnerGroupsWhenNotConfigured() { assertThat(repoCfg.getOwnerGroups(new com.google.gerrit.reviewdb.client.Project.NameKey("someProject"))).isEqualTo(new java.lang.String[]{ }); }
@java.lang.Override public void onClose(com.google.gwt.event.logical.shared.CloseEvent<com.google.gerrit.client.ui.RemoteSuggestBox> event) { hide(); fileTable.registerKeys(); }
public void reset() { if ((com.google.gerrit.client.Gerrit.isSignedIn()) && ((com.google.gerrit.client.Gerrit.getDiffPreferences()) != null)) { set(com.google.gerrit.client.Gerrit.getDiffPreferences()); } else { set(com.google.gerrit.extensions.client.DiffPreferencesInfo.defaults()); } }
public final native boolean isTrusted();
@org.junit.Test public void testWithSymlink() throws java.lang.Exception { org.eclipse.jgit.revwalk.RevCommit c = makeCommitWithSymlink(); java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> m = com.googlesource.gerrit.plugins.uploadvalidator.SymlinkValidator.performValidation(repo, c); java.util.Set<java.lang.String> expected = com.google.common.collect.ImmutableSet.of("ERROR: Symbolic links are not allowed: foo.txt", "ERROR: Symbolic links are not allowed: symbolicFolder"); assertThat(com.googlesource.gerrit.plugins.uploadvalidator.TestUtils.transformMessages(m)).containsExactlyElementsIn(expected); }
@com.google.gerrit.server.query.change.Operator public com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> file(java.lang.String file) throws com.google.gerrit.server.query.QueryParseException { if (allowFileRegex) { if (file.startsWith("^")) { return new com.google.gerrit.server.query.change.RegexFilePredicate(args.dbProvider, args.patchListCache, file); } else { throw new java.lang.IllegalArgumentException(); } } else { if ((!(file.startsWith("^"))) && ((args.index) != (com.google.gerrit.server.index.ChangeIndex.DISABLED))) { return new com.google.gerrit.server.index.PredicateWrapper(args.index, new com.google.gerrit.server.query.change.EqualsFilePredicate(args.dbProvider, args.patchListCache, file)); } else { throw error(("regular expression not permitted here: file:" + file)); } } }
private static java.lang.String randSuffix() { com.google.common.hash.Hasher h = com.google.common.hash.Hashing.murmur3_128().newHasher(); byte[] buf = new byte[8]; org.eclipse.jgit.util.NB.encodeInt64(buf, 0, com.google.gerrit.common.TimeUtil.nowMs()); h.putBytes(buf); com.google.gerrit.server.change.FileContentUtil.rng.nextBytes(buf); h.putBytes(buf); return h.hash().toString(); }
@java.lang.Override public void onShowView() { super.onShowView(); com.google.gwt.user.client.Window.enableScrolling(false); if (prefs.hideTopMenu()) { com.google.gerrit.client.Gerrit.setHeaderVisible(false); } resizeHandler = com.google.gwt.user.client.Window.addResizeHandler(new com.google.gwt.event.logical.shared.ResizeHandler() { @java.lang.Override public void onResize(com.google.gwt.event.logical.shared.ResizeEvent event) { resizeCodeMirror(); } }); final int height = getCodeMirrorHeight(); operation(new java.lang.Runnable() { @java.lang.Override public void run() { cmA.setHeight(height); cmB.setHeight(height); cmA.refresh(); cmB.refresh(); } }); diffTable.sidePanel.adjustGutters(cmB); if (((startSide) == null) && ((diff.meta_b()) != null)) { com.google.gerrit.client.diff.DiffChunkInfo d = chunkManager.getFirst(); if (d != null) { startSide = d.getSide(); startLine = (d.getStart()) + 1; } } if (((startSide) != null) && ((startLine) > 0)) { int line = (startLine) - 1; net.codemirror.lib.CodeMirror cm = getCmFromSide(startSide); if ((cm.lineAtHeight((height - 20))) < line) { cm.scrollToY(((cm.heightAtLine(line, "local")) - (0.5 * height))); } cm.setCursor(net.codemirror.lib.LineCharacter.create(line)); cm.focus(); } else { cmA.setCursor(net.codemirror.lib.LineCharacter.create(0)); cmA.focus(); } if ((com.google.gerrit.client.Gerrit.isSignedIn()) && (prefs.autoReview())) { header.autoReview(); } prefetchNextFile(); }
public void validateNewProject(com.google.gerrit.server.project.CreateProjectArgs args) throws com.google.gerrit.server.validators.ValidationException;
@java.lang.Override protected void doGet(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse rsp) throws java.io.IOException { try { java.lang.String idString = req.getPathInfo(); if (idString.endsWith("/")) { idString = idString.substring(0, ((idString.length()) - 1)); } com.google.gerrit.reviewdb.client.Change.Id id = Change.Id.parse(idString); com.google.gerrit.httpd.UrlModule.toGerrit(com.google.gerrit.common.PageLinks.toChange(null, id), req, rsp); } catch (java.lang.IllegalArgumentException err) { rsp.sendError(HttpServletResponse.SC_NOT_FOUND); } }
public void run() { defer(new java.lang.Runnable() { @java.lang.Override public void run() { net.codemirror.lib.CodeMirror.LineHandle handle = cm.getLineHandleVisualStart(cm.getCursor("end").getLine()); if ((cm.hasActiveLine()) && (cm.getActiveLine().equals(handle))) { return; } clearActiveLine(cm); clearActiveLine(other); cm.setActiveLine(handle); cm.addLineClass(handle, LineClassWhere.WRAP, DiffTable.style.activeLine()); com.google.gerrit.client.diff.LineMapper.LineOnOtherInfo info = lineOnOther(cm.side(), cm.getLineNumber(handle)); if (info.isAligned()) { net.codemirror.lib.CodeMirror.LineHandle oLineHandle = other.getLineHandle(info.getLine()); other.setActiveLine(oLineHandle); other.addLineClass(oLineHandle, LineClassWhere.WRAP, DiffTable.style.activeLine()); } } }); }
@java.lang.Override protected void configure() { bind(com.google.gerrit.httpd.GerritUiOptions.class).toInstance(new com.google.gerrit.httpd.GerritUiOptions(headless)); }
@java.lang.Override public void replace(com.google.gerrit.server.project.ProjectState projectState) throws java.io.IOException { try { replace(com.google.gerrit.lucene.LuceneProjectIndex.idTerm(projectState), toDocument(projectState)).get(); } catch (java.util.concurrent.ExecutionException | java.lang.InterruptedException e) { throw new java.io.IOException(e); } }
public void start() { java.lang.Thread t = new java.lang.Thread() { @java.lang.Override public void run() { reindex(); } }; t.setName(java.lang.String.format("Reindex v%d-v%d", com.google.gerrit.lucene.OnlineReindexer.version(indexes.getSearchIndex()), version)); t.start(); }
@org.junit.Test public void ownersFile1Test() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result c1 = createChange("add OWNERS", "OWNERS", "x@x\na@a\n"); assertThat(getOwnersResponse(c1)).contains("owners:[], files:[ OWNERS ]"); com.google.gerrit.acceptance.PushOneCommit.Result c2 = createChange("add t.c", "t.c", "##"); assertThat(getOwnersResponse(c2)).contains("owners:[], files:[ t.c ]"); approveSubmit(c1); java.lang.String ownerA = ownerJson("a@a"); java.lang.String ownerB = ownerJson("b@b"); java.lang.String ownerC = ownerJson("c@c"); java.lang.String ownerX = ownerJson("x@x"); java.lang.String ownersAX = ((("owners:[ " + ownerA) + ", ") + ownerX) + " ]"; assertThat(getOwnersResponse(c2)).contains((ownersAX + ", files:[ t.c ]")); assertThat(getOwnersResponse(c1)).contains((ownersAX + ", files:[ OWNERS ]")); java.lang.String expectedTail = (("path2owners:{ ./:[ a@a, x@x ] }, owner2paths:{ a@a:[ ./ ], x@x:[ ./ ] } }" + ", file2owners:{ ./t.c:[ a@a, x@x ] }, reviewers:[], ") + ownersAX) + ", files:[ t.c ] }"; assertThat(getOwnersDebugResponse(c2)).contains(expectedTail); }
private static com.google.gson.GsonBuilder gerritDefaultGsonBuilder() { final com.google.gson.GsonBuilder g = defaultGsonBuilder(); g.registerTypeAdapter(org.eclipse.jgit.diff.Edit.class, new org.eclipse.jgit.diff.EditDeserializer()); return g; }
@java.lang.Override public void onClick(com.google.gwt.event.dom.client.ClickEvent event) { if (((replyAction) != null) && (replyAction.isVisible())) { replyAction.quickApprove(input); } else { com.google.gerrit.client.changes.ChangeApi.revision(project.get(), changeId.get(), revision).view("review").post(input, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.changes.ReviewInput>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.changes.ReviewInput result) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(project, changeId)); } }); } }
void setLineLength(int length) { int adjustedLength = (Patch.COMMIT_MSG.equals(path)) ? 72 : length; cmBase.extras().lineLength(adjustedLength); cmEdit.extras().lineLength(adjustedLength); }
private void checkRequiresCapability(org.apache.sshd.server.Command cmd) throws com.google.gerrit.sshd.UnloggedFailure { com.google.gerrit.extensions.annotations.RequiresCapability rc = cmd.getClass().getAnnotation(com.google.gerrit.extensions.annotations.RequiresCapability.class); if (rc != null) { com.google.gerrit.server.CurrentUser user = currentUser.get(); com.google.gerrit.server.account.CapabilityControl ctl = user.getCapabilities(); java.lang.String capability = rc.value(); if (cmd instanceof com.google.gerrit.sshd.BaseCommand) { java.lang.String pluginName = ((com.google.gerrit.sshd.BaseCommand) (cmd)).getPluginName(); if (((pluginName != null) && (!("gerrit".equals(pluginName)))) && (((rc.scope()) == (com.google.gerrit.extensions.annotations.CapabilityScope.PLUGIN)) || ((rc.scope()) == (com.google.gerrit.extensions.annotations.CapabilityScope.CONTEXT)))) { capability = java.lang.String.format("%s-%s", pluginName, rc.value()); } else if ((rc.scope()) == (com.google.gerrit.extensions.annotations.CapabilityScope.PLUGIN)) { com.google.gerrit.sshd.DispatchCommand.log.error(java.lang.String.format("Class %s uses @%s(scope=%s), but is not within a plugin", cmd.getClass().getName(), com.google.gerrit.extensions.annotations.RequiresCapability.class.getSimpleName(), CapabilityScope.PLUGIN.name())); throw new com.google.gerrit.sshd.UnloggedFailure(BaseCommand.STATUS_NOT_ADMIN, "fatal: cannot check capability"); } } if ((!(ctl.canPerform(capability))) && (!(ctl.canAdministrateServer()))) { java.lang.String msg = java.lang.String.format("fatal: %s does not have \"%s\" capability.", user.getUserName(), capability); throw new com.google.gerrit.sshd.UnloggedFailure(BaseCommand.STATUS_NOT_ADMIN, msg); } } }
public int compare(com.google.gerrit.reviewdb.client.PatchLineComment c1, com.google.gerrit.reviewdb.client.PatchLineComment c2) { java.lang.String filename1 = c1.getKey().getParentKey().get(); java.lang.String filename2 = c2.getKey().getParentKey().get(); com.google.gerrit.reviewdb.client.CommentRange range1 = c1.getRange(); com.google.gerrit.reviewdb.client.CommentRange range2 = c2.getRange(); int lineForComment1 = (range1 == null) ? c1.getLine() : range1.getEndLine(); int lineForComment2 = (range2 == null) ? c2.getLine() : range2.getEndLine(); com.google.common.collect.ComparisonChain chain = com.google.common.collect.ComparisonChain.start(); if ((range1 == null) || (range2 == null)) { chain = chain.compare(lineForComment1, lineForComment2); } else { chain = chain.compare(range1.getStartLine(), range2.getStartLine()).compare(range1.getStartCharacter(), range2.getStartCharacter()).compare(range1.getEndLine(), range2.getEndLine()).compare(range1.getEndCharacter(), range2.getEndCharacter()); } return chain.compare(filename1, filename2).compare(c1.getWrittenOn(), c2.getWrittenOn()).result(); }
@java.lang.Override public void run() { (header.hasPrev() ? header.prev : header.up).go(); }
@org.junit.Test public void deleteBranchesNotFoundContinue() throws java.lang.Exception { com.google.gerrit.extensions.api.projects.DeleteBranchesInput input = new com.google.gerrit.extensions.api.projects.DeleteBranchesInput(); java.util.List<java.lang.String> branches = com.google.common.collect.Lists.newArrayList("refs/heads/does-not-exist"); branches.addAll(com.google.gerrit.acceptance.rest.project.DeleteBranchesIT.BRANCHES); input.branches = branches; try { project().deleteBranches(input); fail("Expected ResourceConflictException"); } catch (com.google.gerrit.extensions.restapi.ResourceConflictException e) { assertThat(e).hasMessageThat().isEqualTo(errorMessageForBranches(com.google.common.collect.ImmutableList.of("refs/heads/does-not-exist"))); } assertBranchesDeleted(); }
public int getEndCharacter() { return endCharacter; }
private static com.google.inject.Injector createTestInjector(com.google.gerrit.pgm.Daemon daemon) throws java.lang.Exception { com.google.inject.Injector sysInjector = com.google.gerrit.acceptance.GerritServer.get(daemon, "sysInjector"); java.lang.Module module = new com.google.gerrit.server.config.FactoryModule() { @java.lang.Override protected void configure() { bind(com.google.gerrit.acceptance.AccountCreator.class); factory(PushOneCommit.Factory.class); factory(SubmoduleOp.Factory.class); install(com.google.gerrit.acceptance.InProcessProtocol.module()); install(new com.google.gerrit.server.ssh.NoSshModule()); install(new com.google.gerrit.server.git.AsyncReceiveCommits.Module()); } }; return sysInjector.createChildInjector(module); }
@java.lang.Override public void onKeyDown(com.google.gwt.event.dom.client.KeyDownEvent e) { e.stopPropagation(); if ((((e.getNativeKeyCode()) == (KEY_ENTER)) || ((e.getNativeKeyCode()) == (KEY_MAC_ENTER))) && ((e.isControlKeyDown()) || (e.isMetaKeyDown()))) { e.preventDefault(); if (post.isEnabled()) { onPost(null); } } }
private <T extends com.google.gwt.event.shared.EventHandler> void fireEvent(com.google.gwtjsonrpc.client.BaseRpcEvent<T> e) { e.call = this; com.google.gwtjsonrpc.client.JsonUtil.fireEvent(e); }
private com.google.inject.Injector createSysInjector() { final java.util.List<java.lang.Module> modules = new java.util.ArrayList<java.lang.Module>(); modules.add(com.google.gerrit.server.schema.SchemaVersionCheck.module()); modules.add(new com.google.gerrit.pgm.util.LogFileCompressor.Module()); modules.add(new com.google.gerrit.server.git.WorkQueue.Module()); modules.add(new com.google.gerrit.common.ChangeHookRunner.Module()); modules.add(cfgInjector.getInstance(com.google.gerrit.server.config.GerritGlobalModule.class)); modules.add(new com.google.gerrit.server.cache.EhcachePoolImpl.Module()); modules.add(new com.google.gerrit.server.mail.SmtpEmailSender.Module()); modules.add(new com.google.gerrit.server.mail.SignedTokenEmailTokenVerifier.Module()); modules.add(new com.google.gerrit.server.git.PushReplication.Module()); if (httpd) { modules.add(new com.google.gerrit.server.config.CanonicalWebUrlModule() { @java.lang.Override protected java.lang.Class<? extends com.google.inject.Provider<java.lang.String>> provider() { return com.google.gerrit.httpd.HttpCanonicalWebUrlProvider.class; } }); } else { modules.add(new com.google.gerrit.server.config.CanonicalWebUrlModule() { @java.lang.Override protected java.lang.Class<? extends com.google.inject.Provider<java.lang.String>> provider() { return com.google.gerrit.server.config.CanonicalWebUrlProvider.class; } }); } if (!(slave)) { modules.add(new com.google.gerrit.server.config.MasterNodeStartup()); } return cfgInjector.createChildInjector(modules); }
private boolean isSubmittable(com.google.gerrit.client.changes.ChangeInfo info) { boolean canSubmit = ((info.status().isOpen()) && (revision.equals(info.current_revision()))) && (!(info.revision(revision).draft())); if (canSubmit && ((info.status()) == (com.google.gerrit.reviewdb.client.Change.Status.NEW))) { for (java.lang.String name : info.labels()) { com.google.gerrit.client.changes.ChangeInfo.LabelInfo label = info.label(name); switch (label.status()) { case NEED : statusText.setInnerText(("Needs " + name)); canSubmit = false; break; case REJECT : case IMPOSSIBLE : if (label.blocking()) { statusText.setInnerText(("Not " + name)); canSubmit = false; } break; default : break; } } } return canSubmit; }
public com.google.common.base.Optional<com.google.gerrit.reviewdb.client.PatchLineComment> get(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.notedb.ChangeNotes notes, com.google.gerrit.reviewdb.client.PatchLineComment.Key key) throws com.google.gwtorm.server.OrmException { if (!(migration.readComments())) { return com.google.common.base.Optional.fromNullable(db.patchComments().get(key)); } for (com.google.gerrit.reviewdb.client.PatchLineComment c : publishedByChange(db, notes)) { if (key.equals(c.getKey())) { return com.google.common.base.Optional.of(c); } } for (com.google.gerrit.reviewdb.client.PatchLineComment c : draftByChange(db, notes)) { if (key.equals(c.getKey())) { return com.google.common.base.Optional.of(c); } } return com.google.common.base.Optional.absent(); }
@java.lang.Override public java.util.List<com.google.gerrit.server.account.GetSshKeys.SshKeyInfo> apply(com.google.gerrit.server.account.AccountResource rsrc) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gwtorm.server.OrmException { if (((self.get()) != (rsrc.getUser())) && (!(self.get().getCapabilities().canAdministrateServer()))) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed to get SSH keys"); } java.util.List<com.google.gerrit.server.account.GetSshKeys.SshKeyInfo> sshKeys = com.google.common.collect.Lists.newArrayList(); for (com.google.gerrit.reviewdb.client.AccountSshKey sshKey : dbProvider.get().accountSshKeys().byAccount(rsrc.getUser().getAccountId()).toList()) { com.google.gerrit.server.account.GetSshKeys.SshKeyInfo info = new com.google.gerrit.server.account.GetSshKeys.SshKeyInfo(); info.seq = sshKey.getKey().get(); info.sshPublicKey = sshKey.getSshPublicKey(); info.encodedKey = sshKey.getEncodedKey(); info.algorithm = sshKey.getAlgorithm(); info.comment = com.google.common.base.Strings.emptyToNull(sshKey.getComment()); info.valid = sshKey.isValid(); sshKeys.add(info); } return sshKeys; }
@java.lang.Override public void onLoad() { if ((diffTable) == null) { initUI(); } super.onLoad(); PatchUtil.DETAIL_SVC.unifiedPatchDetail(patchId, new com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gerrit.client.data.UnifiedPatchDetail>(this) { @java.lang.Override protected void preDisplay(final com.google.gerrit.client.data.UnifiedPatchDetail r) { display(r); } }); }
private void add(org.apache.lucene.document.Document doc, com.google.gerrit.server.index.FieldDef<com.google.gerrit.server.query.change.ChangeData, ?> f, java.lang.Iterable<?> values) throws com.google.gwtorm.server.OrmException { java.lang.String name = f.getName(); org.apache.lucene.document.Field.Store store = com.google.gerrit.lucene.LuceneChangeIndex.store(f); if ((f.getType()) == (com.google.gerrit.server.index.FieldType.INTEGER)) { for (java.lang.Object value : values) { doc.add(new org.apache.lucene.document.IntField(name, ((java.lang.Integer) (value)), store)); } } else if ((f.getType()) == (com.google.gerrit.server.index.FieldType.LONG)) { for (java.lang.Object value : values) { doc.add(new org.apache.lucene.document.LongField(name, ((java.lang.Long) (value)), store)); } } else if ((f.getType()) == (com.google.gerrit.server.index.FieldType.TIMESTAMP)) { for (java.lang.Object v : values) { doc.add(new org.apache.lucene.document.IntField(name, com.google.gerrit.lucene.LuceneChangeIndex.toIndexTime(((java.sql.Timestamp) (v))), store)); } } else if (((f.getType()) == (com.google.gerrit.server.index.FieldType.EXACT)) || ((f.getType()) == (com.google.gerrit.server.index.FieldType.PREFIX))) { for (java.lang.Object value : values) { doc.add(new org.apache.lucene.document.StringField(name, ((java.lang.String) (value)), store)); } } else { throw com.google.gerrit.lucene.LuceneChangeIndex.badFieldType(f.getType()); } }
@java.lang.Override public void onEvent(com.google.gerrit.server.events.Event event) { if (event instanceof com.google.gerrit.server.events.RefUpdatedEvent) { com.google.gerrit.server.events.RefUpdatedEvent refUpdate = ((com.google.gerrit.server.events.RefUpdatedEvent) (event)); if (((protectDeleted) || (protectFastForward)) && (isRelevantRef(refUpdate))) { com.google.gerrit.reviewdb.client.Project.NameKey nameKey = refUpdate.getProjectNameKey(); try { com.google.gerrit.server.project.ProjectResource project = new com.google.gerrit.server.project.ProjectResource(projectControl.controlFor(nameKey, user)); if (((protectDeleted) && (isRefDeleted(refUpdate))) || ((protectFastForward) && (isNonFastForwardUpdate(refUpdate, project)))) { backupRef.createBackup(refUpdate, project); } } catch (com.google.gerrit.server.project.NoSuchProjectException | java.io.IOException e) { com.googlesource.gerrit.plugins.refprotection.RefUpdateListener.log.error(e.getMessage(), e); } } } }
private void submit(java.lang.String changeId, int expectedStatus, java.lang.String msg) throws java.lang.Exception { approve(changeId); com.google.gerrit.extensions.api.changes.SubmitInput subm = new com.google.gerrit.extensions.api.changes.SubmitInput(); com.google.gerrit.acceptance.RestResponse r = adminSession.post((("/changes/" + changeId) + "/submit"), subm); assertThat(r.getStatusCode()).isEqualTo(expectedStatus); if (expectedStatus == (org.apache.http.HttpStatus.SC_OK)) { checkArgument((msg == null), "msg must be null for successful submits"); com.google.gerrit.extensions.common.ChangeInfo change = newGson().fromJson(r.getReader(), new com.google.gson.reflect.TypeToken<com.google.gerrit.extensions.common.ChangeInfo>() {}.getType()); assertThat(change.status).isEqualTo(ChangeStatus.MERGED); checkMergeResult(change); } else { checkArgument((!(com.google.common.base.Strings.isNullOrEmpty(msg))), ("msg must be a valid string " + "containing an error message for unsuccessful submits")); assertThat(r.getEntityContent()).isEqualTo(msg); } r.consume(); }
public <T> T execute(com.google.gerrit.server.update.RetryHelper.ActionType actionType, com.google.gerrit.server.update.RetryHelper.Action<T> action, com.google.common.base.Predicate<java.lang.Throwable> exceptionPredicate) throws com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { try { return execute(actionType, action, com.google.gerrit.server.update.RetryHelper.defaults(), exceptionPredicate); } catch (java.lang.Throwable t) { com.google.common.base.Throwables.throwIfUnchecked(t); com.google.common.base.Throwables.throwIfInstanceOf(t, java.io.IOException.class); com.google.common.base.Throwables.throwIfInstanceOf(t, org.eclipse.jgit.errors.ConfigInvalidException.class); com.google.common.base.Throwables.throwIfInstanceOf(t, com.google.gwtorm.server.OrmException.class); throw new com.google.gwtorm.server.OrmException(t); } }
private Project.NameKey createProject(com.google.gerrit.extensions.api.projects.ProjectInput in) throws com.google.gerrit.extensions.restapi.RestApiException { gApi.projects().create(in); return new com.google.gerrit.reviewdb.client.Project.NameKey(in.name); }
private static java.lang.Class<?> findClass(java.lang.String klazzname) { try { return java.lang.Class.forName(klazzname); } catch (java.lang.ClassNotFoundException e) { throw com.google.gerrit.pgm.shell.JythonShell.noShell((("Class " + klazzname) + " not found"), e); } }
public com.google.gerrit.server.account.AuthRequest authenticate(final com.google.gerrit.server.account.AuthRequest who) throws com.google.gerrit.server.account.AccountException { final java.lang.String username = who.getLocalUser(); try { final javax.naming.directory.DirContext ctx; if ((authConfig.getAuthType()) == (com.google.gerrit.reviewdb.AuthType.LDAP_BIND)) { ctx = authenticate(username, who.getPassword()); } else { ctx = open(); } try { final com.google.gerrit.server.auth.ldap.LdapQuery.Result m = findAccount(ctx, username); if ((authConfig.getAuthType()) == (com.google.gerrit.reviewdb.AuthType.LDAP)) { authenticate(m.getDN(), who.getPassword()); } who.setDisplayName(com.google.gerrit.server.auth.ldap.LdapRealm.apply(accountFullName, m)); who.setUserName(com.google.gerrit.server.auth.ldap.LdapRealm.apply(accountSshUserName, m)); if ((accountEmailAddress) != null) { who.setEmailAddress(com.google.gerrit.server.auth.ldap.LdapRealm.apply(accountEmailAddress, m)); } else if (emailExpander.canExpand(username)) { who.setEmailAddress(emailExpander.expand(username)); } membershipCache.put(username, queryForGroups(ctx, username, m)); return who; } finally { try { ctx.close(); } catch (javax.naming.NamingException e) { com.google.gerrit.server.auth.ldap.LdapRealm.log.warn("Cannot close LDAP query handle", e); } } } catch (javax.naming.NamingException e) { com.google.gerrit.server.auth.ldap.LdapRealm.log.error("Cannot query LDAP to autenticate user", e); throw new com.google.gerrit.server.account.AccountException("Cannot query LDAP for account", e); } }
@java.lang.Override public com.googlesource.gerrit.plugins.lfs.LfsBackend apply(java.lang.String input) { return new com.googlesource.gerrit.plugins.lfs.LfsBackend(input, type); }
@java.lang.SuppressWarnings({ "unchecked", "rawtypes" }) private static boolean notModified(javax.servlet.http.HttpServletRequest req, com.google.gerrit.extensions.restapi.RestResource rsrc, com.google.gerrit.extensions.restapi.RestView<com.google.gerrit.extensions.restapi.RestResource> view) { if (!(com.google.gerrit.httpd.restapi.RestApiServlet.isGetOrHead(req))) { return false; } if (view instanceof com.google.gerrit.extensions.restapi.ETagView) { java.lang.String have = req.getHeader(HttpHeaders.IF_NONE_MATCH); if (have != null) { return have.equals(((com.google.gerrit.extensions.restapi.ETagView) (view)).getETag(rsrc)); } } if (rsrc instanceof com.google.gerrit.extensions.restapi.RestResource.HasETag) { java.lang.String have = req.getHeader(HttpHeaders.IF_NONE_MATCH); if (have != null) { return have.equals(((com.google.gerrit.extensions.restapi.RestResource.HasETag) (rsrc)).getETag()); } } if (rsrc instanceof com.google.gerrit.extensions.restapi.RestResource.HasLastModified) { java.sql.Timestamp m = ((com.google.gerrit.extensions.restapi.RestResource.HasLastModified) (rsrc)).getLastModified(); long d = req.getDateHeader(HttpHeaders.IF_MODIFIED_SINCE); return (d / 1000L) == ((m.getTime()) / 1000L); } return false; }
private void setPaddingHeight(int height) { com.google.gerrit.client.diff.SideBySide2.setHeightInPx(wrapper.element, height); wrapper.widget.changed(); }
private com.google.gerrit.client.ui.Screen selectProject() { if (com.google.gerrit.client.Dispatcher.matchPrefix("/admin/projects/", token)) { java.lang.String rest = com.google.gerrit.client.Dispatcher.skip(token); int c = rest.lastIndexOf(','); if (c < 0) { return new com.google.gerrit.client.admin.ProjectInfoScreen(Project.NameKey.parse(rest)); } else if (c == 0) { return new com.google.gerrit.client.NotFoundScreen(); } com.google.gerrit.reviewdb.client.Project.NameKey k = Project.NameKey.parse(rest.substring(0, c)); java.lang.String panel = rest.substring((c + 1)); if (ProjectScreen.INFO.equals(panel)) { return new com.google.gerrit.client.admin.ProjectInfoScreen(k); } if (ProjectScreen.BRANCH.equals(panel)) { return new com.google.gerrit.client.admin.ProjectBranchesScreen(k); } if (ProjectScreen.ACCESS.equals(panel)) { return new com.google.gerrit.client.admin.ProjectAccessScreen(k); } if (ProjectScreen.DASHBOARDS.equals(panel)) { return new com.google.gerrit.client.admin.ProjectDashboardsScreen(k); } } return new com.google.gerrit.client.NotFoundScreen(); }
public void setMem(long value, long total) { mem = com.google.gerrit.server.config.ListCaches.HitRatioInfo.percent(value, total); }
public static java.lang.String getUrl(SitePaths sitePaths) { return com.google.gerrit.server.schema.H2.createUrl(sitePaths.db_dir.resolve("account_patch_reviews")); }
@java.lang.Override public void run() { java.lang.Iterable<com.google.gerrit.reviewdb.Project.NameKey> names = (tryingAgain) ? retryOn : projectCache.all(); for (com.google.gerrit.reviewdb.Project.NameKey projectName : names) { com.google.gerrit.server.git.ProjectConfig config = projectCache.get(projectName).getConfig(); com.google.gerrit.common.data.GroupReference ref = config.getGroup(uuid); if ((ref == null) || (newName.equals(ref.getName()))) { continue; } try { com.google.gerrit.server.git.MetaDataUpdate md = metaDataUpdateFactory.create(projectName); try { rename(md); } finally { md.close(); } } catch (org.eclipse.jgit.errors.RepositoryNotFoundException noProject) { continue; } catch (org.eclipse.jgit.errors.ConfigInvalidException err) { com.google.gerrit.server.git.RenameGroupOp.log.error(((("Cannot rename group " + (oldName)) + " in ") + projectName), err); } catch (java.io.IOException err) { com.google.gerrit.server.git.RenameGroupOp.log.error(((("Cannot rename group " + (oldName)) + " in ") + projectName), err); } } if ((!(retryOn.isEmpty())) && (!(tryingAgain))) { tryingAgain = true; start(5, java.util.concurrent.TimeUnit.MINUTES); } }
@java.lang.Override public com.google.gerrit.extensions.common.ProjectInfo apply(com.google.gerrit.server.project.ChildProjectResource rsrc) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException { if ((recursive) || (rsrc.isDirectChild())) { return json.format(rsrc.getChild().getProject()); } throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(rsrc.getChild().getName()); }
@java.lang.Override public void onKeyPress(com.google.gwt.event.dom.client.KeyPressEvent event) { movePointerTo(((selectedRow) + 1), true); }
@org.junit.Test public void pureRevertReturnsTrueForPureRevert() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result r = createChange(); merge(r); java.lang.String revertId = gApi.changes().id(r.getChangeId()).revert().get().id; assertThat(gApi.changes().id(revertId).pureRevert().isPureRevert).isTrue(); assertThat(gApi.changes().id(revertId).pureRevert(getRemoteHead().toObjectId().name()).isPureRevert).isTrue(); }
@java.lang.Override public void onSuccess(com.google.gerrit.client.info.ChangeInfo result) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.client.Dispatcher.toEditScreen(project, new com.google.gerrit.reviewdb.client.PatchSet.Id(result.legacyId(), 1), "project.config")); }
@java.lang.Override protected void configureServlets() { java.lang.Class<? extends javax.servlet.Filter> authFilter; if (authConfig.isTrustContainerAuth()) { authFilter = com.google.gerrit.httpd.ContainerAuthFilter.class; } else if (authConfig.isGitBasicAuth()) { if ((authConfig.getAuthType()) == (OAUTH)) { authFilter = com.google.gerrit.httpd.ProjectOAuthFilter.class; } else { authFilter = com.google.gerrit.httpd.ProjectBasicAuthFilter.class; } } else { authFilter = com.google.gerrit.httpd.ProjectDigestFilter.class; } if (isHttpEnabled()) { java.lang.String git = GitOverHttpServlet.URL_REGEX; filterRegex(git).through(authFilter); serveRegex(git).with(com.google.gerrit.httpd.GitOverHttpServlet.class); } filterRegex(com.google.gerrit.httpd.GitOverHttpModule.LFS_URL_REGEX).through(authFilter); filter("/a/*").through(authFilter); }
com.google.gerrit.server.cache.PersistentCache.DiskStats diskStats();
private void verifyJsonCommit(com.google.gitiles.CommitJsonData.Commit jsonCommit, org.eclipse.jgit.revwalk.RevCommit commit) throws java.lang.Exception { repo.getRevWalk().parseBody(commit); com.google.gitiles.GitilesAccess access = new com.google.gitiles.TestGitilesAccess(repo.getRepository()).forRequest(null); com.google.gitiles.DateFormatter df = new com.google.gitiles.DateFormatter(access, com.google.gitiles.DateFormatter.Format.DEFAULT); assertThat(jsonCommit.commit).isEqualTo(commit.name()); assertThat(jsonCommit.tree).isEqualTo(commit.getTree().name()); java.util.ArrayList<java.lang.String> expectedParents = new java.util.ArrayList<>(); for (int i = 0; i < (commit.getParentCount()); i++) { expectedParents.add(commit.getParent(i).name()); } assertThat(jsonCommit.parents).containsExactlyElementsIn(expectedParents); assertThat(jsonCommit.author.name).isEqualTo(commit.getAuthorIdent().getName()); assertThat(jsonCommit.author.email).isEqualTo(commit.getAuthorIdent().getEmailAddress()); assertThat(jsonCommit.author.time).isEqualTo(df.format(commit.getAuthorIdent())); assertThat(jsonCommit.committer.name).isEqualTo(commit.getCommitterIdent().getName()); assertThat(jsonCommit.committer.email).isEqualTo(commit.getCommitterIdent().getEmailAddress()); assertThat(jsonCommit.committer.time).isEqualTo(df.format(commit.getCommitterIdent())); assertThat(jsonCommit.message).isEqualTo(commit.getFullMessage()); }
@java.lang.Override protected void onLoad() { super.onLoad(); addPanel.setVisible(false); com.google.gerrit.client.access.AccessMap.get(getProjectKey(), new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.access.ProjectAccessInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.access.ProjectAccessInfo result) { addPanel.setVisible(result.canAddRefs()); } }); refreshBranches(); savedPanel = BRANCH; }
@org.junit.Test public void copyAllScoresOnTrivialRebase() throws java.lang.Exception { java.lang.String subject = "test commit"; java.lang.String file = "a.txt"; java.lang.String contents = "contents"; codeReview.setCopyAllScoresOnTrivialRebase(true); saveLabelConfig(); com.google.gerrit.acceptance.PushOneCommit push = pushFactory.create(db, user.getIdent()); com.google.gerrit.acceptance.PushOneCommit.Result r1 = push.to(git, "refs/for/master"); merge(r1); push = pushFactory.create(db, user.getIdent(), "non-conflicting", "b.txt", "other contents"); com.google.gerrit.acceptance.PushOneCommit.Result r2 = push.to(git, "refs/for/master"); merge(r2); git.checkout().setName(r1.getCommit().name()).call(); push = pushFactory.create(db, user.getIdent(), subject, file, contents); com.google.gerrit.acceptance.PushOneCommit.Result r3 = push.to(git, "refs/for/master"); revision(r3).review(com.google.gerrit.extensions.api.changes.ReviewInput.recommend()); assertApproval(r3, 1); rebase(r3); assertApproval(r3, 1); }
private static boolean isEmptyOrSlash(java.lang.String path) { return (path.isEmpty()) || (path.equals("/")); }
@java.lang.Override public int run() throws java.lang.Exception { mustHaveValidSite(); dbInjector = createDbInjector(com.google.gerrit.pgm.MULTI_USER); globalConfig = dbInjector.getInstance(com.google.inject.Key.get(org.eclipse.jgit.lib.Config.class, com.google.gerrit.server.config.GerritServerConfig.class)); threads = com.google.gerrit.pgm.util.ThreadLimiter.limitThreads(dbInjector, threads); checkNotSlaveMode(); disableLuceneAutomaticCommit(); disableChangeCache(); if ((version) == null) { version = com.google.gerrit.server.index.ChangeSchemas.getLatest().getVersion(); } com.google.gerrit.lifecycle.LifecycleManager dbManager = new com.google.gerrit.lifecycle.LifecycleManager(); dbManager.add(dbInjector); dbManager.start(); sysInjector = createSysInjector(); com.google.gerrit.lifecycle.LifecycleManager sysManager = new com.google.gerrit.lifecycle.LifecycleManager(); sysManager.add(sysInjector); sysManager.start(); index = sysInjector.getInstance(com.google.gerrit.server.index.IndexCollection.class).getSearchIndex(); int result = 0; try { index.markReady(false); index.deleteAll(); result = indexAll(); index.markReady(true); } catch (java.lang.Exception e) { throw die(e.getMessage(), e); } sysManager.stop(); dbManager.stop(); return result; }
@java.lang.Override public void run() throws java.lang.Exception { if (!(currentUser.getCapabilities().canAdministrateServer())) { java.lang.String msg = java.lang.String.format("fatal: %s does not have \"Administrator\" capability.", currentUser.getUserName()); throw new com.google.gerrit.sshd.commands.UnloggedFailure(1, msg); } parseCommandLine(); validate(); setAccount(); }
private java.util.List<com.google.gerrit.extensions.webui.TopMenu.MenuItem> my(com.google.gerrit.server.account.VersionedAccountPreferences v, org.eclipse.jgit.lib.Repository allUsers) { java.util.List<com.google.gerrit.extensions.webui.TopMenu.MenuItem> my = my(v); if ((my.isEmpty()) && (!(v.isDefaults()))) { try { com.google.gerrit.server.account.VersionedAccountPreferences d = com.google.gerrit.server.account.VersionedAccountPreferences.forDefault(); d.load(allUsers); my = my(d); } catch (org.eclipse.jgit.errors.ConfigInvalidException | java.io.IOException e) { com.google.gerrit.server.account.GetPreferences.log.warn("cannot read default preferences", e); } } if (my.isEmpty()) { my.add(new com.google.gerrit.extensions.webui.TopMenu.MenuItem("Changes", "#/dashboard/self", null)); my.add(new com.google.gerrit.extensions.webui.TopMenu.MenuItem("Drafts", "#/q/owner:self+is:draft", null)); my.add(new com.google.gerrit.extensions.webui.TopMenu.MenuItem("Draft Comments", "#/q/has:draft", null)); my.add(new com.google.gerrit.extensions.webui.TopMenu.MenuItem("Edits", "#/q/has:edit", null)); my.add(new com.google.gerrit.extensions.webui.TopMenu.MenuItem("Watched Changes", "#/q/is:watched+is:open", null)); my.add(new com.google.gerrit.extensions.webui.TopMenu.MenuItem("Starred Changes", "#/q/is:starred", null)); my.add(new com.google.gerrit.extensions.webui.TopMenu.MenuItem("Groups", "#/groups/self", null)); } return my; }
private void registerCmEvents(net.codemirror.lib.CodeMirror cm) { cm.on("cursorActivity", updateActiveLine(cm)); cm.on("scroll", doScroll(otherCM(cm))); cm.on("mousedown", ignoreRightClick()); cm.addKeyMap(net.codemirror.lib.KeyMap.create().on("'u'", upToChange())); cm.addKeyMap(net.codemirror.lib.KeyMap.create().on("'o'", toggleOpenBox(cm))); cm.addKeyMap(net.codemirror.lib.KeyMap.create().on("Enter", toggleOpenBox(cm))); if (com.google.gerrit.client.Gerrit.isSignedIn()) { cm.addKeyMap(net.codemirror.lib.KeyMap.create().on("'c'", insertNewDraft(cm))); } for (java.lang.String c : new java.lang.String[]{ "A", "C", "D", "I", "O", "P", "R", "S", "U", "X", "Y", "~" }) { net.codemirror.lib.CodeMirror.disableUnwantedKey("vim", c); } }
@java.lang.Override public void run() { int line = (cm.extras().hasActiveLine()) ? cm.getLineNumber(cm.extras().activeLine()) : 0; int res = java.util.Collections.binarySearch(chunks, new com.google.gerrit.client.diff.DiffChunkInfo(cm.side(), line, 0, false), getDiffChunkComparator()); diffChunkNavHelper(chunks, cm, res, dir); }
public org.eclipse.jgit.lib.ObjectId commit() throws com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.server.notedb.NoteDbUpdateManager updateManager = updateManagerFactory.create(getProjectName()); updateManager.add(this); updateManager.execute(); return getResult(); }
public java.lang.Iterable<com.google.gerrit.reviewdb.client.Account.Id> byChange(final com.google.gerrit.reviewdb.client.Change.Id changeId) throws com.google.gwtorm.server.OrmException { if (!(migration.readChanges())) { return com.google.common.collect.FluentIterable.from(dbProvider.get().starredChanges().byChange(changeId)).transform(new com.google.common.base.Function<com.google.gerrit.reviewdb.client.StarredChange, com.google.gerrit.reviewdb.client.Account.Id>() { @java.lang.Override public Account.Id apply(com.google.gerrit.reviewdb.client.StarredChange in) { return in.getAccountId(); } }); } return com.google.common.collect.FluentIterable.from(getRefNames(RefNames.REFS_STARRED_CHANGES)).filter(new com.google.common.base.Predicate<java.lang.String>() { @java.lang.Override public boolean apply(java.lang.String refPart) { return refPart.endsWith(("/" + (changeId.get()))); } }).transform(new com.google.common.base.Function<java.lang.String, com.google.gerrit.reviewdb.client.Account.Id>() { @java.lang.Override public Account.Id apply(java.lang.String refPart) { return Account.Id.fromRefPart(refPart); } }); }
@java.lang.Override protected void onLoad() { super.onLoad(); com.google.gerrit.client.changes.ChangeApi.detail(changeId.get(), java.util.EnumSet.of(ListChangesOption.ALL_REVISIONS, ListChangesOption.CURRENT_ACTIONS), new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.changes.ChangeInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.changes.ChangeInfo info) { info.init(); loadConfigInfo(info); } }); }
private void processManifestChange(com.amd.gerrit.plugins.manifestsubscription.Event event, java.lang.String projectName, java.lang.String branchName) { try { com.amd.gerrit.plugins.manifestsubscription.VersionedManifests versionedManifests = parseManifests(event); processManifestChange(versionedManifests, projectName, branchName); } catch (javax.xml.bind.JAXBException | java.io.IOException | org.eclipse.jgit.errors.ConfigInvalidException e) { e.printStackTrace(); } }
public java.util.List<com.google.gerrit.common.data.SubmitRecord> evaluate(com.google.gerrit.server.query.change.ChangeData cd) { com.google.gerrit.reviewdb.client.Change change; com.google.gerrit.server.project.ProjectState projectState; try { change = cd.change(); if (change == null) { throw new com.google.gwtorm.server.OrmException("Change not found"); } projectState = projectCache.get(cd.project()); if (projectState == null) { throw new com.google.gerrit.server.project.NoSuchProjectException(cd.project()); } } catch (com.google.gwtorm.server.OrmException | com.google.gerrit.server.project.NoSuchProjectException e) { return ruleError(("Error looking up change " + (cd.getId())), e); } if ((!(opts.allowClosed())) && (change.getStatus().isClosed())) { com.google.gerrit.common.data.SubmitRecord rec = new com.google.gerrit.common.data.SubmitRecord(); rec.status = SubmitRecord.Status.CLOSED; return java.util.Collections.singletonList(rec); } return com.google.common.collect.ImmutableList.copyOf(prologRule.evaluate(cd, opts)); }
protected com.google.gitiles.FakeHttpServletResponse buildResponse(java.lang.String path, java.lang.String queryString, int expectedStatus) throws java.lang.Exception { return buildResponse(path, queryString, expectedStatus, "http://localhost"); }
com.google.gerrit.server.git.AbandonOp create(@com.google.inject.assistedinject.Assisted @com.google.gerrit.common.Nullable com.google.gerrit.reviewdb.client.Account account, @com.google.inject.assistedinject.Assisted @com.google.gerrit.common.Nullable java.lang.String msgTxt, @com.google.inject.assistedinject.Assisted com.google.gerrit.extensions.api.changes.NotifyHandling notifyHandling, @com.google.inject.assistedinject.Assisted com.google.common.collect.Multimap<com.google.gerrit.extensions.api.changes.RecipientType, com.google.gerrit.reviewdb.client.Account.Id> accountsToNotify);
public boolean testOrFalse(com.google.gerrit.server.permissions.ChangePermissionOrLabel perm) { try { return test(perm); } catch (com.google.gerrit.server.permissions.PermissionBackendException e) { com.google.gerrit.server.permissions.PermissionBackend.logger.warn((("Cannot test " + perm) + "; assuming false"), e); return false; } }
@org.junit.Test public void nameOfNewGroupMustNotBeNull() throws java.lang.Exception { com.google.gerrit.server.group.db.InternalGroupCreation groupCreation = getPrefilledGroupCreationBuilder().setNameKey(new com.google.gerrit.reviewdb.client.AccountGroup.NameKey(null)).build(); com.google.gerrit.server.group.db.GroupConfig groupConfig = com.google.gerrit.server.group.db.GroupConfig.createForNewGroup(repository, groupCreation); try (com.google.gerrit.server.git.MetaDataUpdate metaDataUpdate = createMetaDataUpdate()) { expectedException.expectCause(instanceOf(org.eclipse.jgit.errors.ConfigInvalidException.class)); expectedException.expectMessage("Name of the group users-XYZ"); groupConfig.commit(metaDataUpdate); } }
public <T extends com.google.gwt.core.client.JavaScriptObject> void put(com.google.gwtjsonrpc.common.AsyncCallback<T> cb) { send(com.google.gerrit.client.rpc.PUT, cb); }
com.google.common.base.Optional<com.google.gerrit.server.edit.ChangeEdit> getEdit() { return edit; }
private void processProjectConfigChange(com.amd.gerrit.plugins.manifestsubscription.Event event) { com.google.gerrit.reviewdb.client.Project.NameKey p = new com.google.gerrit.reviewdb.client.Project.NameKey(event.getProjectName()); try { com.google.gerrit.server.git.ProjectConfig oldCfg = parseConfig(p, event.getOldObjectId()); com.google.gerrit.server.git.ProjectConfig newCfg = parseConfig(p, event.getNewObjectId()); if (oldCfg != null) { java.lang.String oldStore = oldCfg.getPluginConfig(pluginName).getString(com.amd.gerrit.plugins.manifestsubscription.ManifestSubscription.KEY_STORE); if ((oldStore != null) && (!(oldStore.isEmpty()))) { manifestStores.row(oldStore).clear(); enabledManifestSource.remove(event.getProjectName()); java.util.Iterator<Table.Cell<com.amd.gerrit.plugins.manifestsubscription.ProjectBranchKey, java.lang.String, java.util.Map<java.lang.String, java.util.Set<com.amd.gerrit.plugins.manifestsubscription.manifest.Project>>>> iter = subscribedRepos.cellSet().iterator(); while (iter.hasNext()) { if (oldStore.equals(iter.next().getColumnKey())) { iter.remove(); } } } } if (newCfg != null) { loadStoreFromProjectConfig(event.getProjectName(), newCfg); } } catch (java.io.IOException | org.eclipse.jgit.errors.ConfigInvalidException | javax.xml.bind.JAXBException e) { e.printStackTrace(); } }
public com.google.gerrit.extensions.common.RevisionInfo getRevisionInfo(com.google.gerrit.server.query.change.ChangeData cd, com.google.gerrit.reviewdb.client.PatchSet in) throws com.google.gerrit.server.GpgException, com.google.gerrit.server.patch.PatchListNotAvailableException, com.google.gerrit.server.permissions.PermissionBackendException, com.google.gwtorm.server.OrmException, java.io.IOException { accountLoader = accountLoaderFactory.create(has(com.google.gerrit.server.change.DETAILED_ACCOUNTS)); try (org.eclipse.jgit.lib.Repository repo = openRepoIfNecessary(cd.project());org.eclipse.jgit.revwalk.RevWalk rw = newRevWalk(repo)) { com.google.gerrit.extensions.common.RevisionInfo rev = toRevisionInfo(cd, in, repo, rw, true, null, isWorldReadable(cd)); accountLoader.fill(); return rev; } }
public static com.google.gerrit.server.notedb.NoteDbChangeState.PrimaryStorage of(com.google.gerrit.server.notedb.NoteDbChangeState s) { return s != null ? s.getPrimaryStorage() : com.google.gerrit.server.notedb.NoteDbChangeState.PrimaryStorage.REVIEW_DB; }
@java.lang.Override protected void onLoad() { file.set(id, content); file.setText(fileName); file.setEnabled(fileName.isEmpty()); content.setText(fileContent); save.setEnabled(false); com.google.gwt.core.client.Scheduler.get().scheduleDeferred(new com.google.gwt.core.client.Scheduler.ScheduledCommand() { @java.lang.Override public void execute() { if (fileName.isEmpty()) { file.setFocus(true); } else { content.setFocus(true); } } }); }
public void assertCanDelete(com.google.gerrit.server.project.ProjectResource rsrc, boolean preserveGitRepository) throws com.googlesource.gerrit.plugins.deleteproject.CannotDeleteProjectException { if ((!preserveGitRepository) && (!(cfgFactory.getFromGerritConfig(pluginName).getBoolean("allowDeletionOfReposWithTags", true)))) { assertHasNoTags(rsrc); } }
void set(com.google.gerrit.client.ui.CommentLinkProcessor commentLinkProcessor, com.google.gerrit.client.changes.ChangeInfo change, java.lang.String revision) { com.google.gerrit.client.changes.ChangeInfo.RevisionInfo revInfo = change.revision(revision); com.google.gerrit.client.changes.ChangeInfo.CommitInfo commit = revInfo.commit(); commitName.setText(revision); idText.setText(("Change-Id: " + (change.change_id()))); idText.setPreviewText(change.change_id()); com.google.gerrit.client.change.CommitBox.formatLink(commit.author(), authorPanel, authorNameEmail, authorDate, change); com.google.gerrit.client.change.CommitBox.formatLink(commit.committer(), committerPanel, committerNameEmail, committerDate, change); text.setHTML(commentLinkProcessor.apply(new com.google.gwtexpui.safehtml.client.SafeHtmlBuilder().append(commit.message()).linkify())); setWebLinks(change, revision, revInfo); if ((revInfo.commit().parents().length()) > 1) { mergeCommit.setVisible(true); } setParents(change.project(), revInfo.commit().parents()); }
private org.eclipse.jetty.util.thread.ThreadPool threadPool(org.eclipse.jgit.lib.Config cfg) { int maxThreads = cfg.getInt("httpd", null, "maxthreads", 25); int minThreads = cfg.getInt("httpd", null, "minthreads", 5); int maxQueued = cfg.getInt("httpd", null, "maxqueued", 50); int idleTimeout = ((int) (java.util.concurrent.TimeUnit.MILLISECONDS.convert(60, java.util.concurrent.TimeUnit.SECONDS))); int maxCapacity = (maxQueued == 0) ? java.lang.Integer.MAX_VALUE : java.lang.Math.max(minThreads, maxQueued); org.eclipse.jetty.util.thread.QueuedThreadPool pool = new org.eclipse.jetty.util.thread.QueuedThreadPool(maxThreads, minThreads, idleTimeout, new org.eclipse.jetty.util.BlockingArrayQueue<java.lang.Runnable>(minThreads, minThreads, maxCapacity)); pool.setName("HTTP"); return pool; }
@java.lang.Override public GroupDescription.Basic get(com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid) { com.google.gerrit.server.account.GroupBackend b = backend(uuid); if (b == null) { com.google.gerrit.server.account.UniversalGroupBackend.log.warn(("Unknown GroupBackend for UUID: " + uuid)); return null; } return b.get(uuid); }
private static void checkMutuallyExclusiveLabels(java.util.Set<java.lang.String> labels) throws com.google.gerrit.server.StarredChangesUtil.MutuallyExclusiveLabelsException { if (labels.containsAll(com.google.common.collect.ImmutableSet.of(com.google.gerrit.server.StarredChangesUtil.DEFAULT_LABEL, com.google.gerrit.server.StarredChangesUtil.IGNORE_LABEL))) { throw new com.google.gerrit.server.StarredChangesUtil.MutuallyExclusiveLabelsException(com.google.gerrit.server.StarredChangesUtil.DEFAULT_LABEL, com.google.gerrit.server.StarredChangesUtil.IGNORE_LABEL); } java.util.Set<java.lang.Integer> reviewedPatchSets = labels.stream().filter(( l) -> l.startsWith(com.google.gerrit.server.StarredChangesUtil.REVIEWED_LABEL)).map(( l) -> java.lang.Integer.valueOf(l.substring(((com.google.gerrit.server.StarredChangesUtil.REVIEWED_LABEL.length()) + 1)))).collect(java.util.stream.Collectors.toSet()); java.util.Set<java.lang.Integer> unreviewedPatchSets = labels.stream().filter(( l) -> l.startsWith(com.google.gerrit.server.StarredChangesUtil.UNREVIEWED_LABEL)).map(( l) -> java.lang.Integer.valueOf(l.substring(((com.google.gerrit.server.StarredChangesUtil.UNREVIEWED_LABEL.length()) + 1)))).collect(java.util.stream.Collectors.toSet()); java.util.Optional<java.lang.Integer> ps = com.google.common.collect.Sets.intersection(reviewedPatchSets, unreviewedPatchSets).stream().findFirst(); if (ps.isPresent()) { throw new com.google.gerrit.server.StarredChangesUtil.MutuallyExclusiveLabelsException(com.google.gerrit.server.StarredChangesUtil.getReviewedLabel(ps.get()), com.google.gerrit.server.StarredChangesUtil.getUnreviewedLabel(ps.get())); } }
@org.junit.Test public void applyDeltaToNoteDbPrimaryIsNoOp() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Change c = com.google.gerrit.server.notedb.NoteDbChangeStateTest.newChange(); c.setNoteDbState("N"); com.google.gerrit.server.notedb.NoteDbChangeState.applyDelta(c, com.google.gerrit.server.notedb.NoteDbChangeState.Delta.create(c.getId(), com.google.gerrit.server.notedb.NoteDbChangeStateTest.metaId(SHA1), com.google.gerrit.server.notedb.NoteDbChangeStateTest.drafts(new com.google.gerrit.reviewdb.client.Account.Id(1001), SHA2))); assertThat(c.getNoteDbState()).isEqualTo("N"); }
private boolean add(com.google.gerrit.server.mail.ProjectWatch.Watchers matching, com.google.gerrit.reviewdb.client.Account.Id accountId, com.google.gerrit.server.account.WatchConfig.ProjectWatchKey key, java.util.Set<com.google.gerrit.reviewdb.client.AccountProjectWatch.NotifyType> watchedTypes, com.google.gerrit.reviewdb.client.AccountProjectWatch.NotifyType type) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.IdentifiedUser user = args.identifiedUserFactory.create(accountId); try { if (filterMatch(user, key.filter())) { if (watchedTypes.contains(type)) { matching.bcc.accounts.add(accountId); } return true; } } catch (com.google.gerrit.server.query.QueryParseException e) { } return false; }
public static synchronized java.io.File createTempDirectory() throws java.io.IOException { java.io.File tmp = java.io.File.createTempFile("gerrit_test_", "").getCanonicalFile(); if ((!(tmp.delete())) || (!(tmp.mkdir()))) { throw new java.io.IOException(("Cannot create " + (tmp.getPath()))); } com.google.gerrit.acceptance.TempFileUtil.allDirsCreated.add(tmp); return tmp; }
private static java.nio.file.Path getOrCreateDataDir(com.googlesource.gerrit.plugins.lfs.LfsGlobalConfig config, java.nio.file.Path defaultDataDir) throws java.io.IOException { java.lang.String dataDir = config.getString(LfsBackend.FS.name(), null, "directory"); if (com.google.common.base.Strings.isNullOrEmpty(dataDir)) { return defaultDataDir; } java.nio.file.Path ensured = java.nio.file.Files.createDirectories(java.nio.file.Paths.get(dataDir)); if (!(java.nio.file.Files.isReadable(ensured))) { throw new java.io.IOException((("Path '" + (ensured.toAbsolutePath())) + "' cannot be accessed")); } return ensured; }
@java.lang.Override protected void configure() { bind(com.google.gerrit.server.config.SitePaths.class); bind(com.google.gerrit.pgm.init.api.InitFlags.class); bind(com.google.gerrit.pgm.init.Libraries.class); bind(com.google.gerrit.pgm.init.LibraryDownloader.class); factory(Section.Factory.class); step().to(com.google.gerrit.pgm.init.UpgradeFrom2_0_x.class); step().to(com.google.gerrit.pgm.init.InitGitManager.class); if (initDb) { step().to(com.google.gerrit.pgm.init.InitDatabase.class); } step().to(com.google.gerrit.pgm.init.InitIndex.class); step().to(com.google.gerrit.pgm.init.InitAuth.class); step().to(com.google.gerrit.pgm.init.InitAdminUser.class); step().to(com.google.gerrit.pgm.init.InitLabels.class); step().to(com.google.gerrit.pgm.init.InitSendEmail.class); if (standalone) { step().to(com.google.gerrit.pgm.init.InitContainer.class); } step().to(com.google.gerrit.pgm.init.InitSshd.class); step().to(com.google.gerrit.pgm.init.InitHttpd.class); step().to(com.google.gerrit.pgm.init.InitCache.class); step().to(com.google.gerrit.pgm.init.InitPlugins.class); }
@org.junit.Test public void addedRobotCommentsCanBeRetrievedByChange() throws java.lang.Exception { assume().that(notesMigration.enabled()).isTrue(); com.google.gerrit.extensions.api.changes.ReviewInput.RobotCommentInput in = createRobotCommentInput(); addRobotComment(changeId, in); pushFactory.create(db, admin.getIdent(), testRepo, changeId).to("refs/for/master"); com.google.gerrit.extensions.api.changes.ReviewInput.RobotCommentInput in2 = createRobotCommentInput(); addRobotComment(changeId, in2); java.util.Map<java.lang.String, java.util.List<com.google.gerrit.extensions.common.RobotCommentInfo>> out = gApi.changes().id(changeId).robotComments(); assertThat(out).hasSize(1); assertThat(out.get(in.path)).hasSize(2); com.google.gerrit.extensions.common.RobotCommentInfo comment1 = out.get(in.path).get(0); assertRobotComment(comment1, in, false); com.google.gerrit.extensions.common.RobotCommentInfo comment2 = out.get(in.path).get(1); assertRobotComment(comment2, in2, false); }
@java.lang.Override protected com.google.common.base.Optional<com.googlesource.gerrit.plugins.lfs.fs.LfsFsRequestAuthorizer.LfsFsAuthToken> createToken(java.util.List<java.lang.String> values) { if ((values.size()) != 3) { return com.google.common.base.Optional.absent(); } return com.google.common.base.Optional.of(new com.googlesource.gerrit.plugins.lfs.fs.LfsFsRequestAuthorizer.LfsFsAuthToken(values.get(0), org.eclipse.jgit.lfs.lib.LongObjectId.fromString(values.get(1)), values.get(2))); }
static java.lang.String toJson(java.lang.String cacheName, java.lang.Object key) { com.google.gson.Gson gson = new com.google.gson.GsonBuilder().create(); java.lang.String json; switch (cacheName) { case com.ericsson.gerrit.plugins.highavailability.cache.Constants.ACCOUNTS : json = gson.toJson(key, Account.Id.class); break; case com.ericsson.gerrit.plugins.highavailability.cache.Constants.GROUPS : json = gson.toJson(key, AccountGroup.Id.class); break; case com.ericsson.gerrit.plugins.highavailability.cache.Constants.GROUPS_BYINCLUDE : case com.ericsson.gerrit.plugins.highavailability.cache.Constants.GROUPS_MEMBERS : json = gson.toJson(key, AccountGroup.UUID.class); break; case com.ericsson.gerrit.plugins.highavailability.cache.Constants.PROJECT_LIST : default : json = gson.toJson(key); } return json; }
@java.lang.Override protected com.google.gerrit.server.git.CodeReviewCommit _run(com.google.gerrit.server.git.CodeReviewCommit mergeTip, java.util.List<com.google.gerrit.server.git.CodeReviewCommit> toMerge) throws com.google.gerrit.server.git.MergeException { args.mergeUtil.reduceToMinimalMerge(args.mergeSorter, toMerge); if (mergeTip == null) { mergeTip = toMerge.remove(0); } mergeTip = args.mergeUtil.getFirstFastForward(mergeTip, args.rw, toMerge); while (!(toMerge.isEmpty())) { mergeTip = args.mergeUtil.mergeOneCommit(args.serverIdent.get(), args.repo, args.rw, args.inserter, args.canMergeFlag, args.destBranch, mergeTip, toMerge.remove(0)); } final com.google.gerrit.reviewdb.client.PatchSetApproval submitApproval = args.mergeUtil.markCleanMerges(args.rw, args.canMergeFlag, mergeTip, args.alreadyAccepted); setRefLogIdent(submitApproval); return mergeTip; }
private void display(com.google.gerrit.client.account.Preferences p) { showSiteHeader.setValue(p.showSiteHeader()); useFlashClipboard.setValue(p.useFlashClipboard()); copySelfOnEmails.setValue(p.copySelfOnEmail()); setListBox(maximumPageSize, com.google.gerrit.client.account.DEFAULT_PAGESIZE, p.changesPerPage()); setListBox(dateFormat, AccountGeneralPreferences.DateFormat.STD, p.dateFormat()); setListBox(timeFormat, AccountGeneralPreferences.TimeFormat.HHMM_12, p.timeFormat()); relativeDateInChangeTable.setValue(p.relativeDateInChangeTable()); sizeBarInChangeTable.setValue(p.sizeBarInChangeTable()); legacycidInChangeTable.setValue(p.legacycidInChangeTable()); muteCommonPathPrefixes.setValue(p.muteCommonPathPrefixes()); setListBox(reviewCategoryStrategy, AccountGeneralPreferences.ReviewCategoryStrategy.NONE, p.reviewCategoryStrategy()); setListBox(diffView, AccountGeneralPreferences.DiffView.SIDE_BY_SIDE, p.diffView()); display(p.my()); }
@java.lang.Override protected void init() throws com.google.gerrit.common.errors.EmailException { if ((args.projectCache) != null) { projectState = args.projectCache.get(change.getProject()); } else { projectState = null; } if ((patchSet) == null) { try { patchSet = changeData.currentPatchSet(); } catch (com.google.gwtorm.server.OrmException err) { patchSet = null; } } if ((patchSet) != null) { setHeader("X-Gerrit-PatchSet", ((patchSet.getPatchSetId()) + "")); if ((patchSetInfo) == null) { try { patchSetInfo = args.patchSetInfoFactory.get(args.db.get(), changeData.notes(), patchSet.getId()); } catch (com.google.gerrit.server.patch.PatchSetInfoNotAvailableException | com.google.gwtorm.server.OrmException err) { patchSetInfo = null; } } } authors = getAuthors(); super.init(); if ((timestamp) != null) { setHeader("Date", new java.util.Date(timestamp.getTime())); } setChangeSubjectHeader(); setHeader("X-Gerrit-Change-Id", ("" + (change.getKey().get()))); setHeader("X-Gerrit-Change-Number", ("" + (change.getChangeId()))); setChangeUrlHeader(); setCommitIdHeader(); }
java.util.List<org.eclipse.jgit.transport.URIish> getURIs(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String urlMatch) { java.util.List<org.eclipse.jgit.transport.URIish> r = com.google.common.collect.Lists.newArrayListWithCapacity(remote.getURIs().size()); for (org.eclipse.jgit.transport.URIish uri : remote.getURIs()) { if (com.googlesource.gerrit.plugins.replication.Destination.matches(uri, urlMatch)) { java.lang.String name = project.get(); if (com.googlesource.gerrit.plugins.replication.Destination.needsUrlEncoding(uri)) { name = com.googlesource.gerrit.plugins.replication.Destination.encode(name); } if (remoteNameStyle.equals("dash")) { name = name.replace("/", "-"); } else if (remoteNameStyle.equals("underscore")) { name = name.replace("/", "_"); } else if (!(remoteNameStyle.equals("slash"))) { ReplicationQueue.log.debug(java.lang.String.format("Unknown remoteNameStyle: %s, falling back to slash", remoteNameStyle)); } java.lang.String replacedPath = com.googlesource.gerrit.plugins.replication.ReplicationQueue.replaceName(uri.getPath(), name, isSingleProjectMatch()); if (replacedPath != null) { uri = uri.setPath(replacedPath); r.add(uri); } } } return r; }
public java.util.List<com.google.gerrit.reviewdb.RefRight> getAllRights(final com.google.gerrit.reviewdb.ApprovalCategory.Id id) { java.util.List<com.google.gerrit.reviewdb.RefRight> l = new java.util.ArrayList<com.google.gerrit.reviewdb.RefRight>(); l.addAll(getLocalRights(id)); l.addAll(getInheritedRights(id)); java.util.Collections.sort(l, RefRight.REF_PATTERN_ORDER); return java.util.Collections.unmodifiableList(com.google.gerrit.server.project.RefControl.filterMostSpecific(l)); }
@java.lang.SuppressWarnings("unchecked") public static <S extends com.google.common.truth.Subject<S, E>, E> com.google.gerrit.acceptance.ListSubject<S, E> assertThat(java.util.List<E> list, java.util.function.Function<E, S> elementAssertThatFunction) { return ((com.google.gerrit.acceptance.ListSubject<S, E>) (assertAbout(new com.google.gerrit.acceptance.ListSubject.ListSubjectFactory(elementAssertThatFunction)).that(list))); }
public boolean canReadCommit(com.google.gerrit.reviewdb.server.ReviewDb db, org.eclipse.jgit.revwalk.RevWalk rw, org.eclipse.jgit.revwalk.RevCommit commit) { try (org.eclipse.jgit.lib.Repository repo = openRepository()) { return isMergedIntoVisibleRef(repo, db, rw, commit, repo.getAllRefs().values()); } catch (java.io.IOException e) { java.lang.String msg = java.lang.String.format("Cannot verify permissions to commit object %s in repository %s", commit.name(), getProject().getNameKey()); com.google.gerrit.server.project.ProjectControl.log.error(msg, e); return false; } }
private boolean canRegisterNewEmail() { return com.google.gerrit.client.Gerrit.info().auth().canEdit(Account.FieldName.REGISTER_NEW_EMAIL); }
private com.google.gerrit.server.change.PostReviewers.Addition fail(java.lang.String reviewer, boolean confirm, java.lang.String error) { com.google.gerrit.server.change.PostReviewers.Addition addition = new com.google.gerrit.server.change.PostReviewers.Addition(reviewer); addition.result.confirm = (confirm) ? true : null; addition.result.error = error; return addition; }
@org.junit.Test @com.google.gerrit.acceptance.GerritConfig(name = "accounts.visibility", value = "SAME_GROUP") public void suggestReviewersSameGroupVisibility() throws java.lang.Exception { java.lang.String changeId = createChange().getChangeId(); java.util.List<com.google.gerrit.server.change.SuggestReviewers.SuggestedReviewerInfo> reviewers; reviewers = suggestReviewers(changeId, "user2", 2); assertEquals(1, reviewers.size()); assertEquals("User2", com.google.common.collect.Iterables.getOnlyElement(reviewers).account.name); reviewers = suggestReviewers(new com.google.gerrit.acceptance.RestSession(server, user1), changeId, "user2", 2); assertTrue(reviewers.isEmpty()); reviewers = suggestReviewers(new com.google.gerrit.acceptance.RestSession(server, user2), changeId, "user2", 2); assertEquals(1, reviewers.size()); assertEquals("User2", com.google.common.collect.Iterables.getOnlyElement(reviewers).account.name); reviewers = suggestReviewers(new com.google.gerrit.acceptance.RestSession(server, user3), changeId, "user2", 2); assertEquals(1, reviewers.size()); assertEquals("User2", com.google.common.collect.Iterables.getOnlyElement(reviewers).account.name); }
private void fireCommentAddedEvent(com.google.gerrit.server.update.Context ctx) throws java.io.IOException { if (approvals.isEmpty()) { return; } java.util.List<com.google.gerrit.common.data.LabelType> labels = projectCache.checkedGet(ctx.getProject()).getLabelTypes(notes, ctx.getUser()).getLabelTypes(); java.util.Map<java.lang.String, java.lang.Short> allApprovals = new java.util.HashMap<>(); java.util.Map<java.lang.String, java.lang.Short> oldApprovals = new java.util.HashMap<>(); for (com.google.gerrit.common.data.LabelType lt : labels) { allApprovals.put(lt.getName(), ((short) (0))); oldApprovals.put(lt.getName(), null); } for (java.util.Map.Entry<java.lang.String, java.lang.Short> entry : approvals.entrySet()) { if ((entry.getValue()) != 0) { allApprovals.put(entry.getKey(), entry.getValue()); oldApprovals.put(entry.getKey(), ((short) (0))); } } commentAdded.fire(notes.getChange(), newPatchSet, ctx.getAccount(), null, allApprovals, oldApprovals, ctx.getWhen()); }
protected org.eclipse.jgit.revwalk.RevCommit getRemoteHead(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String branch) throws java.io.IOException { try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(project)) { return getHead(repo, ("refs/heads/" + branch)); } }
public java.util.List<com.google.gerrit.extensions.common.AccountInfo> getDirectMembers(com.google.gerrit.common.data.GroupDescription.Internal group, com.google.gerrit.server.account.GroupControl groupControl) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.group.ListMembers.checkSameGroup(group, groupControl); java.util.Set<com.google.gerrit.reviewdb.client.Account.Id> directMembers = com.google.gerrit.server.group.ListMembers.getDirectMemberIds(group, groupControl); return toAccountInfos(directMembers); }
private void executeUpdateRepo() throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.git.UpdateException { try { logDebug("Executing updateRepo on {} ops", ops.size()); com.google.gerrit.server.git.BatchUpdate.RepoContext ctx = new com.google.gerrit.server.git.BatchUpdate.RepoContext(); for (com.google.gerrit.server.git.BatchUpdate.Op op : ops.values()) { op.updateRepo(ctx); } if (!(repoOnlyOps.isEmpty())) { logDebug("Executing updateRepo on {} RepoOnlyOps", ops.size()); for (com.google.gerrit.server.git.BatchUpdate.RepoOnlyOp op : repoOnlyOps) { op.updateRepo(ctx); } } if ((inserter) != null) { logDebug("Flushing inserter"); inserter.flush(); } else { logDebug("No objects to flush"); } } catch (java.lang.Exception e) { com.google.common.base.Throwables.throwIfInstanceOf(e, com.google.gerrit.extensions.restapi.RestApiException.class); throw new com.google.gerrit.server.git.UpdateException(e); } }
@java.lang.Override public void onSuccess(java.lang.Void result) { net.codemirror.theme.ThemeLoader.loadTheme(prefs.theme(), themeCallback); }
private com.google.gerrit.pgm.Init.SiteInit createSiteInit() { final com.google.gerrit.pgm.util.ConsoleUI ui = com.google.gerrit.pgm.util.ConsoleUI.getInstance(batchMode); final java.io.File sitePath = getSitePath(); final java.util.List<java.lang.Module> m = new java.util.ArrayList<java.lang.Module>(); m.add(new com.google.gerrit.pgm.init.InitModule()); m.add(new com.google.inject.AbstractModule() { @java.lang.Override protected void configure() { bind(com.google.gerrit.pgm.util.ConsoleUI.class).toInstance(ui); bind(java.io.File.class).annotatedWith(com.google.gerrit.server.config.SitePath.class).toInstance(sitePath); bind(com.google.gerrit.pgm.init.ReloadSiteLibrary.class).toInstance(new com.google.gerrit.pgm.init.ReloadSiteLibrary() { @java.lang.Override public void reload() { com.google.gerrit.pgm.Init.super.loadSiteLib(); } }); } }); try { return com.google.inject.Guice.createInjector(com.google.gerrit.pgm.PRODUCTION, m).getInstance(com.google.gerrit.pgm.Init.SiteInit.class); } catch (com.google.inject.CreationException ce) { final com.google.inject.spi.Message first = ce.getErrorMessages().iterator().next(); java.lang.Throwable why = first.getCause(); if (why instanceof com.google.gerrit.pgm.util.Die) { throw ((com.google.gerrit.pgm.util.Die) (why)); } final java.lang.StringBuilder buf = new java.lang.StringBuilder(ce.getMessage()); while (why != null) { buf.append("\n"); buf.append(why.getMessage()); why = why.getCause(); if (why != null) { buf.append("\n caused by "); } } throw die(buf.toString(), new java.lang.RuntimeException("InitInjector failed", ce)); } }
private void initProjectOptions() { projectOptionsPanel = new com.google.gwt.user.client.ui.VerticalPanel(); projectOptionsPanel.add(new com.google.gerrit.client.ui.SmallHeading(Util.C.headingProjectOptions())); submitType = new com.google.gwt.user.client.ui.ListBox(); for (final com.google.gerrit.reviewdb.Project.SubmitType type : Project.SubmitType.values()) { submitType.addItem(com.google.gerrit.client.admin.Util.toLongString(type), type.name()); } saveEnabler.listenTo(submitType); projectOptionsPanel.add(submitType); requireChangeID = new com.google.gwt.user.client.ui.CheckBox(Util.C.requireChangeID(), true); saveEnabler.listenTo(requireChangeID); projectOptionsPanel.add(requireChangeID); add(projectOptionsPanel); }
@java.lang.Override public final void updateRepo(com.google.gerrit.server.git.BatchUpdate.RepoContext ctx) throws java.lang.Exception { logDebug("{}#updateRepo for change {}", getClass().getSimpleName(), toMerge.change().getId()); com.google.gerrit.server.git.CodeReviewCommit tipBefore = args.mergeTip.getCurrentTip(); alreadyMerged = getAlreadyMergedCommit(ctx); if ((alreadyMerged) == null) { updateRepoImpl(ctx); } else { logDebug("Already merged as {}", alreadyMerged.name()); } com.google.gerrit.server.git.CodeReviewCommit tipAfter = args.mergeTip.getCurrentTip(); if (java.util.Objects.equals(tipBefore, tipAfter)) { logDebug("Did not move tip", getClass().getSimpleName()); return; } else if (tipAfter == null) { logDebug("No merge tip, no update to perform"); return; } logDebug("Moved tip from {} to {}", tipBefore, tipAfter); checkProjectConfig(ctx, tipAfter); command = new org.eclipse.jgit.transport.ReceiveCommand(firstNonNull(tipBefore, org.eclipse.jgit.lib.ObjectId.zeroId()), tipAfter, getDest().get()); ctx.addRefUpdate(command); args.submoduleOp.addBranchTip(getDest(), tipAfter); }
@java.lang.Override public com.google.gerrit.reviewdb.AccountDiffPreference run(com.google.gerrit.reviewdb.ReviewDb db) throws com.google.gwtorm.client.OrmException { return currentUser.get().getAccountDiffPreference(); }
@java.lang.Override protected void migrateData(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.schema.UpdateUI ui) throws com.google.gwtorm.server.OrmException, java.sql.SQLException { ui.message("Generating Superproject subscriptions table to submodule ACLs"); try (java.sql.Statement stmt = ((com.google.gwtorm.jdbc.JdbcSchema) (db)).getConnection().createStatement();java.sql.ResultSet rs = stmt.executeQuery(("SELECT " + (((("super_project_project_name, " + "super_project_branch_name, ") + "submodule_project_name, ") + "submodule_branch_name ") + "FROM submodule_subscriptions")))) { while (rs.next()) { com.google.gerrit.reviewdb.client.Project.NameKey superproject = new com.google.gerrit.reviewdb.client.Project.NameKey(rs.getString(1)); com.google.gerrit.reviewdb.client.Branch.NameKey superbranch = new com.google.gerrit.reviewdb.client.Branch.NameKey(superproject, rs.getString(2)); com.google.gerrit.reviewdb.client.Project.NameKey submodule = new com.google.gerrit.reviewdb.client.Project.NameKey(rs.getString(4)); com.google.gerrit.reviewdb.client.Branch.NameKey subbranch = new com.google.gerrit.reviewdb.client.Branch.NameKey(submodule, rs.getString(5)); allowSubmoduleSubscription(subbranch, superbranch); } } }
private void loadFileContent() { com.google.gerrit.client.changes.ChangeEditApi.get(id, getText(), new com.google.gerrit.client.rpc.HttpCallback<com.google.gerrit.client.rpc.NativeString>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.rpc.HttpResponse<com.google.gerrit.client.rpc.NativeString> result) { textArea.setText(result.getResult().asString()); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { if (com.google.gerrit.client.rpc.RestApi.isNotFound(caught)) { } else { com.google.gerrit.client.rpc.GerritCallback.showFailure(caught); } } }); }
protected static <T> java.util.List<T> decodeProtos(com.google.gson.JsonObject doc, java.lang.String fieldName, com.google.gwtorm.protobuf.ProtobufCodec<T> codec) { com.google.gson.JsonArray field = doc.getAsJsonArray(fieldName); if (field == null) { return null; } return com.google.common.collect.FluentIterable.from(field).transform(( i) -> codec.decode(decodeBase64(i.toString()))).toList(); }
public static com.google.gitiles.BaseServlet notFoundServlet() { return new com.google.gitiles.BaseServlet(null, null) { private static final long serialVersionUID = 1L; @java.lang.Override public void service(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse res) { res.setStatus(com.google.gitiles.SC_NOT_FOUND); } }; }
private com.googlesource.gerrit.plugins.reviewers.ReviewerFilterSection newReviewerFilterSection(java.lang.String filter) { com.google.common.collect.ImmutableSet.Builder<java.lang.String> b = com.google.common.collect.ImmutableSet.builder(); for (java.lang.String reviewer : cfg.getStringList(com.googlesource.gerrit.plugins.reviewers.ReviewersConfig.SECTION_FILTER, filter, com.googlesource.gerrit.plugins.reviewers.ReviewersConfig.KEY_REVIEWER)) { b.add(reviewer); } return new com.googlesource.gerrit.plugins.reviewers.ReviewerFilterSection(filter, b.build()); }
@org.junit.Test public void createBranch() throws com.google.gerrit.extensions.restapi.RestApiException, java.io.IOException, org.eclipse.jgit.api.errors.GitAPIException { gApi.projects().name(project.get()).branch("foo").create(new com.google.gerrit.extensions.api.projects.BranchInput()); }
private static com.google.gwt.user.client.rpc.AsyncCallback<com.google.gwt.core.client.JavaScriptObject> callback(final java.lang.String target) { return new com.google.gerrit.client.rpc.GerritCallback<com.google.gwt.core.client.JavaScriptObject>() { @java.lang.Override public void onSuccess(com.google.gwt.core.client.JavaScriptObject in) { com.google.gerrit.client.api.DefaultActions.UiResult result = asUiResult(in); if (result == null) { com.google.gerrit.client.Gerrit.display(target); return; } if ((result.alert()) != null) { com.google.gwt.user.client.Window.alert(result.alert()); } if (((result.redirectUrl()) != null) && (result.openWindow())) { com.google.gwt.user.client.Window.open(result.redirectUrl(), "_blank", null); } else if ((result.redirectUrl()) != null) { com.google.gwt.user.client.Window.Location.assign(result.redirectUrl()); } else { com.google.gerrit.client.Gerrit.display(target); } } private com.google.gerrit.client.api.DefaultActions.UiResult asUiResult(com.google.gwt.core.client.JavaScriptObject in) { if (com.google.gerrit.client.rpc.NativeString.is(in)) { java.lang.String str = ((com.google.gerrit.client.rpc.NativeString) (in)).asString(); return str.isEmpty() ? com.google.gerrit.client.api.DefaultActions.UiResult.none() : com.google.gerrit.client.api.DefaultActions.UiResult.alert(str); } return in.cast(); } }; }
@org.junit.Test public void submitWholeTopicMultipleBranchesOnSameProject() throws java.lang.Exception { assume().that(isSubmitWholeTopicEnabled()).isTrue(); java.lang.String topic = "test-topic"; org.eclipse.jgit.junit.TestRepository<?> repoA = createProjectWithPush("project-a", null, getSubmitType()); com.google.gerrit.extensions.api.projects.BranchInput in = new com.google.gerrit.extensions.api.projects.BranchInput(); gApi.projects().name(name("project-a")).branch("dev").create(in); org.eclipse.jgit.revwalk.RevCommit initialHead = getRemoteHead(project, "master"); com.google.gerrit.acceptance.PushOneCommit.Result change1 = createChange(repoA, "master", "Change 1", "a.txt", "content", topic); com.google.gerrit.acceptance.PushOneCommit.Result change2 = createChange(repoA, "master", "Change 2", "b.txt", "content", topic); repoA.reset(initialHead); com.google.gerrit.acceptance.PushOneCommit.Result change3 = createChange(repoA, "dev", "Change 3", "a.txt", "content", topic); com.google.gerrit.acceptance.PushOneCommit.Result change4 = createChange(repoA, "dev", "Change 4", "b.txt", "content", topic); approve(change1.getChangeId()); approve(change2.getChangeId()); approve(change3.getChangeId()); approve(change4.getChangeId()); submit(change4.getChangeId()); java.lang.String expectedTopic = name(topic); change1.assertChange(Change.Status.MERGED, expectedTopic, admin); change2.assertChange(Change.Status.MERGED, expectedTopic, admin); change3.assertChange(Change.Status.MERGED, expectedTopic, admin); change4.assertChange(Change.Status.MERGED, expectedTopic, admin); }
@com.google.gwt.uibinder.client.UiHandler("add") void onAdd(com.google.gwt.event.dom.client.ClickEvent e) { java.lang.String hashtag = hashtagTextBox.getText(); if (!(hashtag.isEmpty())) { addHashtag(hashtag); } }
public void remove(com.google.gerrit.common.data.AccessSection section) { if (section != null) { com.google.gerrit.common.data.AccessSection a = accessSections.get(section.getName()); if (sectionsWithUnknownPermissions.contains(a)) { accessSections.remove(a); } else { a.setPermissions(new java.util.ArrayList<com.google.gerrit.common.data.Permission>()); } } }
@org.junit.Test public void testPushForMasterWithNotify() throws java.lang.Exception { com.google.gerrit.acceptance.TestAccount user2 = accounts.user2(); java.lang.String pushSpec = ((("refs/for/master" + "%reviewer=") + (user.email)) + ",cc=") + (user2.email); sender.clear(); com.google.gerrit.acceptance.PushOneCommit.Result r = pushTo(((pushSpec + ",notify=") + (com.google.gerrit.extensions.api.changes.NotifyHandling.NONE))); r.assertOkStatus(); assertThat(sender.getMessages()).hasSize(0); sender.clear(); r = pushTo(((pushSpec + ",notify=") + (com.google.gerrit.extensions.api.changes.NotifyHandling.OWNER))); r.assertOkStatus(); assertThat(sender.getMessages()).hasSize(0); sender.clear(); r = pushTo(((pushSpec + ",notify=") + (com.google.gerrit.extensions.api.changes.NotifyHandling.OWNER_REVIEWERS))); r.assertOkStatus(); assertThat(sender.getMessages()).hasSize(1); com.google.gerrit.testutil.FakeEmailSender.Message m = sender.getMessages().get(0); assertThat(m.rcpt()).containsExactly(user.emailAddress); sender.clear(); r = pushTo(((pushSpec + ",notify=") + (com.google.gerrit.extensions.api.changes.NotifyHandling.ALL))); r.assertOkStatus(); assertThat(sender.getMessages()).hasSize(1); m = sender.getMessages().get(0); assertThat(m.rcpt()).containsExactly(user.emailAddress, user2.emailAddress); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<?> apply(com.google.gerrit.server.change.RevisionResource rsrc, com.google.gerrit.server.change.DeleteDraftPatchSet.Input input) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.reviewdb.client.PatchSet patchSet = rsrc.getPatchSet(); com.google.gerrit.reviewdb.client.PatchSet.Id patchSetId = patchSet.getId(); com.google.gerrit.reviewdb.client.Change change = rsrc.getChange(); if (!(patchSet.isDraft())) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException("Patch set is not a draft"); } if (!(allowDrafts)) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException("Draft workflow is disabled"); } if (!(rsrc.getControl().canDeleteDraft(dbProvider.get()))) { throw new com.google.gerrit.extensions.restapi.AuthException("Not permitted to delete this draft patch set"); } deleteDraftPatchSet(patchSet, change); deleteOrUpdateDraftChange(patchSetId, change); return com.google.gerrit.extensions.restapi.Response.none(); }
@java.lang.Override protected void preDisplay(final com.google.gerrit.client.data.AccountDashboardInfo r) { display(r); }
public com.google.gerrit.server.change.ChangeResource parse(com.google.gerrit.reviewdb.client.Change.Id id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException { java.util.List<com.google.gerrit.server.project.ChangeControl> ctls = changeFinder.find(id, user.get()); if (ctls.isEmpty()) { try { changeIndexer.delete(id); } catch (java.io.IOException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(com.google.gerrit.server.change.ChangesCollection.toIdString(id).get(), e); } throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(com.google.gerrit.server.change.ChangesCollection.toIdString(id)); } if ((ctls.size()) != 1) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(("Multiple changes found for " + id)); } com.google.gerrit.server.project.ChangeControl ctl = ctls.get(0); if (!(ctl.isVisible(db.get()))) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(com.google.gerrit.server.change.ChangesCollection.toIdString(id)); } return new com.google.gerrit.server.change.ChangeResource(ctl); }
@com.google.gerrit.server.query.change.Operator public com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> query(java.lang.String name) throws com.google.gerrit.server.query.QueryParseException { com.google.gerrit.server.config.AllUsersName allUsers = args.allUsersName.get(); try (org.eclipse.jgit.lib.Repository git = args.repoManager.openRepository(allUsers)) { com.google.gerrit.server.account.VersionedAccountQueries q = com.google.gerrit.server.account.VersionedAccountQueries.forUser(self()); q.load(git); java.lang.String query = q.getQueryList().getQuery(name); if (query != null) { return parse(query); } } catch (org.eclipse.jgit.errors.RepositoryNotFoundException e) { throw new com.google.gerrit.server.query.QueryParseException(((("Unknown named query (no " + (allUsers.get())) + " repo): ") + name), e); } catch (java.io.IOException | org.eclipse.jgit.errors.ConfigInvalidException e) { throw new com.google.gerrit.server.query.QueryParseException(("Error parsing named query: " + name), e); } throw new com.google.gerrit.server.query.QueryParseException(("Unknown named query: " + name)); }
public java.util.Set<com.googlesource.gerrit.plugins.its.base.workflow.Property> extractFrom(PatchSetAttribute patchSetAttribute) { java.util.Set<com.googlesource.gerrit.plugins.its.base.workflow.Property> properties = com.google.common.collect.Sets.newHashSet(); properties.add(propertyFactory.create("revision", patchSetAttribute.revision)); properties.add(propertyFactory.create("patch-set-number", java.lang.String.valueOf(patchSetAttribute.number))); properties.add(propertyFactory.create("patchSetNumber", java.lang.String.valueOf(patchSetAttribute.number))); properties.add(propertyFactory.create("ref", patchSetAttribute.ref)); properties.add(propertyFactory.create("created-on", patchSetAttribute.createdOn.toString())); properties.add(propertyFactory.create("createdOn", patchSetAttribute.createdOn.toString())); properties.add(propertyFactory.create("parents", patchSetAttribute.parents.toString())); properties.add(propertyFactory.create("deletions", java.lang.Integer.toString(patchSetAttribute.sizeDeletions))); properties.add(propertyFactory.create("insertions", java.lang.Integer.toString(patchSetAttribute.sizeInsertions))); properties.add(propertyFactory.create("is-draft", java.lang.Boolean.toString(patchSetAttribute.isDraft))); properties.add(propertyFactory.create("isDraft", java.lang.Boolean.toString(patchSetAttribute.isDraft))); properties.addAll(extractFrom(patchSetAttribute.uploader, "uploader")); properties.addAll(extractFrom(patchSetAttribute.author, "author")); return properties; }
@java.lang.Override public void onEvent(com.google.gerrit.server.events.Event event) { if (!(event instanceof com.google.gerrit.server.events.ProjectEvent)) { return; } com.google.gerrit.server.events.ProjectEvent projectEvent = ((com.google.gerrit.server.events.ProjectEvent) (event)); org.eclipse.jgit.lib.Config cfg; try { cfg = configFactory.getProjectPluginConfigWithInheritance(projectEvent.getProjectNameKey(), pluginName); } catch (com.google.gerrit.server.project.NoSuchProjectException e) { com.googlesource.gerrit.plugins.webhooks.EventHandler.log.warn("Ignoring event for a non-existing project {}, {}", projectEvent.getProjectNameKey().get(), projectEvent); return; } for (java.lang.String name : cfg.getSubsections(com.googlesource.gerrit.plugins.webhooks.RemoteConfig.REMOTE)) { com.googlesource.gerrit.plugins.webhooks.RemoteConfig remote = remoteFactory.create(cfg, name); if (com.google.common.base.Strings.isNullOrEmpty(remote.getUrl())) { com.googlesource.gerrit.plugins.webhooks.EventHandler.log.warn("remote.{}.url not defined, skipping this remote", name); continue; } taskFactory.create(projectEvent, remote).schedule(); } }
@java.lang.Override public java.util.List<org.apache.lucene.document.Document> call() throws java.io.IOException { return doRead(fields); }
com.google.gerrit.reviewdb.client.PatchLineComment export(com.google.gerrit.reviewdb.client.Change.Id changeId, com.google.gerrit.reviewdb.client.PatchLineComment.Status status) { com.google.gerrit.reviewdb.client.PatchLineComment plc = new com.google.gerrit.reviewdb.client.PatchLineComment(key.export(changeId), lineNbr, author.export(), parentUuid, writtenOn); plc.setSide(side); plc.setMessage(message); if ((range) != null) { plc.setRange(range.export()); } plc.setTag(tag); plc.setRevId(new com.google.gerrit.reviewdb.client.RevId(revId)); plc.setStatus(status); return plc; }
private static org.eclipse.jgit.lib.ObjectId writeAndGetId(org.eclipse.jgit.lib.Repository repository, org.eclipse.jgit.dircache.DirCache tree) throws java.io.IOException { try (org.eclipse.jgit.lib.ObjectInserter objectInserter = repository.newObjectInserter()) { org.eclipse.jgit.lib.ObjectId treeId = tree.writeTree(objectInserter); objectInserter.flush(); return treeId; } }
@org.junit.Test public void mergeOnPushToBranch() throws java.lang.Exception { grant(Permission.PUSH, project, "refs/heads/master"); com.google.gerrit.acceptance.PushOneCommit.Result r = push("refs/for/master", PushOneCommit.SUBJECT, "a.txt", "some content"); r.assertOkStatus(); git().push().setRefSpecs(new org.eclipse.jgit.transport.RefSpec(((r.getCommit().name()) + ":refs/heads/master"))).call(); assertCommit(project, "refs/heads/master"); com.google.gerrit.server.query.change.ChangeData cd = com.google.common.collect.Iterables.getOnlyElement(queryProvider.get().byKey(new com.google.gerrit.reviewdb.client.Change.Key(r.getChangeId()))); org.eclipse.jgit.revwalk.RevCommit c = r.getCommit(); com.google.gerrit.reviewdb.client.PatchSet.Id psId = cd.currentPatchSet().getId(); assertThat(psId.get()).isEqualTo(1); assertThat(cd.change().getStatus()).isEqualTo(Change.Status.MERGED); assertSubmitApproval(psId); assertThat(cd.patchSets()).hasSize(1); assertThat(cd.patchSet(psId).getRevision().get()).isEqualTo(c.name()); }
@java.lang.Override public org.eclipse.jgit.revwalk.RevCommit commit(com.google.gerrit.server.git.MetaDataUpdate update) throws java.io.IOException { org.eclipse.jgit.revwalk.RevCommit c = super.commit(update); loadedGroup = java.util.Optional.of(loadedGroup.get().toBuilder().setRefState(c.toObjectId()).build()); return c; }
public static void refreshUserPreferences() { if (com.google.gerrit.client.Gerrit.isSignedIn()) { com.google.gerrit.client.account.AccountApi.self().view("preferences").get(new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.info.AccountPreferencesInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.info.AccountPreferencesInfo prefs) { com.google.gerrit.client.Gerrit.setUserPreferences(prefs); } }); } else { com.google.gerrit.client.Gerrit.setUserPreferences(com.google.gerrit.client.info.AccountPreferencesInfo.createDefault()); } }
@java.lang.SuppressWarnings("deprecation") public org.eclipse.jgit.lib.ObjectId sha1() { return org.eclipse.jgit.lib.ObjectId.fromRaw(com.google.common.hash.Hashing.sha1().hashString(get(), java.nio.charset.StandardCharsets.UTF_8).asBytes()); }
public static void onAction(com.google.gerrit.client.info.ChangeInfo change, com.google.gerrit.client.info.ActionInfo action, com.google.gerrit.client.actions.ActionButton button) { com.google.gerrit.client.rpc.RestApi api = com.google.gerrit.client.changes.ChangeApi.change(change.project(), change.legacyId().get()).view(action.id()); com.google.gwt.core.client.JavaScriptObject f = com.google.gerrit.client.api.ChangeGlue.get(action.id()); if (f != null) { com.google.gerrit.client.api.ActionContext c = com.google.gerrit.client.api.ActionContext.create(api); c.set(action); c.set(change); c.button(button); com.google.gerrit.client.api.ApiGlue.invoke(f, c); } else { com.google.gerrit.client.api.DefaultActions.invoke(change, action, api); } }
private com.google.gerrit.reviewdb.client.PatchSet getPatchSet(com.google.gerrit.server.notedb.ChangeNotes notes, com.google.gerrit.extensions.common.RevisionInfo info) throws com.google.gwtorm.server.OrmException { return psUtil.get(db.get(), notes, PatchSet.Id.fromRef(info.ref)); }
@java.lang.Override public void updateChangeImpl(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx) throws com.google.gerrit.server.project.NoSuchChangeException, com.google.gwtorm.server.OrmException { checkState(((newCommit) != null), "no new commit produced by CherryPick of %s, expected to fail fast", toMerge.change().getId()); com.google.gerrit.reviewdb.client.PatchSet prevPs = args.psUtil.current(ctx.getDb(), ctx.getNotes()); args.psUtil.insert(ctx.getDb(), ctx.getUpdate(psId), psId, newCommit, false, (prevPs != null ? prevPs.getGroups() : null), null); ctx.getChange().setCurrentPatchSet(patchSetInfo); ctx.saveChange(); newCommit.setControl(ctx.getControl()); }
@java.lang.SuppressWarnings("deprecation") public com.google.common.util.concurrent.CheckedFuture<java.lang.Boolean, java.io.IOException> reindexIfStale(com.google.gerrit.reviewdb.client.Account.Id id) { java.util.concurrent.Callable<java.lang.Boolean> task = () -> { if (stalenessChecker.isStale(id)) { index(id); return true; } return false; }; return com.google.common.util.concurrent.Futures.makeChecked(com.google.common.util.concurrent.Futures.nonCancellationPropagating(batchExecutor.submit(task)), IndexUtils.MAPPER); }
@java.lang.Override public com.google.gerrit.server.permissions.PermissionBackend.ForRef user(com.google.gerrit.server.CurrentUser user) { return forUser(user).asForRef().database(db); }
void save(com.google.gerrit.client.rpc.CallbackGroup group) { java.lang.String message = editArea.getValue().trim(); if ((message.length()) == 0) { return; } com.google.gerrit.client.changes.CommentInfo original = comment; com.google.gerrit.client.changes.CommentInput input = com.google.gerrit.client.changes.CommentInput.create(original); input.setMessage(message); enableEdit(false); com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.changes.CommentInfo> cb = new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.changes.CommentInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.changes.CommentInfo result) { enableEdit(true); set(result); setEdit(false); if (autoClosed) { setOpen(false); } parent.updateUnsaved(com.google.gerrit.client.diff.DraftBox.this, false); } @java.lang.Override public void onFailure(java.lang.Throwable e) { enableEdit(true); super.onFailure(e); } }; if ((original.id()) == null) { com.google.gerrit.client.changes.CommentApi.createDraft(psId, input, (group == null ? cb : group.add(cb))); } else { com.google.gerrit.client.changes.CommentApi.updateDraft(psId, original.id(), input, (group == null ? cb : group.add(cb))); } getCm().focus(); }
@java.lang.Override public void onFailure(java.lang.Throwable caught) { com.google.gerrit.client.change.ChangeScreen.logger.log(java.util.logging.Level.SEVERE, ("Loading file list and inline comments failed: " + (caught.getMessage()))); loadConfigInfo(info, rev); }
@java.lang.Override public com.google.gerrit.server.change.ChangeKind load(com.google.gerrit.server.change.ChangeKindCacheImpl.Key key) throws java.io.IOException { if (java.util.Objects.equals(key.prior, key.next)) { return ChangeKind.NO_CODE_CHANGE; } try (org.eclipse.jgit.revwalk.RevWalk walk = new org.eclipse.jgit.revwalk.RevWalk(key.repo)) { org.eclipse.jgit.revwalk.RevCommit prior = walk.parseCommit(key.prior); walk.parseBody(prior); org.eclipse.jgit.revwalk.RevCommit next = walk.parseCommit(key.next); walk.parseBody(next); if (!(next.getFullMessage().equals(prior.getFullMessage()))) { if (com.google.gerrit.server.change.ChangeKindCacheImpl.Loader.isSameDeltaAndTree(prior, next)) { return ChangeKind.NO_CODE_CHANGE; } else { return ChangeKind.REWORK; } } if (com.google.gerrit.server.change.ChangeKindCacheImpl.Loader.isSameDeltaAndTree(prior, next)) { return ChangeKind.NO_CHANGE; } if (((prior.getParentCount()) != 1) || ((next.getParentCount()) != 1)) { return ChangeKind.REWORK; } org.eclipse.jgit.merge.ThreeWayMerger merger = com.google.gerrit.server.git.MergeUtil.newThreeWayMerger(key.repo, com.google.gerrit.server.git.MergeUtil.createDryRunInserter(key.repo), key.strategyName); merger.setBase(prior.getParent(0)); try { if ((merger.merge(next.getParent(0), prior)) && (merger.getResultTreeId().equals(next.getTree()))) { return ChangeKind.TRIVIAL_REBASE; } } catch (org.eclipse.jgit.errors.LargeObjectException e) { } return ChangeKind.REWORK; } finally { key.repo = null; } }
public com.google.common.base.Optional<com.google.gerrit.server.edit.ChangeEdit> byChange(com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.server.IdentifiedUser user) throws java.io.IOException { try (org.eclipse.jgit.lib.Repository repo = gitManager.openRepository(change.getProject())) { java.lang.String editRefPrefix = com.google.gerrit.reviewdb.client.RefNames.refsEditPrefix(user.getAccountId(), change.getId()); java.util.Map<java.lang.String, org.eclipse.jgit.lib.Ref> refs = repo.getRefDatabase().getRefs(editRefPrefix); if (refs.isEmpty()) { return com.google.common.base.Optional.absent(); } org.eclipse.jgit.lib.Ref ref = com.google.common.collect.Iterables.getOnlyElement(refs.values()); try (org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo)) { org.eclipse.jgit.revwalk.RevCommit commit = rw.parseCommit(ref.getObjectId()); com.google.gerrit.reviewdb.client.PatchSet basePs = getBasePatchSet(change, ref); return com.google.common.base.Optional.of(new com.google.gerrit.server.edit.ChangeEdit(user, change, ref, commit, basePs)); } } }
public com.google.gerrit.server.notedb.rebuild.NoteDbMigrator.Builder setTrialMode(boolean trial) { this.trial = trial; return this; }
@java.lang.Override protected void onInitUI() { super.onInitUI(); table = new com.google.gerrit.client.changes.ChangeTable2(); table.addStyleName(Gerrit.RESOURCES.css().accountDashboard()); outgoing = new com.google.gerrit.client.changes.ChangeTable2.Section(); incoming = new com.google.gerrit.client.changes.ChangeTable2.Section(); closed = new com.google.gerrit.client.changes.ChangeTable2.Section(); outgoing.setTitleText(Util.C.outgoingReviews()); incoming.setTitleText(Util.C.incomingReviews()); incoming.setHighlightUnreviewed(true); closed.setTitleText(Util.C.recentlyClosed()); table.addSection(outgoing); table.addSection(incoming); table.addSection(closed); add(table); table.setSavePointerId(("owner:" + (ownerId))); }
@com.google.common.annotations.VisibleForTesting static java.lang.StackTraceElement[] trimStack(java.lang.StackTraceElement[] trace, java.lang.StackTraceElement ref) { java.util.List<java.lang.StackTraceElement> trimmed = new java.util.ArrayList<>(); for (java.lang.StackTraceElement e : trace) { trimmed.add(e); if ((e.getClassName().equals(ref.getClassName())) && (e.getMethodName().equals(ref.getMethodName()))) { break; } } return trimmed.toArray(new java.lang.StackTraceElement[trimmed.size()]); }
public void publish(com.google.gerrit.server.edit.ChangeEdit edit) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.server.project.InvalidChangeOperationException, com.google.gerrit.server.project.NoSuchChangeException, com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.reviewdb.client.Change change = edit.getChange(); org.eclipse.jgit.lib.Repository repo = gitManager.openRepository(change.getProject()); try { org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo); org.eclipse.jgit.lib.ObjectInserter inserter = repo.newObjectInserter(); try { com.google.gerrit.reviewdb.client.PatchSet basePatchSet = edit.getBasePatchSet(); if (!(basePatchSet.getId().equals(change.currentPatchSetId()))) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException("only edit for current patch set can be published"); } insertPatchSet(edit, change, repo, rw, basePatchSet, squashEdit(repo, rw, inserter, edit.getEditCommit(), basePatchSet)); } finally { inserter.release(); rw.release(); } com.google.gerrit.server.edit.ChangeEditUtil.deleteRef(repo, edit); } finally { repo.close(); } }
java.lang.String hidden();
private void renderHeader(java.lang.String header) throws java.io.IOException { int lf = header.indexOf('\n'); java.lang.String rest = (0 <= lf) ? header.substring((lf + 1)) : ""; java.util.List<java.util.Map<java.lang.String, java.lang.String>> parts = com.google.common.collect.Lists.newArrayListWithCapacity(3); parts.add(com.google.common.collect.ImmutableMap.of("text", "diff --git")); if ((entry.getChangeType()) != (org.eclipse.jgit.diff.DiffEntry.ChangeType.ADD)) { parts.add(com.google.common.collect.ImmutableMap.of("text", com.google.gitiles.GIT_PATH.quote(((getOldPrefix()) + (entry.getOldPath()))), "url", revisionUrl(view.getOldRevision(), entry.getOldPath()))); } else { parts.add(com.google.common.collect.ImmutableMap.of("text", com.google.gitiles.GIT_PATH.quote(((getOldPrefix()) + (entry.getNewPath()))))); } if ((entry.getChangeType()) != (org.eclipse.jgit.diff.DiffEntry.ChangeType.DELETE)) { parts.add(com.google.common.collect.ImmutableMap.of("text", com.google.gitiles.GIT_PATH.quote(((getNewPrefix()) + (entry.getNewPath()))), "url", revisionUrl(view.getRevision(), entry.getNewPath()))); } else { parts.add(com.google.common.collect.ImmutableMap.of("text", com.google.gitiles.GIT_PATH.quote(((getNewPrefix()) + (entry.getOldPath()))))); } getOutputStream().write(renderer.newRenderer("gitiles.diffHeader").setData(com.google.common.collect.ImmutableMap.of("firstParts", parts, "rest", rest, "fileIndex", fileIndex)).render().getBytes(Charsets.UTF_8)); }
private static int changeMessage() { int key = (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.K) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.str(20)); return (((((((((((com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.O) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.P)) + key) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.P)) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.K)) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.P)) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.T)) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.str(64))) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.P)) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.patchSetId())) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.P)) + (com.google.gerrit.server.notedb.ChangeNotesCache.Weigher.P); }
@java.lang.Override public boolean dryRun(final com.google.gerrit.server.git.CodeReviewCommit mergeTip, final com.google.gerrit.server.git.CodeReviewCommit toMerge) throws com.google.gerrit.server.git.MergeException { return com.google.gerrit.server.git.MergeUtil.canMerge(args.mergeSorter, args.repo, args.useContentMerge, mergeTip, toMerge); }
private void parseCreate(final org.eclipse.jgit.transport.ReceiveCommand cmd) { org.eclipse.jgit.revwalk.RevObject obj; try { obj = rp.getRevWalk().parseAny(cmd.getNewId()); } catch (java.io.IOException err) { com.google.gerrit.server.git.ReceiveCommits.log.error((((("Invalid object " + (cmd.getNewId().name())) + " for ") + (cmd.getRefName())) + " creation"), err); reject(cmd, "invalid object"); return; } if ((com.google.gerrit.server.git.ReceiveCommits.isHead(cmd)) && (!(isCommit(cmd)))) { return; } com.google.gerrit.server.project.RefControl ctl = projectControl.controlForRef(cmd.getRefName()); if (ctl.canCreate(rp.getRevWalk(), obj)) { validateNewCommits(ctl, cmd); batch.addCommand(cmd); } else { reject(cmd); } }
private org.eclipse.jgit.treewalk.AbstractTreeIterator getTreeIterator(org.eclipse.jgit.lib.Repository repo, java.lang.String name) throws java.io.IOException { org.eclipse.jgit.treewalk.CanonicalTreeParser p = new org.eclipse.jgit.treewalk.CanonicalTreeParser(); try (org.eclipse.jgit.lib.ObjectReader or = repo.newObjectReader()) { p.reset(or, new org.eclipse.jgit.revwalk.RevWalk(repo).parseTree(repo.resolve(name))); return p; } }
@java.lang.Override public void postUpdate(com.google.gerrit.server.update.Context ctx) throws java.lang.Exception { opResult = com.google.gerrit.server.restapi.change.PostReviewersOp.Result.builder().setAddedReviewers(com.google.common.collect.ImmutableList.copyOf(addedReviewers)).setAddedCCs(com.google.common.collect.ImmutableList.copyOf(addedCCs)).build(); emailReviewers(rsrc.getChange(), com.google.common.collect.Lists.transform(addedReviewers, ( r) -> r.getAccountId()), ((addedCCs) == null ? com.google.common.collect.ImmutableList.of() : addedCCs), reviewersByEmail, addedCCsByEmail, notify, accountsToNotify); if (!(addedReviewers.isEmpty())) { java.util.List<com.google.gerrit.server.account.AccountState> reviewers = addedReviewers.stream().map(( r) -> accountCache.maybeGet(r.getAccountId())).flatMap(Streams::stream).collect(java.util.stream.Collectors.toList()); reviewerAdded.fire(rsrc.getChange(), patchSet, reviewers, ctx.getAccount(), ctx.getWhen()); } }
@java.lang.Override public com.google.gerrit.server.CurrentUser getCurrentUser() { throw new com.google.inject.OutOfScopeException("No user on email thread"); }
public com.google.gerrit.server.IdentifiedUser create(java.net.SocketAddress remotePeer, com.google.gerrit.reviewdb.client.Account.Id id) { return new com.google.gerrit.server.IdentifiedUser(capabilityControlFactory, starredChangesUtil, authConfig, realm, anonymousCowardName, canonicalUrl, accountCache, groupBackend, disableReverseDnsLookup, com.google.inject.util.Providers.of(remotePeer), null, id, null); }
@org.junit.Test public void testKeyToString() throws java.lang.Exception { org.bouncycastle.openpgp.PGPPublicKey key = com.google.gerrit.server.git.gpg.TestKey.key1().getPublicKey(); assertEquals(("46328A8C Testuser One <test1@example.com>" + " (04AE A7ED 2F82 1133 E5B1 28D1 ED06 25DC 4632 8A8C)"), com.google.gerrit.server.git.gpg.PublicKeyStore.keyToString(key)); }
@org.junit.Test public void testUpsertTwoBothExisting() throws com.google.gwtorm.server.OrmException, java.sql.SQLException { java.sql.PreparedStatement update = stubStatementWithUpdateCounts(com.google.gwtorm.jdbc.TestJdbcAccess.UPDATE, 1, 1); java.sql.PreparedStatement insert = stubStatementWithUpdateCounts(com.google.gwtorm.jdbc.TestJdbcAccess.INSERT); createClassUnderTest().upsert(twoRows); com.google.gwtorm.jdbc.TestJdbcAccess.assertUsedBatchingOnly(update); com.google.gwtorm.jdbc.TestJdbcAccess.assertNotUsed(insert); }
private java.lang.String extractWhat(com.google.gerrit.sshd.DispatchCommand dcmd) { if (dcmd == null) { return "Command was already destroyed"; } java.lang.StringBuilder commandName = new java.lang.StringBuilder(dcmd.getCommandName()); java.lang.String[] trimmedArgs = dcmd.getTrimmedArguments(); if (trimmedArgs != null) { commandName.append(com.google.common.base.Joiner.on(".").join(trimmedArgs)); } return commandName.toString(); }
private java.lang.String expand(com.google.gerrit.common.data.ParameterizedString parameterizedRef, java.lang.String userName) { return parameterizedRef.replace(java.util.Collections.singletonMap("username", userName)); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<java.lang.String> apply(com.google.gerrit.server.account.AccountResource rsrc, com.google.gerrit.extensions.common.HttpPasswordInput input) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gerrit.server.permissions.PermissionBackendException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { if ((self.get()) != (rsrc.getUser())) { permissionBackend.user(self).check(GlobalPermission.ADMINISTRATE_SERVER); } if (input == null) { input = new com.google.gerrit.extensions.common.HttpPasswordInput(); } input.httpPassword = com.google.common.base.Strings.emptyToNull(input.httpPassword); java.lang.String newPassword; if (input.generate) { newPassword = com.google.gerrit.server.account.PutHttpPassword.generate(); } else if ((input.httpPassword) == null) { newPassword = null; } else { permissionBackend.user(self).check(GlobalPermission.ADMINISTRATE_SERVER); newPassword = input.httpPassword; } return apply(rsrc.getUser(), newPassword); }
public final boolean submittable() { init(); getMissingLabelIndex(); return _submittable(); }
public static com.google.gerrit.client.account.DiffPreferences create(com.google.gerrit.extensions.client.DiffPreferencesInfo in) { if (in == null) { in = com.google.gerrit.extensions.client.DiffPreferencesInfo.defaults(); } com.google.gerrit.client.account.DiffPreferences p = createObject().cast(); p.ignoreWhitespace(in.ignoreWhitespace); p.tabSize(in.tabSize); p.lineLength(in.lineLength); p.cursorBlinkRate(in.cursorBlinkRate); p.context(in.context); p.intralineDifference(in.intralineDifference); p.showLineEndings(in.showLineEndings); p.showTabs(in.showTabs); p.showWhitespaceErrors(in.showWhitespaceErrors); p.syntaxHighlighting(in.syntaxHighlighting); p.hideTopMenu(in.hideTopMenu); p.autoHideDiffTableHeader(in.autoHideDiffTableHeader); p.hideLineNumbers(in.hideLineNumbers); p.expandAllComments(in.expandAllComments); p.manualReview(in.manualReview); p.renderEntireFile(in.renderEntireFile); p.theme(in.theme); p.hideEmptyPane(in.hideEmptyPane); p.retainHeader(in.retainHeader); p.skipUncommented(in.skipUncommented); p.skipDeleted(in.skipDeleted); p.matchBrackets(in.matchBrackets); return p; }
@org.junit.Test public void testBlockedExtensions() throws java.lang.Exception { try (org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo)) { org.eclipse.jgit.revwalk.RevCommit c = makeCommit(rw, com.googlesource.gerrit.plugins.uploadvalidator.FileExtensionValidatorTest.BLOCKED_EXTENSIONS_LC); java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> m = com.googlesource.gerrit.plugins.uploadvalidator.FileExtensionValidator.performValidation(repo, c, rw, com.googlesource.gerrit.plugins.uploadvalidator.FileExtensionValidatorTest.BLOCKED_EXTENSIONS_LC); java.util.List<java.lang.String> expected = new java.util.ArrayList<>(); for (java.lang.String extension : com.googlesource.gerrit.plugins.uploadvalidator.FileExtensionValidatorTest.BLOCKED_EXTENSIONS_LC) { expected.add(("ERROR: blocked file: foo." + extension)); } assertThat(com.googlesource.gerrit.plugins.uploadvalidator.TestUtils.transformMessages(m)).containsExactlyElementsIn(expected); } }
@org.junit.Test public void accountEvictionFromAccountCreatorIfUserBranchIsDeleted() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Account.Id accountId = new com.google.gerrit.reviewdb.client.Account.Id(1); com.google.gerrit.reviewdb.client.Project.NameKey allUsers = new com.google.gerrit.reviewdb.client.Project.NameKey(com.google.gerrit.server.config.AllUsersNameProvider.DEFAULT); org.eclipse.jgit.lib.Repository allUsersRepo = repoManager.createRepository(allUsers); com.google.gerrit.acceptance.AccountCreator accountCreator = org.easymock.EasyMock.createNiceMock(com.google.gerrit.acceptance.AccountCreator.class); accountCreator.evict(com.google.common.collect.ImmutableSet.of(accountId)); org.easymock.EasyMock.expectLastCall(); org.easymock.EasyMock.replay(accountCreator); try (com.google.gerrit.acceptance.ProjectResetter resetProject = builder(accountCreator, null, null, null).build(new com.google.gerrit.acceptance.ProjectResetter.Config().reset(project).reset(allUsers))) { createRef(allUsersRepo, com.google.gerrit.reviewdb.client.RefNames.refsUsers(accountId)); } org.easymock.EasyMock.verify(accountCreator); }
@org.junit.Before public void setUp() throws java.lang.Exception { com.google.inject.AbstractModule mod = new com.google.inject.AbstractModule() { @java.lang.Override protected void configure() { com.google.gerrit.extensions.registration.DynamicMap.mapOf(binder(), com.google.gerrit.extensions.config.CapabilityDefinition.class); bind(com.google.gerrit.extensions.config.CapabilityDefinition.class).annotatedWith(com.google.gerrit.extensions.annotations.Exports.named("printHello")).toInstance(new com.google.gerrit.extensions.config.CapabilityDefinition() { @java.lang.Override public java.lang.String getDescription() { return "Print Hello"; } }); } }; injector = com.google.inject.Guice.createInjector(mod); }
public java.util.List<com.google.gerrit.reviewdb.client.AccountGroupMemberAudit> getMembersAudit(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.reviewdb.client.AccountGroup.UUID groupUuid) throws com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { if (groupsMigration.readFromNoteDb()) { return auditLogReader.getMembersAudit(groupUuid); } java.util.Optional<com.google.gerrit.reviewdb.client.AccountGroup> group = com.google.gerrit.server.group.db.Groups.getGroupFromReviewDb(db, groupUuid); if (!(group.isPresent())) { return com.google.common.collect.ImmutableList.of(); } java.util.List<com.google.gerrit.reviewdb.client.AccountGroupMemberAudit> audits = db.accountGroupMembersAudit().byGroup(group.get().getId()).toList(); java.util.Collections.sort(audits, java.util.Comparator.comparing((com.google.gerrit.reviewdb.client.AccountGroupMemberAudit a) -> a.getAddedOn())); return audits; }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<java.util.List<com.google.gerrit.extensions.common.AccountInfo>> apply(com.google.gerrit.server.change.ChangeResource rsrc) throws com.google.gwtorm.server.OrmException { java.util.Set<com.google.gerrit.reviewdb.client.Account.Id> pastAssignees = rsrc.getNotes().load().getPastAssignees(); if (pastAssignees == null) { return com.google.gerrit.extensions.restapi.Response.ok(java.util.Collections.emptyList()); } com.google.gerrit.server.account.AccountLoader accountLoader = accountLoaderFactory.create(true); java.util.List<com.google.gerrit.extensions.common.AccountInfo> infos = pastAssignees.stream().map(accountLoader::get).collect(java.util.stream.Collectors.toList()); accountLoader.fill(); return com.google.gerrit.extensions.restapi.Response.ok(infos); }
static com.google.gerrit.client.reviewdb.AccountExternalId newInstance(int rawOldAccountId, java.lang.String rawExternalId) { return new com.google.gerrit.client.reviewdb.AccountExternalId(new com.google.gerrit.client.reviewdb.Account.Id(rawOldAccountId), new com.google.gerrit.client.reviewdb.AccountExternalId.Key(rawExternalId)); }
public void execute() throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.git.UpdateException { execute(com.google.gerrit.server.git.BatchUpdate.Listener.NONE); }
private void executeUpdateRepo() throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.update.UpdateException { try { logDebug("Executing updateRepo on {} ops", ops.size()); com.google.gerrit.server.update.NoteDbBatchUpdate.RepoContextImpl ctx = new com.google.gerrit.server.update.NoteDbBatchUpdate.RepoContextImpl(); for (com.google.gerrit.server.update.BatchUpdateOp op : ops.values()) { op.updateRepo(ctx); } logDebug("Executing updateRepo on {} RepoOnlyOps", repoOnlyOps.size()); for (com.google.gerrit.server.update.RepoOnlyOp op : repoOnlyOps) { op.updateRepo(ctx); } if (((onSubmitValidators) != null) && (!(getRefUpdates().isEmpty()))) { onSubmitValidators.validate(project, ctx.getRevWalk().getObjectReader(), repoView.getCommands()); } if ((repoView) != null) { logDebug("Flushing inserter"); repoView.getInserter().flush(); } else { logDebug("No objects to flush"); } } catch (java.lang.Exception e) { com.google.common.base.Throwables.throwIfInstanceOf(e, com.google.gerrit.extensions.restapi.RestApiException.class); throw new com.google.gerrit.server.update.UpdateException(e); } }
public static com.google.gerrit.index.query.Predicate<com.google.gerrit.reviewdb.client.AccountGroup> name(java.lang.String name) { return new com.google.gerrit.server.query.group.GroupPredicates.GroupPredicate(com.google.gerrit.server.index.group.GroupField.NAME, GroupQueryBuilder.FIELD_NAME, name); }
public boolean login(javax.servlet.http.HttpServletRequest request, javax.servlet.http.HttpServletResponse response, com.googlesource.gerrit.plugins.github.oauth.OAuthProtocol.Scope... scopes) throws java.io.IOException { if (isLoggedIn()) { return true; } com.googlesource.gerrit.plugins.github.oauth.GitHubLogin.log.debug(("Login " + (this))); if (com.googlesource.gerrit.plugins.github.oauth.OAuthProtocol.isOAuthFinal(request)) { com.googlesource.gerrit.plugins.github.oauth.GitHubLogin.log.debug(("Login-FINAL " + (this))); com.googlesource.gerrit.plugins.github.oauth.OAuthProtocol.AccessToken loginAccessToken = oauth.loginPhase2(request, response); if ((loginAccessToken != null) && (!(loginAccessToken.isError()))) { login(loginAccessToken); } if (isLoggedIn()) { com.googlesource.gerrit.plugins.github.oauth.GitHubLogin.log.debug(("Login-SUCCESS " + (this))); response.sendRedirect(com.googlesource.gerrit.plugins.github.oauth.OAuthProtocol.getTargetUrl(request)); return true; } else { response.sendError(HttpStatus.SC_UNAUTHORIZED); return false; } } else { this.loginScopes = getScopes(getScopesKey(request, response), scopes); com.googlesource.gerrit.plugins.github.oauth.GitHubLogin.log.debug(("Login-PHASE1 " + (this))); oauth.loginPhase1(request, response, loginScopes); return false; } }
@java.lang.Override public java.util.Map<java.lang.String, com.google.gerrit.server.access.ListAccess.ProjectAccessInfo> apply(com.google.gerrit.extensions.restapi.TopLevelResource resource) throws com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.ResourceNotFoundException, java.io.IOException { java.util.Map<java.lang.String, com.google.gerrit.server.access.ListAccess.ProjectAccessInfo> access = com.google.common.collect.Maps.newTreeMap(); for (java.lang.String p : projects) { com.google.gerrit.reviewdb.client.Project.NameKey projectName = new com.google.gerrit.reviewdb.client.Project.NameKey(p); try (com.google.gerrit.server.git.MetaDataUpdate md = metaDataUpdateFactory.create(projectName)) { com.google.gerrit.server.project.ProjectControl pc = open(projectName); com.google.gerrit.server.git.ProjectConfig config = com.google.gerrit.server.git.ProjectConfig.read(md); if (config.updateGroupNames(groupBackend)) { md.setMessage("Update group names\n"); config.commit(md); projectCache.evict(config.getProject()); pc = open(projectName); } else if (((config.getRevision()) != null) && (!(config.getRevision().equals(pc.getProjectState().getConfig().getRevision())))) { projectCache.evict(config.getProject()); pc = open(projectName); } access.put(p, new com.google.gerrit.server.access.ListAccess.ProjectAccessInfo(pc, config)); } catch (org.eclipse.jgit.errors.ConfigInvalidException e) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException(e.getMessage()); } catch (org.eclipse.jgit.errors.RepositoryNotFoundException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(p); } } return access; }
public com.google.common.base.Optional<com.google.gerrit.reviewdb.client.PatchLineComment> get(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.notedb.ChangeNotes notes, com.google.gerrit.reviewdb.client.PatchLineComment.Key key) throws com.google.gwtorm.server.OrmException { if (!(migration.readComments())) { return com.google.common.base.Optional.fromNullable(db.patchComments().get(key)); } for (com.google.gerrit.reviewdb.client.PatchLineComment c : byChange(db, notes)) { if (key.equals(c.getKey())) { return com.google.common.base.Optional.of(c); } } return com.google.common.base.Optional.absent(); }
@java.lang.Override public final int parseArguments(final org.kohsuke.args4j.spi.Parameters params) throws org.kohsuke.args4j.CmdLineException { final java.lang.String token = params.getParameter(0); final java.lang.String[] tokens = token.split(","); if ((tokens.length) != 3) { throw new org.kohsuke.args4j.CmdLineException(owner, ("change should be specified as " + "<project>,<branch>,<change-id>")); } try { final com.google.gerrit.reviewdb.client.Change.Key key = Change.Key.parse(tokens[2]); final com.google.gerrit.reviewdb.client.Project.NameKey project = new com.google.gerrit.reviewdb.client.Project.NameKey(tokens[0]); final com.google.gerrit.reviewdb.client.Branch.NameKey branch = new com.google.gerrit.reviewdb.client.Branch.NameKey(project, tokens[1]); for (final com.google.gerrit.reviewdb.client.Change change : db.changes().byBranchKey(branch, key)) { setter.addValue(change.getId()); return 1; } } catch (java.lang.IllegalArgumentException e) { throw new org.kohsuke.args4j.CmdLineException(owner, "Change-Id is not valid"); } catch (com.google.gwtorm.server.OrmException e) { throw new org.kohsuke.args4j.CmdLineException(owner, ("Database error: " + (e.getMessage()))); } throw new org.kohsuke.args4j.CmdLineException(owner, (("\"" + token) + "\": change not found")); }
public com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> reviewerByState(java.lang.String who, com.google.gerrit.server.notedb.ReviewerStateInternal state) throws com.google.gerrit.server.query.QueryParseException, com.google.gwtorm.server.OrmException { com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> reviewerByEmailPredicate = null; if (args.index.getSchema().hasField(ChangeField.REVIEWER_BY_EMAIL)) { com.google.gerrit.server.mail.Address address = com.google.gerrit.server.mail.Address.tryParse(who); if (address != null) { reviewerByEmailPredicate = com.google.gerrit.server.query.change.ReviewerByEmailPredicate.forState(args, address, state); } } com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> reviewerPredicate = null; try { reviewerPredicate = com.google.gerrit.server.query.Predicate.or(parseAccount(who).stream().map(( id) -> com.google.gerrit.server.query.change.ReviewerPredicate.forState(args, id, state)).collect(java.util.stream.Collectors.toList())); } catch (com.google.gerrit.server.query.QueryParseException e) { if (reviewerByEmailPredicate == null) { throw e; } } if ((reviewerPredicate != null) && (reviewerByEmailPredicate != null)) { return com.google.gerrit.server.query.Predicate.or(reviewerPredicate, reviewerByEmailPredicate); } else if (reviewerPredicate != null) { return reviewerPredicate; } return reviewerByEmailPredicate; }
public final native com.google.gerrit.client.info.GroupInfo autoVerifyGroup();
@java.lang.Override protected void configure() { factory(AddBranch.Factory.class); factory(ChangeProjectAccess.Factory.class); factory(CreateProjectHandler.Factory.class); factory(ChangeProjectSettings.Factory.class); factory(DeleteBranches.Factory.class); factory(ListBranches.Factory.class); factory(VisibleProjects.Factory.class); factory(VisibleProjectDetails.Factory.class); factory(ProjectAccessFactory.Factory.class); factory(ProjectDetailFactory.Factory.class); factory(SuggestParentCandidatesHandler.Factory.class); }
public final void removeLineClass(net.codemirror.lib.CodeMirror.LineHandle line, net.codemirror.lib.CodeMirror.LineClassWhere where, java.lang.String className) { removeLineClassNative(line, where.value(), className); }
private void checkRequiresCapability() throws com.google.gerrit.httpd.RestApiServlet.RequireCapabilityException { com.google.gerrit.extensions.annotations.RequiresCapability rc = getClass().getAnnotation(com.google.gerrit.extensions.annotations.RequiresCapability.class); if (rc != null) { com.google.gerrit.server.CurrentUser user = currentUser.get(); com.google.gerrit.server.account.CapabilityControl ctl = user.getCapabilities(); if ((!(ctl.canPerform(rc.value()))) && (!(ctl.canAdministrateServer()))) { java.lang.String msg = java.lang.String.format("fatal: %s does not have \"%s\" capability.", user.getUserName(), rc.value()); throw new com.google.gerrit.httpd.RestApiServlet.RequireCapabilityException(msg); } } }
@java.lang.Override protected void onRequestSuggestions(com.google.gerrit.client.ui.Request request, com.google.gerrit.client.ui.Callback done) { java.util.List<com.google.gerrit.client.ui.CreateChangeDialog.BranchSuggestion> suggestions = new java.util.ArrayList<>(); for (com.google.gerrit.client.projects.BranchInfo b : branches) { if (b.ref().contains(request.getQuery())) { suggestions.add(new com.google.gerrit.client.ui.CreateChangeDialog.BranchSuggestion(b)); } } done.onSuggestionsReady(request, new com.google.gerrit.client.ui.Response(suggestions)); }
@org.junit.Test public void testUpdateOne() throws com.google.gwtorm.server.OrmException, java.sql.SQLException { java.sql.PreparedStatement update = stubStatementWithUpdateCounts(com.google.gwtorm.jdbc.TestJdbcAccess.UPDATE, 1); createClassUnderTest().update(oneRow); com.google.gwtorm.jdbc.TestJdbcAccess.assertUsedBatchingOnly(update); }
private void assertChanges(java.util.Set<java.lang.String> actualChanges, com.google.gerrit.acceptance.PushOneCommit... expectedChanges) { assertThat(((java.lang.Iterable<?>) (actualChanges))).hasSize(expectedChanges.length); for (com.google.gerrit.acceptance.PushOneCommit.Result c : expectedChanges) { assertThat(actualChanges.contains(id(c))).isTrue(); } }
@org.junit.Test public void submitWithMergedAncestorsOnOtherBranch() throws java.lang.Exception { org.eclipse.jgit.revwalk.RevCommit initialHead = getRemoteHead(); com.google.gerrit.acceptance.PushOneCommit.Result change1 = createChange(testRepo, "master", "base commit", "a.txt", "1", ""); submit(change1.getChangeId()); org.eclipse.jgit.revwalk.RevCommit headAfterFirstSubmit = getRemoteHead(); gApi.projects().name(project.get()).branch("branch").create(new com.google.gerrit.extensions.api.projects.BranchInput()); com.google.gerrit.acceptance.PushOneCommit.Result change2 = createChange(testRepo, "master", "We want to commit this to master first", "a.txt", "2", ""); submit(change2.getChangeId()); org.eclipse.jgit.revwalk.RevCommit headAfterSecondSubmit = getRemoteLog(project, "master").get(0); assertThat(headAfterSecondSubmit.getShortMessage()).isEqualTo(change2.getCommit().getShortMessage()); org.eclipse.jgit.revwalk.RevCommit tip2 = getRemoteLog(project, "branch").get(0); assertThat(tip2.getShortMessage()).isEqualTo(change1.getCommit().getShortMessage()); com.google.gerrit.acceptance.PushOneCommit.Result change3 = createChange(testRepo, "branch", ("This commit is based on master, which includes change2, " + "but is targeted at branch, which doesn't include it."), "a.txt", "3", ""); submit(change3.getChangeId()); java.util.List<org.eclipse.jgit.revwalk.RevCommit> log3 = getRemoteLog(project, "branch"); assertThat(log3.get(0).getShortMessage()).isEqualTo(change3.getCommit().getShortMessage()); assertThat(log3.get(1).getShortMessage()).isEqualTo(change2.getCommit().getShortMessage()); assertRefUpdatedEvents(initialHead, headAfterFirstSubmit, headAfterFirstSubmit, headAfterSecondSubmit); assertChangeMergedEvents(change1.getChangeId(), headAfterFirstSubmit.name(), change2.getChangeId(), headAfterSecondSubmit.name()); }
private com.google.gerrit.server.account.AccountState missing(com.google.gerrit.reviewdb.client.Account.Id accountId) { com.google.gerrit.reviewdb.client.Account account = new com.google.gerrit.reviewdb.client.Account(accountId, com.google.gerrit.common.TimeUtil.nowTs()); account.setActive(false); return com.google.gerrit.server.account.AccountState.forAccount(allUsersName, account); }
@org.junit.Test public void testCreateGroupWithoutCapability_Forbidden() throws com.google.gwtorm.server.OrmException, com.jcraft.jsch.JSchException, java.io.IOException { com.google.gerrit.acceptance.TestAccount user = accounts.create("user", "user@example.com", "User"); com.google.gerrit.acceptance.RestResponse r = new com.google.gerrit.acceptance.RestSession(user).put("/groups/newGroup"); assertEquals(HttpStatus.SC_FORBIDDEN, r.getStatusCode()); }
@java.lang.Override public void setUp() throws java.lang.Exception { super.setUp(); index = new com.google.gerrit.server.index.IndexRewriteTest.DummyIndex(); queryBuilder = new com.google.gerrit.server.index.IndexRewriteTest.QueryBuilder(); rewrite = new com.google.gerrit.server.index.IndexRewriteImpl(index, null, new com.google.gerrit.server.index.IndexRewriteImpl.BasicRewritesImpl(null)); }
@java.lang.Override public java.util.List<com.google.gerrit.server.change.TestSubmitRule.Record> apply(com.google.gerrit.server.change.RevisionResource rsrc, com.google.gerrit.extensions.common.TestSubmitRuleInput input) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gwtorm.server.OrmException { if (input == null) { input = new com.google.gerrit.extensions.common.TestSubmitRuleInput(); } if (((input.rule) != null) && (!(rules.isProjectRulesEnabled()))) { throw new com.google.gerrit.extensions.restapi.AuthException("project rules are disabled"); } input.filters = com.google.common.base.MoreObjects.firstNonNull(input.filters, filters); com.google.gerrit.server.project.SubmitRuleEvaluator evaluator = new com.google.gerrit.server.project.SubmitRuleEvaluator(accountCache, accounts, changeDataFactory.create(db.get(), rsrc.getControl())); java.util.List<com.google.gerrit.common.data.SubmitRecord> records = evaluator.setPatchSet(rsrc.getPatchSet()).setLogErrors(false).setSkipSubmitFilters(((input.filters) == (com.google.gerrit.extensions.common.TestSubmitRuleInput.Filters.SKIP))).setRule(input.rule).evaluate(); java.util.List<com.google.gerrit.server.change.TestSubmitRule.Record> out = com.google.common.collect.Lists.newArrayListWithCapacity(records.size()); com.google.gerrit.server.account.AccountLoader accounts = accountInfoFactory.create(true); for (com.google.gerrit.common.data.SubmitRecord r : records) { out.add(new com.google.gerrit.server.change.TestSubmitRule.Record(r, accounts)); } if (!(out.isEmpty())) { out.get(0).prologReductionCount = evaluator.getReductionsConsumed(); } accounts.fill(); return out; }
@org.junit.Test public void inalidPathSeparator() { for (char c : com.google.gerrit.server.config.GitwebConfigTest.SOME_INVALID_CHARACTERS.toCharArray()) { assertWithMessage(("invalid character accepted: " + c)).that(com.google.gerrit.server.config.GitwebConfig.isValidPathSeparator(c)).isFalse(); } }
@java.lang.Override public java.util.Optional<com.google.gerrit.reviewdb.client.Account.Id> load(java.lang.String username) throws java.lang.Exception { com.google.gerrit.reviewdb.server.ReviewDb db = dbProvider.get(); return java.util.Optional.ofNullable(db.accountExternalIds().get(new com.google.gerrit.reviewdb.client.AccountExternalId.Key((((com.google.gerrit.server.account.ExternalId.SCHEME_USERNAME) + ":") + username)))).map(AccountExternalId::getAccountId); }
@java.lang.Override public void postEvent(com.google.gerrit.server.events.Event event, com.google.gerrit.reviewdb.server.ReviewDb db) { }
public java.lang.String toProject(final com.google.gerrit.reviewdb.Project.NameKey project) { com.google.gerrit.common.data.ParameterizedString pattern = new com.google.gerrit.common.data.ParameterizedString(type.getProject()); final java.util.Map<java.lang.String, java.lang.String> p = new java.util.HashMap<java.lang.String, java.lang.String>(); p.put("project", com.google.gwt.http.client.URL.encodeQueryString(project.get())); return (baseUrl) + (pattern.replace(p)); }
@java.lang.Override public com.google.gerrit.extensions.restapi.RestModifyView<com.google.gerrit.server.project.ProjectResource, ?> create(com.google.gerrit.server.project.ProjectResource parent, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.RestApiException { parent.getProjectState().checkStatePermitsWrite(); if (com.google.gerrit.server.restapi.project.DashboardsCollection.isDefaultDashboard(id)) { return createDefault.get(); } throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); }
@java.lang.Override public java.util.Collection<com.google.gerrit.reviewdb.RefRight> get() { return this.get(wildProject).getLocalRights(); }
@java.lang.Override public com.google.gerrit.server.mail.Address from(com.google.gerrit.reviewdb.client.Account.Id fromId) { final java.lang.String senderName; if (fromId != null) { java.lang.String fullName = accountCache.maybeGet(fromId).map(( a) -> a.getAccount().getFullName()).orElse(null); if ((fullName == null) || ("".equals(fullName))) { fullName = anonymousCowardName; } senderName = namePattern.replace("user", fullName).toString(); } else { senderName = serverAddress.getName(); } java.lang.String senderEmail; if (senderEmailPattern.getParameterNames().isEmpty()) { senderEmail = senderEmailPattern.getRawPattern(); } else { senderEmail = senderEmailPattern.replace("userHash", com.google.gerrit.server.mail.send.FromAddressGeneratorProvider.hashOf(senderName)).toString(); } return new com.google.gerrit.server.mail.Address(senderName, senderEmail); }
public static com.google.gerrit.reviewdb.client.ChangeMessage newMessage(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx, java.lang.String body, @com.google.gerrit.common.Nullable java.lang.String tag) throws com.google.gwtorm.server.OrmException { return com.google.gerrit.server.ChangeMessagesUtil.newMessage(ctx.getDb(), ctx.getChange().currentPatchSetId(), ctx.getUser(), ctx.getWhen(), body, tag); }
public void BROKEN_testIsEnabledUnknownEvent() { com.google.gerrit.server.events.RefEvent event = createMock(com.google.gerrit.server.events.RefEvent.class); com.googlesource.gerrit.plugins.its.base.its.ItsConfig itsConfig = createItsConfig(); replayMocks(); assertFalse(itsConfig.isEnabled(event)); assertLogMessageContains("not recognised and ignored"); }
private void removeUI() { if ((replyToBox) != null) { replyToBox.unregisterReplyBox(); } parent.removeDraft(this, comment.side(), ((comment.line()) - 1)); removeFromParent(); com.google.gwt.core.client.Scheduler.get().scheduleDeferred(new com.google.gwt.core.client.Scheduler.ScheduledCommand() { @java.lang.Override public void execute() { resizePaddingWidget(); } }); getSelfWidget().clear(); com.google.gerrit.client.diff.PaddingManager manager = getPaddingManager(); manager.remove(this); manager.resizePaddingWidget(); cm.focus(); }
public static void publishEdit(@com.google.gerrit.common.Nullable java.lang.String project, int id, com.google.gwt.user.client.rpc.AsyncCallback<com.google.gwt.core.client.JavaScriptObject> cb) { com.google.gwt.core.client.JavaScriptObject in = com.google.gwt.core.client.JavaScriptObject.createObject(); com.google.gerrit.client.changes.ChangeApi.change(project, id).view("edit:publish").post(in, cb); }
private com.google.gerrit.acceptance.server.mail.StagedChange stageWipChangeWithExtraReviewer() throws java.lang.Exception { return stageChangeWithExtraReviewer(this::stageWipChange); }
private void appendPath(java.lang.String path) { if (Patch.COMMIT_MSG.equals(path)) { sb.append(Util.C.commitMessage()); } else if (Patch.MERGE_LIST.equals(path)) { sb.append(Util.C.mergeList()); } else if (com.google.gerrit.client.Gerrit.getUserPreferences().muteCommonPathPrefixes()) { int commonPrefixLen = commonPrefix(path); if (commonPrefixLen > 0) { sb.openSpan().setStyleName(com.google.gerrit.client.change.FileTable.R.css().commonPrefix()).append(path.substring(0, commonPrefixLen)).closeSpan(); } sb.append(path.substring(commonPrefixLen)); lastPath = path; } else { sb.append(path); } }
@org.junit.Test @com.google.gerrit.acceptance.GerritConfigs({ @com.google.gerrit.acceptance.GerritConfig(name = "plugin.high-availability.url", value = "http://localhost:18888"), @com.google.gerrit.acceptance.GerritConfig(name = "plugin.high-availability.user", value = "admin") }) public void flushAndSendPost() throws java.lang.Exception { final java.lang.String flushRequest = "/plugins/high-availability/cache/" + (com.ericsson.gerrit.plugins.highavailability.cache.Constants.PROJECT_LIST); wireMockRule.addMockServiceRequestListener(new com.github.tomakehurst.wiremock.http.RequestListener() { @java.lang.Override public void requestReceived(com.github.tomakehurst.wiremock.http.Request request, com.github.tomakehurst.wiremock.http.Response response) { if (request.getAbsoluteUrl().contains(flushRequest)) { synchronized(flushRequest) { flushRequest.notify(); } } } }); givenThat(post(urlEqualTo(flushRequest)).willReturn(aResponse().withStatus(HttpStatus.SC_OK))); adminSshSession.exec(("gerrit flush-caches --cache " + (com.ericsson.gerrit.plugins.highavailability.cache.Constants.PROJECT_LIST))); synchronized(flushRequest) { flushRequest.wait(java.util.concurrent.TimeUnit.SECONDS.toMillis(5)); } verify(postRequestedFor(urlEqualTo(flushRequest))); }
@org.junit.Test public void parseAndPersistChangeMessage() throws java.lang.Exception { java.lang.String changeId = createChangeWithReview(); com.google.gerrit.extensions.common.ChangeInfo changeInfo = gApi.changes().id(changeId).get(); java.util.List<com.google.gerrit.extensions.common.CommentInfo> comments = gApi.changes().id(changeId).current().commentsAsList(); java.lang.String ts = MailUtil.rfcDateformatter.format(java.time.ZonedDateTime.ofInstant(comments.get(0).updated.toInstant(), java.time.ZoneId.of("UTC"))); com.google.gerrit.server.mail.receive.MailMessage.Builder b = messageBuilderWithDefaultFields(); java.lang.String txt = newPlaintextBody(((((canonicalWebUrl.get()) + "#/c/") + (changeInfo._number)) + "/1"), "Test Message", null, null, null); b.textContent((txt + (textFooterForChange(changeId, ts)))); mailProcessor.process(b.build()); java.util.Collection<com.google.gerrit.extensions.common.ChangeMessageInfo> messages = gApi.changes().id(changeId).get().messages; assertThat(messages).hasSize(3); assertThat(com.google.common.collect.Iterables.getLast(messages).message).isEqualTo("Patch Set 1:\n\nTest Message"); assertThat(com.google.common.collect.Iterables.getLast(messages).tag).isEqualTo("mailMessageId=some id"); }
public static AccountGroup.UUID make(java.lang.String groupName, org.eclipse.jgit.lib.PersonIdent creator) { java.security.MessageDigest md = org.eclipse.jgit.lib.Constants.newMessageDigest(); md.update(org.eclipse.jgit.lib.Constants.encode((("group " + groupName) + "\n"))); md.update(org.eclipse.jgit.lib.Constants.encode((("creator " + (creator.toExternalString())) + "\n"))); md.update(org.eclipse.jgit.lib.Constants.encode(java.lang.String.valueOf(java.lang.Math.random()))); return new com.google.gerrit.reviewdb.client.AccountGroup.UUID(org.eclipse.jgit.lib.ObjectId.fromRaw(md.digest()).name()); }
private com.google.gerrit.server.account.AccountState makeUser(java.lang.String name, java.lang.String email) { final com.google.gerrit.reviewdb.client.Account.Id userId = new com.google.gerrit.reviewdb.client.Account.Id(42); final com.google.gerrit.reviewdb.client.Account account = new com.google.gerrit.reviewdb.client.Account(userId, com.google.gerrit.common.TimeUtil.nowTs()); account.setFullName(name); account.setPreferredEmail(email); return com.google.gerrit.server.account.AccountState.forAccount(new com.google.gerrit.server.config.AllUsersName(com.google.gerrit.server.config.AllUsersNameProvider.DEFAULT), account); }
private void addReviewerByEmailToReviewableChangeInReviewDb(com.google.gerrit.acceptance.server.mail.AddReviewerSenderIT.Adder adder) throws java.lang.Exception { assume().that(notesMigration.readChanges()).isFalse(); java.lang.String email = "addedbyemail@example.com"; com.google.gerrit.acceptance.server.mail.StagedChange sc = stageReviewableChange(); addReviewer(adder, sc.changeId, sc.owner, email); assertThat(sender).notSent(); }
public com.google.gerrit.server.change.ChangeJson.ChangeInfo format(com.google.gerrit.server.change.ChangeResource rsrc) throws com.google.gwtorm.server.OrmException { return format(changeDataFactory.create(db.get(), rsrc.getControl())); }
private net.codemirror.lib.CodeMirror.BeforeSelectionChangeHandler onSelectionChange(final net.codemirror.lib.CodeMirror cm) { return new net.codemirror.lib.CodeMirror.BeforeSelectionChangeHandler() { private com.google.gerrit.client.diff.InsertCommentBubble bubble; @java.lang.Override public void handle(net.codemirror.lib.CodeMirror cm, net.codemirror.lib.Pos anchor, net.codemirror.lib.Pos head) { if (anchor.equals(head)) { if ((bubble) != null) { bubble.setVisible(false); } return; } else if ((bubble) == null) { init(anchor); } else { bubble.setVisible(true); } bubble.position(cm.charCoords(head, "local")); } private void init(net.codemirror.lib.Pos anchor) { bubble = new com.google.gerrit.client.diff.InsertCommentBubble(commentManager, cm); add(bubble); cm.addWidget(anchor, bubble.getElement()); } }; }
@java.lang.Override protected void doGet(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse rsp) throws java.io.IOException { java.lang.String query = com.google.common.base.CharMatcher.is('/').trimTrailingFrom(req.getPathInfo()); java.util.List<com.google.gerrit.extensions.common.ChangeInfo> results; try { results = changes.query(query).withLimit(2).get(); } catch (com.google.gerrit.extensions.restapi.RestApiException e) { com.google.gerrit.httpd.DirectChangeByCommit.log.warn(("Cannot process query by URL: /r/" + query), e); results = com.google.common.collect.ImmutableList.of(); } java.lang.String token; if ((results.size()) == 1) { com.google.gerrit.extensions.common.ChangeInfo ci = results.iterator().next(); token = com.google.gerrit.common.PageLinks.toChange(new com.google.gerrit.reviewdb.client.Project.NameKey(ci.project), new com.google.gerrit.reviewdb.client.Change.Id(ci._number)); } else { token = com.google.gerrit.common.PageLinks.toChangeQuery(query); } com.google.gerrit.httpd.UrlModule.toGerrit(token, req, rsp); }
public void start(final org.apache.sshd.server.Environment env) throws java.io.IOException { com.google.gerrit.sshd.SshScope.Context old = com.google.gerrit.sshd.SshScope.set(context); java.lang.String message; try { message = messageFactory.get().getMessage(); } finally { com.google.gerrit.sshd.SshScope.set(old); } err.write(org.eclipse.jgit.lib.Constants.encode(message.toString())); err.flush(); in.close(); out.close(); err.close(); exit.onExit(127); }
@com.google.gerrit.common.Nullable public org.eclipse.jgit.lib.ObjectId getMetaId() { return metaId; }
private void insertChange(com.google.gerrit.reviewdb.server.ReviewDb db) throws com.google.gwtorm.server.OrmException { final com.google.gerrit.reviewdb.client.Account.Id me = currentUser.getAccountId(); final java.util.List<org.eclipse.jgit.revwalk.FooterLine> footerLines = commit.getFooterLines(); final com.google.gerrit.server.mail.MailUtil.MailRecipients recipients = new com.google.gerrit.server.mail.MailUtil.MailRecipients(); if ((magicBranch) != null) { recipients.add(magicBranch.getMailRecipients()); } recipients.add(getRecipientsFromFooters(accountResolver, ps, footerLines)); recipients.remove(me); changeInserter.insertChange(db, change, ps, commit, labelTypes, footerLines, info, recipients.getReviewers()); created = true; workQueue.getDefaultQueue().submit(requestScopePropagator.wrap(new java.lang.Runnable() { @java.lang.Override public void run() { try { com.google.gerrit.server.mail.CreateChangeSender cm = createChangeSenderFactory.create(change); cm.setFrom(me); cm.setPatchSet(ps, info); cm.addReviewers(recipients.getReviewers()); cm.addExtraCC(recipients.getCcOnly()); cm.send(); } catch (java.lang.Exception e) { com.google.gerrit.server.git.ReceiveCommits.log.error(("Cannot send email for new change " + (change.getId())), e); } } @java.lang.Override public java.lang.String toString() { return "send-email newchange"; } })); }
private void insertNoneRow(int row) { table.insertRow(row); table.setText(row, 0, Util.C.docTableNone()); com.google.gwt.user.client.ui.FlexTable.FlexCellFormatter fmt = table.getFlexCellFormatter(); fmt.setStyleName(row, 0, Gerrit.RESOURCES.css().emptySection()); }
@org.junit.Test public void putDraft() throws java.lang.Exception { for (java.lang.Integer line : lines) { com.google.gerrit.acceptance.PushOneCommit.Result r = createChange(); java.lang.String changeId = r.getChangeId(); java.lang.String revId = r.getCommit().getName(); com.google.gerrit.extensions.api.changes.ReviewInput.CommentInput comment = newCommentInfo("file1", Side.REVISION, line, "comment 1"); addDraft(changeId, revId, comment); java.util.Map<java.lang.String, java.util.List<com.google.gerrit.extensions.common.CommentInfo>> result = getDraftComments(changeId, revId); com.google.gerrit.extensions.common.CommentInfo actual = com.google.common.collect.Iterables.getOnlyElement(result.get(comment.path)); com.google.gerrit.acceptance.server.change.CommentsIT.assertCommentInfo(comment, actual); java.lang.String uuid = actual.id; comment.message = "updated comment 1"; updateDraft(changeId, revId, comment, uuid); result = getDraftComments(changeId, revId); actual = com.google.common.collect.Iterables.getOnlyElement(result.get(comment.path)); com.google.gerrit.acceptance.server.change.CommentsIT.assertCommentInfo(comment, actual); } }
private com.google.gerrit.server.project.DashboardResource defaultOf(com.google.gerrit.server.project.ProjectState projectState, com.google.gerrit.server.CurrentUser user) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.permissions.PermissionBackendException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { java.lang.String id = projectState.getProject().getLocalDefaultDashboard(); if (com.google.common.base.Strings.isNullOrEmpty(id)) { id = projectState.getProject().getDefaultDashboard(); } if (com.google.gerrit.server.restapi.project.DashboardsCollection.isDefaultDashboard(id)) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } else if (!(com.google.common.base.Strings.isNullOrEmpty(id))) { return parse(projectState, user, id); } else if (!(inherited)) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } for (com.google.gerrit.server.project.ProjectState ps : projectState.tree()) { id = ps.getProject().getDefaultDashboard(); if (com.google.gerrit.server.restapi.project.DashboardsCollection.isDefaultDashboard(id)) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } else if (!(com.google.common.base.Strings.isNullOrEmpty(id))) { return parse(projectState, user, id); } } throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); }
private com.google.gerrit.server.git.BatchUpdate.ChangeContext newChangeContext(com.google.gerrit.reviewdb.server.ReviewDb db, org.eclipse.jgit.lib.Repository repo, org.eclipse.jgit.revwalk.RevWalk rw, com.google.gerrit.reviewdb.client.Change.Id id) throws com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.client.Change c = newChanges.get(id); if (c == null) { c = com.google.gerrit.server.notedb.ChangeNotes.readOneReviewDbChange(db, id); if (c == null) { logDebug("Failed to get change {} from unwrapped db", id); throw new com.google.gerrit.server.project.NoSuchChangeException(id); } com.google.gerrit.server.notedb.NoteDbChangeState.checkNotReadOnly(c, skewMs); } com.google.gerrit.server.notedb.ChangeNotes notes = changeNotesFactory.createForBatchUpdate(c); com.google.gerrit.server.project.ChangeControl ctl = changeControlFactory.controlFor(notes, user); return new com.google.gerrit.server.git.BatchUpdate.ChangeContext(ctl, new com.google.gerrit.server.git.BatchUpdateReviewDb(db), repo, rw); }
@java.lang.Override @com.google.gerrit.common.Nullable public synchronized <T> T get(com.google.gerrit.server.PropertyKey<T> key) { if ((properties) != null) { @java.lang.SuppressWarnings("unchecked") T value = ((T) (properties.get(key))); return value; } return null; }
private com.google.gerrit.client.change.RelatedChangesTab getTab() { if ((conflictingChangesTab) == null) { conflictingChangesTab = createTab(Resources.C.conflictingChanges(), Resources.C.conflictingChangesTooltip()); } return conflictingChangesTab; }
protected void checkUpdate(com.google.gerrit.server.notedb.AbstractChangeUpdate update) { checkState(java.util.Objects.equals(update.getPatchSetId(), psId), "cannot apply event for %s to update for %s", update.getPatchSetId(), psId); checkState((((when.getTime()) - (update.getWhen().getTime())) <= (com.google.gerrit.server.notedb.rebuild.ChangeRebuilderImpl.MAX_WINDOW_MS)), "event at %s outside update window starting at %s", when, update.getWhen()); checkState(java.util.Objects.equals(update.getNullableAccountId(), user), "cannot apply event by %s to update by %s", user, update.getNullableAccountId()); }
@org.junit.Test public void exactlyOnePage() throws java.lang.Exception { java.util.List<org.eclipse.jgit.revwalk.RevCommit> commits = linearCommits(3); walk.markStart(commits.get(2)); com.google.gitiles.Paginator p = new com.google.gitiles.Paginator(walk, 3, null); assertEquals(com.google.common.collect.ImmutableList.of(commits.get(2), commits.get(1), commits.get(0)), com.google.common.collect.ImmutableList.copyOf(p)); assertNull(p.getPreviousStart()); assertNull(p.getNextStart()); }
private java.lang.Iterable<java.lang.String> getUsernames(com.google.gerrit.server.CurrentUser user) { if (user.isIdentifiedUser()) { java.util.Set<java.lang.String> emails = user.asIdentifiedUser().getEmailAddresses(); if ((user.getUserName()) == null) { return emails; } else if (emails.isEmpty()) { return com.google.common.collect.ImmutableSet.of(user.getUserName()); } com.google.common.collect.Iterables.concat(emails, com.google.common.collect.ImmutableSet.of(user.getUserName())); } if ((user.getUserName()) != null) { return com.google.common.collect.ImmutableSet.of(user.getUserName()); } return com.google.common.collect.ImmutableSet.of(); }
@java.lang.Override protected int getValueInt(com.google.gerrit.server.query.change.ChangeData changeData) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.query.change.ChangeData.ChangedLines changedLines = changeData.changedLines(); return (changedLines.insertions) + (changedLines.deletions); }
void set(com.google.gerrit.client.changes.ChangeInfo info, final java.lang.String revision) { if (info.status().isClosed()) { setVisible(false); return; } project = info.project(); com.google.gerrit.client.changes.ChangeApi.revision(info.legacy_id().get(), revision).view("related").get(new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.change.RelatedChanges.RelatedInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.change.RelatedChanges.RelatedInfo result) { tabPanel.getTabBar().setTabText(0, Resources.M.relatedChanges(result.changes().length())); render(revision, result.changes()); } @java.lang.Override public void onFailure(java.lang.Throwable err) { tabPanel.getTabBar().setTabText(0, Resources.M.relatedChanges(Resources.C.notAvailable())); progress.setVisible(false); scroll.setVisible(false); com.google.gwt.user.client.ui.UIObject.setVisible(error, true); error.setInnerText(err.getMessage()); } }); }
private com.google.gerrit.acceptance.AbstractNotificationTest.FakeEmailSenderSubject rcpt(@com.google.gerrit.common.Nullable com.google.gerrit.acceptance.RecipientType type, com.google.gerrit.server.account.WatchConfig.NotifyType[] watches) { for (com.google.gerrit.server.account.WatchConfig.NotifyType watch : watches) { rcpt(type, watch); } return this; }
protected void onInitUI() { final com.google.gwt.user.client.ui.FlowPanel me = ((com.google.gwt.user.client.ui.FlowPanel) (getWidget())); me.add((header = new com.google.gwt.user.client.ui.Grid(1, com.google.gerrit.client.ui.Screen.Cols.values().length))); me.add((body = new com.google.gwt.user.client.ui.FlowPanel())); com.google.gwt.user.client.ui.FlowPanel title = new com.google.gwt.user.client.ui.FlowPanel(); title.add((headerText = new com.google.gwt.user.client.ui.InlineLabel())); title.setStyleName(Gerrit.RESOURCES.css().screenHeader()); header.setWidget(0, com.google.gerrit.client.ui.Screen.Cols.Title.ordinal(), title); header.setStyleName(Gerrit.RESOURCES.css().screenHeader()); header.getCellFormatter().setHorizontalAlignment(0, com.google.gerrit.client.ui.Screen.Cols.FarEast.ordinal(), HasHorizontalAlignment.ALIGN_RIGHT); header.getCellFormatter().setWidth(0, com.google.gerrit.client.ui.Screen.Cols.FarEast.ordinal(), "100%"); }
@java.lang.Override public com.google.gerrit.server.project.DashboardResource parse(com.google.gerrit.server.project.ProjectResource parent, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gerrit.server.permissions.PermissionBackendException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { if (com.google.gerrit.server.restapi.project.DashboardsCollection.isDefaultDashboard(id)) { return com.google.gerrit.server.project.DashboardResource.projectDefault(parent.getProjectState(), parent.getUser()); } com.google.gerrit.extensions.api.projects.DashboardInfo info; try { info = com.google.gerrit.server.restapi.project.DashboardsCollection.newDashboardInfo(id.get()); } catch (com.google.gerrit.server.restapi.project.DashboardsCollection.InvalidDashboardId e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } for (com.google.gerrit.server.project.ProjectState ps : parent.getProjectState().tree()) { try { return parse(ps, parent.getProjectState(), parent.getUser(), info); } catch (org.eclipse.jgit.errors.AmbiguousObjectException | org.eclipse.jgit.errors.ConfigInvalidException | org.eclipse.jgit.errors.IncorrectObjectTypeException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } catch (com.google.gerrit.extensions.restapi.ResourceNotFoundException e) { continue; } } throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); }
private com.google.gerrit.server.diff.PatchListKey getKey(org.eclipse.jgit.lib.ObjectId revisionIdA, org.eclipse.jgit.lib.ObjectId revisionIdB) { return com.google.gerrit.server.diff.PatchListKey.againstCommit(revisionIdA, revisionIdB, Whitespace.IGNORE_NONE); }
com.google.gerrit.extensions.restapi.Response<com.google.gerrit.server.change.ChangeJson.ChangeInfo> apply(com.google.gerrit.server.change.RevisionResource rsrc) throws com.google.gwtorm.server.OrmException { return cache(json.format(rsrc)); }
@java.lang.Override protected void onLoad() { super.onLoad(); Util.ACCOUNT_SVC.myAccount(new com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gerrit.reviewdb.Account>(this) { public void preDisplay(final com.google.gerrit.reviewdb.Account result) { display(result.getGeneralPreferences()); } }); }
private void checkRequiresCapability(org.apache.sshd.server.Command cmd) throws com.google.gerrit.sshd.UnloggedFailure { java.lang.String pluginName = null; if (cmd instanceof com.google.gerrit.sshd.BaseCommand) { pluginName = ((com.google.gerrit.sshd.BaseCommand) (cmd)).getPluginName(); } try { com.google.gerrit.server.account.CapabilityUtils.checkRequiresCapability(currentUser, pluginName, cmd.getClass()); } catch (com.google.gerrit.extensions.restapi.AuthException e) { throw new com.google.gerrit.sshd.UnloggedFailure(BaseCommand.STATUS_NOT_ADMIN, e.getMessage()); } }
@java.lang.Override public void evict(com.google.gerrit.reviewdb.AccountExternalId id) { byKey.remove(id.getKey()); byAccountId.remove(id.getAccountId()); if ((id.getEmailAddress()) != null) { byEmail.remove(new com.google.gerrit.server.account.AccountExternalIdCacheImpl.EmailWrapper(id.getEmailAddress())); } }
@java.lang.Override public java.lang.Iterable<com.google.gerrit.reviewdb.client.Project.NameKey> byName(final java.lang.String pfx) { final java.lang.Iterable<com.google.gerrit.reviewdb.client.Project.NameKey> src; try { src = list.get(com.google.gerrit.server.project.ProjectCacheImpl.ListKey.ALL).tailSet(new com.google.gerrit.reviewdb.client.Project.NameKey(pfx)); } catch (java.util.concurrent.ExecutionException e) { return java.util.Collections.emptyList(); } return new java.lang.Iterable<com.google.gerrit.reviewdb.client.Project.NameKey>() { @java.lang.Override public java.util.Iterator<com.google.gerrit.reviewdb.client.Project.NameKey> iterator() { return new java.util.Iterator<com.google.gerrit.reviewdb.client.Project.NameKey>() { private java.util.Iterator<com.google.gerrit.reviewdb.client.Project.NameKey> itr = src.iterator(); private Project.NameKey next; @java.lang.Override public boolean hasNext() { if ((next) != null) { return true; } if (!(itr.hasNext())) { return false; } com.google.gerrit.reviewdb.client.Project.NameKey r = itr.next(); if (r.get().startsWith(pfx)) { next = r; return true; } else { itr = java.util.Collections.<com.google.gerrit.reviewdb.client.Project.NameKey>emptyList().iterator(); return false; } } @java.lang.Override public Project.NameKey next() { if (!(hasNext())) { throw new java.util.NoSuchElementException(); } com.google.gerrit.reviewdb.client.Project.NameKey r = next; next = null; return r; } @java.lang.Override public void remove() { throw new java.lang.UnsupportedOperationException(); } }; } }; }
@java.lang.Override public com.google.gwtorm.server.ResultSet<com.google.gerrit.index.query.FieldBundle> readRaw() throws com.google.gwtorm.server.OrmException { return source.readRaw(); }
private org.eclipse.jgit.lib.Repository openRepository(java.nio.file.Path path, com.google.gerrit.reviewdb.client.Project.NameKey name) throws org.eclipse.jgit.errors.RepositoryNotFoundException { if (isUnreasonableName(name)) { throw new org.eclipse.jgit.errors.RepositoryNotFoundException(("Invalid name: " + name)); } org.eclipse.jgit.lib.RepositoryCache.FileKey loc = org.eclipse.jgit.lib.RepositoryCache.FileKey.lenient(path.resolve(name.get()).toFile(), FS.DETECTED); try { return org.eclipse.jgit.lib.RepositoryCache.open(loc); } catch (java.io.IOException e1) { final org.eclipse.jgit.errors.RepositoryNotFoundException e2; e2 = new org.eclipse.jgit.errors.RepositoryNotFoundException(("Cannot open repository " + name)); e2.initCause(e1); throw e2; } }
@org.junit.Test public void submitWithFastForward() throws java.lang.Exception { org.eclipse.jgit.revwalk.RevCommit oldHead = getRemoteHead(); com.google.gerrit.acceptance.PushOneCommit.Result change = createChange(); submit(change.getChangeId()); org.eclipse.jgit.revwalk.RevCommit head = getRemoteHead(); assertThat(head.getId()).isEqualTo(change.getCommitId()); assertThat(head.getParent(0)).isEqualTo(oldHead); assertSubmitter(change.getChangeId(), 1); assertPersonEquals(admin.getIdent(), head.getAuthorIdent()); assertPersonEquals(admin.getIdent(), head.getCommitterIdent()); }
private void initIncludedInAction(com.google.gerrit.client.changes.ChangeInfo info) { if ((info.status()) == (com.google.gerrit.reviewdb.client.Change.Status.MERGED)) { includedInAction = new com.google.gerrit.client.change.IncludedInAction(info.legacy_id(), style, headerLine, includedIn); includedIn.setVisible(true); } }
private static boolean isLocal(final java.lang.String hostname) { try { return java.net.InetAddress.getByName(hostname).isLoopbackAddress(); } catch (java.net.UnknownHostException e) { return false; } }
@org.junit.Test public void remoteUrlDefinedTaskScheduled() { when(config.getSubsections(eq(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.REMOTE))).thenReturn(com.google.common.collect.ImmutableSet.of(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.FOO)); when(remote.getUrl()).thenReturn(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.FOO_URL); eventHandler.onEvent(projectCreated); verify(taskFactory, times(1)).create(eq(projectCreated), eq(remote)); verify(postTask, times(1)).schedule(); }
@java.lang.Override public java.util.Map<java.lang.String, com.google.gerrit.server.config.ListCaches.CacheInfo> apply(com.google.gerrit.server.config.ConfigResource rsrc) { java.util.Map<java.lang.String, com.google.gerrit.server.config.ListCaches.CacheInfo> cacheInfos = new java.util.TreeMap<>(); for (DynamicMap.Entry<com.google.common.cache.Cache<?, ?>> e : cacheMap) { cacheInfos.put(com.google.gerrit.server.config.ListCaches.cacheNameOf(e.getPluginName(), e.getExportName()), new com.google.gerrit.server.config.ListCaches.CacheInfo(e.getProvider().get())); } return cacheInfos; }
@java.lang.Override public org.eclipse.jgit.lib.ObjectId getOldId(com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.PatchSet patchSet, java.lang.Integer parentNum) throws com.google.gerrit.server.diff.PatchListNotAvailableException { return get(change, patchSet, parentNum).getOldId(); }
private void setSubmitType(com.google.gerrit.extensions.common.SubmitType submitType) throws java.io.IOException { com.google.gerrit.server.project.PutConfig.Input in = new com.google.gerrit.server.project.PutConfig.Input(); in.submitType = submitType; in.useContentMerge = com.google.gerrit.extensions.common.InheritableBoolean.FALSE; com.google.gerrit.acceptance.RestResponse r = adminSession.put((("/projects/" + (project.get())) + "/config"), in); assertEquals(HttpStatus.SC_OK, r.getStatusCode()); r.consume(); }
private boolean applyRightFloor(com.google.gerrit.server.notedb.ChangeNotes notes, com.google.gerrit.common.data.LabelType lt, com.google.gerrit.reviewdb.client.PatchSetApproval a) throws com.google.gerrit.server.permissions.PermissionBackendException { com.google.gerrit.server.permissions.PermissionBackend.ForChange forChange = permissionBackend.user(userFactory.create(a.getAccountId())).database(db).change(notes); try { forChange.check(new com.google.gerrit.server.permissions.LabelPermission(lt.getName())); } catch (com.google.gerrit.extensions.restapi.AuthException e) { return false; } try { forChange.check(new com.google.gerrit.server.permissions.LabelPermission.WithValue(lt.getName(), a.getValue())); return true; } catch (com.google.gerrit.extensions.restapi.AuthException e) { a.setValue(forChange.squashThenCheck(lt, a.getValue())); return true; } }
private java.util.List<com.google.gerrit.server.query.change.ChangeData> getChangesByTopic(java.lang.String topic) { try { return queryProvider.get().byExactTopicOpen(topic); } catch (com.google.gwtorm.server.OrmException e) { throw new com.google.gwtorm.server.OrmRuntimeException(e); } }
@java.lang.Override public void doProjectCreatedHook(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String headName) { com.google.gerrit.server.events.ProjectCreatedEvent event = new com.google.gerrit.server.events.ProjectCreatedEvent(); event.projectName = project.get(); event.headName = headName; fireEvent(project, event); if (!(projectCreatedHook.isPresent())) { return; } java.util.List<java.lang.String> args = new java.util.ArrayList<>(); addArg(args, "--project", project.get()); addArg(args, "--head", headName); runHook(project, projectCreatedHook, args); }
@net.codemirror.mode.Source("idl.js") @com.google.gwt.resources.client.DataResource.DoNotEmbed com.google.gwt.resources.client.DataResource idl();
@java.lang.Override public com.google.gerrit.server.project.FileResource parse(com.google.gerrit.server.project.BranchResource parent, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, java.io.IOException { return com.google.gerrit.server.project.FileResource.create(repoManager, parent.getProjectState(), org.eclipse.jgit.lib.ObjectId.fromString(parent.getRevision()), id.get()); }
@java.lang.Override public void modifyFile(java.lang.String filePath, com.google.gerrit.extensions.restapi.RawInput newContent) { throw new com.google.gerrit.extensions.restapi.NotImplementedException(); }
void setWidget(net.codemirror.lib.LineWidget widget) { this.widget = widget; }
private boolean canForcePerform(java.lang.String permissionName) { java.util.List<com.google.gerrit.common.data.PermissionRule> access = access(permissionName); java.util.Set<com.google.gerrit.server.project.ProjectRef> allows = com.google.common.collect.Sets.newHashSet(); java.util.Set<com.google.gerrit.server.project.ProjectRef> blocks = com.google.common.collect.Sets.newHashSet(); for (com.google.gerrit.common.data.PermissionRule rule : access) { if (rule.isBlock()) { blocks.add(relevant.getRuleProps(rule)); } else if (rule.getForce()) { allows.add(relevant.getRuleProps(rule)); } } blocks.removeAll(allows); return (blocks.isEmpty()) && (!(allows.isEmpty())); }
public com.google.gerrit.server.CurrentUser getUser(java.lang.String auth, java.lang.String project, java.lang.String operation) { if (!(com.google.common.base.Strings.isNullOrEmpty(auth))) { if (auth.startsWith(com.googlesource.gerrit.plugins.lfs.LfsAuthUserProvider.BASIC_AUTH_PREFIX)) { return user.get(); } if (auth.startsWith(com.googlesource.gerrit.plugins.lfs.LfsSshRequestAuthorizer.SSH_AUTH_PREFIX)) { java.util.Optional<java.lang.String> user = sshAuth.getUserFromValidToken(auth.substring(com.googlesource.gerrit.plugins.lfs.LfsSshRequestAuthorizer.SSH_AUTH_PREFIX.length()), project, operation); if (user.isPresent()) { java.util.Optional<com.google.gerrit.server.account.AccountState> acc = accounts.getByUsername(user.get()); if (acc.isPresent()) { return userFactory.create(acc.get()); } } } } return anonymous.get(); }
private static native void init0();
private static com.google.common.collect.ListMultimap<java.lang.String, com.google.gerrit.server.group.db.GroupBundle.AuditEntry> toByIdAuditEntriesById(com.google.common.collect.ImmutableSet<com.google.gerrit.reviewdb.client.AccountGroupByIdAud> byIdAudits) { return byIdAudits.stream().flatMap(com.google.gerrit.server.group.db.GroupBundle::toAuditEntries).collect(com.google.common.collect.Multimaps.toMultimap(com.google.gerrit.server.group.db.GroupBundle.AuditEntry::getTarget, java.util.function.Function.identity(), com.google.common.collect.MultimapBuilder.hashKeys().arrayListValues()::build)); }
public static com.google.gerrit.server.index.FieldDef.Builder<java.sql.Timestamp> timestamp(java.lang.String name) { return new com.google.gerrit.server.index.FieldDef.Builder(FieldType.TIMESTAMP, name); }
java.util.Set<com.google.gerrit.reviewdb.client.Account.Id> getMembers();
@org.junit.Test public void simpleChangeMessage() { com.google.gerrit.server.mail.receive.MailMessage.Builder b = newMailMessageBuilder(); b.htmlContent(newHtmlBody("Looks good to me", null, null, null, null, null, null)); java.util.List<com.google.gerrit.reviewdb.client.Comment> comments = defaultComments(); java.util.List<com.google.gerrit.server.mail.receive.MailComment> parsedComments = com.google.gerrit.server.mail.receive.HtmlParser.parse(b.build(), comments, ""); assertThat(parsedComments).hasSize(1); assertChangeMessage("Looks good to me", parsedComments.get(0)); }
@java.lang.Override public com.google.gerrit.extensions.api.changes.ChangeApi id(java.lang.String project, int id) throws com.google.gerrit.extensions.restapi.RestApiException { return id(com.google.common.base.Joiner.on('~').join(com.google.common.collect.ImmutableList.of(com.google.gerrit.extensions.restapi.Url.encode(project), com.google.gerrit.extensions.restapi.Url.encode(java.lang.String.valueOf(id))))); }
@java.lang.Override public void onKeyPress(com.google.gwt.event.dom.client.KeyPressEvent event) { onOpenRow(getRow(selectedRow)); }
@java.lang.Override public void onSuccess(com.google.gerrit.client.changes.ChangeList result) { com.google.gwt.core.client.JsArray<com.google.gerrit.client.changes.ChangeList> wrapped = com.google.gwt.core.client.JsArray.createArray(1).cast(); wrapped.set(0, result); callback.onSuccess(wrapped); }
private void submit(com.google.gerrit.server.project.ChangeControl changeCtl, com.google.gerrit.reviewdb.client.PatchSet ps) throws com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.server.change.Submit submit = submitProvider.get(); com.google.gerrit.server.change.RevisionResource rsrc = new com.google.gerrit.server.change.RevisionResource(changes.parse(changeCtl), ps); java.util.List<com.google.gerrit.reviewdb.client.Change> changes; try { changes = submit.submit(rsrc, currentUser, true); } catch (com.google.gerrit.extensions.restapi.ResourceConflictException e) { throw new java.io.IOException(e); } try { mergeFactory.create(com.google.gerrit.server.git.ChangeSet.create(changes), ((com.google.gerrit.server.IdentifiedUser) (changeCtl.getCurrentUser()))).merge(false); } catch (com.google.gerrit.server.project.NoSuchChangeException e) { throw new com.google.gwtorm.server.OrmException(e); } addMessage(""); for (com.google.gerrit.reviewdb.client.Change c : changes) { c = db.changes().get(c.getId()); switch (c.getStatus()) { case SUBMITTED : addMessage((("Change " + (c.getChangeId())) + " submitted.")); break; case MERGED : addMessage((("Change " + (c.getChangeId())) + " merged.")); break; case NEW : com.google.gerrit.reviewdb.client.ChangeMessage msg = submit.getConflictMessage(rsrc); if (msg != null) { addMessage(((("Change " + (c.getChangeId())) + ": ") + (msg.getMessage()))); break; } default : addMessage(((("change " + (c.getChangeId())) + " is ") + (c.getStatus().name().toLowerCase()))); } } }
java.lang.String getLinkName();
private org.eclipse.jgit.revwalk.RevCommit getHead(org.eclipse.jgit.lib.Repository repo) throws java.io.IOException { return getHead(repo, "HEAD"); }
void setHeaderVisible(boolean show) { headerVisible = (!(autoHideHeader)) || show; showHeader(headerVisible); }
private org.eclipse.jgit.revwalk.RevCommit updateRef(org.eclipse.jgit.lib.AnyObjectId oldId, org.eclipse.jgit.lib.AnyObjectId newId, java.lang.String refName) throws java.io.IOException { org.eclipse.jgit.lib.BatchRefUpdate bru = update.getBatch(); if (bru != null) { bru.addCommand(new org.eclipse.jgit.transport.ReceiveCommand(oldId.toObjectId(), newId.toObjectId(), refName)); inserter.flush(); revision = rw.parseCommit(newId); return revision; } org.eclipse.jgit.lib.RefUpdate ru = db.updateRef(refName); ru.setExpectedOldObjectId(oldId); ru.setNewObjectId(src); ru.setRefLogIdent(update.getCommitBuilder().getAuthor()); try (java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.StringReader(update.getCommitBuilder().getMessage()))) { ru.setRefLogMessage(("commit: " + (reader.readLine())), true); } inserter.flush(); org.eclipse.jgit.lib.RefUpdate.Result result = ru.update(); switch (result) { case NEW : case FAST_FORWARD : revision = rw.parseCommit(ru.getNewObjectId()); update.fireGitRefUpdatedEvent(ru); return revision; default : throw new java.io.IOException(((((("Cannot update " + (ru.getName())) + " in ") + (db.getDirectory())) + ": ") + (ru.getResult()))); } }
private boolean inBranch(final com.google.gerrit.reviewdb.client.Change change) { if ((branch) == null) { return true; } return change.getDest().get().equals(branch); }
@java.lang.Override public int compare(com.google.gerrit.server.group.MembersCollection.MemberInfo a, com.google.gerrit.server.group.MembersCollection.MemberInfo b) { return com.google.common.collect.ComparisonChain.start().compare(a.fullName, b.fullName, com.google.common.collect.Ordering.natural().nullsFirst()).compare(a.preferredEmail, b.preferredEmail, com.google.common.collect.Ordering.natural().nullsFirst()).compare(a.id, b.id, com.google.common.collect.Ordering.natural().nullsFirst()).result(); }
@java.lang.Override public void start() { com.google.gerrit.server.git.ProjectConfig config; for (com.google.gerrit.reviewdb.client.Project.NameKey p : projectCache.all()) { try { config = com.google.gerrit.server.git.ProjectConfig.read(metaDataUpdateFactory.create(p)); loadStoreFromProjectConfig(p.toString(), config); } catch (java.io.IOException | org.eclipse.jgit.errors.ConfigInvalidException | javax.xml.bind.JAXBException e) { com.amd.gerrit.plugins.manifestsubscription.ManifestSubscription.log.error(e.toString()); e.printStackTrace(); } } }
static void replyText(@javax.annotation.Nullable javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse res, java.lang.String text) throws java.io.IOException { if (((req == null) || ("GET".equals(req.getMethod()))) && (com.google.gerrit.httpd.restapi.RestApiServlet.isMaybeHTML(text))) { com.google.gerrit.httpd.restapi.RestApiServlet.replyJson(req, res, com.google.common.collect.ImmutableMultimap.of("pp", "0"), new com.google.gson.JsonPrimitive(text)); } else { if (!(text.endsWith("\n"))) { text += "\n"; } com.google.gerrit.httpd.restapi.RestApiServlet.replyBinaryResult(req, res, com.google.gerrit.extensions.restapi.BinaryResult.create(text).setContentType("text/plain")); } }
@java.lang.Override public void onKeyPress(final com.google.gwt.event.dom.client.KeyPressEvent event) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange2(revision.getParentKey(), java.lang.String.valueOf(revision.get()))); }
private com.google.gitiles.CommitData.DiffList computeDiffEntries(org.eclipse.jgit.lib.Repository repo, com.google.gitiles.GitilesView view, org.eclipse.jgit.revwalk.RevCommit commit) throws java.io.IOException { com.google.gitiles.CommitData.DiffList result = new com.google.gitiles.CommitData.DiffList(); org.eclipse.jgit.treewalk.AbstractTreeIterator oldTree; switch (commit.getParentCount()) { case 0 : result.oldRevision = Revision.NULL; oldTree = new org.eclipse.jgit.treewalk.EmptyTreeIterator(); break; case 1 : result.oldRevision = com.google.gitiles.Revision.peeled(((view.getRevision().getName()) + "^"), commit.getParent(0)); oldTree = getTreeIterator(commit.getParent(0)); break; default : return result; } org.eclipse.jgit.treewalk.AbstractTreeIterator newTree = getTreeIterator(commit); org.eclipse.jgit.diff.DiffFormatter diff = new org.eclipse.jgit.diff.DiffFormatter(org.eclipse.jgit.util.io.NullOutputStream.INSTANCE); try { diff.setRepository(repo); diff.setDetectRenames(true); result.entries = diff.scan(oldTree, newTree); return result; } finally { diff.release(); } }
public void fire(com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.PatchSet ps, com.google.gerrit.reviewdb.client.Account merger, java.lang.String newRevisionId, java.sql.Timestamp when) { if (!(listeners.iterator().hasNext())) { return; } try { com.google.gerrit.server.extensions.events.ChangeMerged.Event event = new com.google.gerrit.server.extensions.events.ChangeMerged.Event(util.changeInfo(change), util.revisionInfo(change.getProject(), ps), util.accountInfo(merger), newRevisionId, when); for (com.google.gerrit.extensions.events.ChangeMergedListener l : listeners) { try { l.onChangeMerged(event); } catch (java.lang.Exception e) { util.logEventListenerError(this, l, e); } } } catch (com.google.gerrit.server.patch.PatchListObjectTooLargeException e) { com.google.gerrit.server.extensions.events.ChangeMerged.log.warn(("Couldn't fire event: " + (e.getMessage()))); } catch (com.google.gerrit.server.patch.PatchListNotAvailableException | com.google.gerrit.server.GpgException | java.io.IOException | com.google.gwtorm.server.OrmException | com.google.gerrit.server.permissions.PermissionBackendException e) { com.google.gerrit.server.extensions.events.ChangeMerged.log.error("Couldn't fire event", e); } }
public com.google.gerrit.server.ssh.Command createCommand(final java.lang.String commandLine) { return new com.google.gerrit.server.ssh.BaseCommand() { @java.lang.Override public void start() throws java.io.IOException { final int sp1 = commandLine.indexOf(' '); java.lang.String cmd; java.lang.String args; if (0 < sp1) { cmd = commandLine.substring(0, sp1); args = commandLine.substring((sp1 + 1)); } else { cmd = commandLine; args = ""; } if (("git".equals(cmd)) || ("gerrit".equals(cmd))) { cmd += "-"; final int sp2 = args.indexOf(' '); if (0 < sp2) { cmd += args.substring(0, sp2); args = args.substring((sp2 + 1)); } else { cmd += args; args = ""; } } final com.google.inject.Provider<com.google.gerrit.server.ssh.Command> p = commands.get(cmd); if (p != null) { final com.google.gerrit.server.ssh.SshScopes.Context old = SshScopes.current.get(); try { SshScopes.current.set(new com.google.gerrit.server.ssh.SshScopes.Context(session)); final com.google.gerrit.server.ssh.Command c = p.get(); if (c instanceof com.google.gerrit.server.ssh.AbstractCommand) { ((com.google.gerrit.server.ssh.AbstractCommand) (c)).setCommandLine(cmd, args); } delegateTo(c); } finally { SshScopes.current.set(old); } } else { final java.lang.String msg = ("gerrit: " + cmd) + ": not found\n"; err.write(msg.getBytes("UTF-8")); err.flush(); exit.onExit(127); } } }; }
public static void capabilities(com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.config.CapabilityInfo>> cb) { new com.google.gerrit.client.rpc.RestApi("/config/server/capabilities/").get(cb); }
@java.lang.Override public int getBegin(com.google.gerrit.server.patch.EditTransformer.ContextAwareEdit edit) { return edit.getBeginA(); }
private void rename(com.google.gerrit.server.git.MetaDataUpdate md) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { boolean success = false; for (int attempts = 0; (!success) && (attempts < (com.google.gerrit.server.git.RenameGroupOp.MAX_TRIES)); attempts++) { com.google.gerrit.server.git.ProjectConfig config = com.google.gerrit.server.git.ProjectConfig.read(md); com.google.gerrit.common.data.GroupReference ref = config.getGroup(uuid); if ((ref == null) || (newName.equals(ref.getName()))) { projectCache.evict(config.getProject()); return; } ref.setName(newName); md.getCommitBuilder().setAuthor(author); md.setMessage((((("Rename group " + (oldName)) + " to ") + (newName)) + "\n")); try { config.commit(md); projectCache.evict(config.getProject()); success = true; } catch (java.io.IOException e) { com.google.gerrit.server.git.RenameGroupOp.log.error(((((("Could not commit rename of group " + (oldName)) + " to ") + (newName)) + " in ") + (md.getProjectName().get())), e); try { java.lang.Thread.sleep(25); } catch (java.lang.InterruptedException wakeUp) { continue; } } } if (!success) { if (tryingAgain) { com.google.gerrit.server.git.RenameGroupOp.log.warn(((((("Could not rename group " + (oldName)) + " to ") + (newName)) + " in ") + (md.getProjectName().get()))); } else { retryOn.add(md.getProjectName()); } } }
@java.lang.Override public void onReplaceByKeys(org.eclipse.jgit.lib.ObjectId oldNotesRev, org.eclipse.jgit.lib.ObjectId newNotesRev, com.google.gerrit.reviewdb.client.Account.Id accountId, java.util.Collection<com.google.gerrit.server.account.externalids.ExternalId.Key> toRemove, java.util.Collection<com.google.gerrit.server.account.externalids.ExternalId> toAdd) throws java.io.IOException { com.google.gerrit.server.account.externalids.ExternalIdsUpdate.checkSameAccount(toAdd, accountId); updateCache(oldNotesRev, newNotesRev, ( m) -> { removeKeys(m.get(accountId), toRemove); for (com.google.gerrit.server.account.externalids.ExternalId extId : toAdd) { m.put(extId.accountId(), extId); } }); }
private boolean addSuggestion(java.util.Map<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.extensions.common.AccountInfo> map, com.google.gerrit.reviewdb.client.Account.Id id) { com.google.gerrit.reviewdb.client.Account a = accountCache.get(id).getAccount(); return addSuggestion(map, a); }
public void onSuccess(final com.google.gerrit.common.auth.userpass.LoginResult result) { if (result.success) { java.lang.String to = token; if (!(to.startsWith("/"))) { to = "/" + to; } if ((result.isNew) && (!(token.startsWith(((com.google.gerrit.common.PageLinks.REGISTER) + "/"))))) { to = (com.google.gerrit.common.PageLinks.REGISTER) + to; } com.google.gwt.user.client.Window.Location.replace((((com.google.gwt.user.client.Window.Location.getPath()) + "login") + to)); } else { showError(Util.C.invalidLogin()); enable(true); password.selectAll(); com.google.gwt.core.client.Scheduler.get().scheduleDeferred(new com.google.gwt.core.client.Scheduler.ScheduledCommand() { @java.lang.Override public void execute() { password.setFocus(true); } }); } }
private void matchChange(java.util.Set<com.google.gerrit.reviewdb.Change.Id> matched, com.google.gerrit.reviewdb.Change change) { try { if (((change != null) && (inProject(change))) && (changeControlFactory.controlFor(change).isVisible(db))) { matched.add(change.getId()); } } catch (com.google.gerrit.server.project.NoSuchChangeException e) { } catch (com.google.gwtorm.client.OrmException e) { com.google.gerrit.sshd.commands.SetReviewersCommand.log.warn(("Error reading change " + (change.getId())), e); } }
public static com.google.gerrit.server.index.FieldDef.Builder<java.lang.Integer> integer(java.lang.String name) { return new com.google.gerrit.server.index.FieldDef.Builder(FieldType.INTEGER, name); }
void onAuthFail(final com.google.gerrit.sshd.SshSession sd) { final org.apache.log4j.spi.LoggingEvent event = new org.apache.log4j.spi.LoggingEvent(org.apache.log4j.Logger.class.getName(), com.google.gerrit.sshd.SshLog.log, java.lang.System.currentTimeMillis(), org.apache.log4j.Level.INFO, ("AUTH FAILURE FROM " + (sd.getRemoteAddressAsString())), "SSHD", null, null, null, null); event.setProperty(com.google.gerrit.sshd.SshLog.P_SESSION, com.google.gerrit.sshd.SshLog.id(sd.getSessionId())); event.setProperty(com.google.gerrit.sshd.SshLog.P_USER_NAME, sd.getUsername()); final java.lang.String error = sd.getAuthenticationError(); if (error != null) { event.setProperty(com.google.gerrit.sshd.SshLog.P_STATUS, error); } async.append(event); audit("FAIL", "AUTH", new java.lang.String[]{ sd.getRemoteAddressAsString() }); }
com.google.gerrit.extensions.common.AccountInfo getWho();
@com.google.gerrit.server.query.account.Operator public com.google.gerrit.server.query.Predicate<com.google.gerrit.server.account.AccountState> username(java.lang.String username) { return com.google.gerrit.server.query.account.AccountPredicates.username(username); }
public com.google.gwtjsonrpc.client.VoidResult run(com.google.gerrit.client.reviewdb.ReviewDb db) throws com.google.gerrit.server.patch.Failure, com.google.gwtorm.client.OrmException { final com.google.gerrit.server.patch.PatchDetailServiceImpl.PublishResult r; r = db.run(new com.google.gwtorm.client.OrmRunnable<com.google.gerrit.server.patch.PatchDetailServiceImpl.PublishResult, com.google.gerrit.client.reviewdb.ReviewDb>() { public com.google.gerrit.server.patch.PatchDetailServiceImpl.PublishResult run(com.google.gerrit.client.reviewdb.ReviewDb db, com.google.gwtorm.client.Transaction txn, boolean retry) throws com.google.gwtorm.client.OrmException { return doPublishComments(psid, message, approvals, db, txn); } }); try { final com.google.gerrit.server.ChangeMail cm = new com.google.gerrit.server.ChangeMail(server, r.change); cm.setFrom(com.google.gerrit.client.rpc.Common.getAccountId()); cm.setPatchSet(r.patchSet, r.info); cm.setChangeMessage(r.message); cm.setPatchLineComments(r.comments); cm.setReviewDb(db); cm.setHttpServletRequest(com.google.gerrit.server.GerritJsonServlet.getCurrentCall().getHttpServletRequest()); cm.sendComment(); } catch (MessagingException e) { log.error(("Cannot send comments by email for patch set " + psid), e); throw new com.google.gerrit.server.patch.Failure(e); } return com.google.gwtjsonrpc.client.VoidResult.INSTANCE; }
void setUpPatchSetNav(com.google.gwt.core.client.JsArray<com.google.gerrit.client.changes.ChangeInfo.RevisionInfo> list, com.google.gerrit.client.diff.DiffInfo.FileMeta meta) { com.google.gerrit.client.ui.InlineHyperlink baseLink = null; com.google.gerrit.client.ui.InlineHyperlink selectedLink = null; if (sideA) { baseLink = createLink(PatchUtil.C.patchBase(), null); linkPanel.add(baseLink); } for (int i = 0; i < (list.length()); i++) { com.google.gerrit.client.changes.ChangeInfo.RevisionInfo r = list.get(i); com.google.gerrit.client.ui.InlineHyperlink link = createLink(r.id(), new com.google.gerrit.reviewdb.client.PatchSet.Id(changeId, r._number())); linkPanel.add(link); if (((revision) != null) && (r.id().equals(revision.getId()))) { selectedLink = link; } } if (selectedLink != null) { selectedLink.setStyleName(style.selected()); } else if (sideA) { baseLink.setStyleName(style.selected()); } if ((meta != null) && (!(Patch.COMMIT_MSG.equals(path)))) { linkPanel.add(createDownloadLink()); } }
public void delete(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.notedb.ChangeUpdate update, com.google.gerrit.reviewdb.client.PatchSet ps) throws com.google.gwtorm.server.OrmException { ensurePatchSetMatches(ps.getId(), update); checkArgument(ps.isDraft(), "cannot delete non-draft patch set %s", ps.getId()); update.setPatchSetState(PatchSetState.DELETED); if ((com.google.gerrit.server.notedb.NoteDbChangeState.PrimaryStorage.of(update.getChange())) == (REVIEW_DB)) { db.patchSets().delete(java.util.Collections.singleton(ps)); } }
public java.util.List<com.google.gerrit.extensions.common.SshKeyInfo> apply(com.google.gerrit.server.IdentifiedUser user) throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException, org.eclipse.jgit.errors.RepositoryNotFoundException { return com.google.common.collect.Lists.transform(authorizedKeys.getKeys(user.getAccountId()), new com.google.common.base.Function<com.google.gerrit.reviewdb.client.AccountSshKey, com.google.gerrit.extensions.common.SshKeyInfo>() { @java.lang.Override public com.google.gerrit.extensions.common.SshKeyInfo apply(com.google.gerrit.reviewdb.client.AccountSshKey key) { return com.google.gerrit.server.account.GetSshKeys.newSshKeyInfo(key); } }); }
@java.lang.Override public int hashCode() { return java.util.Objects.hash(filter, reviewer); }
@java.lang.Override protected void configure() { install(copyConfigModule); install(cm); install(sm); }
@java.lang.Override public com.google.gerrit.reviewdb.client.AccountGroupName get(com.google.gerrit.reviewdb.client.AccountGroup.NameKey name) { throw new java.lang.UnsupportedOperationException(com.google.gerrit.reviewdb.server.DisallowReadFromGroupsReviewDbWrapper.MSG); }
private void setWebLinks(com.google.gerrit.client.changes.ChangeInfo change, java.lang.String revision, com.google.gerrit.client.changes.ChangeInfo.RevisionInfo revInfo) { com.google.gerrit.client.config.GitWebInfo gw = com.google.gerrit.client.Gerrit.info().gitWeb(); if ((gw != null) && (gw.canLink(revInfo))) { toAnchor(gw.toRevision(change.project(), revision), gw.getLinkName()); } com.google.gwt.core.client.JsArray<com.google.gerrit.client.WebLinkInfo> links = revInfo.commit().webLinks(); if (links != null) { for (com.google.gerrit.client.WebLinkInfo link : com.google.gerrit.client.rpc.Natives.asList(links)) { webLinkPanel.add(link.toAnchor()); } } }
private void initProviderJce() { setKeyExchangeFactories(NamedFactory.Utils.setUpTransformedFactories(true, java.util.Collections.unmodifiableList(java.util.Arrays.asList(BuiltinDHFactories.dhg1)), ServerBuilder.DH2KEX)); setKeyExchangeFactories(org.apache.sshd.server.ServerBuilder.setUpDefaultKeyExchanges(true)); setRandomFactory(new org.apache.sshd.common.random.SingletonRandomFactory(org.apache.sshd.common.random.JceRandomFactory.INSTANCE)); }
public java.lang.Class<?> findClass(java.lang.String name) throws java.lang.ClassNotFoundException { java.lang.String path = (name.replace('.', '/')) + ".class"; java.io.InputStream resource = target.getResourceAsStream(path); if (resource != null) { try { byte[] bytes = com.google.common.io.ByteStreams.toByteArray(resource); return defineClass(name, bytes, 0, bytes.length); } catch (java.io.IOException e) { } } throw new java.lang.ClassNotFoundException(name); }
private java.util.Map<java.lang.String, java.lang.Object> toRenameSoyData(org.eclipse.jgit.diff.DiffEntry entry) { if (entry == null) { return null; } org.eclipse.jgit.diff.DiffEntry.ChangeType type = entry.getChangeType(); if ((type != (org.eclipse.jgit.diff.DiffEntry.ChangeType.RENAME)) && (type != (org.eclipse.jgit.diff.DiffEntry.ChangeType.COPY))) { return null; } return com.google.common.collect.ImmutableMap.<java.lang.String, java.lang.Object>of("changeType", type.toString(), "oldPath", entry.getOldPath(), "newPath", entry.getNewPath(), "score", entry.getScore()); }
private static boolean toBoolean(java.lang.String v) { return (!(com.google.common.base.Strings.isNullOrEmpty(v))) && (v.equalsIgnoreCase("Y")); }
@java.lang.Override public java.lang.Iterable<com.google.gerrit.extensions.common.CommentInfo> getComments(int changeId, java.lang.String rev) throws com.google.gerrit.extensions.restapi.BadRequestException, com.google.gwtorm.server.OrmException, java.io.IOException { try { java.util.Map<java.lang.String, java.util.List<com.google.gerrit.extensions.common.CommentInfo>> result = gApi.changes().id(changeId).revision(rev).comments(); for (java.util.Map.Entry<java.lang.String, java.util.List<com.google.gerrit.extensions.common.CommentInfo>> e : result.entrySet()) { for (com.google.gerrit.extensions.common.CommentInfo i : e.getValue()) { i.path = e.getKey(); } } return com.google.common.collect.Iterables.concat(result.values()); } catch (com.google.gerrit.extensions.restapi.RestApiException e) { throw new com.google.gerrit.extensions.restapi.BadRequestException(e.getMessage()); } }
@java.lang.Override public void onChangeMerged(com.google.gerrit.server.Event event) { if ((!(allProjects.get().equals(event.getChange().project))) || (!(RefNames.REFS_CONFIG.equals(event.getChange().branch)))) { return; } try { syncIfNeeded(); } catch (java.io.IOException | org.eclipse.jgit.errors.ConfigInvalidException e) { com.google.gerrit.server.CreateGroupPermissionSyncer.log.error("Can't sync create group permissions", e); } }
static com.google.gerrit.server.patch.PatchListEntry empty(final java.lang.String fileName) { return new com.google.gerrit.server.patch.PatchListEntry(com.google.gerrit.reviewdb.Patch.ChangeType.MODIFIED, com.google.gerrit.reviewdb.Patch.PatchType.UNIFIED, null, fileName, com.google.gerrit.server.patch.PatchListEntry.EMPTY_HEADER, java.util.Collections.<com.google.gerrit.prettify.common.LineEdit>emptyList()); }
@java.lang.Override public <V> com.google.gerrit.metrics.CallbackMetric0<V> newCallbackMetric(java.lang.String name, java.lang.Class<V> valueClass, com.google.gerrit.metrics.Description desc) { define(name, desc); return new com.google.gerrit.metrics.dropwizard.CallbackMetricImpl0(name, valueClass); }
@org.kohsuke.args4j.Option(name = "-o", usage = "Output options") void addOption(java.lang.String option) { for (com.google.gerrit.extensions.client.ListChangesOption o : com.google.gerrit.extensions.client.ListChangesOption.values()) { if (o.name().equalsIgnoreCase(option)) { jsonOpt.add(o); return; } } for (com.google.gerrit.extensions.api.changes.SubmittedTogetherOption o : com.google.gerrit.extensions.api.changes.SubmittedTogetherOption.values()) { if (o.name().equalsIgnoreCase(option)) { options.add(o); return; } } throw new java.lang.IllegalArgumentException(("option not recognized: " + option)); }
@org.junit.Test public void testUpgradeSchema() throws com.google.gwtorm.server.OrmException, java.sql.SQLException { final com.google.gwtorm.data.PhoneBookDb p = phoneBook.open(); try { p.updateSchema(executor); execute("CREATE SEQUENCE cnt"); execute("CREATE TABLE foo (cnt INT)"); execute("ALTER TABLE people ADD COLUMN fake_name VARCHAR(20)"); execute("ALTER TABLE people DROP COLUMN registered"); execute("DROP TABLE addresses"); execute("DROP SEQUENCE address_id"); java.util.Set<java.lang.String> sequences; java.util.Set<java.lang.String> tables; p.updateSchema(executor); sequences = dialect.listSequences(db); tables = dialect.listTables(db); assertTrue(sequences.contains("cnt")); assertTrue(tables.contains("foo")); assertTrue(sequences.contains("address_id")); assertTrue(tables.contains("addresses")); p.pruneSchema(executor); sequences = dialect.listSequences(db); tables = dialect.listTables(db); assertFalse(sequences.contains("cnt")); assertFalse(tables.contains("foo")); final com.google.gwtorm.data.Person.Key pk = new com.google.gwtorm.data.Person.Key("Bob"); final com.google.gwtorm.data.Person bob = new com.google.gwtorm.data.Person(pk, p.nextAddressId()); p.people().insert(java.util.Collections.singleton(bob)); final com.google.gwtorm.data.Address addr = new com.google.gwtorm.data.Address(new com.google.gwtorm.data.Address.Key(pk, "home"), "some place"); p.addresses().insert(java.util.Collections.singleton(addr)); } finally { p.close(); } final com.google.gwtorm.data.PhoneBookDb2 p2 = phoneBook2.open(); try { ((com.google.gwtorm.jdbc.JdbcSchema) (p2)).renameField(executor, "people", "registered", "isRegistered"); } finally { p2.close(); } }
public static void suggest(java.lang.String query, int limit, com.google.gwt.user.client.rpc.AsyncCallback<com.google.gwt.core.client.JsArray<com.google.gerrit.client.account.AccountInfo>> cb) { new com.google.gerrit.client.rpc.RestApi("/accounts/").addParameter("q", query).addParameter("n", limit).background().get(cb); }
java.util.Map<java.lang.String, java.lang.Short> getLabels() { return labels; }
@org.junit.Test public void testSubmoduleCommitMessage() throws java.lang.Exception { org.eclipse.jgit.junit.TestRepository<?> superRepo = createProjectWithPush("super-project"); org.eclipse.jgit.junit.TestRepository<?> subRepo = createProjectWithPush("subscribed-to-project"); pushChangeTo(subRepo, "master"); createSubscription(superRepo, "master", "subscribed-to-project", "master"); org.eclipse.jgit.lib.ObjectId subHEAD = pushChangeTo(subRepo, "master"); org.eclipse.jgit.revwalk.RevWalk rw = subRepo.getRevWalk(); org.eclipse.jgit.revwalk.RevCommit subCommitMsg = rw.parseCommit(subHEAD); expectToHaveCommitMessage(superRepo, "master", ((((("Updated git submodules\n\n" + "Project: ") + (name("subscribed-to-project"))) + " master ") + (subHEAD.name())) + "\n\n")); subHEAD = pushChangeTo(subRepo, "master"); subCommitMsg = rw.parseCommit(subHEAD); expectToHaveCommitMessage(superRepo, "master", ((((((("Updated git submodules\n\n" + "Project: ") + (name("subscribed-to-project"))) + " master ") + (subHEAD.name())) + "\n\n") + (subCommitMsg.getFullMessage())) + "\n\n")); }
public void display(com.google.gerrit.reviewdb.client.Change chg, java.lang.Boolean starred, java.lang.Boolean canEditCommitMessage, com.google.gerrit.reviewdb.client.PatchSetInfo info, final com.google.gerrit.common.data.AccountInfoCache acc, com.google.gerrit.common.data.SubmitTypeRecord submitTypeRecord) { infoBlock.display(chg, acc, submitTypeRecord); messageBlock.display(chg.currentPatchSetId(), starred, canEditCommitMessage, info.getMessage()); }
@java.lang.Override public int compareTo(com.google.gerrit.client.diff.DiffChunkInfo o) { if ((side) == (o.side)) { return (start) - (o.start); } else if ((side) == (DisplaySide.A)) { int comp = (startOnOther) - (o.start); return comp == 0 ? -1 : comp; } else { int comp = (start) - (o.startOnOther); return comp == 0 ? 1 : comp; } }
@org.junit.Test public void updateMessage() throws java.lang.Exception { assertThat(modifier.createEdit(change, getCurrentPatchSet(changeId))).isEqualTo(RefUpdate.Result.NEW); com.google.common.base.Optional<com.google.gerrit.server.edit.ChangeEdit> edit = editUtil.byChange(change); try { modifier.modifyMessage(edit.get(), edit.get().getEditCommit().getFullMessage()); fail("InvalidChangeOperationException expected"); } catch (com.google.gerrit.server.project.InvalidChangeOperationException ex) { assertThat(ex.getMessage()).isEqualTo("New commit message cannot be same as existing commit message"); } java.lang.String msg = java.lang.String.format("New commit message\n\nChange-Id: %s", change.getKey()); assertThat(modifier.modifyMessage(edit.get(), msg)).isEqualTo(RefUpdate.Result.FORCED); edit = editUtil.byChange(change); assertThat(edit.get().getEditCommit().getFullMessage()).isEqualTo(msg); editUtil.publish(edit.get()); assertThat(editUtil.byChange(change).isPresent()).isFalse(); ChangeInfo info = get(changeId, ListChangesOption.CURRENT_COMMIT, ListChangesOption.CURRENT_REVISION); assertThat(info.revisions.get(info.currentRevision).commit.message).isEqualTo(msg); }
private void initChannels() { setChannelFactories(ServerBuilder.DEFAULT_CHANNEL_FACTORIES); }
@java.lang.Override public boolean match(com.google.gerrit.server.query.change.ChangeData cd) throws com.google.gwtorm.server.OrmException { java.util.Set<com.google.gerrit.reviewdb.client.Account.Id> reviewedBy = cd.reviewedBy(); return !(reviewedBy.isEmpty()) ? reviewedBy.contains(id) : (id) == (com.google.gerrit.server.query.change.IsReviewedPredicate.NOT_REVIEWED); }
public com.google.gerrit.server.account.AuthResult link(com.google.gerrit.reviewdb.client.Account.Id to, com.google.gerrit.server.account.AuthRequest who) throws com.google.gerrit.server.account.AccountException, com.google.gwtorm.server.OrmException, java.io.IOException { try (com.google.gerrit.reviewdb.server.ReviewDb db = schema.open()) { com.google.gerrit.server.account.ExternalId extId = findExternalId(db, who.getExternalIdKey()); if (extId != null) { if (!(extId.accountId().equals(to))) { throw new com.google.gerrit.server.account.AccountException("Identity in use by another account"); } update(db, who, extId); } else { externalIdsUpdateFactory.create().insert(db, com.google.gerrit.server.account.ExternalId.createWithEmail(who.getExternalIdKey(), to, who.getEmailAddress())); if ((who.getEmailAddress()) != null) { com.google.gerrit.reviewdb.client.Account a = db.accounts().get(to); if ((a.getPreferredEmail()) == null) { a.setPreferredEmail(who.getEmailAddress()); db.accounts().update(java.util.Collections.singleton(a)); byIdCache.evict(to); } byEmailCache.evict(who.getEmailAddress()); } } return new com.google.gerrit.server.account.AuthResult(to, who.getExternalIdKey(), false); } }
private void logFailToLoadUpdatedGroup(com.google.gerrit.server.audit.group.GroupAuditEvent event) { com.google.common.collect.ImmutableList<java.lang.String> descriptions = createEventDescriptions(event, "(fail to load group)"); java.lang.String message = createErrorMessage("Fail to load the updated group", event.getActor(), descriptions); com.google.gerrit.server.group.DbGroupMemberAuditListener.log.error(message); }
com.google.gerrit.server.diff.IntraLineDiff getIntraLineDiff(com.google.gerrit.server.diff.IntraLineDiffKey key, com.google.gerrit.server.diff.IntraLineDiffArgs args);
public static com.google.gerrit.reviewdb.client.Change.Id parse(final java.lang.String str) { final com.google.gerrit.reviewdb.client.Change.Id r = new com.google.gerrit.reviewdb.client.Change.Id(); r.fromString(str); return r; }
@org.junit.Test public void create() throws java.lang.Exception { TestAccount foo = accounts.create("foo"); com.google.gerrit.extensions.common.AccountInfo info = gApi.accounts().id(foo.id.get()).get(); assertThat(info.username).isEqualTo("foo"); try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(allUsers);org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo)) { org.eclipse.jgit.lib.Ref ref = repo.exactRef(com.google.gerrit.reviewdb.client.RefNames.refsUsers(foo.getId())); assertThat(ref).isNotNull(); org.eclipse.jgit.revwalk.RevCommit c = rw.parseCommit(ref.getObjectId()); long timestampDiffMs = java.lang.Math.abs((((c.getCommitTime()) * 1000L) - (accountCache.get(foo.getId()).getAccount().getRegisteredOn().getTime()))); assertThat(timestampDiffMs).isAtMost(ChangeRebuilderImpl.MAX_WINDOW_MS); } }
public com.google.gerrit.extensions.client.DiffPreferencesInfo getDiffPrefs() { return diffPrefs; }
public static void parentCandidates(com.google.gwtjsonrpc.common.AsyncCallback<com.google.gerrit.client.projects.ProjectMap> callback) { new com.google.gerrit.client.rpc.RestApi("/projects/").addParameterRaw("type", "PARENT_CANDIDATES").addParameterTrue("all").addParameterTrue("d").send(com.google.gerrit.client.rpc.NativeMap.copyKeysIntoChildren(callback)); }
private void deleteEmail(java.lang.String email) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.permissions.PermissionBackendException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { if (email.equals("ALL")) { java.util.List<com.google.gerrit.extensions.common.EmailInfo> emails = getEmails.apply(rsrc); for (com.google.gerrit.extensions.common.EmailInfo e : emails) { deleteEmail.apply(new com.google.gerrit.server.account.AccountResource.Email(user, e.email), new com.google.gerrit.server.account.DeleteEmail.Input()); } } else { deleteEmail.apply(new com.google.gerrit.server.account.AccountResource.Email(user, email), new com.google.gerrit.server.account.DeleteEmail.Input()); } }
private boolean suggestGroupAsReviewer(final com.google.gerrit.reviewdb.Project.NameKey project, final com.google.gerrit.common.data.GroupReference group) throws com.google.gwtorm.client.OrmException { if (!(com.google.gerrit.server.patch.AddReviewer.isLegalReviewerGroup(group.getUUID()))) { return false; } try { final java.util.Set<com.google.gerrit.reviewdb.Account> members = groupMembersFactory.create().listAccounts(group.getUUID(), project); if (members.isEmpty()) { return false; } final int maxAllowed = cfg.getInt("addreviewer", "maxAllowed", AddReviewer.DEFAULT_MAX_REVIEWERS); if ((maxAllowed > 0) && ((members.size()) > maxAllowed)) { return false; } } catch (com.google.gerrit.common.errors.NoSuchGroupException e) { return false; } catch (com.google.gerrit.server.project.NoSuchProjectException e) { return false; } return true; }
@org.junit.Test public void withSecondaryEmails() throws java.lang.Exception { com.google.gerrit.extensions.common.AccountInfo user1 = newAccount("myuser", "My User", "my.user@example.com", true); java.lang.String[] secondaryEmails = new java.lang.String[]{ "bar@example.com", "foo@example.com" }; addEmails(user1, secondaryEmails); java.util.List<com.google.gerrit.extensions.common.AccountInfo> result = assertQuery(user1.username, user1); assertThat(result.get(0).secondaryEmails).isNull(); result = assertQuery(newQuery(user1.username).withOption(ListAccountsOption.DETAILS), user1); assertThat(result.get(0).secondaryEmails).isNull(); result = assertQuery(newQuery(user1.username).withOption(ListAccountsOption.ALL_EMAILS), user1); assertThat(result.get(0).secondaryEmails).containsExactlyElementsIn(java.util.Arrays.asList(secondaryEmails)).inOrder(); result = assertQuery(newQuery(user1.username).withOptions(ListAccountsOption.DETAILS, ListAccountsOption.ALL_EMAILS), user1); assertThat(result.get(0).secondaryEmails).containsExactlyElementsIn(java.util.Arrays.asList(secondaryEmails)).inOrder(); }
@java.lang.Override public void onTopicEdited(com.google.gerrit.extensions.events.TopicEditedListener.Event ev) { try { hooks.doTopicChangedHook(getNotes(ev.getChange()).getChange(), getAccount(ev.getEditor()), ev.getOldTopic(), db.get()); } catch (com.google.gwtorm.server.OrmException e) { com.google.gerrit.common.ChangeHookApiListener.log.error(("TopicChanged hook failed to run " + (ev.getChange()._number)), e); } }
public Account.Id getAccountId() { checkState(((accountId) != null), "author identity for %s is not from an IdentifiedUser: %s", getClass().getSimpleName(), authorIdent.toExternalString()); return accountId; }
private static boolean isContentType(com.google.gwt.http.client.Response res, java.lang.String want) { java.lang.String type = res.getHeader("Content-Type"); if (type == null) { return false; } int semi = type.indexOf(';'); if (semi >= 0) { type = type.substring(0, semi).trim(); } return want.equals(type); }
public com.google.gerrit.client.rpc.RestApi id(java.lang.String project, int id) { return idRaw((((com.google.gwt.http.client.URL.encodePathSegment(project)) + "~") + id)); }
static com.google.gerrit.server.diff.PatchListEntry readFrom(java.io.InputStream in) throws java.io.IOException { com.google.gerrit.reviewdb.client.Patch.ChangeType changeType = readEnum(in, com.google.gerrit.reviewdb.client.Patch.ChangeType.values()); com.google.gerrit.reviewdb.client.Patch.PatchType patchType = readEnum(in, com.google.gerrit.reviewdb.client.Patch.PatchType.values()); java.lang.String oldName = readString(in); java.lang.String newName = readString(in); byte[] hdr = readBytes(in); int ins = readVarInt32(in); int del = readVarInt32(in); long size = readFixInt64(in); long sizeDelta = readFixInt64(in); org.eclipse.jgit.diff.Edit[] editArray = com.google.gerrit.server.diff.PatchListEntry.readEditArray(in); org.eclipse.jgit.diff.Edit[] editsDueToRebase = com.google.gerrit.server.diff.PatchListEntry.readEditArray(in); return new com.google.gerrit.server.diff.PatchListEntry(changeType, patchType, oldName, newName, hdr, com.google.common.collect.ImmutableList.copyOf(editArray), com.google.common.collect.ImmutableSet.copyOf(editsDueToRebase), ins, del, size, sizeDelta); }
com.google.gwt.dom.client.DivElement getCmB() { return cmB; }
public void run() { synchronized(cleanup) { ran = true; for (final java.util.Iterator<java.lang.Runnable> i = cleanup.iterator(); i.hasNext();) { try { i.next().run(); } catch (java.lang.Throwable err) { com.google.gerrit.server.RequestCleanup.log.error("Failed to execute per-request cleanup", err); } i.remove(); } } }
private com.google.gerrit.server.account.AccountState makeUser(final java.lang.String name, final java.lang.String email) { final com.google.gerrit.reviewdb.client.Account.Id userId = new com.google.gerrit.reviewdb.client.Account.Id(42); final com.google.gerrit.reviewdb.client.Account account = new com.google.gerrit.reviewdb.client.Account(userId, com.google.gerrit.common.TimeUtil.nowTs()); account.setFullName(name); account.setPreferredEmail(email); return new com.google.gerrit.server.account.AccountState(account, java.util.Collections.emptySet(), java.util.Collections.emptySet(), new java.util.HashMap()); }
@java.lang.Override public synchronized <F1> com.google.gerrit.metrics.Timer1<F1> newTimer(java.lang.String name, com.google.gerrit.metrics.Description desc, com.google.gerrit.metrics.Field<F1> field1) { com.google.gerrit.metrics.dropwizard.DropWizardMetricMaker.checkTimerDescription(desc); com.google.gerrit.metrics.dropwizard.TimerImpl1<F1> m = new com.google.gerrit.metrics.dropwizard.TimerImpl1(this, name, desc, field1); define(name, desc); bucketed.put(name, m); return m.timer(); }
public static <T> void itemOf(com.google.inject.Binder binder, com.google.inject.TypeLiteral<T> member) { @java.lang.SuppressWarnings("unchecked") com.google.inject.Key<com.google.gerrit.extensions.registration.DynamicItem<T>> key = ((com.google.inject.Key<com.google.gerrit.extensions.registration.DynamicItem<T>>) (com.google.inject.Key.get(com.google.inject.util.Types.newParameterizedType(com.google.gerrit.extensions.registration.DynamicItem.class, member.getType())))); binder.bind(key).toProvider(new com.google.gerrit.extensions.registration.DynamicItemProvider(member, key)).in(Scopes.SINGLETON); }
public java.util.List<java.lang.String> check(com.google.gerrit.reviewdb.client.Change c) { reset(); change = c; try { checkImpl(); return messages; } finally { if ((rw) != null) { rw.release(); } if ((repo) != null) { repo.close(); } } }
@org.junit.Test public void nullAsDefault() throws java.lang.Exception { org.eclipse.jgit.lib.Config config = new org.eclipse.jgit.lib.Config(); java.time.Duration t; t = com.google.gitiles.ConfigUtil.getDuration(config, "core", null, "blank", null); assertThat(t).isNull(); config.setString("core", null, "blank", ""); t = com.google.gitiles.ConfigUtil.getDuration(config, "core", null, "blank", null); assertThat(t).isNull(); config.setString("core", null, "blank", " "); t = com.google.gitiles.ConfigUtil.getDuration(config, "core", null, "blank", null); assertThat(t).isNull(); }
@java.lang.Override public void onClick(final com.google.gwt.event.dom.client.ClickEvent event) { doSave(); }
@org.junit.Test public void banCommit() throws java.lang.Exception { com.google.gerrit.acceptance.GitUtil.add(git, "a.txt", "some content"); com.google.gerrit.acceptance.GitUtil.Commit c = com.google.gerrit.acceptance.GitUtil.createCommit(git, admin.getIdent(), "subject"); com.google.gerrit.acceptance.RestResponse r = adminSession.put((("/projects/" + (project.get())) + "/ban/"), BanCommit.Input.fromCommits(c.getCommit().getName())); assertThat(r.getStatusCode()).isEqualTo(HttpStatus.SC_OK); com.google.gerrit.server.project.BanCommit.BanResultInfo info = newGson().fromJson(r.getReader(), com.google.gerrit.server.project.BanCommit.BanResultInfo.class); assertThat(com.google.common.collect.Iterables.getOnlyElement(info.newlyBanned)).isEqualTo(c.getCommit().getName()); assertThat(info.alreadyBanned).isNull(); assertThat(info.ignored).isNull(); org.eclipse.jgit.transport.PushResult pushResult = com.google.gerrit.acceptance.GitUtil.pushHead(git, "refs/heads/master", false); assertThat(pushResult.getRemoteUpdate("refs/heads/master").getMessage()).startsWith("contains banned commit"); }
com.googlesource.gerrit.plugins.lfs.locks.LfsGetLocksResponse listLocks(com.google.gerrit.reviewdb.client.Project.NameKey project) { com.googlesource.gerrit.plugins.lfs.locks.LfsLocksHandler.log.debug("Get locks for {} project", project); return new com.googlesource.gerrit.plugins.lfs.locks.LfsGetLocksResponse(projectLocks.getUnchecked(project).getLocks(), null); }
private static void inline(org.commonmark.node.HtmlInline curr) { java.lang.String html = curr.getLiteral(); java.util.regex.Matcher m = com.google.gitiles.doc.GitilesHtmlExtension.BREAK.matcher(html); if (m.matches()) { switch (m.group(1).toLowerCase()) { case "br" : curr.insertAfter(new org.commonmark.node.HardLineBreak()); curr.unlink(); return; case "hr" : curr.insertAfter(new org.commonmark.node.ThematicBreak()); curr.unlink(); return; } } m = com.google.gitiles.doc.GitilesHtmlExtension.ANCHOR_OPEN.matcher(html); if (m.matches()) { java.lang.String name = m.group(2); org.commonmark.node.Node next = curr.getNext(); if (com.google.gitiles.doc.GitilesHtmlExtension.isAnchorClose(next)) { next.unlink(); com.google.gitiles.doc.NamedAnchor anchor = new com.google.gitiles.doc.NamedAnchor(); anchor.setName(name); curr.insertAfter(anchor); curr.unlink(); com.google.gitiles.doc.MarkdownUtil.trimPreviousWhitespace(anchor); return; } } curr.unlink(); }
@java.lang.Override public com.google.gerrit.extensions.common.WebLinkInfo getProjectWeblink(java.lang.String projectName) { return new com.google.gerrit.extensions.common.WebLinkInfo(name, null, java.lang.String.format("%s/%s", baseUrl, projectName), Target.BLANK); }
public java.lang.String generateToken(java.lang.String operation, org.eclipse.jgit.lfs.lib.AnyLongObjectId id) { try { byte[] initVector = new byte[com.googlesource.gerrit.plugins.lfs.fs.LfsFsRequestAuthorizer.IV_LENGTH]; rndm.nextBytes(initVector); javax.crypto.Cipher cipher = cipher(initVector, javax.crypto.Cipher.ENCRYPT_MODE); return org.eclipse.jgit.util.Base64.encodeBytes(com.google.common.primitives.Bytes.concat(initVector, cipher.doFinal(java.lang.String.format("%s-%s-%s", operation, id.name(), timeout()).getBytes(java.nio.charset.StandardCharsets.UTF_8)))); } catch (java.security.GeneralSecurityException e) { com.googlesource.gerrit.plugins.lfs.fs.LfsFsRequestAuthorizer.log.error("Token generation failed with error", e); throw new java.lang.RuntimeException(e); } }
private com.google.gerrit.extensions.common.SubmitType getSubmitType(com.google.gerrit.server.project.ChangeControl ctl, com.google.gerrit.reviewdb.client.PatchSet ps) { com.google.gerrit.common.data.SubmitTypeRecord r = ctl.getSubmitTypeRecord(db, ps); if ((r.status) != (SubmitTypeRecord.Status.OK)) { com.google.gerrit.server.git.MergeOp.log.error(("Failed to get submit type for " + (ctl.getChange().getKey()))); return null; } return r.type; }
@org.junit.Before public void setUpInjector() throws java.lang.Exception { lifecycle = new com.google.gerrit.lifecycle.LifecycleManager(); com.google.inject.Injector injector = createInjector(); lifecycle.add(injector); injector.injectMembers(this); lifecycle.start(); db = schemaFactory.open(); schemaCreator.create(db); userId = accountManager.authenticate(com.google.gerrit.server.account.AuthRequest.forUser("user")).getAccountId(); com.google.gerrit.reviewdb.client.Account userAccount = db.accounts().get(userId); userAccount.setPreferredEmail("user@example.com"); db.accounts().update(com.google.common.collect.ImmutableList.of(userAccount)); user = userFactory.create(com.google.inject.util.Providers.of(db), userId); requestContext.setContext(newRequestContext(userAccount.getId())); }
private boolean isJiraConnectSuccessful() { ui.message("Checking Jira connectivity ... "); try { new com.googlesource.gerrit.plugins.its.jira.JiraClient(jiraUrl, jiraUsername, jiraPassword).sysInfo().getVersion(); ui.message("[OK]\n"); return true; } catch (java.net.URISyntaxException e) { ui.message("*FAILED* (%s)\n", e.toString()); return false; } }
private java.util.List<org.bouncycastle.openpgp.PGPPublicKeyRing> get(long keyId, byte[] fp) throws java.io.IOException { if ((reader) == null) { load(); } if ((notes) == null) { return java.util.Collections.emptyList(); } org.eclipse.jgit.notes.Note note = notes.getNote(com.google.gerrit.gpg.PublicKeyStore.keyObjectId(keyId)); if (note == null) { return java.util.Collections.emptyList(); } java.util.List<org.bouncycastle.openpgp.PGPPublicKeyRing> keys = new java.util.ArrayList<>(); try (java.io.InputStream in = reader.open(note.getData(), com.google.gerrit.gpg.OBJ_BLOB).openStream()) { while (true) { @java.lang.SuppressWarnings("unchecked") java.util.Iterator<java.lang.Object> it = new org.bouncycastle.openpgp.bc.BcPGPObjectFactory(new org.bouncycastle.bcpg.ArmoredInputStream(in)).iterator(); if (!(it.hasNext())) { break; } java.lang.Object obj = it.next(); if (obj instanceof org.bouncycastle.openpgp.PGPPublicKeyRing) { org.bouncycastle.openpgp.PGPPublicKeyRing kr = ((org.bouncycastle.openpgp.PGPPublicKeyRing) (obj)); if ((fp == null) || (java.util.Arrays.equals(fp, kr.getPublicKey().getFingerprint()))) { keys.add(kr); } } checkState((!(it.hasNext())), "expected one PGP object per ArmoredInputStream"); } return keys; } }
@org.junit.Test public void listProjects() throws com.jcraft.jsch.JSchException, java.io.IOException { com.google.gerrit.reviewdb.client.Project.NameKey someProject = new com.google.gerrit.reviewdb.client.Project.NameKey("some-project"); com.google.gerrit.acceptance.GitUtil.createProject(sshSession, someProject.get()); com.google.gerrit.acceptance.RestResponse r = GET("/projects/"); assertEquals(HttpStatus.SC_OK, r.getStatusCode()); java.util.Map<java.lang.String, com.google.gerrit.extensions.common.ProjectInfo> result = com.google.gerrit.acceptance.rest.project.ListProjectsIT.toProjectInfoMap(r); com.google.gerrit.acceptance.rest.project.ProjectAssert.assertProjects(java.util.Arrays.asList(allUsers, someProject, project), result.values()); }
private void findParameters(final java.util.List<com.google.gwtorm.schema.ColumnModel> r, final org.antlr.runtime.tree.Tree node) { switch (node.getType()) { case QueryParser.WHERE : extractParameters(r, node); break; default : for (int i = 0; i < (node.getChildCount()); i++) { findParameters(r, node.getChild(i)); } break; } }
@org.junit.Test public void testVerifyAgainstDifferentOperation() throws java.lang.Exception { com.googlesource.gerrit.plugins.lfs.AuthInfo info = auth.generateAuthInfo("o", zeroId(), java.time.Instant.now(), 1L); assertThat(auth.verifyAuthInfo(info.authToken(), "p", zeroId())).isFalse(); }
@java.lang.Override protected void onLoad() { super.onLoad(); createProjectLinkPanel.setVisible(false); com.google.gerrit.client.account.AccountCapabilities.all(new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.account.AccountCapabilities>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.account.AccountCapabilities ac) { createProjectLinkPanel.setVisible(ac.canPerform(com.google.gerrit.client.admin.CREATE_PROJECT)); } }, com.google.gerrit.client.admin.CREATE_PROJECT); com.google.gerrit.client.projects.ProjectMap.all(new com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gerrit.client.projects.ProjectMap>(this) { @java.lang.Override protected void preDisplay(final com.google.gerrit.client.projects.ProjectMap result) { projects.display(result); projects.finishDisplay(); } }); }
@java.lang.Override public UiAction.Description getDescription(com.google.gerrit.server.change.ChangeResource rsrc) { com.google.gerrit.reviewdb.client.Change.Status status = rsrc.getChange().getStatus(); com.google.gerrit.server.permissions.PermissionBackend.ForChange perm = rsrc.permissions().database(db); return new com.google.gerrit.extensions.webui.UiAction.Description().setLabel("Delete").setTitle(("Delete change " + (rsrc.getId()))).setVisible(and(com.google.gerrit.server.restapi.change.DeleteChange.isChangeDeletable(status), perm.testCond(ChangePermission.DELETE))); }
private java.lang.String getAccessTokenAttribute(java.lang.String tokenResponse) throws com.googlesource.gerrit.plugins.cfoauth.UAAClientException { com.google.gson.JsonObject json = getAsJsonObject(tokenResponse); java.lang.String accessToken = getAttribute(json, com.googlesource.gerrit.plugins.cfoauth.UAAClient.ACCESS_TOKEN_ATTRIBUTE); if (accessToken == null) { throw new com.googlesource.gerrit.plugins.cfoauth.UAAClientException("Can't extract a token: missing or invalid 'access_token' attribute"); } return accessToken; }
public static com.google.gerrit.server.edit.tree.ChangeFileContentModificationSubject assertThat(com.google.gerrit.server.edit.tree.ChangeFileContentModification modification) { return assertAbout(com.google.gerrit.server.edit.tree.ChangeFileContentModificationSubject::new).that(modification); }
public native final com.google.gerrit.client.config.ServerInfo.SuggestInfo suggest();
void tryOnce() throws com.ericsson.gerrit.plugins.highavailability.forwarder.rest.ForwardingException { try { com.ericsson.gerrit.plugins.highavailability.forwarder.rest.HttpResponseHandler.HttpResult result = send(); if (!(result.isSuccessful())) { throw new com.ericsson.gerrit.plugins.highavailability.forwarder.rest.ForwardingException(true, ((("Unable to " + (name)) + ": ") + (result.getMessage()))); } } catch (java.io.IOException e) { throw new com.ericsson.gerrit.plugins.highavailability.forwarder.rest.ForwardingException(isRecoverable(e), e.getMessage(), e); } }
@java.lang.Override public org.eclipse.jgit.revwalk.RevCommit commitAt(org.eclipse.jgit.lib.ObjectId expected) throws java.io.IOException { if (com.google.common.base.Objects.equal(src, expected)) { return revision; } org.eclipse.jgit.lib.RefUpdate ru = db.updateRef(getRefName()); if (expected != null) { ru.setExpectedOldObjectId(expected); } else { ru.setExpectedOldObjectId(org.eclipse.jgit.lib.ObjectId.zeroId()); } ru.setNewObjectId(src); ru.disableRefLog(); inserter.flush(); switch (ru.update(rw)) { case NEW : case FAST_FORWARD : revision = rw.parseCommit(ru.getNewObjectId()); update.fireGitRefUpdatedEvent(ru); return revision; default : throw new java.io.IOException(((((("Cannot update " + (ru.getName())) + " in ") + (db.getDirectory())) + ": ") + (ru.getResult()))); } }
public static com.google.gerrit.client.rpc.RestApi hashtag(@com.google.gerrit.common.Nullable java.lang.String project, int changeId, java.lang.String hashtag) { return com.google.gerrit.client.changes.ChangeApi.change(project, changeId).view("hashtags").id(hashtag); }
public static boolean isInstalled() { if (!(com.google.gwtexpui.user.client.UserAgent.Flash.checked)) { com.google.gwtexpui.user.client.UserAgent.Flash.installed = com.google.gwtexpui.user.client.UserAgent.Flash.hasFlash(); com.google.gwtexpui.user.client.UserAgent.Flash.checked = true; } return com.google.gwtexpui.user.client.UserAgent.Flash.installed; }
private org.eclipse.jgit.revwalk.RevCommit newMergeCommit(org.eclipse.jgit.lib.Repository repo, org.eclipse.jgit.lib.ObjectInserter oi, org.eclipse.jgit.revwalk.RevWalk rw, com.google.gerrit.server.project.ProjectState projectState, org.eclipse.jgit.revwalk.RevCommit mergeTip, com.google.gerrit.extensions.common.MergeInput merge, org.eclipse.jgit.lib.PersonIdent authorIdent, java.lang.String commitMessage) throws com.google.gerrit.extensions.restapi.RestApiException, java.io.IOException { if (com.google.common.base.Strings.isNullOrEmpty(merge.source)) { throw new com.google.gerrit.extensions.restapi.BadRequestException("merge.source must be non-empty"); } org.eclipse.jgit.revwalk.RevCommit sourceCommit = com.google.gerrit.server.git.MergeUtil.resolveCommit(repo, rw, merge.source); if (!(commits.canRead(projectState, repo, sourceCommit))) { throw new com.google.gerrit.extensions.restapi.BadRequestException(("do not have read permission for: " + (merge.source))); } com.google.gerrit.server.git.MergeUtil mergeUtil = mergeUtilFactory.create(projectState); java.lang.String mergeStrategy = com.google.common.base.MoreObjects.firstNonNull(com.google.common.base.Strings.emptyToNull(merge.strategy), mergeUtil.mergeStrategyName()); return com.google.gerrit.server.git.MergeUtil.createMergeCommit(oi, repo.getConfig(), mergeTip, sourceCommit, mergeStrategy, authorIdent, commitMessage, rw); }
private void update() { if ((colWidth.getIntValue()) <= 0) { new com.google.gerrit.client.ErrorDialog(PatchUtil.C.illegalNumberOfColumns()).center(); return; } com.google.gerrit.extensions.client.DiffPreferencesInfo dp = getValue(); dp.ignoreWhitespace = getIgnoreWhitespace(); dp.context = getContext(); dp.tabSize = tabWidth.getIntValue(); dp.lineLength = colWidth.getIntValue(); dp.syntaxHighlighting = syntaxHighlighting.getValue(); dp.intralineDifference = intralineDifference.getValue(); dp.showWhitespaceErrors = whitespaceErrors.getValue(); dp.showLineEndings = showLineEndings.getValue(); dp.showTabs = showTabs.getValue(); dp.skipDeleted = skipDeleted.getValue(); dp.skipUncommented = skipUncommented.getValue(); dp.expandAllComments = expandAllComments.getValue(); dp.retainHeader = retainHeader.getValue(); dp.manualReview = manualReview.getValue(); listenablePrefs.set(dp); }
void appendSubmittedBy(com.google.gerrit.reviewdb.client.Account.Id accountId, java.util.Optional<com.google.gerrit.reviewdb.client.Account> account) { sb.append("Submitted-by: "); appendUserData(accountId, account); sb.append("\n"); }
public com.google.gerrit.server.account.AuthResult authenticate(com.google.gerrit.server.account.AuthRequest who) throws com.google.gerrit.server.account.AccountException { who = realm.authenticate(who); try { try (com.google.gerrit.reviewdb.server.ReviewDb db = schema.open()) { com.google.gerrit.reviewdb.client.AccountExternalId.Key key = com.google.gerrit.server.account.AccountManager.id(who); com.google.gerrit.reviewdb.client.AccountExternalId id = getAccountExternalId(db, key); if (id == null) { return create(db, who); } else { com.google.gerrit.reviewdb.client.Account act = byIdCache.get(id.getAccountId()).getAccount(); if (!(act.isActive())) { throw new com.google.gerrit.server.account.AccountException("Authentication error, account inactive"); } update(db, who, id); return new com.google.gerrit.server.account.AuthResult(id.getAccountId(), key, false); } } } catch (com.google.gwtorm.server.OrmException | com.google.gerrit.common.errors.NameAlreadyUsedException | com.google.gerrit.common.errors.InvalidUserNameException e) { throw new com.google.gerrit.server.account.AccountException("Authentication error", e); } }
private java.util.Map<java.lang.String, com.google.gerrit.server.dashboard.ListDashboards.DashboardInfo> loadDashboards(final com.google.gerrit.reviewdb.client.Project project, final org.eclipse.jgit.lib.Repository repo, final org.eclipse.jgit.revwalk.RevWalk revWalk, final org.eclipse.jgit.lib.Ref ref) throws java.io.IOException { final java.util.Map<java.lang.String, com.google.gerrit.server.dashboard.ListDashboards.DashboardInfo> dashboards = com.google.common.collect.Maps.newTreeMap(); org.eclipse.jgit.treewalk.TreeWalk treeWalk = new org.eclipse.jgit.treewalk.TreeWalk(repo); try { final org.eclipse.jgit.revwalk.RevCommit commit = revWalk.parseCommit(ref.getObjectId()); final org.eclipse.jgit.revwalk.RevTree tree = commit.getTree(); treeWalk.addTree(tree); treeWalk.setRecursive(true); while (treeWalk.next()) { final org.eclipse.jgit.lib.ObjectLoader loader = repo.open(treeWalk.getObjectId(0)); final com.google.gerrit.server.dashboard.ListDashboards.DashboardInfo info = loadDashboard(project, ref.getName(), treeWalk.getPathString(), loader); dashboards.put(info.id, info); } } catch (org.eclipse.jgit.errors.ConfigInvalidException e) { com.google.gerrit.server.dashboard.ListDashboards.log.warn(((("Failed to load dashboards of project " + (project.getName())) + " from ref ") + (ref.getName())), e); } catch (java.io.IOException e) { com.google.gerrit.server.dashboard.ListDashboards.log.warn(((("Failed to load dashboards of project " + (project.getName())) + " from ref ") + (ref.getName())), e); } finally { treeWalk.release(); } return dashboards; }
public boolean isMatchable() { return (this) instanceof com.google.gerrit.server.query.Matchable; }
private java.util.Set<com.google.gerrit.reviewdb.client.Project.NameKey> getAllParents(final com.google.gerrit.reviewdb.client.Project.NameKey projectName) { final java.util.Set<com.google.gerrit.reviewdb.client.Project.NameKey> parents = new java.util.HashSet<com.google.gerrit.reviewdb.client.Project.NameKey>(); com.google.gerrit.reviewdb.client.Project.NameKey p = projectName; while ((p != null) && (parents.add(p))) { final com.google.gerrit.server.project.ProjectState e = projectCache.get(p); if (e == null) { break; } p = e.getProject().getParent(allProjectsName); } return parents; }
@java.lang.Override public void deleteBranches(com.google.gerrit.extensions.api.projects.DeleteBranchesInput in) throws com.google.gerrit.extensions.restapi.RestApiException { try { deleteBranches.apply(checkExists(), in); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot delete branches", e); } }
@java.lang.Override public com.google.gerrit.common.data.GroupDetail call() throws com.google.gerrit.common.errors.NoSuchGroupException, com.google.gwtorm.client.OrmException { control = groupControl.validateFor(groupId); final com.google.gerrit.reviewdb.AccountGroup group = control.getAccountGroup(); final com.google.gerrit.common.data.GroupDetail detail = new com.google.gerrit.common.data.GroupDetail(); detail.setGroup(group); detail.setOwnerGroup(groupCache.get(group.getOwnerGroupId())); switch (group.getType()) { case INTERNAL : detail.setMembers(loadMembers()); detail.setIncludes(loadIncludes()); break; } detail.setAccounts(aic.create()); detail.setCanModify(control.isOwner()); detail.setGroups(gic.create()); return detail; }
private com.google.gerrit.server.change.ChangeResource parseResource(com.google.gerrit.acceptance.PushOneCommit.Result r) throws java.lang.Exception { return parseChangeResource(r.getChangeId()); }
@org.junit.Test public void copyMaxScoreOnRework() throws java.lang.Exception { java.lang.String subject = "test commit"; java.lang.String file = "a.txt"; codeReview.setCopyMaxScore(true); saveLabelConfig(); com.google.gerrit.acceptance.PushOneCommit push = pushFactory.create(db, user.getIdent(), subject, file, "first contents"); com.google.gerrit.acceptance.PushOneCommit.Result r = push.to(git, "refs/for/master"); revision(r).review(com.google.gerrit.extensions.api.changes.ReviewInput.approve()); assertApproval(r, 2); push = pushFactory.create(db, user.getIdent(), subject, file, "second contents", r.getChangeId()); r = push.to(git, "refs/for/master"); assertApproval(r, 2); }
private void appendHeader(com.google.gerrit.common.data.PatchScript script, final com.google.gwtexpui.safehtml.client.SafeHtmlBuilder m) { m.openTr(); m.openTd(); m.addStyleName(Gerrit.RESOURCES.css().iconCell()); m.addStyleName(Gerrit.RESOURCES.css().fileColumnHeader()); m.closeTd(); m.openTd(); m.addStyleName(Gerrit.RESOURCES.css().fileColumnHeader()); m.addStyleName(Gerrit.RESOURCES.css().lineNumber()); m.closeTd(); m.openTd(); m.setStyleName(Gerrit.RESOURCES.css().fileColumnHeader()); m.setAttribute("width", "50%"); m.append(PatchUtil.C.patchHeaderOld()); m.br(); if (0 < (script.getA().size())) { if ((idSideA) == null) { downloadLink(m, patchKey, "1"); } else { downloadLink(m, new com.google.gerrit.reviewdb.Patch.Key(idSideA, patchKey.get()), "0"); } } m.closeTd(); m.openTd(); m.addStyleName(Gerrit.RESOURCES.css().fileColumnHeader()); m.addStyleName(Gerrit.RESOURCES.css().lineNumber()); m.closeTd(); m.openTd(); m.setStyleName(Gerrit.RESOURCES.css().fileColumnHeader()); m.setAttribute("width", "50%"); m.append(PatchUtil.C.patchHeaderNew()); m.br(); if (0 < (script.getB().size())) { downloadLink(m, new com.google.gerrit.reviewdb.Patch.Key(idSideB, patchKey.get()), "0"); } m.closeTd(); m.closeTr(); }
public boolean hasPushTask() { return (totalPushTasksCount) != 0; }
public com.google.gerrit.server.account.GroupControl controlFor(com.google.gerrit.common.data.GroupDescription.Basic group) { return new com.google.gerrit.server.account.GroupControl(user.get(), group); }
public final org.eclipse.jgit.notes.NoteMap commitNewNotes(org.eclipse.jgit.notes.NoteMap notes, java.lang.String notesBranch, org.eclipse.jgit.lib.PersonIdent commitAuthor, java.lang.String commitMessage) throws java.io.IOException, org.eclipse.jgit.api.errors.ConcurrentRefUpdateException { this.overwrite = false; commitNotes(notes, notesBranch, commitAuthor, commitMessage); org.eclipse.jgit.notes.NoteMap newlyCreated = org.eclipse.jgit.notes.NoteMap.newEmptyMap(); for (org.eclipse.jgit.notes.Note n : notes) { if (((base) == null) || (!(base.contains(n)))) { newlyCreated.set(n, n.getData()); } } return newlyCreated; }
@java.lang.Override public void onKeyPress(com.google.gwt.event.dom.client.KeyPressEvent event) { if (((event.getSource()) == (newTopic)) && ((event.getNativeEvent().getKeyCode()) == (com.google.gwt.event.dom.client.KeyCodes.KEY_ENTER))) { doTopicEdit(); } }
private com.google.gerrit.server.group.InternalGroup createGroupInNoteDb(org.eclipse.jgit.lib.Repository allUsersRepo, com.google.gerrit.server.group.db.InternalGroupCreation groupCreation, com.google.gerrit.server.group.db.InternalGroupUpdate groupUpdate) throws com.google.gwtorm.server.OrmDuplicateKeyException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { com.google.gerrit.server.group.db.GroupConfig groupConfig = com.google.gerrit.server.group.db.GroupConfig.createForNewGroup(allUsersRepo, groupCreation); groupConfig.setGroupUpdate(groupUpdate, com.google.gerrit.reviewdb.client.Account.Id::toString, com.google.gerrit.reviewdb.client.AccountGroup.UUID::get); com.google.gerrit.reviewdb.client.AccountGroup.NameKey groupName = groupUpdate.getName().orElseGet(groupCreation::getNameKey); com.google.gerrit.server.group.db.GroupNameNotes groupNameNotes = com.google.gerrit.server.group.db.GroupNameNotes.loadForNewGroup(allUsersRepo, groupCreation.getGroupUUID(), groupName); commit(allUsersRepo, groupConfig, groupNameNotes); return groupConfig.getLoadedGroup().orElseThrow(() -> new java.lang.IllegalStateException("Created group wasn't automatically loaded")); }
@org.junit.Test public void pushToPublishMagicBranchIsAllowed() throws java.lang.Exception { createChange("refs/publish/master"); com.google.gerrit.acceptance.PushOneCommit.Result result = pushTo("refs/publish/master"); result.assertOkStatus(); assertThat(result.getMessage()).endsWith("Pushing to refs/publish/* is deprecated, use refs/for/* instead.\n"); }
@org.junit.Test public void addRemoveMember() throws java.lang.Exception { com.google.gerrit.acceptance.TestAccount u = accounts.create("user", "user@example.com", "Full Name"); com.google.gerrit.acceptance.RestResponse r = PUT("/groups/Administrators/members/user"); assertEquals(HttpStatus.SC_CREATED, r.getStatusCode()); com.google.gerrit.acceptance.rest.group.AccountInfo ai = new com.google.gson.Gson().fromJson(r.getReader(), new com.google.gson.reflect.TypeToken<com.google.gerrit.acceptance.rest.group.AccountInfo>() {}.getType()); assertAccountInfo(u, ai); assertMembers("Administrators", admin, u); r.consume(); assertEquals(HttpStatus.SC_NO_CONTENT, DELETE("/groups/Administrators/members/user")); assertMembers("Administrators", admin); }
public static com.googlesource.gerrit.plugins.replication.ReplicationFilter.PatternType getPatternType(java.lang.String pattern) { if (pattern.startsWith(AccessSection.REGEX_PREFIX)) { return com.googlesource.gerrit.plugins.replication.ReplicationFilter.PatternType.REGEX; } else if (pattern.endsWith("*")) { return com.googlesource.gerrit.plugins.replication.ReplicationFilter.PatternType.WILDCARD; } else { return com.googlesource.gerrit.plugins.replication.ReplicationFilter.PatternType.EXACT_MATCH; } }
@java.lang.Override public void remove() { guiceFilter.destroy(); }
@java.lang.Override public SiteIndexer.Result indexAll(com.google.gerrit.server.index.group.GroupIndex index) { org.eclipse.jgit.lib.ProgressMonitor progress = new org.eclipse.jgit.lib.TextProgressMonitor(new java.io.PrintWriter(progressOut)); progress.start(2); com.google.common.base.Stopwatch sw = com.google.common.base.Stopwatch.createStarted(); java.util.List<com.google.gerrit.reviewdb.client.AccountGroup.UUID> uuids; try { uuids = collectGroups(progress); } catch (com.google.gwtorm.server.OrmException e) { com.google.gerrit.server.index.group.AllGroupsIndexer.log.error("Error collecting groups", e); return new com.google.gerrit.server.index.SiteIndexer.Result(sw, false, 0, 0); } return reindexGroups(index, uuids, progress); }
private void evictCache(com.google.common.cache.Cache<?, ?> cache, java.lang.String cacheName, java.lang.Object key) { if (Constants.PROJECT_LIST.equals(cacheName)) { cache.invalidateAll(); } else { cache.invalidate(key); } com.ericsson.gerrit.plugins.highavailability.forwarder.rest.CacheRestApiServlet.logger.debug(("Invalidated " + cacheName)); }
private void addLink(java.lang.String label, final com.google.gerrit.reviewdb.client.PatchSet.Id id) { final com.google.gwt.user.client.ui.Anchor anchor = new com.google.gwt.user.client.ui.Anchor(label); anchor.addClickHandler(new com.google.gwt.event.dom.client.ClickHandler() { @java.lang.Override public void onClick(com.google.gwt.event.dom.client.ClickEvent event) { if ((side) == (com.google.gerrit.client.patches.PatchSetSelectBox.Side.A)) { idSideA = id; } else { idSideB = id; } com.google.gerrit.reviewdb.client.Patch.Key keySideB = new com.google.gerrit.reviewdb.client.Patch.Key(idSideB, patchKey.get()); switch (screenType) { case SIDE_BY_SIDE : com.google.gerrit.client.Gerrit.display(com.google.gerrit.client.Dispatcher.toPatchSideBySide(idSideA, keySideB)); break; case UNIFIED : com.google.gerrit.client.Gerrit.display(com.google.gerrit.client.Dispatcher.toPatchUnified(idSideA, keySideB)); break; } } }); links.add(anchor); linkPanel.add(anchor); }
public final void setOwnerUUID(com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid) { owner_id(com.google.gwt.http.client.URL.encodeQueryString(uuid.get())); }
private void initIgnoreWhitespace() { ignoreWhitespace.addItem(PatchUtil.C.whitespaceIGNORE_NONE(), com.google.gerrit.client.diff.IGNORE_NONE.name()); ignoreWhitespace.addItem(PatchUtil.C.whitespaceIGNORE_TRAILING(), com.google.gerrit.client.diff.IGNORE_TRAILING.name()); ignoreWhitespace.addItem(PatchUtil.C.whitespaceIGNORE_LEADING_AND_TRAILING(), com.google.gerrit.client.diff.IGNORE_LEADING_AND_TRAILING.name()); ignoreWhitespace.addItem(PatchUtil.C.whitespaceIGNORE_ALL(), com.google.gerrit.client.diff.IGNORE_ALL.name()); }
protected void populateProjects() { com.google.gerrit.client.projects.ProjectMap.all(new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.projects.ProjectMap>() { @java.lang.Override public void onSuccess(final com.google.gerrit.client.projects.ProjectMap result) { projectsTab.display(result); if (firstPopupLoad) { firstPopupLoad = false; displayPopup(); } } }); }
public static com.google.gerrit.client.rpc.GerritCallback<com.google.gwt.core.client.JavaScriptObject> cs(com.google.gerrit.reviewdb.client.Project.NameKey project, final com.google.gerrit.reviewdb.client.Change.Id id, com.google.gwt.user.client.ui.Button... draftButtons) { com.google.gerrit.client.change.ChangeActions.setEnabled(false, draftButtons); return new com.google.gerrit.client.rpc.GerritCallback<com.google.gwt.core.client.JavaScriptObject>() { @java.lang.Override public void onSuccess(com.google.gwt.core.client.JavaScriptObject result) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(project, id)); } @java.lang.Override public void onFailure(java.lang.Throwable err) { com.google.gerrit.client.change.ChangeActions.setEnabled(true, draftButtons); if (com.google.gerrit.client.change.SubmitFailureDialog.isConflict(err)) { new com.google.gerrit.client.change.SubmitFailureDialog(err.getMessage()).center(); com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(project, id)); } else { super.onFailure(err); } } }; }
public com.google.common.collect.FluentIterable<com.google.gerrit.extensions.common.WebLinkInfo> getProjectLinks(final java.lang.String project) { return filterLinks(projectLinks, new com.google.common.base.Function<com.google.gerrit.extensions.webui.WebLink, com.google.gerrit.extensions.common.WebLinkInfo>() { @java.lang.Override public com.google.gerrit.extensions.common.WebLinkInfo apply(com.google.gerrit.extensions.webui.WebLink webLink) { return ((com.google.gerrit.extensions.webui.ProjectWebLink) (webLink)).getProjectWeblink(project); } }); }
public java.lang.String getGerritPluginName(java.nio.file.Path srcPath) { java.lang.String fileName = srcPath.getFileName().toString(); if (com.google.gerrit.server.plugins.PluginLoader.isUiPlugin(fileName)) { return fileName.substring(0, fileName.lastIndexOf('.')); } if (serverPluginFactory.handles(srcPath)) { return serverPluginFactory.getPluginName(srcPath); } return null; }
@java.lang.Override protected void loadDefaults() { approvals = com.google.common.collect.ImmutableListMultimap.of(); reviewers = com.google.common.collect.ImmutableSetMultimap.of(); submitRecords = com.google.common.collect.ImmutableList.of(); allChangeMessages = com.google.common.collect.ImmutableList.of(); changeMessagesByPatchSet = com.google.common.collect.ImmutableListMultimap.of(); comments = com.google.common.collect.ImmutableListMultimap.of(); hashtags = com.google.common.collect.ImmutableSet.of(); patchSets = com.google.common.collect.ImmutableSortedMap.of(); allPastReviewers = com.google.common.collect.ImmutableList.of(); }
public void testInlineWithSingleProperty() throws java.io.IOException { com.googlesource.gerrit.plugins.its.base.workflow.ActionRequest actionRequest = createMock(com.googlesource.gerrit.plugins.its.base.workflow.ActionRequest.class); expect(actionRequest.getParameter(1)).andReturn("inline"); expect(actionRequest.getParameters()).andReturn(new java.lang.String[]{ "inline", "${subject}" }); java.util.Set<com.googlesource.gerrit.plugins.its.base.workflow.Property> properties = com.google.common.collect.Sets.newHashSet(); com.googlesource.gerrit.plugins.its.base.workflow.Property propertySubject = createMock(com.googlesource.gerrit.plugins.its.base.workflow.Property.class); expect(propertySubject.getKey()).andReturn("subject").anyTimes(); expect(propertySubject.getValue()).andReturn("Rosebud").anyTimes(); properties.add(propertySubject); org.easymock.IAnswer<java.lang.Boolean> answer = new com.googlesource.gerrit.plugins.its.base.workflow.action.AddVelocityCommentTest.VelocityWriterFiller("Rosebud"); org.easymock.Capture<org.apache.velocity.VelocityContext> contextCapture = createCapture(); expect(velocityRuntime.evaluate(capture(contextCapture), ((java.io.Writer) (anyObject())), ((java.lang.String) (anyObject())), eq("${subject}"))).andAnswer(answer); its.addComment("4711", "Rosebud"); replayMocks(); com.googlesource.gerrit.plugins.its.base.workflow.action.AddVelocityComment addVelocityComment = createAddVelocityComment(); addVelocityComment.execute("4711", actionRequest, properties); org.apache.velocity.VelocityContext context = contextCapture.getValue(); assertEquals("Subject property of context did not match", "Rosebud", context.get("subject")); }
@java.lang.Override public java.lang.String toString() { return ((((((("Range[startLine=" + (startLine)) + ", startCharacter=") + (startCharacter)) + ", endLine=") + (endLine)) + ", endCharacter=") + (endCharacter)) + "]"; }
public void setSideB(com.google.gerrit.client.reviewdb.PatchSet.Id patchSetId) { idSideB = patchSetId; com.google.gerrit.client.patches.PatchScreen.diffSideB = patchSetId; }
public static com.google.gerrit.server.diff.IntraLineDiffKey create(org.eclipse.jgit.lib.ObjectId aId, org.eclipse.jgit.lib.ObjectId bId, com.google.gerrit.extensions.client.DiffPreferencesInfo.Whitespace whitespace) { return new com.google.gerrit.server.diff.AutoValue_IntraLineDiffKey(aId, bId, whitespace); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<com.google.gerrit.extensions.common.EditInfo> apply(com.google.gerrit.server.change.FixResource fixResource, java.lang.Void nothing) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.server.change.RevisionResource revisionResource = fixResource.getRevisionResource(); com.google.gerrit.reviewdb.client.Project.NameKey project = revisionResource.getProject(); com.google.gerrit.server.project.ProjectState projectState = revisionResource.getControl().getProjectControl().getProjectState(); com.google.gerrit.reviewdb.client.PatchSet patchSet = revisionResource.getPatchSet(); org.eclipse.jgit.lib.ObjectId patchSetCommitId = org.eclipse.jgit.lib.ObjectId.fromString(patchSet.getRevision().get()); try (org.eclipse.jgit.lib.Repository repository = gitRepositoryManager.openRepository(project)) { com.google.gerrit.server.edit.tree.TreeModification treeModification = fixReplacementInterpreter.toTreeModification(repository, projectState, patchSetCommitId, fixResource.getFixReplacements()); com.google.gerrit.server.edit.ChangeEdit changeEdit = changeEditModifier.combineWithModifiedPatchSetTree(repository, revisionResource.getControl(), patchSet, treeModification); com.google.gerrit.extensions.common.EditInfo editInfo = changeEditJson.toEditInfo(changeEdit, false); return com.google.gerrit.extensions.restapi.Response.ok(editInfo); } catch (com.google.gerrit.server.project.InvalidChangeOperationException e) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException(e.getMessage()); } }
private com.google.inject.ProvisionException fail(java.lang.Throwable t) { com.google.inject.ProvisionException e = new com.google.inject.ProvisionException("Error scanning indexes"); e.initCause(t); return e; }
void setMaxHeight(int height) { maxHeightWithHeader = height; if (isVisible()) { applyMaxHeight(); } }
private java.lang.String getCommitMessageHookInstallationHint() { if ((installCommitMsgHookCommand) != null) { return installCommitMsgHookCommand; } final java.util.List<com.jcraft.jsch.HostKey> hostKeys = sshInfo.getHostKeys(); if (hostKeys.isEmpty()) { java.lang.String p = ".git/hooks/commit-msg"; return java.lang.String.format(" curl -Lo %s %s/tools/hooks/commit-msg ; chmod +x %s", p, com.google.gerrit.server.git.validators.CommitValidators.getGerritUrl(canonicalWebUrl), p); } java.lang.String sshHost; int sshPort; java.lang.String host = hostKeys.get(0).getHost(); int c = host.lastIndexOf(':'); if (0 <= c) { if (host.startsWith("*:")) { sshHost = com.google.gerrit.server.git.validators.CommitValidators.getGerritHost(canonicalWebUrl); } else { sshHost = host.substring(0, c); } sshPort = java.lang.Integer.parseInt(host.substring((c + 1))); } else { sshHost = host; sshPort = 22; } return java.lang.String.format(" scp -p -P %d %s@%s:hooks/commit-msg .git/hooks/", sshPort, user.getUserName(), sshHost); }
@org.junit.Test public void pushNonGroupsAccessSectionChangeToAllUsersSucceeds() throws java.lang.Exception { com.google.gerrit.server.git.ProjectConfig projectConfig = projectCache.checkedGet(allUsers).getConfig(); com.google.gerrit.common.data.AccessSection as = new com.google.gerrit.common.data.AccessSection(((com.google.gerrit.reviewdb.client.RefNames.REFS_GROUPS) + "foo")); com.google.gerrit.common.data.Permission perm = new com.google.gerrit.common.data.Permission("push"); perm.add(new com.google.gerrit.common.data.PermissionRule(systemGroupBackend.getGroup(com.google.gerrit.acceptance.api.group.ANONYMOUS_USERS))); as.addPermission(perm); projectConfig.replace(as); saveProjectConfig(allUsers, projectConfig); org.eclipse.jgit.junit.TestRepository<org.eclipse.jgit.internal.storage.dfs.InMemoryRepository> repo = cloneProject(allUsers, RefNames.REFS_CONFIG); java.lang.String config = gApi.projects().name(allUsers.get()).branch(RefNames.REFS_CONFIG).file(ProjectConfig.PROJECT_CONFIG).asString(); assertThat(config).contains("[access \"refs/groups/foo\"]"); org.eclipse.jgit.lib.Config cfg = new org.eclipse.jgit.lib.Config(); cfg.fromText(config); cfg.setString("access", ((com.google.gerrit.reviewdb.client.RefNames.REFS_CHANGES) + "foo"), "push", "group Registered Users"); config = cfg.toText(); com.google.gerrit.acceptance.PushOneCommit.Result r = pushFactory.create(db, admin.getIdent(), repo, "Subject", ProjectConfig.PROJECT_CONFIG, config).to(RefNames.REFS_CONFIG); r.assertOkStatus(); }
private com.google.gerrit.extensions.client.SubmitType getSubmitType(com.google.gerrit.server.query.change.ChangeData cd, com.google.gerrit.reviewdb.client.PatchSet patchSet) throws com.google.gwtorm.server.OrmException { com.google.gerrit.common.data.SubmitTypeRecord rec = new com.google.gerrit.server.project.SubmitRuleEvaluator(accountCache, accounts, cd).setPatchSet(patchSet).getSubmitType(); if ((rec.status) != (SubmitTypeRecord.Status.OK)) { throw new com.google.gwtorm.server.OrmException(("Submit type rule failed: " + rec)); } return rec.type; }
public Project.NameKey project() { return project; }
private java.util.Set<java.lang.String> getEmailsByState(com.google.gerrit.server.notedb.ReviewerStateInternal state) { java.util.Set<java.lang.String> reviewers = new java.util.TreeSet<>(); try { for (com.google.gerrit.reviewdb.client.Account.Id who : changeData.reviewers().byState(state)) { reviewers.add(getNameEmailFor(who)); } } catch (com.google.gwtorm.server.OrmException e) { com.google.gerrit.server.mail.send.ChangeEmail.log.warn("Cannot get change reviewers", e); } return reviewers; }
private void beforeTest(org.junit.runner.Description description, boolean memory, boolean enableHttpd) throws java.lang.Exception { org.eclipse.jgit.lib.Config cfg = config(description); server = startServer(cfg, memory, enableHttpd); server.getTestInjector().injectMembers(this); admin = accounts.admin(); user = accounts.user(); adminSession = new com.google.gerrit.acceptance.RestSession(server, admin); userSession = new com.google.gerrit.acceptance.RestSession(server, user); com.google.gerrit.acceptance.GitUtil.initSsh(admin); db = reviewDbProvider.open(); com.google.gerrit.acceptance.AcceptanceTestRequestScope.Context ctx = newRequestContext(admin); atrScope.set(ctx); sshSession = ctx.getSession(); sshSession.open(); resourcePrefix = com.google.gerrit.acceptance.AbstractDaemonTest.UNSAFE_PROJECT_NAME.matcher(((((description.getClassName()) + "_") + (description.getMethodName())) + "_")).replaceAll(""); project = createProject(projectInput(description)); testRepo = com.google.gerrit.acceptance.GitUtil.cloneProject(project, sshSession); }
@java.lang.Override public com.google.gerrit.server.group.GroupJson.GroupInfo apply(com.google.gerrit.server.group.GroupResource resource) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.client.AccountGroup group = resource.toAccountGroup(); if (group == null) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } try { com.google.gerrit.server.account.GroupControl c = controlFactory.validateFor(group.getOwnerGroupUUID()); return json.format(c.getGroup()); } catch (com.google.gerrit.common.errors.NoSuchGroupException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } }
@java.lang.SuppressWarnings("unchecked") @java.lang.Override public void export(com.google.gerrit.extensions.annotations.Export export, java.lang.Class<?> type) throws com.google.gerrit.server.plugins.InvalidPluginException { if (javax.servlet.http.HttpServlet.class.isAssignableFrom(type)) { java.lang.Class<javax.servlet.http.HttpServlet> old = serve.get(export.value()); if (old != null) { throw new com.google.gerrit.server.plugins.InvalidPluginException(java.lang.String.format("@Export(\"%s\") has duplicate bindings:\n %s\n %s", export.value(), old.getName(), type.getName())); } serve.put(export.value(), ((java.lang.Class<javax.servlet.http.HttpServlet>) (type))); } else { throw new com.google.gerrit.server.plugins.InvalidPluginException(java.lang.String.format("Class %s with @Export(\"%s\") must extend %s", type.getName(), export.value(), javax.servlet.http.HttpServlet.class.getName())); } }
@org.junit.Test public void singleHashtag() throws java.lang.Exception { java.lang.String commitMessage = "#Subject\n\nLine 1\n\nLine 2"; assertThat(com.google.gerrit.server.change.HashtagsUtil.extractTags(commitMessage)).containsExactlyElementsIn(com.google.common.collect.Sets.newHashSet("Subject")); }
@java.lang.Override public com.google.gwtorm.server.ResultSet<com.google.gerrit.reviewdb.client.AccountGroupByIdAud> get(java.lang.Iterable<com.google.gerrit.reviewdb.client.AccountGroupByIdAud.Key> keys) { throw new java.lang.UnsupportedOperationException(com.google.gerrit.reviewdb.server.DisallowReadFromGroupsReviewDbWrapper.MSG); }
public com.google.gerrit.common.data.ParameterizedString.Builder replace(final java.lang.String name, final java.lang.String value) { params.put(name, value); return this; }
public static boolean isStale(com.google.gerrit.server.git.GitRepositoryManager repoManager, com.google.gerrit.reviewdb.client.Change.Id id, com.google.gerrit.reviewdb.client.Change indexChange, @com.google.gerrit.common.Nullable com.google.gerrit.reviewdb.client.Change reviewDbChange, com.google.common.collect.SetMultimap<com.google.gerrit.reviewdb.client.Project.NameKey, com.google.gerrit.server.index.change.StalenessChecker.RefState> states, com.google.common.collect.Multimap<com.google.gerrit.reviewdb.client.Project.NameKey, com.google.gerrit.server.index.change.StalenessChecker.RefStatePattern> patterns) { return (com.google.gerrit.server.index.change.StalenessChecker.reviewDbChangeIsStale(indexChange, reviewDbChange)) || (com.google.gerrit.server.index.change.StalenessChecker.refsAreStale(repoManager, id, states, patterns)); }
@java.lang.Override public java.lang.Void call() throws java.lang.Exception { index.replace(new com.google.gerrit.server.query.change.ChangeData(change)); return null; }
@java.lang.Override public void onPreReceive(final org.eclipse.jgit.transport.ReceivePack arg0, final java.util.Collection<org.eclipse.jgit.transport.ReceiveCommand> commands) { parseCommands(commands); if (((newChange) != null) && ((newChange.getResult()) == (org.eclipse.jgit.transport.ReceiveCommand.Result.NOT_ATTEMPTED))) { createNewChanges(); } doReplaces(); }
public java.util.List<com.google.gerrit.server.query.change.QueryResult> queryByStrings(java.util.List<java.lang.String> queryStrings) throws com.google.gerrit.server.query.QueryParseException, com.google.gwtorm.server.OrmException { java.util.List<com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData>> queries = new java.util.ArrayList<>(queryStrings.size()); for (java.lang.String qs : queryStrings) { queries.add(queryBuilder.parse(qs)); } return queryChanges(queries); }
public boolean isVisible(com.google.gerrit.reviewdb.ReviewDb db) throws com.google.gwtorm.client.OrmException { if (((change.getStatus()) == (Change.Status.DRAFT)) && (!(isDraftVisible(db)))) { return false; } return isRefVisible(); }
protected com.google.gerrit.prettify.common.SparseHtmlFile getSparseHtmlFileB(com.google.gerrit.common.data.PatchScript s) { com.google.gerrit.reviewdb.client.AccountDiffPreference dp = new com.google.gerrit.reviewdb.client.AccountDiffPreference(s.getDiffPrefs()); com.google.gerrit.prettify.common.SparseFileContent b = s.getB(); com.google.gerrit.prettify.common.PrettyFormatter f = ClientSideFormatter.FACTORY.get(); f.setDiffPrefs(dp); f.setFileName(b.getPath()); f.setEditFilter(PrettyFormatter.B); f.setEditList(s.getEdits()); if ((s.getA().isWholeFile()) && (!(b.isWholeFile()))) { b = b.apply(s.getA(), s.getEdits()); } f.format(b); return f; }
public static void queryMultiple(final com.google.gwt.user.client.rpc.AsyncCallback<com.google.gwt.core.client.JsArray<com.google.gerrit.client.changes.ChangeList>> callback, java.util.EnumSet<com.google.gerrit.extensions.client.ListChangesOption> options, java.lang.String... queries) { if ((queries.length) == 0) { return; } com.google.gerrit.client.rpc.RestApi call = new com.google.gerrit.client.rpc.RestApi(com.google.gerrit.client.changes.ChangeList.URI); for (java.lang.String q : queries) { call.addParameterRaw("q", com.google.gwtorm.client.KeyUtil.encode(q)); } com.google.gerrit.client.changes.ChangeList.OPTIONS.addAll(options); com.google.gerrit.client.changes.ChangeList.addOptions(call, com.google.gerrit.client.changes.ChangeList.OPTIONS); if ((queries.length) == 1) { call.get(new com.google.gwt.user.client.rpc.AsyncCallback<com.google.gerrit.client.changes.ChangeList>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.changes.ChangeList result) { com.google.gwt.core.client.JsArray<com.google.gerrit.client.changes.ChangeList> wrapped = com.google.gwt.core.client.JsArray.createArray(1).cast(); wrapped.set(0, result); callback.onSuccess(wrapped); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { callback.onFailure(caught); } }); } else { call.get(callback); } }
@org.junit.Test public void listTagsOfNonExistingProjectWithApi() throws java.lang.Exception { exception.expect(com.google.gerrit.extensions.restapi.ResourceNotFoundException.class); gApi.projects().name("does-not-exist").tags().get(); }
private void addChangeImpl(java.lang.String id) throws com.google.gerrit.sshd.commands.UnloggedFailure, com.google.gwtorm.server.OrmException { java.util.List<com.google.gerrit.server.project.ChangeControl> matched = changeFinder.find(id, userProvider.get()); java.util.List<com.google.gerrit.server.project.ChangeControl> toAdd = new java.util.ArrayList(changes.size()); for (com.google.gerrit.server.project.ChangeControl ctl : matched) { if (((!(changes.containsKey(ctl.getId()))) && (inProject(ctl.getProject()))) && (ctl.isVisible(db))) { toAdd.add(ctl); } } switch (toAdd.size()) { case 0 : throw com.google.gerrit.sshd.commands.SetReviewersCommand.error((("\"" + id) + "\" no such change")); case 1 : com.google.gerrit.server.project.ChangeControl ctl = toAdd.get(0); changes.put(ctl.getId(), changesCollection.parse(ctl)); break; default : throw com.google.gerrit.sshd.commands.SetReviewersCommand.error((("\"" + id) + "\" matches multiple changes")); } }
@org.junit.Test public void createdOnIsPopulatedForGroupsCreatedBeforeAudit() throws java.lang.Exception { com.google.gerrit.reviewdb.client.AccountGroup.Id groupId = createGroup("Ancient group for schema migration"); setCreatedOnToVeryOldTimestamp(groupId); removeAuditEntriesFor(groupId); schema151.migrateData(db, new com.google.gerrit.testing.TestUpdateUI()); java.sql.Timestamp createdOn = getCreatedOn(groupId); assertThat(createdOn).isEqualTo(com.google.gerrit.reviewdb.client.AccountGroup.auditCreationInstantTs()); }
private void addMessage(com.google.gerrit.server.update.ChangeContext ctx, com.google.gerrit.server.notedb.ChangeUpdate update) throws com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.client.Change c = ctx.getChange(); com.google.gerrit.reviewdb.client.ChangeMessage cmsg = com.google.gerrit.server.ChangeMessagesUtil.newMessage(ctx, (c.isPrivate() ? "Set private" : "Unset private"), (c.isPrivate() ? com.google.gerrit.server.ChangeMessagesUtil.TAG_SET_PRIVATE : com.google.gerrit.server.ChangeMessagesUtil.TAG_UNSET_PRIVATE)); cmUtil.addChangeMessage(ctx.getDb(), update, cmsg); }
@java.lang.Override protected com.google.gerrit.extensions.restapi.Response<?> applyImpl(com.google.gerrit.server.update.BatchUpdate.Factory updateFactory, com.google.gerrit.server.change.ChangeResource rsrc, com.google.gerrit.extensions.common.Input input) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.permissions.PermissionBackendException, com.google.gerrit.server.update.UpdateException { if (!(com.google.gerrit.server.restapi.change.DeleteChange.isChangeDeletable(rsrc.getChange().getStatus()))) { throw new com.google.gerrit.extensions.restapi.MethodNotAllowedException("delete not permitted"); } rsrc.permissions().database(db).check(ChangePermission.DELETE); try (com.google.gerrit.server.update.BatchUpdate bu = updateFactory.create(db.get(), rsrc.getProject(), rsrc.getUser(), com.google.gerrit.common.TimeUtil.nowTs())) { com.google.gerrit.reviewdb.client.Change.Id id = rsrc.getChange().getId(); bu.setOrder(Order.DB_BEFORE_REPO); bu.addOp(id, opProvider.get()); bu.execute(); } return com.google.gerrit.extensions.restapi.Response.none(); }
public void addDependencies(com.google.gerrit.server.events.ChangeAttribute ca, com.google.gerrit.reviewdb.client.Change change) { ca.dependsOn = new java.util.ArrayList<com.google.gerrit.server.events.DependencyAttribute>(); ca.neededBy = new java.util.ArrayList<com.google.gerrit.server.events.DependencyAttribute>(); try { final com.google.gerrit.reviewdb.server.ReviewDb db = schema.open(); try { final com.google.gerrit.reviewdb.client.PatchSet.Id psId = change.currentPatchSetId(); for (com.google.gerrit.reviewdb.client.PatchSetAncestor a : db.patchSetAncestors().ancestorsOf(psId)) { for (com.google.gerrit.reviewdb.client.PatchSet p : db.patchSets().byRevision(a.getAncestorRevision())) { com.google.gerrit.reviewdb.client.Change c = db.changes().get(p.getId().getParentKey()); ca.dependsOn.add(newDependsOn(c, p)); } } final com.google.gerrit.reviewdb.client.RevId revId = db.patchSets().get(psId).getRevision(); for (com.google.gerrit.reviewdb.client.PatchSetAncestor a : db.patchSetAncestors().descendantsOf(revId)) { final com.google.gerrit.reviewdb.client.PatchSet p = db.patchSets().get(a.getPatchSet()); final com.google.gerrit.reviewdb.client.Change c = db.changes().get(p.getId().getParentKey()); ca.neededBy.add(newNeededBy(c, p)); } } finally { db.close(); } } catch (com.google.gwtorm.server.OrmException e) { } if (ca.dependsOn.isEmpty()) { ca.dependsOn = null; } if (ca.neededBy.isEmpty()) { ca.neededBy = null; } }
static com.google.gerrit.server.patch.EditTransformer.ContextAwareEdit create(java.lang.String oldFilePath, java.lang.String newFilePath, int beginA, int endA, int beginB, int endB, boolean filePathAdjusted) { java.lang.String adjustedOldFilePath = com.google.common.base.MoreObjects.firstNonNull(oldFilePath, newFilePath); boolean implicitRename = (!(java.util.Objects.equals(oldFilePath, newFilePath))) && filePathAdjusted; return new com.google.gerrit.server.patch.AutoValue_EditTransformer_ContextAwareEdit(adjustedOldFilePath, newFilePath, beginA, endA, beginB, endB, implicitRename); }
@java.lang.Override public void start() { if (!(supportAutomaticAccountActivityUpdate)) { return; } long interval = scheduleConfig.getInterval(); long delay = scheduleConfig.getInitialDelay(); if ((delay == (MISSING_CONFIG)) && (interval == (MISSING_CONFIG))) { com.google.gerrit.server.account.AccountDeactivator.log.info("Ignoring missing accountDeactivator schedule configuration"); } else if ((delay < 0) || (interval <= 0)) { com.google.gerrit.server.account.AccountDeactivator.log.warn(java.lang.String.format("Ignoring invalid accountDeactivator schedule configuration: %s", scheduleConfig)); } else { queue.getDefaultQueue().scheduleAtFixedRate(deactivator, delay, interval, java.util.concurrent.TimeUnit.MILLISECONDS); } }
private static org.eclipse.jgit.lib.BaseRepositoryBuilder<?, ?> builder(org.eclipse.jgit.lib.Repository r) { checkNotNull(r); return new org.eclipse.jgit.lib.BaseRepositoryBuilder().setFS(r.getFS()).setGitDir(r.getDirectory()).setWorkTree(r.getWorkTree()).setIndexFile(r.getIndexFile()); }
private void assertCreateGroupBranch(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String expectedErrorOnCreate) throws java.lang.Exception { grant(project, ((com.google.gerrit.reviewdb.client.RefNames.REFS_GROUPS) + "*"), Permission.CREATE, false, com.google.gerrit.acceptance.api.group.REGISTERED_USERS); grant(project, ((com.google.gerrit.reviewdb.client.RefNames.REFS_GROUPS) + "*"), Permission.PUSH, false, com.google.gerrit.acceptance.api.group.REGISTERED_USERS); org.eclipse.jgit.junit.TestRepository<org.eclipse.jgit.internal.storage.dfs.InMemoryRepository> repo = cloneProject(project); com.google.gerrit.acceptance.PushOneCommit.Result r = pushFactory.create(db, admin.getIdent(), repo, "Update group config", GroupConfig.GROUP_CONFIG_FILE, "some content").setParents(com.google.common.collect.ImmutableList.of()).to(((com.google.gerrit.reviewdb.client.RefNames.REFS_GROUPS) + (name("bar")))); if (expectedErrorOnCreate != null) { r.assertErrorStatus(expectedErrorOnCreate); } else { r.assertOkStatus(); } }
public com.google.gerrit.testutil.InMemoryDatabase create() throws com.google.gwtorm.server.OrmException { if (!(created)) { created = true; try (com.google.gerrit.reviewdb.server.ReviewDb c = open()) { schemaCreator.create(c); } catch (java.io.IOException | org.eclipse.jgit.errors.ConfigInvalidException e) { throw new com.google.gwtorm.server.OrmException("Cannot create in-memory database", e); } } return this; }
@java.lang.Override public java.util.Map<java.lang.String, com.google.gitiles.RepositoryDescription> listRepositories(java.lang.String prefix, java.util.Set<java.lang.String> branches) throws java.io.IOException { java.util.Map<java.lang.String, com.google.gitiles.RepositoryDescription> repos = com.google.common.collect.Maps.newTreeMap(com.google.gitiles.DefaultAccess.US_COLLATOR); for (org.eclipse.jgit.lib.Repository repo : scanRepositories(basePath, prefix, req)) { repos.put(getRepositoryName(repo), buildDescription(repo, branches)); repo.close(); } return repos; }
private com.google.gerrit.server.git.strategy.SubmitStrategy createStrategy(com.google.gerrit.extensions.client.SubmitType submitType) throws com.google.gerrit.server.git.MergeException, com.google.gerrit.server.project.NoSuchProjectException { return submitStrategyFactory.create(submitType, db, repo, rw, inserter, canMergeFlag, getAlreadyAccepted(branchTip), destBranch); }
@java.lang.Override public void run() { try (com.google.gerrit.reviewdb.server.ReviewDb db = database.open()) { for (; ;) { java.util.Map.Entry<com.google.gerrit.reviewdb.client.Project.NameKey, java.util.List<com.google.gerrit.reviewdb.client.Change>> next = next(); if (next != null) { try { export(db, next.getKey(), next.getValue()); } catch (com.google.gwtorm.server.OrmException | java.io.IOException e) { stderr.println(e.getMessage()); } } else { break; } } } catch (com.google.gwtorm.server.OrmException e) { stderr.println(e.getMessage()); } finally { monitor.endWorker(); } }
@java.lang.Override public com.google.gerrit.extensions.client.SubmitType testSubmitType(com.google.gerrit.extensions.common.TestSubmitRuleInput in) throws com.google.gerrit.extensions.restapi.RestApiException { try { return testSubmitType.get().apply(revision, in); } catch (com.google.gwtorm.server.OrmException e) { throw new com.google.gerrit.extensions.restapi.RestApiException("Cannot test submit type", e); } }
@java.lang.Override protected org.eclipse.jgit.lfs.server.LargeFileRepository getLargeFileRepository(com.googlesource.gerrit.plugins.lfs.LfsRequest request, java.lang.String path) throws org.eclipse.jgit.lfs.errors.LfsException { java.lang.String pathInfo = (path.startsWith("/")) ? path : "/" + path; java.util.regex.Matcher matcher = com.googlesource.gerrit.plugins.lfs.LfsApiServlet.URL_PATTERN.matcher(pathInfo); if (!(matcher.matches())) { return null; } com.google.gerrit.reviewdb.client.Project.NameKey project = Project.NameKey.parse(com.google.gerrit.common.ProjectUtil.stripGitSuffix(matcher.group(1))); com.google.gerrit.server.project.ProjectState state = projectCache.get(project); if ((state == null) || ((state.getProject().getState()) == (HIDDEN))) { throw new org.eclipse.jgit.lfs.errors.LfsRepositoryNotFound(project.get()); } if ((request.getOperation().equals("upload")) && ((state.getProject().getState()) == (READ_ONLY))) { throw new org.eclipse.jgit.lfs.errors.LfsRepositoryReadOnly(project.get()); } org.eclipse.jgit.lib.Config config = pluginConfigFactory.getProjectPluginConfigWithInheritance(state, pluginName); if (!(config.getBoolean("lfs", "enabled", false))) { return null; } if (request.getOperation().equals("upload")) { long maxObjectSize = config.getLong("lfs", "maxObjectSize", 0); if (maxObjectSize > 0) { for (org.eclipse.jgit.lfs.server.LfsObject object : request.getObjects()) { if ((object.getSize()) > maxObjectSize) { throw new org.eclipse.jgit.lfs.errors.LfsValidationError(java.lang.String.format("size of object %s (%d bytes) exceeds limit (%d bytes)", object.getOid(), object.getSize(), maxObjectSize)); } } } } return getRepository(); }
@java.lang.Override public void onKeyPress(com.google.gwt.event.dom.client.KeyPressEvent event) { if ((event.getNativeEvent().getKeyCode()) == (com.google.gwt.event.dom.client.KeyCodes.KEY_ENTER)) { widget.setEnabled(true); add(); } }
@java.lang.Override public void postUpdate(com.google.gerrit.server.git.BatchUpdate.Context ctx) throws com.google.gwtorm.server.OrmException { assigneeChanged.fire(change, ctx.getAccount(), oldAssignee, ctx.getWhen()); }
private java.lang.Runnable doScroll(final net.codemirror.lib.CodeMirror cm) { return new java.lang.Runnable() { public void run() { if (((cm.getScrollSetAt()) + 5) > (java.lang.System.currentTimeMillis())) { return; } net.codemirror.lib.ScrollInfo si = cm.getScrollInfo(); if (((si.getTop()) == 0) && (!(com.google.gerrit.client.Gerrit.isHeaderVisible()))) { com.google.gerrit.client.Gerrit.setHeaderVisible(true); diffTable.updateFileCommentVisibility(false); } else if (((si.getTop()) > (0.5 * (si.getClientHeight()))) && (com.google.gerrit.client.Gerrit.isHeaderVisible())) { com.google.gerrit.client.Gerrit.setHeaderVisible(false); diffTable.updateFileCommentVisibility(true); } fixScroll(cm); scrollTimerA.cancel(); scrollTimerB.cancel(); (cm == (cmA) ? scrollTimerA : scrollTimerB).schedule(10); } }; }
private void createGroupBranch(com.google.gerrit.reviewdb.client.Project.NameKey project, java.lang.String ref) throws java.io.IOException { try (org.eclipse.jgit.lib.Repository r = repoManager.openRepository(project);org.eclipse.jgit.lib.ObjectInserter oi = r.newObjectInserter();org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(r)) { org.eclipse.jgit.lib.ObjectId emptyTree = oi.insert(Constants.OBJ_TREE, new byte[]{ }); org.eclipse.jgit.lib.PersonIdent ident = new org.eclipse.jgit.lib.PersonIdent(serverIdent.get(), com.google.gerrit.common.TimeUtil.nowTs()); org.eclipse.jgit.lib.CommitBuilder cb = new org.eclipse.jgit.lib.CommitBuilder(); cb.setTreeId(emptyTree); cb.setCommitter(ident); cb.setAuthor(ident); cb.setMessage("Create group"); org.eclipse.jgit.lib.ObjectId emptyCommit = oi.insert(cb); oi.flush(); org.eclipse.jgit.lib.RefUpdate updateRef = r.updateRef(ref); updateRef.setExpectedOldObjectId(org.eclipse.jgit.lib.ObjectId.zeroId()); updateRef.setNewObjectId(emptyCommit); assertThat(updateRef.update(rw)).isEqualTo(RefUpdate.Result.NEW); } }
@java.lang.Override protected void doPost(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse rsp) { this.healthy = true; rsp.setStatus(com.ericsson.gerrit.plugins.highavailability.health.SC_NO_CONTENT); }
@java.lang.Override public void run() throws java.io.IOException { com.google.gerrit.server.index.IndexModule.IndexType type = com.google.gerrit.server.index.IndexModule.IndexType.LUCENE; if ((com.google.gerrit.server.index.IndexModule.IndexType.values().length) > 1) { ui.header("Index"); type = index.select("Type", "type", type); } if (type == (com.google.gerrit.server.index.IndexModule.IndexType.ELASTICSEARCH)) { com.google.gerrit.pgm.init.api.Section elasticsearch = sections.get("elasticsearch", null); elasticsearch.string("Index Prefix", "prefix", "gerrit"); java.lang.String name = ui.readString("default", "Server Name"); com.google.gerrit.pgm.init.api.Section defaultServer = sections.get("elasticsearch", name); defaultServer.select("Transport protocol", "protocol", "http", com.google.common.collect.Sets.newHashSet("http", "https")); defaultServer.string("Hostname", "hostname", "localhost"); defaultServer.string("Port", "port", "9200"); } if (((site.isNew) || (isEmptySite())) && (type == (com.google.gerrit.server.index.IndexModule.IndexType.LUCENE))) { for (com.google.gerrit.server.index.SchemaDefinitions<?> def : com.google.gerrit.server.index.IndexModule.ALL_SCHEMA_DEFS) { com.google.gerrit.server.index.IndexUtils.setReady(site, def.getName(), def.getLatest().getVersion(), true); } } else { if ((com.google.gerrit.server.index.IndexModule.IndexType.values().length) <= 1) { ui.header("Index"); } java.lang.String message = java.lang.String.format(("\nThe index must be %sbuilt before starting Gerrit:\n" + " java -jar gerrit.war reindex -d site_path\n"), (site.isNew ? "" : "re")); ui.message(message); initFlags.autoStart = false; } }
private void initRevisionsAction(com.google.gerrit.client.changes.ChangeInfo info, java.lang.String revision) { int currentPatchSet; if (((info.current_revision()) != null) && (info.revisions().containsKey(info.current_revision()))) { currentPatchSet = info.revision(info.current_revision())._number(); } else { com.google.gwt.core.client.JsArray<com.google.gerrit.client.changes.ChangeInfo.RevisionInfo> revList = info.revisions().values(); com.google.gerrit.client.changes.ChangeInfo.RevisionInfo.sortRevisionInfoByNumber(revList); currentPatchSet = revList.get(((revList.length()) - 1))._number(); } java.lang.String currentlyViewedPatchSet; if (info.revision(revision).id().equals("edit")) { currentlyViewedPatchSet = Resources.M.editPatchSet(com.google.gerrit.client.changes.ChangeInfo.RevisionInfo.findEditParent(info.revisions().values())); currentPatchSet = (info.revisions().values().length()) - 1; } else { currentlyViewedPatchSet = info.revision(revision).id(); } patchSetsText.setInnerText(Resources.M.patchSets(currentlyViewedPatchSet, currentPatchSet)); patchSetsAction = new com.google.gerrit.client.change.PatchSetsAction(info.legacy_id(), revision, style, headerLine, patchSets); }
@java.lang.Override protected void configure() { final com.google.inject.TypeLiteral<com.google.gerrit.server.cache.Cache<com.google.gerrit.reviewdb.ActiveSession.Key, com.google.gerrit.reviewdb.ActiveSession>> type = new com.google.inject.TypeLiteral<com.google.gerrit.server.cache.Cache<com.google.gerrit.reviewdb.ActiveSession.Key, com.google.gerrit.reviewdb.ActiveSession>>() {}; core(type, com.google.gerrit.httpd.WebSession.CACHE_NAME).memoryLimit(1024).maxAge(12, java.util.concurrent.TimeUnit.HOURS).evictionPolicy(EvictionPolicy.LRU); bind(com.google.gerrit.httpd.WebSession.class).in(com.google.inject.servlet.RequestScoped.class); bind(com.google.gerrit.httpd.WebSession.KeyGenerator.class).in(com.google.gerrit.httpd.SINGLETON); }
void resizePaddingWidget() { com.google.gwt.core.client.Scheduler.get().scheduleDeferred(new com.google.gwt.core.client.Scheduler.ScheduledCommand() { public void execute() { if (((selfWidget) == null) || ((widgetManager) == null)) { throw new java.lang.IllegalStateException("resizePaddingWidget() called before setting up widgets"); } selfWidget.changed(); widgetManager.resizePaddingWidget(); } }); }
@java.lang.Override public java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> onCommitReceived(CommitReceivedEvent receiveEvent) throws com.google.gerrit.server.git.validators.CommitValidationException { com.google.gerrit.server.IdentifiedUser user = receiveEvent.user; java.lang.String refname = receiveEvent.refName; org.eclipse.jgit.lib.ObjectId old = org.eclipse.jgit.lib.ObjectId.zeroId(); if ((receiveEvent.commit.getParentCount()) > 0) { old = receiveEvent.commit.getParent(0); } if (receiveEvent.command.getRefName().startsWith(com.googlesource.gerrit.plugins.hooks.REFS_CHANGES)) { refname = refname.replace(com.googlesource.gerrit.plugins.hooks.R_HEADS, "refs/for/refs/heads/"); old = org.eclipse.jgit.lib.ObjectId.zeroId(); } com.googlesource.gerrit.plugins.hooks.HookArgs args = hookFactory.createArgs(); args.add("--project", receiveEvent.project.getName()); args.add("--refname", refname); args.add("--uploader", user.getNameEmail()); args.add("--oldrev", old.name()); args.add("--newrev", receiveEvent.commit.name()); com.googlesource.gerrit.plugins.hooks.HookResult result = hook.run(args); if (result != null) { java.lang.String output = result.toString(); if ((result.getExitValue()) != 0) { throw new com.google.gerrit.server.git.validators.CommitValidationException(output); } if (!(output.isEmpty())) { return com.google.common.collect.ImmutableList.of(new com.google.gerrit.server.git.validators.CommitValidationMessage(output, false)); } } return java.util.Collections.emptyList(); }
private void doClearPassword() { if ((id) != null) { enableUI(false); com.google.gerrit.client.account.AccountApi.clearHttpPassword("self", new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.VoidResult>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.VoidResult result) { id.setPassword(null); display(id); } @java.lang.Override public void onFailure(final java.lang.Throwable caught) { enableUI(true); } }); } }
@java.lang.Override public java.lang.String toString() { if (isError()) { return ((((("Error AccessToken [error=" + (error)) + ", error_description=") + (errorDescription)) + ", error_uri=") + (errorUri)) + "]"; } else { return ((("AccessToken [access_token=" + (accessToken)) + ", token_type=") + (tokenType)) + "]"; } }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<?> apply(com.google.gerrit.server.change.VoteResource rsrc, com.google.gerrit.server.change.DeleteVote.Input input) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.git.UpdateException { com.google.gerrit.server.change.ReviewerResource r = rsrc.getReviewer(); com.google.gerrit.reviewdb.client.Change change = r.getChange(); try (com.google.gerrit.server.git.BatchUpdate bu = batchUpdateFactory.create(db.get(), change.getProject(), r.getControl().getUser(), com.google.gerrit.common.TimeUtil.nowTs())) { bu.addOp(change.getId(), new com.google.gerrit.server.change.DeleteVote.Op(r.getReviewerUser().getAccountId(), rsrc.getLabel())); bu.execute(); } return com.google.gerrit.extensions.restapi.Response.none(); }
private void renderRange(int start, int end, boolean removeAll, boolean insertFirst) { if (insertFirst || removeAll) { startRow = start; top = start * (rowHeight); } if ((!insertFirst) || removeAll) { bottom = ((end - 2) * (rowHeight)) - (maxHeight); } com.google.gwtexpui.safehtml.client.SafeHtmlBuilder sb = new com.google.gwtexpui.safehtml.client.SafeHtmlBuilder(); for (int i = start; i < end; i++) { sb.append(rows.get(i)); } if (removeAll) { body.setInnerSafeHtml(sb); body.getStyle().setTop(top, Style.Unit.PX); } else { surrogate.setInnerSafeHtml(sb); for (int cnt = surrogate.getChildCount(); cnt > 0; cnt--) { fragment.appendChild(surrogate.getFirstChild()); } if (insertFirst) { body.insertFirst(fragment); body.getStyle().setTop(top, Style.Unit.PX); } else { body.appendChild(fragment); } } }
private void fireEventForUnrestrictedListeners(final com.google.gerrit.server.events.Event event) { for (com.google.gerrit.common.EventListener listener : unrestrictedListeners) { listener.onEvent(event); } }
public void setHttpInjector(com.google.inject.Injector injector) { httpModule = copy(injector); httpGen = injector.getProvider(com.google.gerrit.server.plugins.ModuleGenerator.class); httpItems = dynamicItemsOf(injector); httpSets = dynamicSetsOf(injector); httpMaps = dynamicMapsOf(injector); onStart.addAll(com.google.gerrit.server.plugins.PluginGuiceEnvironment.listeners(injector, com.google.gerrit.server.plugins.StartPluginListener.class)); onReload.addAll(com.google.gerrit.server.plugins.PluginGuiceEnvironment.listeners(injector, com.google.gerrit.server.plugins.ReloadPluginListener.class)); }
public AccountResource.SshKey parse(com.google.gerrit.server.IdentifiedUser user, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { try { int seq = java.lang.Integer.parseInt(id.get(), 10); com.google.gerrit.reviewdb.client.AccountSshKey sshKey = authorizedKeys.getKey(user.getAccountId(), seq); if (sshKey == null) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } return new com.google.gerrit.server.account.AccountResource.SshKey(user, sshKey); } catch (java.lang.NumberFormatException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } }
@org.junit.Test public void addReviewerToReviewableChangeByOtherCcingSelfInNoteDbBatch() throws java.lang.Exception { addReviewerToReviewableChangeByOtherCcingSelfInNoteDb(batch()); }
private java.util.Map<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.server.group.MembersCollection.MemberInfo> getMembers(final com.google.gerrit.reviewdb.client.AccountGroup.UUID groupUUID, final java.util.HashSet<com.google.gerrit.reviewdb.client.AccountGroup.UUID> seenGroups) throws com.google.gerrit.common.errors.NoSuchGroupException, com.google.gwtorm.server.OrmException { seenGroups.add(groupUUID); final java.util.Map<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.server.group.MembersCollection.MemberInfo> members = com.google.common.collect.Maps.newHashMap(); final com.google.gerrit.reviewdb.client.AccountGroup group = groupCache.get(groupUUID); if (group == null) { return java.util.Collections.emptyMap(); } final com.google.gerrit.common.data.GroupDetail groupDetail = groupDetailFactory.create(group.getId()).call(); if ((groupDetail.members) != null) { for (final com.google.gerrit.reviewdb.client.AccountGroupMember m : groupDetail.members) { if (!(members.containsKey(m.getAccountId()))) { final com.google.gerrit.reviewdb.client.Account account = accountCache.get(m.getAccountId()).getAccount(); members.put(account.getId(), com.google.gerrit.server.group.MembersCollection.parse(account)); } } } if (recursive) { if ((groupDetail.includes) != null) { for (final com.google.gerrit.reviewdb.client.AccountGroupIncludeByUuid includedGroup : groupDetail.includes) { if (!(seenGroups.contains(includedGroup.getIncludeUUID()))) { members.putAll(getMembers(includedGroup.getIncludeUUID(), seenGroups)); } } } } return members; }
public void doChangeMergedHook(final com.google.gerrit.reviewdb.Change change, final com.google.gerrit.reviewdb.Account account, final com.google.gerrit.reviewdb.PatchSet patchSet) { final com.google.gerrit.common.ChangeHookRunner.ChangeMergedEvent event = new com.google.gerrit.common.ChangeHookRunner.ChangeMergedEvent(); event.change = getChangeAttribute(change); event.submitter = getAccountAttribute(account); event.patchSet = getPatchSetAttribute(patchSet); fireEvent(change, event); final java.util.List<java.lang.String> args = new java.util.ArrayList<java.lang.String>(); args.add(changeMergedHook.getAbsolutePath()); args.add("--change"); args.add(event.change.id); args.add("--change-url"); args.add(event.change.url); args.add("--project"); args.add(event.change.project); args.add("--branch"); args.add(event.change.branch); args.add("--submitter"); args.add(getDisplayName(account)); args.add("--commit"); args.add(event.patchSet.revision); runHook(getRepo(change), args); }
@org.junit.Test public void submitTwoChangesWithFastForward() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result change = createChange(); com.google.gerrit.acceptance.PushOneCommit.Result change2 = createChange(); java.lang.String id1 = change.getChangeId(); java.lang.String id2 = change2.getChangeId(); approve(id1); submit(id2); org.eclipse.jgit.revwalk.RevCommit head = getRemoteHead(); assertThat(head.getId()).isEqualTo(change2.getCommitId()); assertThat(head.getParent(0).getId()).isEqualTo(change.getCommitId()); assertSubmitter(change.getChangeId(), 1); assertSubmitter(change2.getChangeId(), 1); assertPersonEquals(admin.getIdent(), head.getAuthorIdent()); assertPersonEquals(admin.getIdent(), head.getCommitterIdent()); assertSubmittedTogether(id1, id1, id2); assertSubmittedTogether(id2, id1, id2); }
@org.junit.Before public void setup() throws com.google.gerrit.server.project.NoSuchProjectException { when(projectCreated.getProjectNameKey()).thenReturn(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.PROJECT_NAME); when(configFactory.getProjectPluginConfigWithInheritance(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.PROJECT_NAME, com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.PLUGIN)).thenReturn(config); when(remoteFactory.create(eq(config), eq(com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.FOO))).thenReturn(remote); when(taskFactory.create(eq(projectCreated), eq(remote))).thenReturn(postTask); eventHandler = new com.googlesource.gerrit.plugins.webhooks.EventHandler(configFactory, com.googlesource.gerrit.plugins.webhooks.EventHandlerTest.PLUGIN, remoteFactory, taskFactory); }
private java.util.List<com.google.gerrit.common.data.SubmitRecord> cannotSubmitDraft() { try { if (!(control.isDraftVisible(cd.db(), cd))) { return com.google.gerrit.server.project.SubmitRuleEvaluator.createRuleError((("Patch set " + (patchSet.getId())) + " not found")); } else if (patchSet.isDraft()) { return com.google.gerrit.server.project.SubmitRuleEvaluator.createRuleError("Cannot submit draft patch sets"); } else { return com.google.gerrit.server.project.SubmitRuleEvaluator.createRuleError("Cannot submit draft changes"); } } catch (com.google.gwtorm.server.OrmException err) { java.lang.String msg = "Cannot check visibility of patch set " + (patchSet.getId()); com.google.gerrit.server.project.SubmitRuleEvaluator.log.error(msg, err); return com.google.gerrit.server.project.SubmitRuleEvaluator.createRuleError(msg); } }
@java.lang.Override int getCmLine(int line, com.google.gerrit.client.diff.DisplaySide side) { int res = java.util.Collections.binarySearch(chunks, new com.google.gerrit.client.diff.UnifiedDiffChunkInfo(side, line, 0, 0, 0, false)); if (res >= 0) { return chunks.get(res).cmLine; } else { res = (-res) - 1; if (res > 0) { com.google.gerrit.client.diff.UnifiedDiffChunkInfo info = chunks.get((res - 1)); if (((side == (DisplaySide.A)) && (info.edit)) && ((info.side) == (DisplaySide.B))) { com.google.gerrit.client.diff.UnifiedDiffChunkInfo delete = chunks.get((res - 2)); if (line <= (delete.end)) { return ((delete.cmLine) + line) - (delete.start); } else { return (((((delete.cmLine) + line) - (delete.start)) + (info.end)) - (info.start)) + 1; } } else if (side == (info.side)) { return ((info.cmLine) + line) - (info.start); } else { return ((info.cmLine) + (lineMapper.lineOnOther(side, line).getLine())) - (info.start); } } else { return line; } } }
@java.lang.Override public java.lang.String authenticate(com.google.gerrit.server.CurrentUser user, java.util.List<java.lang.String> args) throws com.google.gerrit.sshd.BaseCommand.Failure, com.google.gerrit.sshd.BaseCommand.UnloggedFailure { try { java.net.URL url = new java.net.URL(canonicalWebUrl); java.lang.String path = url.getPath(); java.lang.String project = args.get(0); java.lang.String operation = args.get(1); java.lang.StringBuilder href = new java.lang.StringBuilder(url.getProtocol()).append("://").append(url.getAuthority()).append(path).append((path.endsWith("/") ? "" : "/")).append(project).append("/info/lfs"); com.googlesource.gerrit.plugins.lfs.LfsSshRequestAuthorizer.SshAuthInfo info = auth.generateAuthInfo(user, project, operation); com.googlesource.gerrit.plugins.lfs.ExpiringAction action = new com.googlesource.gerrit.plugins.lfs.ExpiringAction(href.toString(), info); return gson.toJson(action); } catch (java.net.MalformedURLException e) { throw new com.google.gerrit.sshd.BaseCommand.Failure(1, ((("Server configuration error: " + "forming Git LFS endpoint URL from canonicalWebUrl [") + (canonicalWebUrl)) + "] failed.")); } }
@java.lang.SuppressWarnings({ "rawtypes", "unchecked" }) public void execute(java.util.Collection<com.google.gerrit.server.update.BatchUpdate> updates, com.google.gerrit.server.update.BatchUpdateListener listener, @com.google.gerrit.common.Nullable com.google.gerrit.server.util.RequestId requestId, boolean dryRun) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.update.UpdateException { checkNotNull(listener); com.google.gerrit.server.update.BatchUpdate.Factory.checkDifferentProject(updates); if (migration.disableChangeReviewDb()) { com.google.common.collect.ImmutableList<com.google.gerrit.server.update.NoteDbBatchUpdate> noteDbUpdates = ((com.google.common.collect.ImmutableList) (com.google.common.collect.ImmutableList.copyOf(updates))); com.google.gerrit.server.update.NoteDbBatchUpdate.execute(noteDbUpdates, listener, requestId, dryRun); } else { com.google.common.collect.ImmutableList<com.google.gerrit.server.update.ReviewDbBatchUpdate> reviewDbUpdates = ((com.google.common.collect.ImmutableList) (com.google.common.collect.ImmutableList.copyOf(updates))); com.google.gerrit.server.update.ReviewDbBatchUpdate.execute(reviewDbUpdates, listener, requestId, dryRun); } }
public com.google.gerrit.common.data.PermissionRange getRange(java.lang.String permission) { return getRefControl().getRange(permission, isOwner()); }
private static com.google.gerrit.server.query.change.ChangeData.StarsOf create(com.google.gerrit.reviewdb.client.Account.Id accountId, java.lang.Iterable<java.lang.String> stars) { return new com.google.gerrit.server.query.change.AutoValue_ChangeData_StarsOf(accountId, com.google.common.collect.ImmutableSortedSet.copyOf(stars)); }
private com.google.gerrit.server.group.InternalGroup createGroupInReviewDb(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.group.db.InternalGroupCreation groupCreation, com.google.gerrit.server.group.db.InternalGroupUpdate groupUpdate) throws com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.client.AccountGroupName gn = new com.google.gerrit.reviewdb.client.AccountGroupName(groupCreation.getNameKey(), groupCreation.getId()); db.accountGroupNames().insert(com.google.common.collect.ImmutableList.of(gn)); java.sql.Timestamp createdOn = groupUpdate.getUpdatedOn().orElseGet(TimeUtil::nowTs); com.google.gerrit.reviewdb.client.AccountGroup group = com.google.gerrit.server.group.db.GroupsUpdate.createAccountGroup(groupCreation, createdOn); com.google.gerrit.server.group.db.GroupsUpdate.UpdateResult updateResult = updateGroupInReviewDb(db, group, groupUpdate); return com.google.gerrit.server.group.InternalGroup.create(group, updateResult.getAddedMembers(), updateResult.getAddedSubgroups(), updateResult.getRefState()); }
@java.lang.Override public com.google.gerrit.extensions.common.AccountInfo setAssignee(com.google.gerrit.extensions.api.changes.AssigneeInput input) throws com.google.gerrit.extensions.restapi.RestApiException { try { return putAssignee.apply(change, input); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot set assignee", e); } }
@java.lang.Override protected void onLoad() { file.set(id, content); file.setText(fileName); file.setEnabled(fileName.isEmpty()); content.setText(fileContent); save.setEnabled(false); com.google.gwt.core.client.Scheduler.get().scheduleDeferred(new com.google.gwt.core.client.Scheduler.ScheduledCommand() { @java.lang.Override public void execute() { if (fileName.isEmpty()) { file.setFocus(true); } else { content.setFocus(true); } } }); }
@org.junit.Test public void testDefaultSubmitTypeWhenNotConfigured() { assertThat(repoCfg.getDefaultSubmitType(new com.google.gerrit.reviewdb.client.Project.NameKey("someProject"))).isEqualTo(SubmitType.MERGE_IF_NECESSARY); }
protected abstract org.eclipse.jgit.lfs.server.LargeFileRepository getLargeFileRepository(org.eclipse.jgit.lfs.server.LfsGerritProtocolServlet.LfsRequest request, java.lang.String path, java.lang.String auth) throws org.eclipse.jgit.lfs.errors.LfsException;
@org.junit.Test public void testDefaultSubmitTypeForStartWithFilter() { configureDefaultSubmitType("somePath/somePath/*", SubmitType.REBASE_IF_NECESSARY); configureDefaultSubmitType("somePath/*", SubmitType.CHERRY_PICK); configureDefaultSubmitType("*", SubmitType.MERGE_ALWAYS); assertThat(repoCfg.getDefaultSubmitType(new com.google.gerrit.reviewdb.client.Project.NameKey("someProject"))).isEqualTo(SubmitType.MERGE_ALWAYS); assertThat(repoCfg.getDefaultSubmitType(new com.google.gerrit.reviewdb.client.Project.NameKey("somePath/someProject"))).isEqualTo(SubmitType.CHERRY_PICK); assertThat(repoCfg.getDefaultSubmitType(new com.google.gerrit.reviewdb.client.Project.NameKey("somePath/somePath/someProject"))).isEqualTo(SubmitType.REBASE_IF_NECESSARY); }
public java.util.Optional<java.lang.String> label() { return java.util.Optional.ofNullable(label); }
public final native java.lang.String urlAliasToken(java.lang.String n);
@java.lang.Override public void onClick(final com.google.gwt.event.dom.client.ClickEvent event) { closePopup(); }
private void listen(java.lang.reflect.Type type, java.lang.Class<?> clazz) throws com.google.gerrit.server.plugins.InvalidPluginException { while (type != null) { java.lang.Class<?> rawType; if (type instanceof java.lang.reflect.ParameterizedType) { rawType = ((java.lang.Class<?>) (((java.lang.reflect.ParameterizedType) (type)).getRawType())); } else if (type instanceof java.lang.Class) { rawType = ((java.lang.Class<?>) (type)); } else { return; } if ((rawType.getAnnotation(com.google.gerrit.extensions.annotations.ExtensionPoint.class)) != null) { com.google.inject.TypeLiteral<?> tl = com.google.inject.TypeLiteral.get(type); if (env.hasDynamicSet(tl)) { sysSingletons.add(clazz); sysListen.put(tl, clazz); } else if (env.hasDynamicMap(tl)) { if ((clazz.getAnnotation(com.google.gerrit.extensions.annotations.Export.class)) == null) { throw new com.google.gerrit.server.plugins.InvalidPluginException(java.lang.String.format("Class %s requires @Export(\"name\") annotation for %s", clazz.getName(), rawType.getName())); } sysSingletons.add(clazz); sysListen.put(tl, clazz); } else { throw new com.google.gerrit.server.plugins.InvalidPluginException(java.lang.String.format("Cannot register %s, server does not accept %s", clazz.getName(), rawType.getName())); } return; } java.lang.reflect.Type[] interfaces = rawType.getGenericInterfaces(); if (interfaces != null) { for (java.lang.reflect.Type i : interfaces) { listen(i, clazz); } } type = rawType.getGenericSuperclass(); } }
@org.junit.Test public void wrongChangeNumberReturnsNotFound() throws java.lang.Exception { exception.expect(com.google.gerrit.extensions.restapi.ResourceNotFoundException.class); gApi.changes().id(java.lang.Integer.MAX_VALUE); }
private org.eclipse.jgit.revwalk.RevCommit createCommit(org.eclipse.jgit.notes.NoteMap map, org.eclipse.jgit.lib.PersonIdent author, java.lang.String message, org.eclipse.jgit.revwalk.RevCommit... parents) throws java.io.IOException { org.eclipse.jgit.lib.CommitBuilder b = new org.eclipse.jgit.lib.CommitBuilder(); b.setTreeId(map.writeTree(inserter)); b.setAuthor(author); b.setCommitter(gerritIdent); if ((parents.length) > 0) { b.setParentIds(parents); } b.setMessage(message); org.eclipse.jgit.lib.ObjectId commitId = inserter.insert(b); inserter.flush(); return revWalk.parseCommit(commitId); }
private void display(com.google.gerrit.client.info.GeneralPreferences p) { showSiteHeader.setValue(p.showSiteHeader()); useFlashClipboard.setValue(p.useFlashClipboard()); setListBox(maximumPageSize, com.google.gerrit.client.account.DEFAULT_PAGESIZE, p.changesPerPage()); setListBox(dateFormat, GeneralPreferencesInfo.DateFormat.STD, p.dateFormat()); setListBox(timeFormat, GeneralPreferencesInfo.TimeFormat.HHMM_12, p.timeFormat()); relativeDateInChangeTable.setValue(p.relativeDateInChangeTable()); sizeBarInChangeTable.setValue(p.sizeBarInChangeTable()); legacycidInChangeTable.setValue(p.legacycidInChangeTable()); muteCommonPathPrefixes.setValue(p.muteCommonPathPrefixes()); signedOffBy.setValue(p.signedOffBy()); setListBox(reviewCategoryStrategy, GeneralPreferencesInfo.ReviewCategoryStrategy.NONE, p.reviewCategoryStrategy()); setListBox(diffView, GeneralPreferencesInfo.DiffView.SIDE_BY_SIDE, p.diffView()); setListBox(emailStrategy, GeneralPreferencesInfo.EmailStrategy.ENABLED, p.emailStrategy()); display(p.my()); }
void reloadRevisionActions(com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.actions.ActionInfo> actions) { if (!(com.google.gerrit.client.Gerrit.isSignedIn())) { return; } boolean canSubmit = actions.containsKey("submit"); if (canSubmit) { com.google.gerrit.client.actions.ActionInfo action = actions.get("submit"); submit.setTitle(action.title()); submit.setEnabled(action.enabled()); submit.setHTML(new com.google.gwtexpui.safehtml.client.SafeHtmlBuilder().openDiv().append(action.label()).closeDiv()); submit.setEnabled(action.enabled()); } submit.setVisible(canSubmit); com.google.gerrit.client.change.Actions.a2b(actions, "cherrypick", cherrypick); com.google.gerrit.client.change.Actions.a2b(actions, "rebase", rebase); com.google.gerrit.client.changes.ChangeInfo.RevisionInfo revInfo = changeInfo.revision(revision); for (java.lang.String id : com.google.gerrit.client.change.Actions.filterNonCore(actions)) { add(new com.google.gerrit.client.actions.ActionButton(changeInfo, revInfo, actions.get(id))); } }
@java.lang.Override public java.lang.Boolean callImpl(com.google.inject.Provider<com.google.gerrit.reviewdb.server.ReviewDb> db) throws java.lang.Exception { try { if (stalenessChecker.isStale(id)) { index(newChangeData(db.get(), project, id)); return true; } } catch (com.google.gerrit.server.project.NoSuchChangeException e) { com.google.gerrit.server.index.change.ChangeIndexer.log.debug("Change {} was deleted, aborting reindexing the change.", id.get()); } return false; }
protected boolean hasDifferences(com.google.gerrit.common.data.PatchScript script) { return (hasEdits(script)) || (hasMeta(script)); }
public static void submit(final com.google.gerrit.reviewdb.PatchSet.Id patchSetId, final com.google.gerrit.server.IdentifiedUser user, final com.google.gerrit.reviewdb.ReviewDb db, final com.google.gerrit.server.git.MergeOp.Factory opFactory, final com.google.gerrit.server.git.MergeQueue merger) throws com.google.gwtorm.client.OrmException { final com.google.gerrit.reviewdb.Change.Id changeId = patchSetId.getParentKey(); final com.google.gerrit.reviewdb.PatchSetApproval approval = com.google.gerrit.server.ChangeUtil.createSubmitApproval(patchSetId, user, db); db.patchSetApprovals().upsert(java.util.Collections.singleton(approval)); final com.google.gerrit.reviewdb.Change updatedChange = db.changes().atomicUpdate(changeId, new com.google.gwtorm.client.AtomicUpdate<com.google.gerrit.reviewdb.Change>() { @java.lang.Override public com.google.gerrit.reviewdb.Change update(com.google.gerrit.reviewdb.Change change) { if ((change.getStatus()) == (Change.Status.NEW)) { change.setStatus(Change.Status.SUBMITTED); com.google.gerrit.server.ChangeUtil.updated(change); } return change; } }); if ((updatedChange.getStatus()) == (Change.Status.SUBMITTED)) { merger.merge(opFactory, updatedChange.getDest()); } }
private void populatePublishAction() { final com.google.gwt.user.client.ui.Button b = new com.google.gwt.user.client.ui.Button(Util.C.buttonPublishPatchSet()); b.addClickHandler(new com.google.gwt.event.dom.client.ClickHandler() { @java.lang.Override public void onClick(final com.google.gwt.event.dom.client.ClickEvent event) { b.setEnabled(false); final com.google.gerrit.reviewdb.client.Change.Id id = patchSet.getId().getParentKey(); com.google.gerrit.client.changes.ChangeApi.publish(id.get(), patchSet.getRevision().get(), com.google.gerrit.client.change.DraftActions.cs(id)); } }); actionsPanel.add(b); }
private com.google.gerrit.reviewdb.client.Change.Id getOrRegisterAccount(com.google.gerrit.reviewdb.server.ReviewDb db, java.lang.String login, java.lang.String name, java.lang.String email) throws com.google.gerrit.extensions.restapi.BadRequestException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.UnprocessableEntityException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { java.util.Optional<com.google.gerrit.server.account.externalids.ExternalId> gerritId = externalIdByScheme(ExternalId.SCHEME_GERRIT, login); if (gerritId.isPresent()) { return gerritId.get().accountId(); } return accountImporter.importAccount(login, name, email); }
public void assertReviewerDeletedEvents(java.lang.String... expected) { com.google.common.collect.ImmutableList<ReviewerDeletedEvent> events = getReviewerDeletedEvents(((expected.length) / 2)); int i = 0; for (ReviewerDeletedEvent event : events) { java.lang.String id = event.change.get().id; assertThat(id).isEqualTo(expected[i]); java.lang.String reviewer = event.reviewer.get().email; assertThat(reviewer).isEqualTo(expected[(i + 1)]); i += 2; } }
com.google.gerrit.server.patch.FileList getFileList(com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.PatchSet patchSet) throws com.google.gerrit.server.patch.PatchListNotAvailableException;
@org.junit.Test public void testWithAnotherURI() throws java.lang.Exception { com.google.gerrit.reviewdb.client.Project.NameKey p = createProject("a"); org.eclipse.jgit.lib.Config cfg = new org.eclipse.jgit.lib.Config(); cfg.fromText((((("" + (("[submodule \"a\"]\n" + "path = a\n") + "url = http://localhost:80/")) + (p.get())) + "\n") + "branch = master\n")); com.google.gerrit.reviewdb.client.Branch.NameKey targetBranch = new com.google.gerrit.reviewdb.client.Branch.NameKey(new com.google.gerrit.reviewdb.client.Project.NameKey("project"), "master"); java.util.Set<com.google.gerrit.reviewdb.client.SubmoduleSubscription> res = new com.google.gerrit.server.util.SubmoduleSectionParser(cfg, com.google.gerrit.acceptance.git.SubmoduleSectionParserIT.THIS_SERVER, targetBranch).parseAllSections(); java.util.Set<com.google.gerrit.reviewdb.client.SubmoduleSubscription> expected = com.google.common.collect.Sets.newHashSet(new com.google.gerrit.reviewdb.client.SubmoduleSubscription(targetBranch, new com.google.gerrit.reviewdb.client.Branch.NameKey(p, "master"), "a")); assertThat(res).containsExactlyElementsIn(expected); }
@java.lang.Override protected void configure() { bind(new com.google.inject.TypeLiteral<com.google.common.collect.ImmutableSet<com.google.gerrit.common.data.GroupReference>>() {}).annotatedWith(com.google.gerrit.server.config.AdministrateServerGroups.class).toProvider(com.google.gerrit.server.config.AdministrateServerGroupsProvider.class).in(com.google.gerrit.server.project.SINGLETON); bind(new com.google.inject.TypeLiteral<java.util.Set<com.google.gerrit.reviewdb.client.AccountGroup.UUID>>() {}).annotatedWith(com.google.gerrit.server.config.GitUploadPackGroups.class).toProvider(com.google.gerrit.server.config.GitUploadPackGroupsProvider.class).in(com.google.gerrit.server.project.SINGLETON); bind(new com.google.inject.TypeLiteral<java.util.Set<com.google.gerrit.reviewdb.client.AccountGroup.UUID>>() {}).annotatedWith(com.google.gerrit.server.config.GitReceivePackGroups.class).toProvider(com.google.gerrit.server.config.GitReceivePackGroupsProvider.class).in(com.google.gerrit.server.project.SINGLETON); bind(ChangeControl.Factory.class); factory(ProjectControl.AssistedFactory.class); }
com.google.gerrit.httpd.rpc.changedetail.PatchSetDetailFactory create(@com.google.inject.assistedinject.Assisted("psIdBase") @com.google.gerrit.common.Nullable com.google.gerrit.reviewdb.client.PatchSet.Id psIdBase, @com.google.inject.assistedinject.Assisted("psIdNew") com.google.gerrit.reviewdb.client.PatchSet.Id psIdNew, @com.google.gerrit.common.Nullable com.google.gerrit.extensions.client.DiffPreferencesInfo diffPrefs);
public com.google.common.collect.FluentIterable<com.google.gerrit.common.data.WebLinkInfoCommon> getFileHistoryLinksCommon(final java.lang.String project, final java.lang.String revision, final java.lang.String file) { return com.google.common.collect.FluentIterable.from(fileHistoryLinks).transform(new com.google.common.base.Function<com.google.gerrit.extensions.webui.WebLink, com.google.gerrit.common.data.WebLinkInfoCommon>() { @java.lang.Override public com.google.gerrit.common.data.WebLinkInfoCommon apply(com.google.gerrit.extensions.webui.WebLink webLink) { com.google.gerrit.extensions.common.WebLinkInfo info = ((com.google.gerrit.extensions.webui.FileHistoryWebLink) (webLink)).getFileHistoryWebLink(project, revision, file); com.google.gerrit.common.data.WebLinkInfoCommon commonInfo = new com.google.gerrit.common.data.WebLinkInfoCommon(); commonInfo.name = info.name; commonInfo.imageUrl = info.imageUrl; commonInfo.url = info.url; commonInfo.target = info.target; return commonInfo; } }).filter(com.google.gerrit.server.WebLinks.INVALID_WEBLINK_COMMON); }
java.lang.String removeHashtag(java.lang.String name);
public void assertCanDelete(com.google.gerrit.server.project.ProjectResource rsrc, com.googlesource.gerrit.plugins.deleteproject.DeleteProject.Input input) throws com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gwtorm.server.OrmException { try { pcHandler.assertCanDelete(rsrc); dbHandler.assertCanDelete(rsrc.getControl().getProject()); fsHandler.assertCanDelete(rsrc, (input == null ? false : input.preserve)); } catch (com.googlesource.gerrit.plugins.deleteproject.CannotDeleteProjectException e) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException(e.getMessage()); } }
static void initialize(org.eclipse.jgit.lib.Config cfg) { cfg.setString(com.googlesource.gerrit.plugins.xdocs.XDocGlobalConfig.SECTION_FORMATTER, AsciidoctorFormatter.NAME, com.googlesource.gerrit.plugins.xdocs.XDocGlobalConfig.KEY_EXT, "adoc"); cfg.setString(com.googlesource.gerrit.plugins.xdocs.XDocGlobalConfig.SECTION_FORMATTER, MarkdownFormatter.NAME, com.googlesource.gerrit.plugins.xdocs.XDocGlobalConfig.KEY_MIME_TYPE, "text/x-markdown"); cfg.setString(com.googlesource.gerrit.plugins.xdocs.XDocGlobalConfig.SECTION_FORMATTER, PlainTextFormatter.NAME, com.googlesource.gerrit.plugins.xdocs.XDocGlobalConfig.KEY_MIME_TYPE, "text/plain"); }
private static void onRemove(com.google.gwt.dom.client.NativeEvent event) { java.lang.String hashtags = com.google.gerrit.client.change.Hashtags.getDataId(event); if (hashtags != null) { final com.google.gerrit.client.change.ChangeScreen screen = com.google.gerrit.client.change.ChangeScreen.get(event); final com.google.gerrit.reviewdb.client.PatchSet.Id psId = screen.getPatchSetId(); com.google.gerrit.client.changes.ChangeApi.hashtags(screen.getProject().get(), psId.getParentKey().get()).post(com.google.gerrit.client.change.Hashtags.PostInput.create(null, hashtags), new com.google.gerrit.client.rpc.GerritCallback<com.google.gwt.core.client.JavaScriptObject>() { @java.lang.Override public void onSuccess(com.google.gwt.core.client.JavaScriptObject result) { if (screen.isCurrentView()) { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(screen.getProject(), psId)); } } }); } }
static com.google.gerrit.server.project.PermissionCollection.SeenRule create(com.google.gerrit.common.data.AccessSection section, com.google.gerrit.common.data.Permission permission, @com.google.gerrit.common.Nullable com.google.gerrit.common.data.PermissionRule rule) { com.google.gerrit.reviewdb.client.AccountGroup.UUID group = ((rule != null) && ((rule.getGroup()) != null)) ? rule.getGroup().getUUID() : null; return new com.google.gerrit.server.project.AutoValue_PermissionCollection_SeenRule(section.getName(), permission.getName(), group); }
static com.google.gerrit.acceptance.GerritServer.Description forTestMethod(org.junit.runner.Description testDesc, java.lang.String configName) { return new com.google.gerrit.acceptance.AutoValue_GerritServer_Description(configName, ((testDesc.getAnnotation(com.google.gerrit.acceptance.UseLocalDisk.class)) == null), (((testDesc.getAnnotation(com.google.gerrit.acceptance.NoHttpd.class)) == null) && ((testDesc.getTestClass().getAnnotation(com.google.gerrit.acceptance.NoHttpd.class)) == null)), testDesc.getAnnotation(com.google.gerrit.acceptance.GerritConfig.class), testDesc.getAnnotation(com.google.gerrit.acceptance.GerritConfigs.class)); }
private void testGetGroup(java.lang.String url, com.google.gerrit.reviewdb.client.AccountGroup expectedGroup) throws java.io.IOException { com.google.gerrit.acceptance.RestResponse r = session.get(url); com.google.gerrit.server.group.GroupJson.GroupInfo group = newGson().fromJson(r.getReader(), com.google.gerrit.server.group.GroupJson.GroupInfo.class); com.google.gerrit.acceptance.rest.group.GroupAssert.assertGroupInfo(expectedGroup, group); }
private void setMissingHeader(final java.util.Map<java.lang.String, com.google.gerrit.server.mail.EmailHeader> hdrs, final java.lang.String name, final java.lang.String value) { if ((!(hdrs.containsKey(name))) || (hdrs.get(name).isEmpty())) { hdrs.put(name, new com.google.gerrit.server.mail.EmailHeader.String(value)); } }
public static void saveInlineComments() { final com.google.gerrit.client.change.LocalComments.StorageBackend storage = new com.google.gerrit.client.change.LocalComments.StorageBackend(); for (java.lang.String cookie : storage.getKeys()) { if (com.google.gerrit.client.change.LocalComments.isInlineComment(cookie)) { com.google.gerrit.client.change.LocalComments.InlineComment input = com.google.gerrit.client.change.LocalComments.getInlineComment(cookie); if ((input.commentInfo.id()) == null) { com.google.gerrit.client.changes.CommentApi.createDraft(Project.NameKey.asStringOrNull(input.project), input.psId, input.commentInfo, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.changes.CommentInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.changes.CommentInfo result) { storage.removeItem(cookie); } }); } else { com.google.gerrit.client.changes.CommentApi.updateDraft(Project.NameKey.asStringOrNull(input.project), input.psId, input.commentInfo.id(), input.commentInfo, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.changes.CommentInfo>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.changes.CommentInfo result) { storage.removeItem(cookie); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { if (com.google.gerrit.client.rpc.RestApi.isNotFound(caught)) { storage.removeItem(cookie); } else { super.onFailure(caught); } } }); } } } }
private GroupBundle.Builder newBundle() { com.google.gerrit.reviewdb.client.AccountGroup group = new com.google.gerrit.reviewdb.client.AccountGroup(new com.google.gerrit.reviewdb.client.AccountGroup.NameKey("group"), new com.google.gerrit.reviewdb.client.AccountGroup.Id(1), new com.google.gerrit.reviewdb.client.AccountGroup.UUID("group-1"), ts); com.google.gerrit.reviewdb.client.AccountGroupMember member = new com.google.gerrit.reviewdb.client.AccountGroupMember(new com.google.gerrit.reviewdb.client.AccountGroupMember.Key(new com.google.gerrit.reviewdb.client.Account.Id(1000), group.getId())); com.google.gerrit.reviewdb.client.AccountGroupMemberAudit memberAudit = new com.google.gerrit.reviewdb.client.AccountGroupMemberAudit(member, new com.google.gerrit.reviewdb.client.Account.Id(2000), ts); com.google.gerrit.reviewdb.client.AccountGroupById byId = new com.google.gerrit.reviewdb.client.AccountGroupById(new com.google.gerrit.reviewdb.client.AccountGroupById.Key(group.getId(), new com.google.gerrit.reviewdb.client.AccountGroup.UUID("subgroup"))); com.google.gerrit.reviewdb.client.AccountGroupByIdAud byIdAudit = new com.google.gerrit.reviewdb.client.AccountGroupByIdAud(byId, new com.google.gerrit.reviewdb.client.Account.Id(3000), ts); return com.google.gerrit.server.group.db.GroupBundle.builder().group(group).members(member).memberAudit(memberAudit).byId(byId).byIdAudit(byIdAudit); }
@java.lang.Override public boolean allowsEdit(final com.google.gerrit.reviewdb.client.Account.FieldName field) { if ((authConfig.getAuthType()) == (com.google.gerrit.reviewdb.client.AuthType.HTTP)) { switch (field) { case USER_NAME : return false; case FULL_NAME : return (com.google.common.base.Strings.emptyToNull(authConfig.getHttpDisplaynameHeader())) == null; case REGISTER_NEW_EMAIL : return (emailSettings.allowRegisterNewEmail) && ((com.google.common.base.Strings.emptyToNull(authConfig.getHttpEmailHeader())) == null); default : return true; } } else { switch (field) { case REGISTER_NEW_EMAIL : return emailSettings.allowRegisterNewEmail; default : return true; } } }
@java.lang.Override public T set(int index, T element) { T old = this.get(index); this.set0(index, element); return old; }
@org.junit.Before public void setUp() throws java.lang.Exception { lifecycle = new com.google.gerrit.lifecycle.LifecycleManager(); com.google.gerrit.testutil.InMemoryModule.createInjector(lifecycle).injectMembers(this); lifecycle.start(); }
private boolean isSecure(javax.servlet.http.HttpServletRequest req) { return (req.isSecure()) || ("https".equals(req.getScheme())); }
@org.junit.Test public void testUSERNoAllowDomain() { setFrom("USER"); setDomains(java.util.Arrays.asList("example.com")); final java.lang.String name = "A U. Thor"; final java.lang.String email = "a.u.thor@test.com"; final com.google.gerrit.reviewdb.client.Account.Id user = user(name, email); replay(accountCache); final com.google.gerrit.server.mail.Address r = create().from(user); assertThat(r).isNotNull(); assertThat(r.name).isEqualTo((name + " (Code Review)")); assertThat(r.email).isEqualTo(ident.getEmailAddress()); verify(accountCache); }
@org.junit.Test public void defaultGroupsCreated_internals() throws java.lang.Exception { java.util.Set<java.lang.String> names = com.google.common.collect.Sets.newHashSet(); for (com.google.gerrit.reviewdb.client.AccountGroup g : db.accountGroups().all()) { names.add(g.getName()); } assertThat(((java.lang.Iterable<?>) (names))).contains("Administrators"); assertThat(((java.lang.Iterable<?>) (names))).contains("Non-Interactive Users"); }
@java.lang.Override public com.google.gerrit.server.project.DashboardResource parse(com.google.gerrit.server.project.ProjectResource parent, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gerrit.server.permissions.PermissionBackendException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { com.google.gerrit.server.project.ProjectControl myCtl = parent.getControl(); if (com.google.gerrit.server.project.DashboardsCollection.isDefaultDashboard(id)) { return com.google.gerrit.server.project.DashboardResource.projectDefault(myCtl); } java.util.List<java.lang.String> parts = com.google.common.collect.Lists.newArrayList(com.google.common.base.Splitter.on(':').limit(2).split(id.get())); if ((parts.size()) != 2) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } com.google.gerrit.server.CurrentUser user = myCtl.getUser(); java.lang.String ref = parts.get(0); java.lang.String path = parts.get(1); for (com.google.gerrit.server.project.ProjectState ps : myCtl.getProjectState().tree()) { try { return parse(ps.controlFor(user), ref, path, myCtl); } catch (org.eclipse.jgit.errors.AmbiguousObjectException | org.eclipse.jgit.errors.ConfigInvalidException | org.eclipse.jgit.errors.IncorrectObjectTypeException e) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } catch (com.google.gerrit.extensions.restapi.ResourceNotFoundException e) { continue; } } throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); }
@org.junit.Test public void revert() throws com.google.gerrit.extensions.restapi.RestApiException, java.io.IOException, org.eclipse.jgit.api.errors.GitAPIException { com.google.gerrit.acceptance.PushOneCommit.Result r = createChange(); gApi.changes().id(("p~master~" + (r.getChangeId()))).revision(r.getCommit().name()).review(com.google.gerrit.extensions.api.changes.ReviewInput.approve()); gApi.changes().id(("p~master~" + (r.getChangeId()))).revision(r.getCommit().name()).submit(); gApi.changes().id(("p~master~" + (r.getChangeId()))).revert(); }
public com.google.gerrit.server.project.ProjectState checkedGet(com.google.gerrit.reviewdb.client.Project.NameKey projectName) throws java.io.IOException;
private java.util.Map<java.lang.String, org.eclipse.jgit.lib.Ref> getDraftRefs(com.google.gerrit.reviewdb.client.Change.Id changeId) throws com.google.gwtorm.server.OrmException { try (org.eclipse.jgit.lib.Repository repo = repoManager.openMetadataRepository(allUsers)) { return getDraftRefs(repo, changeId); } catch (java.io.IOException e) { throw new com.google.gwtorm.server.OrmException(e); } }
@java.lang.Override public com.google.gerrit.server.project.ProjectState get(final com.google.gerrit.reviewdb.client.Project.NameKey projectName) { try { return checkedGet(projectName); } catch (java.io.IOException e) { return null; } }
public void add(com.google.gerrit.extensions.registration.RegistrationHandle handle) { if (handle instanceof com.google.gerrit.extensions.registration.ReloadableRegistrationHandle) { if ((reloadableHandles) == null) { reloadableHandles = com.google.common.collect.Lists.newArrayList(); } reloadableHandles.add(((com.google.gerrit.extensions.registration.ReloadableRegistrationHandle<?>) (handle))); } manager.add(handle); }
@java.lang.Override public com.google.gerrit.reviewdb.client.AccountGroupMemberAudit get(com.google.gerrit.reviewdb.client.AccountGroupMemberAudit.Key key) { throw new java.lang.UnsupportedOperationException(com.google.gerrit.reviewdb.server.DisallowReadFromGroupsReviewDbWrapper.MSG); }
@java.lang.Override protected void onLoad() throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { revision = getRevision(); keys = com.google.gerrit.server.account.AuthorizedKeys.parse(accountId, readUTF8(AuthorizedKeys.FILE_NAME)); }
public com.google.gerrit.server.project.RefFilter<T> start(int start) { this.start = start; return this; }
@org.junit.Test public void listProjectsWithBranch() throws com.jcraft.jsch.JSchException, java.io.IOException { com.google.gerrit.acceptance.RestResponse r = GET("/projects/?b=master"); assertEquals(HttpStatus.SC_OK, r.getStatusCode()); java.util.Map<java.lang.String, com.google.gerrit.extensions.common.ProjectInfo> result = com.google.gerrit.acceptance.rest.project.ListProjectsIT.toProjectInfoMap(r); assertNotNull(result.get(project.get())); assertNotNull(result.get(project.get()).branches); assertEquals(1, result.get(project.get()).branches.size()); assertNotNull(result.get(project.get()).branches.get("master")); }
public static java.util.List<java.lang.String> getNames() { java.util.List<java.lang.String> names = new java.util.ArrayList<>(); for (com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid : com.google.gerrit.server.group.SystemGroupBackend.all) { int c = uuid.get().indexOf(':'); names.add(uuid.get().substring((c + 1)).replace('-', ' ')); } return names; }
private void assertRefs(java.lang.String... expectedWithMeta) throws java.lang.Exception { try (org.eclipse.jgit.lib.Repository repo = repoManager.openRepository(project)) { assertRefs(repo, new com.google.gerrit.server.git.VisibleRefFilter(tagCache, notesFactory, changeCache, repo, projectControl(), new com.google.gerrit.testutil.DisabledReviewDb(), true), true, expectedWithMeta); } }
private void setMerged(final com.google.gerrit.reviewdb.client.Change c, final com.google.gerrit.reviewdb.client.ChangeMessage msg) throws com.google.gwtorm.server.OrmException { try { db.changes().beginTransaction(c.getId()); com.google.gerrit.server.git.CodeReviewCommit commit = commits.get(c.getId()); com.google.gerrit.reviewdb.client.PatchSet.Id merged = commit.change.currentPatchSetId(); setMergedPatchSet(c.getId(), merged); com.google.gerrit.reviewdb.client.PatchSetApproval submitter = saveApprovals(c, merged); addMergedMessage(submitter, msg); db.commit(); sendMergedEmail(c, submitter); if (submitter != null) { try { hooks.doChangeMergedHook(c, accountCache.get(submitter.getAccountId()).getAccount(), db.patchSets().get(c.currentPatchSetId()), db); } catch (com.google.gwtorm.server.OrmException ex) { com.google.gerrit.server.git.MergeOp.log.error(("Cannot run hook for submitted patch set " + (c.getId())), ex); } } } finally { db.rollback(); } }
boolean match(java.lang.String refName) { return regex().matcher(refName).find(); }
@java.lang.Override public java.lang.String apply(com.google.gerrit.server.change.RevisionResource resource) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.BadRequestException, com.google.gwtorm.server.OrmException { return test.apply(resource, null); }
@org.junit.Test public void revertChangeByOwnerInNoteDb() throws java.lang.Exception { assume().that(notesMigration.readChanges()).isTrue(); com.google.gerrit.acceptance.server.mail.StagedChange sc = stageChange(); revert(sc, sc.owner); assertThat(sender).sent("newchange", sc).to(sc.reviewer, sc.watchingProjectOwner, admin).cc(sc.ccer).bcc(com.google.gerrit.acceptance.server.mail.NEW_CHANGES, com.google.gerrit.acceptance.server.mail.NEW_PATCHSETS).noOneElse(); assertThat(sender).sent("revert", sc).cc(sc.reviewer, sc.ccer, admin).bcc(com.google.gerrit.acceptance.server.mail.ALL_COMMENTS).noOneElse(); }
@java.lang.Override public com.google.gerrit.extensions.restapi.RestView<com.google.gerrit.server.project.ProjectResource> list() throws com.google.gerrit.extensions.restapi.ResourceNotFoundException { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); }
private void populateDiffAllActions(final com.google.gerrit.common.data.PatchSetDetail detail) { final com.google.gwt.user.client.ui.Button diffAllSideBySide = new com.google.gwt.user.client.ui.Button(Util.C.buttonDiffAllSideBySide()); diffAllSideBySide.addClickHandler(new com.google.gwt.event.dom.client.ClickHandler() { @java.lang.Override public void onClick(com.google.gwt.event.dom.client.ClickEvent event) { for (com.google.gerrit.reviewdb.Patch p : detail.getPatches()) { openWindow(com.google.gerrit.client.Dispatcher.toPatchSideBySide(diffBaseId, p.getKey())); } } }); actionsPanel.add(diffAllSideBySide); final com.google.gwt.user.client.ui.Button diffAllUnified = new com.google.gwt.user.client.ui.Button(Util.C.buttonDiffAllUnified()); diffAllUnified.addClickHandler(new com.google.gwt.event.dom.client.ClickHandler() { @java.lang.Override public void onClick(com.google.gwt.event.dom.client.ClickEvent event) { for (com.google.gerrit.reviewdb.Patch p : detail.getPatches()) { openWindow(com.google.gerrit.client.Dispatcher.toPatchUnified(diffBaseId, p.getKey())); } } }); actionsPanel.add(diffAllUnified); }
@com.google.gwtjsonrpc.common.HostPageCache(name = "gerrit_hostpagedata", once = true) void load(com.google.gwtjsonrpc.common.AsyncCallback<com.google.gerrit.common.data.HostPageData> callback);
public T load() throws com.google.gwtorm.server.OrmException { if (loaded) { return self(); } if ((!(args.migration.enabled())) || ((changeId) == null)) { loadDefaults(); return self(); } try (com.google.gerrit.metrics.Timer1.Context timer = args.metrics.readLatency.start(com.google.gerrit.server.notedb.NoteDbTable.CHANGES);org.eclipse.jgit.lib.Repository repo = args.repoManager.openMetadataRepository(getProjectName());org.eclipse.jgit.revwalk.RevWalk walk = new org.eclipse.jgit.revwalk.RevWalk(repo)) { org.eclipse.jgit.lib.Ref ref = repo.getRefDatabase().exactRef(getRefName()); org.eclipse.jgit.lib.ObjectId id = (ref != null) ? ref.getObjectId() : null; revision = (id != null) ? walk.parseCommit(id).copy() : null; onLoad(walk); loaded = true; } catch (org.eclipse.jgit.errors.ConfigInvalidException | java.io.IOException e) { throw new com.google.gwtorm.server.OrmException(e); } return self(); }
public com.googlesource.gerrit.plugins.reviewers.ReviewersConfig.ForProject forProject(com.google.gerrit.reviewdb.client.Project.NameKey projectName) { org.eclipse.jgit.lib.Config cfg; try { cfg = cfgFactory.getProjectPluginConfigWithInheritance(projectName, pluginName); } catch (com.google.gerrit.server.project.NoSuchProjectException e) { com.googlesource.gerrit.plugins.reviewers.ReviewersConfig.log.error("Unable to get config for project {}", projectName.get()); cfg = new org.eclipse.jgit.lib.Config(); } return new com.googlesource.gerrit.plugins.reviewers.ReviewersConfig.ForProject(cfg); }
private boolean isPatchSetMerged(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx, com.google.gerrit.reviewdb.client.PatchSet patchSet) throws java.io.IOException { org.eclipse.jgit.lib.Repository repository = ctx.getRepository(); org.eclipse.jgit.lib.Ref destinationRef = repository.exactRef(ctx.getChange().getDest().get()); if (destinationRef == null) { return false; } org.eclipse.jgit.revwalk.RevWalk revWalk = ctx.getRevWalk(); org.eclipse.jgit.lib.ObjectId objectId = org.eclipse.jgit.lib.ObjectId.fromString(patchSet.getRevision().get()); org.eclipse.jgit.revwalk.RevCommit revCommit = revWalk.parseCommit(objectId); return com.google.gerrit.server.change.IncludedInResolver.includedInOne(repository, revWalk, revCommit, java.util.Collections.singletonList(destinationRef)); }
@org.junit.Test public void getVersion() throws java.lang.Exception { assertThat(gApi.config().server().getVersion()).isEqualTo(com.google.gerrit.common.Version.getVersion()); }
private <T extends com.google.gerrit.extensions.api.changes.ReviewInput.CommentInput> void checkComments(com.google.gerrit.server.change.RevisionResource revision, java.util.Map<java.lang.String, java.util.List<T>> commentsPerPath) throws com.google.gerrit.extensions.restapi.BadRequestException, com.google.gerrit.server.diff.PatchListNotAvailableException { java.util.Set<java.lang.String> revisionFilePaths = getAffectedFilePaths(revision); for (java.util.Map.Entry<java.lang.String, java.util.List<T>> entry : commentsPerPath.entrySet()) { java.lang.String path = entry.getKey(); com.google.gerrit.reviewdb.client.PatchSet.Id patchSetId = revision.getChange().currentPatchSetId(); com.google.gerrit.server.change.PostReview.ensurePathRefersToAvailableOrMagicFile(path, revisionFilePaths, patchSetId); java.util.List<T> comments = entry.getValue(); for (T comment : comments) { com.google.gerrit.server.change.PostReview.ensureLineIsNonNegative(comment.line, path); com.google.gerrit.server.change.PostReview.ensureCommentNotOnMagicFilesOfAutoMerge(path, comment); com.google.gerrit.server.change.PostReview.ensureRangeIsValid(path, comment.range); } } }
private org.eclipse.jgit.lib.Ref findMergedInto(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx, java.lang.String first, org.eclipse.jgit.revwalk.RevCommit commit) { try { java.util.Map<java.lang.String, org.eclipse.jgit.lib.Ref> all = ctx.getRepository().getRefDatabase().getRefs(com.google.gerrit.server.git.ALL); org.eclipse.jgit.lib.Ref firstRef = all.get(first); if ((firstRef != null) && (com.google.gerrit.server.git.ReplaceOp.isMergedInto(ctx.getRevWalk(), commit, firstRef))) { return firstRef; } for (org.eclipse.jgit.lib.Ref ref : all.values()) { if (com.google.gerrit.server.git.ReplaceOp.isBranch(ref)) { if (com.google.gerrit.server.git.ReplaceOp.isMergedInto(ctx.getRevWalk(), commit, ref)) { return ref; } } } return null; } catch (java.io.IOException e) { com.google.gerrit.server.git.ReplaceOp.log.warn("Can't check for already submitted change", e); return null; } }
public org.bouncycastle.openpgp.PGPPublicKeyRing get(byte[] fingerprint) throws java.io.IOException, org.bouncycastle.openpgp.PGPException { java.util.List<org.bouncycastle.openpgp.PGPPublicKeyRing> keyRings = get(com.google.gerrit.gpg.Fingerprint.getId(fingerprint), fingerprint); return !(keyRings.isEmpty()) ? keyRings.get(0) : null; }
public java.io.Reader get(java.lang.String endPoint) throws java.io.IOException { org.apache.http.client.methods.HttpGet get = new org.apache.http.client.methods.HttpGet(("http://localhost:8080/a" + endPoint)); org.apache.http.HttpResponse response = getClient().execute(get); java.io.Reader reader = new java.io.InputStreamReader(response.getEntity().getContent()); reader.skip(JSON_MAGIC.length); return reader; }
@org.junit.Test public void createDraft() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result r = createChange(); java.lang.String changeId = r.getChangeId(); java.lang.String revId = r.getCommit().getName(); com.google.gerrit.extensions.api.changes.ReviewInput.CommentInput comment = newCommentInfo("file1", Comment.Side.REVISION, 1, "comment 1"); addDraft(changeId, revId, comment); java.util.Map<java.lang.String, java.util.List<com.google.gerrit.extensions.common.CommentInfo>> result = getDraftComments(changeId, revId); assertThat(result).hasSize(1); com.google.gerrit.extensions.common.CommentInfo actual = com.google.common.collect.Iterables.getOnlyElement(result.get(comment.path)); com.google.gerrit.acceptance.server.change.CommentsIT.assertCommentInfo(comment, actual); }
public static boolean isDefaultDashboard(@com.google.gerrit.common.Nullable java.lang.String id) { return com.google.gerrit.server.project.DashboardsCollection.DEFAULT_DASHBOARD_NAME.equals(id); }
@java.lang.Override public java.lang.Void get(long timeout, java.util.concurrent.TimeUnit unit) throws java.lang.InterruptedException, java.util.concurrent.ExecutionException, java.util.concurrent.TimeoutException { if (!(isDone())) { nrtManager.waitForGeneration(gen, timeout, unit); set(null); } return super.get(timeout, unit); }
@java.lang.Override public java.util.Collection<com.google.gerrit.common.data.GroupReference> suggest(java.lang.String name) { java.util.Set<com.google.gerrit.common.data.GroupReference> groups = com.google.common.collect.Sets.newTreeSet(com.google.gerrit.server.account.GroupBackends.GROUP_REF_NAME_COMPARATOR); for (com.google.gerrit.server.account.GroupBackend g : backends) { groups.addAll(g.suggest(name)); } return groups; }
public static void sortRevisionInfoByNumber(com.google.gwt.core.client.JsArray<com.google.gerrit.client.changes.ChangeInfo.RevisionInfo> list) { java.util.Collections.sort(com.google.gerrit.client.rpc.Natives.asList(list), new java.util.Comparator<com.google.gerrit.client.changes.ChangeInfo.RevisionInfo>() { @java.lang.Override public int compare(com.google.gerrit.client.changes.ChangeInfo.RevisionInfo a, com.google.gerrit.client.changes.ChangeInfo.RevisionInfo b) { return (a._number()) - (b._number()); } }); }
public com.google.gerrit.reviewdb.client.Account find(java.lang.String nameOrEmail) throws com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { java.util.Set<com.google.gerrit.reviewdb.client.Account.Id> r = findAll(nameOrEmail); if ((r.size()) == 1) { return byId.maybeGet(r.iterator().next()).map(AccountState::getAccount).orElse(null); } com.google.gerrit.reviewdb.client.Account match = null; for (com.google.gerrit.reviewdb.client.Account.Id id : r) { java.util.Optional<com.google.gerrit.reviewdb.client.Account> account = byId.maybeGet(id).map(AccountState::getAccount); if (!(account.map(Account::isActive).orElse(false))) { continue; } if (match != null) { return null; } match = account.get(); } return match; }
@java.lang.Override protected void setUp() throws java.lang.Exception { super.setUp(); idA = org.eclipse.jgit.lib.ObjectId.fromString("df84c2f4f7ce7e0b25cdeac84b8870bcff319885"); name = new com.google.gerrit.reviewdb.Project.NameKey("test"); realDb = createBareRepository(); mockDb = createStrictMock(org.eclipse.jgit.lib.Repository.class); pc = createStrictMock(com.google.gerrit.server.project.ProjectControl.class); pcf = createStrictMock(ProjectControl.Factory.class); grm = createStrictMock(com.google.gerrit.server.git.GitRepositoryManager.class); }
public static org.eclipse.jgit.lib.CommitBuilder rebaseCommit(org.eclipse.jgit.lib.Repository git, org.eclipse.jgit.revwalk.RevCommit original, org.eclipse.jgit.revwalk.RevCommit base, org.eclipse.jgit.lib.PersonIdent committerIdent) throws java.io.IOException { if ((original.getParentCount()) == 0) { throw new java.io.IOException("Commits with no parents cannot be rebased (is this the initial commit?)."); } if ((original.getParentCount()) > 1) { throw new java.io.IOException((("Patch sets with multiple parents cannot be rebased (merge commits)." + " Parents: ") + (java.util.Arrays.toString(original.getParents())))); } final org.eclipse.jgit.revwalk.RevCommit parentCommit = original.getParent(0); if (base.equals(parentCommit)) { throw new java.io.IOException("Change is already up to date."); } final org.eclipse.jgit.merge.ThreeWayMerger merger = MergeStrategy.RESOLVE.newMerger(git, true); merger.setBase(parentCommit); merger.merge(original, base); if ((merger.getResultTreeId()) == null) { throw new java.io.IOException("The rebase failed since conflicts occured during the merge."); } final org.eclipse.jgit.lib.CommitBuilder rebasedCommitBuilder = new org.eclipse.jgit.lib.CommitBuilder(); rebasedCommitBuilder.setTreeId(merger.getResultTreeId()); rebasedCommitBuilder.setParentId(base); rebasedCommitBuilder.setAuthor(original.getAuthorIdent()); rebasedCommitBuilder.setMessage(original.getFullMessage()); rebasedCommitBuilder.setCommitter(committerIdent); return rebasedCommitBuilder; }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<java.lang.String> apply(com.google.gerrit.server.account.AccountResource rsrc, com.google.gerrit.server.account.PutHttpPassword.Input input) throws com.google.gerrit.extensions.restapi.AuthException, com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException { if (input == null) { input = new com.google.gerrit.server.account.PutHttpPassword.Input(); } input.httpPassword = com.google.common.base.Strings.emptyToNull(input.httpPassword); java.lang.String newPassword; if (input.generate) { if (((self.get()) != (rsrc.getUser())) && (!(self.get().getCapabilities().canGenerateHttpPassword()))) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed to generate HTTP password"); } newPassword = com.google.gerrit.server.account.PutHttpPassword.generate(); } else if ((input.httpPassword) == null) { if (((self.get()) != (rsrc.getUser())) && (!(self.get().getCapabilities().canGenerateHttpPassword()))) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed to clear HTTP password"); } newPassword = null; } else { if (!(self.get().getCapabilities().canGenerateHttpPassword())) { throw new com.google.gerrit.extensions.restapi.AuthException(("not allowed to set HTTP password directly, " + "requires the Generate HTTP Password permission")); } newPassword = input.httpPassword; } return apply(rsrc.getUser(), newPassword); }
@java.lang.Override public com.google.gerrit.server.notedb.NoteDbChangeState rebuild(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.reviewdb.client.Change.Id changeId) throws com.google.gwtorm.server.OrmException { return null; }
private void init() { final org.eclipse.jgit.lib.Config cfg = new org.eclipse.jgit.lib.Config(); try { cfg.fromText(com.google.gerrit.pgm.init.Libraries.read(com.google.gerrit.pgm.init.Libraries.RESOURCE_FILE)); } catch (java.io.IOException e) { throw new java.lang.RuntimeException(e.getMessage(), e); } catch (org.eclipse.jgit.errors.ConfigInvalidException e) { throw new java.lang.RuntimeException(e.getMessage(), e); } for (java.lang.reflect.Field f : com.google.gerrit.pgm.init.Libraries.class.getDeclaredFields()) { if ((((f.getModifiers()) & (java.lang.reflect.Modifier.STATIC)) == 0) && ((f.getType()) == (com.google.gerrit.pgm.init.LibraryDownloader.class))) { try { f.set(this, downloadProvider.get()); } catch (java.lang.IllegalArgumentException e) { throw new java.lang.IllegalStateException(("Cannot initialize " + (f.getName()))); } catch (java.lang.IllegalAccessException e) { throw new java.lang.IllegalStateException(("Cannot initialize " + (f.getName()))); } } } for (java.lang.reflect.Field f : com.google.gerrit.pgm.init.Libraries.class.getDeclaredFields()) { if ((((f.getModifiers()) & (java.lang.reflect.Modifier.STATIC)) == 0) && ((f.getType()) == (com.google.gerrit.pgm.init.LibraryDownloader.class))) { try { init(f, cfg); } catch (java.lang.IllegalArgumentException e) { throw new java.lang.IllegalStateException(("Cannot configure " + (f.getName()))); } catch (java.lang.IllegalAccessException e) { throw new java.lang.IllegalStateException(("Cannot configure " + (f.getName()))); } catch (java.lang.NoSuchFieldException e) { throw new java.lang.IllegalStateException(("Cannot configure " + (f.getName()))); } catch (java.lang.SecurityException e) { throw new java.lang.IllegalStateException(("Cannot configure " + (f.getName()))); } } } }
@java.lang.SuppressWarnings("deprecation") @com.google.common.annotations.VisibleForTesting static org.eclipse.jgit.lib.ObjectId getNoteKey(com.google.gerrit.reviewdb.client.AccountGroup.NameKey groupName) { return org.eclipse.jgit.lib.ObjectId.fromRaw(com.google.common.hash.Hashing.sha1().hashString(groupName.get(), java.nio.charset.StandardCharsets.UTF_8).asBytes()); }
public void displayPopup() { poppingUp = true; if (firstPopupLoad) { match = ""; query = new com.google.gerrit.client.ui.ProjectListPopup.Query(match).run(); } else { popup.setPopupPositionAndShow(popupPosition); com.google.gwtexpui.globalkey.client.GlobalKey.dialog(popup); try { com.google.gwtexpui.globalkey.client.GlobalKey.addApplication(popup, new com.google.gwtexpui.globalkey.client.HidePopupPanelCommand(0, com.google.gwt.event.dom.client.KeyCodes.KEY_ESCAPE, popup)); } catch (java.lang.Throwable e) { } projectsTab.setRegisterKeys(true); projectsTab.finishDisplay(); filterTxt.setFocus(true); poppingUp = false; } }
public void removeApproval(java.lang.String label) { removeApprovalFor(getAccountId(), label); }
@org.junit.Test public void testPersonByNameAge() throws java.lang.Exception { com.google.gwtorm.nosql.IndexFunction<com.google.gwtorm.data.Person> idx = index("nameAge", "WHERE name=? AND age=?"); org.junit.Assert.assertEquals("nameAge", idx.getName()); com.google.gwtorm.nosql.IndexKeyBuilder b; com.google.gwtorm.data.Person p; b = new com.google.gwtorm.nosql.IndexKeyBuilder(); p = new com.google.gwtorm.data.Person(new com.google.gwtorm.data.Person.Key("hm"), 42); assertTrue(idx.includes(p)); idx.encode(b, p); com.google.gwtorm.nosql.IndexFunctionTest.assertEqualToBuilderResult(new byte[]{ 'h', 'm', 0, 1, 1, 42 }, b); p = new com.google.gwtorm.data.Person(new com.google.gwtorm.data.Person.Key(null), 0); assertFalse(idx.includes(p)); }
public static com.google.gerrit.server.notedb.NotesMigration allEnabled() { return new com.google.gerrit.server.notedb.NotesMigration(com.google.gerrit.server.notedb.NotesMigration.allEnabledConfig()); }
@java.lang.Override public java.lang.Void call() throws java.lang.Exception { try { final com.google.gerrit.reviewdb.server.ReviewDb db = schemaFactory.open(); try { context.setContext(new com.google.gerrit.server.util.RequestContext() { @java.lang.Override public com.google.inject.Provider<com.google.gerrit.reviewdb.server.ReviewDb> getReviewDbProvider() { return com.google.inject.util.Providers.of(db); } @java.lang.Override public com.google.gerrit.server.CurrentUser getCurrentUser() { throw new com.google.inject.OutOfScopeException("No user during ChangeIndexer"); } }); index.replace(cd); return null; } finally { context.setContext(null); db.close(); } } catch (java.lang.Exception e) { com.google.gerrit.server.index.ChangeIndexerImpl.log.error(java.lang.String.format("Failed to index change %d in %s", cd.getId().get(), cd.getChange().getProject().get()), e); throw e; } }
@java.lang.Override public void run() { if (!(listeners.iterator().hasNext())) { return; } try { com.googlesource.gerrit.plugins.quota.Publisher.UsageDataEvent repoSizeEvent = createRepoSizeEvent(); com.googlesource.gerrit.plugins.quota.Publisher.UsageDataEvent pushCountEvent = createEvent(com.googlesource.gerrit.plugins.quota.Publisher.PUSH_COUNT, numberOfPushesCache); com.googlesource.gerrit.plugins.quota.Publisher.UsageDataEvent fetchCountEvent = createEvent(com.googlesource.gerrit.plugins.quota.Publisher.FETCH_COUNT, numberOfFetchesCache); for (com.google.gerrit.extensions.events.UsageDataPublishedListener l : listeners) { try { l.onUsageDataPublished(repoSizeEvent); l.onUsageDataPublished(pushCountEvent); l.onUsageDataPublished(fetchCountEvent); } catch (java.lang.RuntimeException e) { com.googlesource.gerrit.plugins.quota.Publisher.log.warn("Failure in UsageDataPublishedListener", e); } } } catch (java.util.concurrent.ExecutionException e) { com.googlesource.gerrit.plugins.quota.Publisher.log.warn("Error creating RepoSizeEvent", e); } }
@java.lang.Override public void setUserAccountId(com.google.gerrit.reviewdb.client.Account.Id id) { key = new com.google.gerrit.httpd.WebSessionManager.Key(("id:" + id)); val = new com.google.gerrit.httpd.WebSessionManager.Val(id, 0, false, null, 0, null); }
static com.google.gerrit.extensions.common.GpgKeyInfo toJson(org.bouncycastle.openpgp.PGPPublicKeyRing keyRing, com.google.gerrit.gpg.PublicKeyChecker checker, com.google.gerrit.gpg.PublicKeyStore store) throws java.io.IOException { org.bouncycastle.openpgp.PGPPublicKey key = keyRing.getPublicKey(); com.google.gerrit.extensions.common.GpgKeyInfo info = new com.google.gerrit.extensions.common.GpgKeyInfo(); info.id = com.google.gerrit.gpg.PublicKeyStore.keyIdToString(key.getKeyID()); info.fingerprint = com.google.gerrit.gpg.Fingerprint.toString(key.getFingerprint()); @java.lang.SuppressWarnings("unchecked") java.util.Iterator<java.lang.String> userIds = key.getUserIDs(); info.userIds = com.google.common.collect.ImmutableList.copyOf(userIds); try (java.io.ByteArrayOutputStream out = new java.io.ByteArrayOutputStream(4096);org.bouncycastle.bcpg.ArmoredOutputStream aout = new org.bouncycastle.bcpg.ArmoredOutputStream(out)) { key.encode(aout); info.key = new java.lang.String(out.toByteArray(), java.nio.charset.StandardCharsets.UTF_8); } com.google.gerrit.gpg.CheckResult checkResult = checker.check(key, store); info.status = checkResult.getStatus(); info.problems = checkResult.getProblems(); return info; }
public final void copyTo(com.google.gerrit.extensions.client.EditPreferencesInfo p) { p.tabSize = tabSize(); p.lineLength = lineLength(); p.hideTopMenu = hideTopMenu(); p.showTabs = showTabs(); p.showWhitespaceErrors = showWhitespaceErrors(); p.syntaxHighlighting = syntaxHighlighting(); p.hideLineNumbers = hideLineNumbers(); p.theme = theme(); }
public com.google.gerrit.server.account.AuthResult link(com.google.gerrit.reviewdb.client.Account.Id to, com.google.gerrit.server.account.AuthRequest who) throws com.google.gerrit.server.account.AccountException, com.google.gwtorm.server.OrmException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { try (com.google.gerrit.reviewdb.server.ReviewDb db = schema.open()) { com.google.gerrit.server.account.ExternalId extId = findExternalId(who.getExternalIdKey()); if (extId != null) { if (!(extId.accountId().equals(to))) { throw new com.google.gerrit.server.account.AccountException("Identity in use by another account"); } update(db, who, extId); } else { externalIdsUpdateFactory.create().insert(db, com.google.gerrit.server.account.ExternalId.createWithEmail(who.getExternalIdKey(), to, who.getEmailAddress())); if ((who.getEmailAddress()) != null) { com.google.gerrit.reviewdb.client.Account a = db.accounts().get(to); if ((a.getPreferredEmail()) == null) { a.setPreferredEmail(who.getEmailAddress()); db.accounts().update(java.util.Collections.singleton(a)); } } if ((who.getEmailAddress()) != null) { byEmailCache.evict(who.getEmailAddress()); } byIdCache.evict(to); } return new com.google.gerrit.server.account.AuthResult(to, who.getExternalIdKey(), false); } }
private void scanProjects(final java.io.File dir, final java.lang.String prefix, final java.util.SortedSet<com.google.gerrit.reviewdb.Project.NameKey> names) { final java.io.File[] ls = dir.listFiles(); if (ls == null) { return; } for (java.io.File f : ls) { java.lang.String fileName = f.getName(); if (org.eclipse.jgit.lib.RepositoryCache.FileKey.isGitRepository(f, FS.DETECTED)) { java.lang.String projectName; if (fileName.equals(Constants.DOT_GIT)) { projectName = prefix.substring(0, ((prefix.length()) - 1)); } else if (fileName.endsWith(Constants.DOT_GIT_EXT)) { int newLen = (fileName.length()) - (Constants.DOT_GIT_EXT.length()); projectName = prefix + (fileName.substring(0, newLen)); } else { projectName = prefix + fileName; } com.google.gerrit.reviewdb.Project.NameKey nameKey = new com.google.gerrit.reviewdb.Project.NameKey(projectName); if (isUnreasonableName(nameKey)) { com.google.gerrit.server.git.LocalDiskRepositoryManager.log.warn(("Ignoring unreasonably named repository " + (f.getAbsolutePath()))); } else { names.add(nameKey); } } else if (f.isDirectory()) { scanProjects(f, ((prefix + (f.getName())) + "/"), names); } } }
@org.junit.Test public void preflightBadMethod() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result change = createChange(); for (java.lang.String method : new java.lang.String[]{ "POST", "PUT", "DELETE", "PATCH" }) { org.apache.http.client.fluent.Request req = org.apache.http.client.fluent.Request.Options(((((adminRestSession.url()) + "/a/changes/") + (change.getChangeId())) + "/detail")); req.addHeader(com.google.gerrit.acceptance.rest.change.ORIGIN, "http://example.com"); req.addHeader(com.google.gerrit.acceptance.rest.change.ACCESS_CONTROL_REQUEST_METHOD, method); adminRestSession.execute(req).assertBadRequest(); } }
@org.junit.Test public void createDuplicateInternalGroupCaseSensitiveName_Conflict() throws java.lang.Exception { java.lang.String dupGroupName = name("dupGroup"); gApi.groups().create(dupGroupName); exception.expect(com.google.gerrit.extensions.restapi.ResourceConflictException.class); exception.expectMessage((("group '" + dupGroupName) + "' already exists")); gApi.groups().create(dupGroupName); }
@java.lang.Override public void start() { try (com.google.gerrit.reviewdb.server.ReviewDb db = schema.open()) { final com.google.gerrit.reviewdb.client.CurrentSchemaVersion currentVer = getSchemaVersion(db); final int expectedVer = com.google.gerrit.server.schema.SchemaVersion.getBinaryVersion(); if (currentVer == null) { throw new com.google.inject.ProvisionException((("Schema not yet initialized." + (" Run init to initialize the schema:\n" + "$ java -jar gerrit.war init -d ")) + (site.site_path.toAbsolutePath()))); } if ((currentVer.versionNbr) < expectedVer) { throw new com.google.inject.ProvisionException((((((((("Unsupported schema version " + (currentVer.versionNbr)) + "; expected schema version ") + expectedVer) + ". Run init to upgrade:\n") + "$ java -jar ") + (site.gerrit_war.toAbsolutePath())) + " init -d ") + (site.site_path.toAbsolutePath()))); } else if ((currentVer.versionNbr) > expectedVer) { throw new com.google.inject.ProvisionException((((("Unsupported schema version " + (currentVer.versionNbr)) + "; expected schema version ") + expectedVer) + ". Downgrade is not supported.")); } } catch (com.google.gwtorm.server.OrmException e) { throw new com.google.inject.ProvisionException("Cannot read schema_version", e); } }
protected java.lang.String soyHtmlTemplate(java.lang.String name) { return soyTemplate(name, SanitizedContent.ContentKind.HTML); }
@java.lang.Override public com.google.gerrit.extensions.api.changes.ChangeApi create(com.google.gerrit.extensions.common.ChangeInput in) throws com.google.gerrit.extensions.restapi.RestApiException { try { com.google.gerrit.extensions.common.ChangeInfo out = createChange.apply(TopLevelResource.INSTANCE, in).value(); return api.create(changes.parse(new com.google.gerrit.reviewdb.client.Change.Id(out._number))); } catch (com.google.gwtorm.server.OrmException | java.io.IOException | com.google.gerrit.server.project.InvalidChangeOperationException | com.google.gerrit.server.update.UpdateException | com.google.gerrit.server.permissions.PermissionBackendException e) { throw new com.google.gerrit.extensions.restapi.RestApiException("Cannot create change", e); } }
@java.lang.Override protected void configure() { bind(new com.google.inject.TypeLiteral<com.google.common.base.Optional<com.ericsson.gerrit.plugins.highavailability.peers.PeerInfo>>() {}).toProvider(com.ericsson.gerrit.plugins.highavailability.peers.PeerInfoProvider.class); if ((strategy) == (Configuration.PeerInfoStrategy.JGROUPS)) { listener().to(com.ericsson.gerrit.plugins.highavailability.peers.jgroups.JGroupsPeerInfoProvider.class); } }
@java.lang.Override public java.util.List<com.google.gerrit.extensions.common.AccountExternalIdInfo> apply(com.google.gerrit.server.account.AccountResource resource) throws com.google.gerrit.extensions.restapi.RestApiException { if ((self.get()) != (resource.getUser())) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed to get external IDs"); } java.util.Collection<com.google.gerrit.reviewdb.client.AccountExternalId> ids = externalIdCache.byAccount(resource.getUser().getAccountId()); if (ids.isEmpty()) { return com.google.common.collect.ImmutableList.of(); } java.util.List<com.google.gerrit.extensions.common.AccountExternalIdInfo> result = com.google.common.collect.Lists.newArrayListWithCapacity(ids.size()); for (com.google.gerrit.reviewdb.client.AccountExternalId id : ids) { com.google.gerrit.extensions.common.AccountExternalIdInfo info = new com.google.gerrit.extensions.common.AccountExternalIdInfo(); info.identity = id.getExternalId(); info.emailAddress = id.getEmailAddress(); info.trusted = authConfig.isIdentityTrustable(java.util.Collections.singleton(id)); if (id.isScheme(com.google.gerrit.server.account.SCHEME_USERNAME)) { info.canDelete = false; } else { com.google.gerrit.server.CurrentUser.PropertyKey<com.google.gerrit.reviewdb.client.AccountExternalId.Key> k = CurrentUser.PropertyKey.create(); com.google.gerrit.reviewdb.client.AccountExternalId.Key last = resource.getUser().get(k); info.canDelete = (last != null) && (!(last.get().equals(info.identity))); } result.add(info); } return result; }
private boolean isMember(com.google.gerrit.reviewdb.client.AccountGroup parent, com.google.gerrit.common.data.GroupDescription.Basic member) throws com.google.gwtorm.server.OrmException { return groups.isIncluded(dbProvider.get(), parent.getId(), member.getGroupUUID()); }
@org.junit.Test public void systemGroupsCreated_rest() throws java.io.IOException { com.google.gerrit.acceptance.RestSession session = new com.google.gerrit.acceptance.RestSession(server, admin); com.google.gerrit.acceptance.RestResponse r = session.get("/groups/"); com.google.gson.Gson gson = new com.google.gson.Gson(); java.util.Map<java.lang.String, com.google.gerrit.acceptance.rest.group.GroupInfo> result = gson.fromJson(r.getReader(), new com.google.gson.reflect.TypeToken<java.util.Map<java.lang.String, com.google.gerrit.acceptance.rest.group.GroupInfo>>() {}.getType()); java.util.Set<java.lang.String> names = result.keySet(); assertTrue(names.contains("Administrators")); assertTrue(names.contains("Anonymous Users")); assertTrue(names.contains("Change Owner")); assertTrue(names.contains("Non-Interactive Users")); assertTrue(names.contains("Project Owners")); assertTrue(names.contains("Registered Users")); }
@java.lang.SuppressWarnings("deprecation") @org.junit.Test public void createGroupWithProperties() throws java.lang.Exception { com.google.gerrit.extensions.api.groups.GroupInput in = new com.google.gerrit.extensions.api.groups.GroupInput(); in.name = name("newGroup"); in.description = "Test description"; in.visibleToAll = true; in.ownerId = getFromCache("Administrators").getGroupUUID().get(); com.google.gerrit.extensions.common.GroupInfo g = gApi.groups().create(in).detail(); assertThat(g.description).isEqualTo(in.description); assertThat(g.options.visibleToAll).isEqualTo(in.visibleToAll); assertThat(g.ownerId).isEqualTo(in.ownerId); if (groupsInNoteDb()) { assertGroupOwnerPermissions(g.id, in.ownerId); } }
private com.google.gerrit.extensions.api.changes.NotifyHandling defaultNotify(com.google.gerrit.server.project.ChangeControl control) { return control.getChange().hasReviewStarted() ? com.google.gerrit.extensions.api.changes.NotifyHandling.ALL : com.google.gerrit.extensions.api.changes.NotifyHandling.OWNER; }
@org.junit.Test @com.google.gerrit.acceptance.TestProjectInput(createEmptyCommit = false) public void submitToEmptyRepo() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result change = createChange(); submit(change.getChangeId()); assertThat(getRemoteHead().getId()).isEqualTo(change.getCommitId()); }
private java.util.List<com.google.gerrit.server.notedb.ChangeNotes> changeFromNotesFactory(java.lang.String id) throws com.google.gerrit.sshd.BaseCommand.UnloggedFailure, com.google.gwtorm.server.OrmException { return changeNotesFactory.create(db, parseId(id)); }
@com.google.gwtorm.client.Relation com.google.gerrit.reviewdb.AccountGroupIncludeAccess accountGroupIncludes();
@java.lang.Override public Iterable<java.lang.String> get(com.google.gerrit.server.account.AccountState input, com.google.gerrit.server.index.account.FillArgs args) { java.lang.String fullName = input.getAccount().getFullName(); Set<java.lang.String> parts = com.google.gerrit.server.index.SchemaUtil.getPersonParts(fullName, com.google.common.collect.Iterables.transform(input.getExternalIds(), new Function<com.google.gerrit.reviewdb.client.AccountExternalId, java.lang.String>() { @java.lang.Override public java.lang.String apply(com.google.gerrit.reviewdb.client.AccountExternalId in) { return in.getEmailAddress(); } })); if (fullName != null) { parts.add(fullName); } return parts; }
private int inheritedMax(com.google.gerrit.server.git.ProjectConfig config, com.google.gerrit.server.schema.Schema_53.OldRefRight old) { int max = 0; java.lang.String ref = old.ref_pattern; java.lang.String category = old.category; com.google.gerrit.reviewdb.AccountGroup.UUID group = old.group.getUUID(); com.google.gerrit.reviewdb.Project.NameKey project = config.getProject().getParent(); if (project == null) { project = systemConfig.wildProjectName; } do { java.util.List<com.google.gerrit.server.schema.Schema_53.OldRefRight> rights = rightsByProject.get(project); if (rights != null) { for (com.google.gerrit.server.schema.Schema_53.OldRefRight r : rights) { if (((r.ref_pattern.equals(ref)) && (r.group.getUUID().equals(group))) && (r.category.equals(category))) { max = java.lang.Math.max(max, r.max_value); break; } } } project = parentsByProject.get(project); } while (!(project.equals(systemConfig.wildProjectName)) ); return max; }
private java.lang.String createErrorMessage(java.lang.String header, com.google.gerrit.reviewdb.client.Account.Id me, com.google.common.collect.ImmutableList<java.lang.String> descriptions) { java.lang.StringBuilder message = new java.lang.StringBuilder(header); message.append(" "); message.append(me); message.append("/"); message.append(getUserName(me).orElse(null)); message.append(": "); message.append(com.google.common.base.Joiner.on("; ").join(descriptions)); return message.toString(); }
public void testChangeRefReplicated() throws com.google.gwtorm.server.OrmException, java.net.URISyntaxException { com.google.gerrit.reviewdb.client.Change expectedChange = new com.google.gerrit.reviewdb.client.Change(null, null, null, null, null); reset(changeAccessMock); expect(changeAccessMock.get(anyObject(Change.Id.class))).andReturn(expectedChange); replay(changeAccessMock); reset(changeHooksMock); com.googlesource.gerrit.plugins.replication.RefReplicatedEvent expectedEvent = new com.googlesource.gerrit.plugins.replication.RefReplicatedEvent("someProject", "refs/changes/01/1/1", "someHost", com.googlesource.gerrit.plugins.replication.ReplicationState.RefPushResult.FAILED); changeHooksMock.postEvent(eq(expectedChange), com.googlesource.gerrit.plugins.replication.RefReplicatedEventEquals.eqEvent(expectedEvent), anyObject(com.google.gerrit.reviewdb.server.ReviewDb.class)); expectLastCall().once(); replay(changeHooksMock); gitUpdateProcessing.onRefReplicatedToOneNode("someProject", "refs/changes/01/1/1", new org.eclipse.jgit.transport.URIish("git://someHost/someProject.git"), RefPushResult.FAILED); verify(changeHooksMock); }
public java.lang.String getStyleName() { return style; }
@java.lang.Override protected void onLoad() { super.onLoad(); com.google.gerrit.client.account.AccountApi.getAgreements("self", new com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gwt.core.client.JsArray<com.google.gerrit.client.account.AgreementInfo>>(this) { @java.lang.Override public void preDisplay(com.google.gwt.core.client.JsArray<com.google.gerrit.client.account.AgreementInfo> result) { agreements.display(com.google.gerrit.client.rpc.Natives.asList(result)); } }); }
@java.lang.Override protected void configure() { bind(com.google.gerrit.server.index.ChangeIndex.class).to(com.google.gerrit.lucene.LuceneChangeIndex.class); bind(com.google.gerrit.server.index.ChangeIndexer.class).to(com.google.gerrit.server.index.ChangeIndexerImpl.class); listener().to(com.google.gerrit.lucene.LuceneChangeIndex.class); if (checkVersion) { listener().to(com.google.gerrit.lucene.IndexVersionCheck.class); } }
private static <T> com.google.common.collect.ImmutableSet<T> logIfNotUnique(com.google.gerrit.server.group.db.GroupBundle.Source source, com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid, java.lang.Iterable<T> iterable, java.util.Comparator<T> comparator, java.lang.Class<T> clazz) { java.util.List<T> list = com.google.common.collect.Streams.stream(iterable).sorted(comparator).collect(java.util.stream.Collectors.toList()); com.google.common.collect.ImmutableSet<T> set = com.google.common.collect.ImmutableSet.copyOf(list); if ((set.size()) != (list.size())) { com.google.gerrit.server.group.db.GroupBundle.log.warn("group {} in {} has duplicate {} entities: {}", uuid, source, clazz.getSimpleName(), iterable); } return set; }
private void addSuggestion(java.util.Map map, com.google.gerrit.reviewdb.Account account, com.google.gerrit.common.data.AccountInfo info, java.lang.Boolean active) { if ((active == null) || (active == (account.isActive()))) { map.put(account.getId(), info); } }
public static com.google.gerrit.client.rpc.RestApi edit(@com.google.gerrit.common.Nullable java.lang.String project, int id) { return com.google.gerrit.client.changes.ChangeApi.change(project, id).view("edit"); }
private void doSave() { project.setDescription(descTxt.getText().trim()); project.setUseContributorAgreements(useContributorAgreements.getValue()); project.setUseSignedOffBy(useSignedOffBy.getValue()); project.setUseContentMerge(useContentMerge.getValue()); project.setRequireChangeID(requireChangeID.getValue()); if ((submitType.getSelectedIndex()) >= 0) { project.setSubmitType(Project.SubmitType.valueOf(submitType.getValue(submitType.getSelectedIndex()))); } enableForm(false, false, false); Util.PROJECT_SVC.changeProjectSettings(project, new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.common.data.ProjectDetail>() { public void onSuccess(final com.google.gerrit.common.data.ProjectDetail result) { enableForm(result.canModifyAgreements, result.canModifyDescription, result.canModifyMergeType); display(result); } }); }
@java.lang.Override public org.eclipse.jgit.lib.Repository createRepository(com.google.gerrit.reviewdb.client.Project.NameKey name) throws com.google.gerrit.server.git.RepositoryCaseMismatchException, org.eclipse.jgit.errors.RepositoryNotFoundException { org.eclipse.jgit.lib.Repository repo = createRepository(getBasePath(name), name); if ((notesMigration.writeChanges()) && (!(noteDbPath.equals(basePath)))) { createRepository(noteDbPath, name); } return repo; }
public org.eclipse.jgit.lib.PersonIdent newCommitterIdent(final java.util.Date when, final java.util.TimeZone tz) { final com.google.gerrit.reviewdb.Account ua = getAccount(); java.lang.String name = ua.getFullName(); java.lang.String email = ua.getPreferredEmail(); if ((email == null) || (email.isEmpty())) { java.lang.String user = getUserName(); if ((user == null) || (user.isEmpty())) { user = "account-" + (ua.getId().toString()); } java.lang.String host; if ((canonicalUrl.get()) != null) { try { host = new java.net.URL(canonicalUrl.get()).getHost(); } catch (java.net.MalformedURLException e) { host = org.eclipse.jgit.util.SystemReader.getInstance().getHostname(); } } else { host = org.eclipse.jgit.util.SystemReader.getInstance().getHostname(); } email = (user + "@") + host; } if ((name == null) || (name.isEmpty())) { final int at = email.indexOf('@'); if (0 < at) { name = email.substring(0, at); } else { name = "Anonymous Coward"; } } return new org.eclipse.jgit.lib.PersonIdent(name, email, when, tz); }
void showUpdates(com.google.gerrit.client.info.ChangeInfo newInfo) { if ((!(isAttached())) || (newInfo.updated().equals(lastDisplayedUpdate))) { return; } com.google.gwt.core.client.JsArray<com.google.gerrit.client.info.ChangeInfo.MessageInfo> om = changeInfo.messages(); com.google.gwt.core.client.JsArray<com.google.gerrit.client.info.ChangeInfo.MessageInfo> nm = newInfo.messages(); if (om == null) { om = com.google.gwt.core.client.JsArray.createArray().cast(); } if (nm == null) { nm = com.google.gwt.core.client.JsArray.createArray().cast(); } if ((om.length()) == (nm.length())) { return; } if ((updateAvailable) == null) { updateAvailable = new com.google.gerrit.client.change.UpdateAvailableBar() { @java.lang.Override void onShow() { com.google.gerrit.client.Gerrit.display(com.google.gerrit.common.PageLinks.toChange(project, changeId)); } @java.lang.Override void onIgnore(java.sql.Timestamp newTime) { lastDisplayedUpdate = newTime; } }; } updateAvailable.set(com.google.gerrit.client.rpc.Natives.asList(nm).subList(om.length(), nm.length()), newInfo.updated()); if (!(updateAvailable.isAttached())) { add(updateAvailable); } }
@java.lang.Override public void onLoad() { if ((info) == null) { initUI(); } super.onLoad(); display(com.google.gerrit.client.Gerrit.getUserAccount()); tabs.selectTab(tabTokens.indexOf(initialTabToken)); Util.ACCOUNT_SVC.myAccount(new com.google.gerrit.client.rpc.ScreenLoadCallback<com.google.gerrit.client.reviewdb.Account>(this) { @java.lang.Override protected void preDisplay(final com.google.gerrit.client.reviewdb.Account result) { display(result); } }); }
public static boolean isValidHttpUri(java.lang.String val) { return (((val.startsWith("https://")) || (val.startsWith("http://"))) || (val.startsWith("//"))) && (com.google.gitiles.doc.html.HtmlBuilder.URI.getValueFilter().matcher(val).find()); }
com.google.gerrit.server.mail.RebasedPatchSetSender create(com.google.gerrit.reviewdb.client.Change change);
private com.google.inject.Injector createSysInjector() { final java.util.List<java.lang.Module> modules = new java.util.ArrayList<java.lang.Module>(); modules.add(com.google.gerrit.server.schema.SchemaVersionCheck.module()); modules.add(new com.google.gerrit.pgm.util.LogFileCompressor.Module()); modules.add(new com.google.gerrit.server.git.WorkQueue.Module()); modules.add(new com.google.gerrit.common.ChangeHookRunner.Module()); modules.add(new com.google.gerrit.server.git.ReceiveCommitsExecutorModule()); modules.add(cfgInjector.getInstance(com.google.gerrit.server.config.GerritGlobalModule.class)); modules.add(new com.google.gerrit.ehcache.EhcachePoolImpl.Module()); modules.add(new com.google.gerrit.server.mail.SmtpEmailSender.Module()); modules.add(new com.google.gerrit.server.mail.SignedTokenEmailTokenVerifier.Module()); modules.add(new com.google.gerrit.server.git.PushReplication.Module()); modules.add(new com.google.gerrit.server.plugins.PluginModule()); if (httpd) { modules.add(new com.google.gerrit.server.config.CanonicalWebUrlModule() { @java.lang.Override protected java.lang.Class<? extends com.google.inject.Provider<java.lang.String>> provider() { return com.google.gerrit.httpd.HttpCanonicalWebUrlProvider.class; } }); } else { modules.add(new com.google.gerrit.server.config.CanonicalWebUrlModule() { @java.lang.Override protected java.lang.Class<? extends com.google.inject.Provider<java.lang.String>> provider() { return com.google.gerrit.server.config.CanonicalWebUrlProvider.class; } }); } if (!(slave)) { modules.add(new com.google.gerrit.server.config.MasterNodeStartup()); } return cfgInjector.createChildInjector(modules); }
private boolean canPerform(java.lang.String permissionName, boolean isChangeOwner, boolean withForce) { if (isBlocked(permissionName, isChangeOwner, withForce)) { return false; } for (com.google.gerrit.common.data.PermissionRule pr : relevant.getAllowRules(permissionName)) { if ((com.google.gerrit.server.permissions.RefControl.isAllow(pr, withForce)) && (projectControl.match(pr, isChangeOwner))) { return true; } } return false; }
@com.google.gwt.uibinder.client.UiHandler("deleteChange") void onDeleteChange(@java.lang.SuppressWarnings("unused") com.google.gwt.event.dom.client.ClickEvent e) { if (com.google.gwt.user.client.Window.confirm(Resources.C.deleteChange())) { com.google.gerrit.client.change.ChangeActions.delete(project, changeId, deleteChange); } }
public java.util.Optional<com.google.gerrit.server.group.InternalGroup> getLoadedGroup() { checkLoaded(); return loadedGroup; }
public final com.google.gerrit.gpg.CheckResult check(org.eclipse.jgit.transport.PushCertificate cert) { if ((cert.getNonceStatus()) != (org.eclipse.jgit.transport.PushCertificate.NonceStatus.OK)) { return new com.google.gerrit.gpg.CheckResult("Invalid nonce"); } java.util.List<java.lang.String> problems = new java.util.ArrayList<>(); try { org.bouncycastle.openpgp.PGPSignature sig = readSignature(cert); if (sig != null) { @java.lang.SuppressWarnings("resource") org.eclipse.jgit.lib.Repository repo = getRepository(); try (com.google.gerrit.gpg.PublicKeyStore store = new com.google.gerrit.gpg.PublicKeyStore(repo)) { checkSignature(sig, cert, store, problems); checkCustom(repo, problems); } finally { if (shouldClose(repo)) { repo.close(); } } } else { problems.add("Invalid signature format"); } } catch (org.bouncycastle.openpgp.PGPException | java.io.IOException e) { java.lang.String msg = "Internal error checking push certificate"; com.google.gerrit.gpg.PushCertificateChecker.log.error(msg, e); problems.add(msg); } return new com.google.gerrit.gpg.CheckResult(problems); }
private static com.google.gwt.json.client.JSONValue parseJson(com.google.gwt.http.client.Response res) throws com.google.gwt.json.client.JSONException { java.lang.String json = com.google.gerrit.client.rpc.RestApi.trimJsonMagic(res.getText()); if (json.isEmpty()) { throw new com.google.gwt.json.client.JSONException("response was empty"); } return com.google.gwt.json.client.JSONParser.parseStrict(json); }
void createOrEditFileComment() { if (!(com.google.gerrit.client.Gerrit.isSignedIn())) { com.google.gerrit.client.Gerrit.doSignIn(parent.getToken()); return; } if (boxes.isEmpty()) { addFileComment(parent.getCommentManager().newFileDraft(side)); } else { com.google.gerrit.client.diff.CommentBox box = boxes.get(((boxes.size()) - 1)); if (box instanceof com.google.gerrit.client.diff.DraftBox) { ((com.google.gerrit.client.diff.DraftBox) (box)).setEdit(true); } else { addFileComment(((com.google.gerrit.client.diff.PublishedBox) (box)).addReplyBox()); } } }
public static java.util.List<java.lang.Module> loadModules(com.google.inject.Injector parent) { org.eclipse.jgit.lib.Config cfg = com.google.gerrit.server.LibModuleLoader.getConfig(parent); return java.util.Arrays.stream(cfg.getStringList("gerrit", null, "installModule")).map(( m) -> createModule(parent, m)).collect(java.util.stream.Collectors.toList()); }
@org.junit.Test public void retrieveFilesInEdit() throws java.lang.Exception { assertThat(modifier.createEdit(change, ps)).isEqualTo(RefUpdate.Result.NEW); com.google.common.base.Optional<com.google.gerrit.server.edit.ChangeEdit> edit = editUtil.byChange(change); assertThat(modifier.modifyFile(edit.get(), com.google.gerrit.acceptance.edit.ChangeEditIT.FILE_NAME, com.google.gerrit.acceptance.RestSession.newRawInput(com.google.gerrit.acceptance.edit.ChangeEditIT.CONTENT_NEW))).isEqualTo(RefUpdate.Result.FORCED); EditInfo info = toEditInfo(true); assertThat(info.files).hasSize(2); java.util.List<java.lang.String> l = com.google.common.collect.Lists.newArrayList(info.files.keySet()); assertThat(l.get(0)).isEqualTo("/COMMIT_MSG"); assertThat(l.get(1)).isEqualTo("foo"); }
private java.lang.String eventClassName(java.lang.String name) { java.lang.String[] nameParts = name.split("_"); java.util.List<java.lang.String> classNameParts = com.google.common.collect.Lists.transform(java.util.Arrays.asList(nameParts), new com.google.common.base.Function<java.lang.String, java.lang.String>() { @java.lang.Override public java.lang.String apply(java.lang.String part) { return (java.lang.Character.toUpperCase(part.charAt(0))) + (part.substring(1)); } }); return (((com.googlesource.gerrit.plugins.github.notification.WebhookServlet.PACKAGE_NAME) + ".") + (com.google.common.base.Joiner.on("").join(classNameParts))) + "Handler"; }
private static long computeInitialDelay(long interval, java.lang.String start, java.time.ZonedDateTime now) { checkNotNull(start); try { java.time.format.DateTimeFormatter formatter = java.time.format.DateTimeFormatter.ofPattern("[E ]HH:mm").withLocale(java.util.Locale.US); java.time.LocalTime firstStartTime = java.time.LocalTime.parse(start, formatter); java.time.ZonedDateTime startTime = now.with(firstStartTime); try { java.time.DayOfWeek dayOfWeek = formatter.parse(start, java.time.DayOfWeek::from); startTime = startTime.with(dayOfWeek); } catch (java.time.format.DateTimeParseException ignored) { } startTime = startTime.truncatedTo(java.time.temporal.ChronoUnit.MINUTES); long delay = (java.time.Duration.between(now, startTime).toMillis()) % interval; if (delay <= 0) { delay += interval; } return delay; } catch (java.time.format.DateTimeParseException e) { return com.google.gerrit.server.config.ScheduleConfig.INVALID_CONFIG; } }
private void display(com.google.gerrit.client.info.GeneralPreferences p) { showSiteHeader.setValue(p.showSiteHeader()); useFlashClipboard.setValue(p.useFlashClipboard()); setListBox(maximumPageSize, com.google.gerrit.client.account.DEFAULT_PAGESIZE, p.changesPerPage()); setListBox(dateFormat, GeneralPreferencesInfo.DateFormat.STD, p.dateFormat()); setListBox(timeFormat, GeneralPreferencesInfo.TimeFormat.HHMM_12, p.timeFormat()); relativeDateInChangeTable.setValue(p.relativeDateInChangeTable()); sizeBarInChangeTable.setValue(p.sizeBarInChangeTable()); legacycidInChangeTable.setValue(p.legacycidInChangeTable()); muteCommonPathPrefixes.setValue(p.muteCommonPathPrefixes()); setListBox(reviewCategoryStrategy, GeneralPreferencesInfo.ReviewCategoryStrategy.NONE, p.reviewCategoryStrategy()); setListBox(diffView, GeneralPreferencesInfo.DiffView.SIDE_BY_SIDE, p.diffView()); setListBox(emailStrategy, GeneralPreferencesInfo.EmailStrategy.ENABLED, p.emailStrategy()); display(p.my()); }
@java.lang.Override Account.Id parse(java.lang.String id) { return Account.Id.parse(id); }
private java.util.Map<java.lang.String, com.google.gerrit.reviewdb.client.PatchSetApproval> scanLabels(com.google.gerrit.server.change.RevisionResource rsrc, java.util.List<com.google.gerrit.reviewdb.client.PatchSetApproval> del) throws com.google.gwtorm.server.OrmException { com.google.gerrit.common.data.LabelTypes labelTypes = rsrc.getControl().getLabelTypes(); java.util.Map<java.lang.String, com.google.gerrit.reviewdb.client.PatchSetApproval> current = com.google.common.collect.Maps.newHashMap(); for (com.google.gerrit.reviewdb.client.PatchSetApproval a : db.patchSetApprovals().byPatchSetUser(rsrc.getPatchSet().getId(), rsrc.getAccountId())) { if (a.isSubmit()) { continue; } com.google.gerrit.common.data.LabelType lt = labelTypes.byLabel(a.getLabelId()); if (lt != null) { current.put(lt.getName(), a); } else { del.add(a); } } return current; }
@java.lang.Override protected void configureServlets() { com.googlesource.gerrit.plugins.lfs.LfsBackend backend = config.getEnum("storage", null, "backend", LfsBackend.FS); switch (backend) { case FS : serveRegex(com.googlesource.gerrit.plugins.lfs.URL_REGEX).with(com.googlesource.gerrit.plugins.lfs.fs.LfsFsApiServlet.class); bind(com.googlesource.gerrit.plugins.lfs.fs.LocalLargeFileRepository.class); serve((("/" + (CONTENT_PATH)) + "/*")).with(com.googlesource.gerrit.plugins.lfs.fs.LfsFsContentServlet.class); break; case S3 : serveRegex(com.googlesource.gerrit.plugins.lfs.URL_REGEX).with(com.googlesource.gerrit.plugins.lfs.s3.LfsS3ApiServlet.class); bind(com.googlesource.gerrit.plugins.lfs.s3.S3LargeFileRepository.class); break; default : throw new java.lang.RuntimeException(("Unsupported backend: " + backend)); } }
@java.lang.Override public java.util.Set<com.google.gerrit.reviewdb.client.AccountGroup.UUID> getKnownGroups() { if ((knownGroups) == null) { knownGroups = computeKnownGroups(); } return knownGroups; }
@org.junit.Test(expected = org.eclipse.jgit.errors.RepositoryNotFoundException.class) public void testOpenRepositoryInvalidName() throws java.lang.Exception { repoManager.openRepository(new com.google.gerrit.reviewdb.client.Project.NameKey("project%?|<>A")); }
@org.junit.Test public void testOwnerGroupsForStartWithFilter() { com.google.common.collect.ImmutableList<java.lang.String> ownerGroups1 = com.google.common.collect.ImmutableList.of("group1"); com.google.common.collect.ImmutableList<java.lang.String> ownerGroups2 = com.google.common.collect.ImmutableList.of("group2"); com.google.common.collect.ImmutableList<java.lang.String> ownerGroups3 = com.google.common.collect.ImmutableList.of("group3"); configureOwnerGroups("*", ownerGroups1); configureOwnerGroups("somePath/*", ownerGroups2); configureOwnerGroups("somePath/somePath/*", ownerGroups3); assertThat(repoCfg.getOwnerGroups(new com.google.gerrit.reviewdb.client.Project.NameKey("someProject"))).containsExactlyElementsIn(ownerGroups1); assertThat(repoCfg.getOwnerGroups(new com.google.gerrit.reviewdb.client.Project.NameKey("somePath/someProject"))).containsExactlyElementsIn(ownerGroups2); assertThat(repoCfg.getOwnerGroups(new com.google.gerrit.reviewdb.client.Project.NameKey("somePath/somePath/someProject"))).containsExactlyElementsIn(ownerGroups3); }
private java.util.concurrent.Callable<com.google.gerrit.httpd.raw.ResourceServlet.Resource> newLoader(final java.nio.file.Path p) { return new java.util.concurrent.Callable<com.google.gerrit.httpd.raw.ResourceServlet.Resource>() { @java.lang.Override public com.google.gerrit.httpd.raw.ResourceServlet.Resource call() throws java.io.IOException { try { return new com.google.gerrit.httpd.raw.ResourceServlet.Resource(getLastModifiedTime(p), com.google.gerrit.httpd.raw.ResourceServlet.contentType(p.toString()), java.nio.file.Files.readAllBytes(p)); } catch (java.nio.file.NoSuchFileException e) { return com.google.gerrit.httpd.raw.ResourceServlet.Resource.NOT_FOUND; } } }; }
public com.google.gwtjsonrpc.client.VoidResult run(final com.google.gerrit.reviewdb.ReviewDb db) throws com.google.gwtorm.client.OrmException { final com.google.gerrit.reviewdb.Account.Id me = getAccountId(); final java.util.Set<com.google.gerrit.reviewdb.Change.Id> existing = currentUser.get().getStarredChanges(); java.util.List<com.google.gerrit.reviewdb.StarredChange> add = new java.util.ArrayList<com.google.gerrit.reviewdb.StarredChange>(); java.util.List<com.google.gerrit.reviewdb.StarredChange.Key> remove = new java.util.ArrayList<com.google.gerrit.reviewdb.StarredChange.Key>(); if ((req.getAddSet()) != null) { for (final com.google.gerrit.reviewdb.Change.Id id : req.getAddSet()) { if (!(existing.contains(id))) { add.add(new com.google.gerrit.reviewdb.StarredChange(new com.google.gerrit.reviewdb.StarredChange.Key(me, id))); } } } if ((req.getRemoveSet()) != null) { for (final com.google.gerrit.reviewdb.Change.Id id : req.getRemoveSet()) { remove.add(new com.google.gerrit.reviewdb.StarredChange.Key(me, id)); } } db.starredChanges().insert(add); db.starredChanges().deleteKeys(remove); for (com.google.gerrit.reviewdb.StarredChange sc : add) { starredChangesCache.evict(sc.getKey()); } for (com.google.gerrit.reviewdb.StarredChange.Key key : remove) { starredChangesCache.evict(key); } return com.google.gwtjsonrpc.client.VoidResult.INSTANCE; }
@java.lang.Override protected void configureServlets() { install(new com.google.gerrit.server.config.FactoryModule() { @java.lang.Override protected void configure() { factory(ChangeProjectAccess.Factory.class); factory(ReviewProjectAccess.Factory.class); factory(ProjectAccessFactory.Factory.class); } }); rpc(com.google.gerrit.httpd.rpc.project.ProjectAdminServiceImpl.class); }
private com.google.gerrit.reviewdb.client.PatchSet getOrCreateAlreadyMergedPatchSet(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx) throws com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.reviewdb.client.PatchSet.Id psId = alreadyMerged.getPatchsetId(); logDebug("Fixing up already-merged patch set {}", psId); com.google.gerrit.reviewdb.client.PatchSet prevPs = args.psUtil.current(ctx.getDb(), ctx.getNotes()); ctx.getRevWalk().parseBody(alreadyMerged); ctx.getChange().setCurrentPatchSet(psId, alreadyMerged.getShortMessage(), ctx.getChange().getOriginalSubject()); com.google.gerrit.reviewdb.client.PatchSet existing = args.psUtil.get(ctx.getDb(), ctx.getNotes(), psId); if (existing != null) { logDebug("Patch set row exists, only updating change"); return existing; } java.util.List<java.lang.String> groups = (prevPs != null) ? prevPs.getGroups() : com.google.gerrit.server.git.GroupCollector.getDefaultGroups(alreadyMerged); return args.psUtil.insert(ctx.getDb(), ctx.getRevWalk(), ctx.getUpdate(psId), psId, alreadyMerged, false, groups, null); }
@java.lang.Override protected com.google.gerrit.extensions.restapi.Response<?> applyImpl(com.google.gerrit.server.update.BatchUpdate.Factory updateFactory, com.google.gerrit.server.change.ChangeResource rsrc, com.google.gerrit.server.change.WorkInProgressOp.Input input) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gerrit.server.permissions.PermissionBackendException, com.google.gerrit.server.update.UpdateException { com.google.gerrit.reviewdb.client.Change change = rsrc.getChange(); if ((!(rsrc.isUserOwner())) && (!(permissionBackend.user(self).test(GlobalPermission.ADMINISTRATE_SERVER)))) { throw new com.google.gerrit.extensions.restapi.AuthException("not allowed to set work in progress"); } if ((change.getStatus()) != (com.google.gerrit.reviewdb.client.Change.Status.NEW)) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException(("change is " + (com.google.gerrit.server.ChangeUtil.status(change)))); } if (change.isWorkInProgress()) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException("change is already work in progress"); } try (com.google.gerrit.server.update.BatchUpdate bu = updateFactory.create(db.get(), rsrc.getProject(), rsrc.getUser(), com.google.gerrit.common.TimeUtil.nowTs())) { bu.addOp(rsrc.getChange().getId(), opFactory.create(true, input)); bu.execute(); return com.google.gerrit.extensions.restapi.Response.ok(""); } }
public com.googlesource.gerrit.plugins.its.base.validation.ItsAssociationPolicy getItsAssociationPolicy() { com.googlesource.gerrit.plugins.its.base.validation.ItsAssociationPolicy legacyItsAssociationPolicy = gerritConfig.getEnum("commentLink", getCommentLinkName(), "association", ItsAssociationPolicy.OPTIONAL); return getPluginConfigEnum("association", legacyItsAssociationPolicy); }
@org.junit.Test public void revert() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result r = createChange(); gApi.changes().id(r.getChangeId()).revision(r.getCommit().name()).review(com.google.gerrit.extensions.api.changes.ReviewInput.approve()); gApi.changes().id(r.getChangeId()).revision(r.getCommit().name()).submit(); ChangeInfo revertChange = gApi.changes().id(r.getChangeId()).revert().get(); java.util.List<com.google.gerrit.extensions.common.ChangeMessageInfo> sourceMessages = new java.util.ArrayList(gApi.changes().id(r.getChangeId()).get().messages); assertThat(sourceMessages).hasSize(4); java.lang.String expectedMessage = java.lang.String.format("Created a revert of this change as %s", revertChange.changeId); assertThat(sourceMessages.get(3).message).isEqualTo(expectedMessage); assertThat(revertChange.messages).hasSize(1); assertThat(revertChange.messages.iterator().next().message).isEqualTo("Uploaded patch set 1."); assertThat(revertChange.revertOf).isEqualTo(gApi.changes().id(r.getChangeId()).get()._number); }
private void recreatePK(com.google.gwtorm.server.StatementExecutor executor, java.lang.String tableName, com.google.gerrit.server.schema.Schema_101.PrimaryKey pk, com.google.gerrit.server.schema.UpdateUI ui) throws com.google.gwtorm.server.OrmException { if ((pk.oldNameInDb) == null) { ui.message(java.lang.String.format("warning: primary key for table %s didn't exist ... ", tableName)); } else { if ((dialect) instanceof com.google.gwtorm.schema.sql.DialectPostgreSQL) { executor.execute(((("ALTER TABLE " + tableName) + " DROP CONSTRAINT ") + (pk.oldNameInDb))); } else { executor.execute((("ALTER TABLE " + tableName) + " DROP PRIMARY KEY")); } } executor.execute((((("ALTER TABLE " + tableName) + " ADD PRIMARY KEY(") + (com.google.common.base.Joiner.on(",").join(pk.cols))) + ")")); }
java.lang.Runnable navigate(com.google.gerrit.client.diff.Direction dir) { switch (dir) { case PREV : return new java.lang.Runnable() { @java.lang.Override public void run() { (hasPrev ? prev : up).go(); } }; case NEXT : return new java.lang.Runnable() { @java.lang.Override public void run() { (hasNext ? next : up).go(); } }; default : return new java.lang.Runnable() { @java.lang.Override public void run() { } }; } }
public abstract com.google.gerrit.server.diff.Text aText();
private void renderLinks(com.google.gerrit.client.editor.EditFileInfo info, com.google.gerrit.client.diff.DiffInfo diffInfo) { for (com.google.gerrit.client.ui.InlineHyperlink link : getLinks()) { linkPanel.add(link); } if (info != null) { renderPluginLinks(com.google.gerrit.client.rpc.Natives.asList(info.web_links())); } else if (diffInfo != null) { renderPluginLinks(com.google.gerrit.client.rpc.Natives.asList(diffInfo.web_links())); } }
@java.lang.Override public boolean apply(java.lang.String refPart) { return refPart.endsWith(("/" + (changeId.get()))); }
private java.util.concurrent.Callable<java.lang.Void> reindexProject(final com.google.gerrit.server.index.ChangeIndexer indexer, final com.google.gerrit.reviewdb.client.Project.NameKey project, final com.google.gerrit.server.git.MultiProgressMonitor.Task done, final com.google.gerrit.server.git.MultiProgressMonitor.Task failed, final java.io.PrintWriter verboseWriter) { return new java.util.concurrent.Callable<java.lang.Void>() { @java.lang.Override public java.lang.Void call() throws java.lang.Exception { com.google.common.collect.Multimap<org.eclipse.jgit.lib.ObjectId, com.google.gerrit.server.query.change.ChangeData> byId = com.google.common.collect.ArrayListMultimap.create(); org.eclipse.jgit.lib.Repository repo = null; com.google.gerrit.reviewdb.server.ReviewDb db = null; try { repo = repoManager.openRepository(project); java.util.Map<java.lang.String, org.eclipse.jgit.lib.Ref> refs = repo.getRefDatabase().getRefs(com.google.gerrit.server.index.ALL); db = schemaFactory.open(); for (com.google.gerrit.reviewdb.client.Change c : db.changes().byProject(project)) { org.eclipse.jgit.lib.Ref r = refs.get(c.currentPatchSetId().toRefName()); if (r != null) { byId.put(r.getObjectId(), changeDataFactory.create(db, c)); } } new com.google.gerrit.server.index.ChangeBatchIndexer.ProjectIndexer(indexer, mergeStrategy, byId, repo, done, failed, verboseWriter).call(); } catch (org.eclipse.jgit.errors.RepositoryNotFoundException rnfe) { com.google.gerrit.server.index.ChangeBatchIndexer.log.error(rnfe.getMessage()); } finally { if (db != null) { db.close(); } if (repo != null) { repo.close(); } } return null; } }; }
@org.junit.Test public void rebuildEmptySiteStartingWithNoteDbEnabled() throws java.lang.Exception { initSite(); setNotesMigrationState(NotesMigrationState.NOTE_DB_UNFUSED); com.google.gerrit.acceptance.pgm.RebuildNoteDbIT.runGerrit("RebuildNoteDb", "-d", sitePath, "--show-stack-trace"); }
@org.junit.Before public void setUp() throws java.lang.Exception { group1 = group("users1"); group2 = group("users2"); group3 = group("users3"); user1 = user("user1", "First1 Last1", group1); user2 = user("user2", "First2 Last2", group2); user3 = user("user3", "First3 Last3", group1, group2); user4 = user("jdoe", "John Doe", "JDOE"); }
private com.google.common.base.Supplier<com.google.gerrit.server.data.ChangeAttribute> changeAttributeSupplier(final com.google.gerrit.reviewdb.client.Change change) { return com.google.common.base.Suppliers.memoize(new com.google.common.base.Supplier<com.google.gerrit.server.data.ChangeAttribute>() { @java.lang.Override public com.google.gerrit.server.data.ChangeAttribute get() { return eventFactory.asChangeAttribute(change); } }); }
@java.lang.Override public void visit(org.commonmark.node.Heading node) { outputNamedAnchor = false; java.lang.String tag = "h" + (node.getLevel()); html.open(tag); java.lang.String id = toc.idFromHeader(node); if (id != null) { html.open("a").attribute("class", "h").attribute("name", id).attribute("href", ("#" + id)).open("span").close("span").close("a"); html.open("a").attribute("class", "h").attribute("name", id.toLowerCase()).attribute("href", ("#" + (id.toLowerCase()))).open("span").close("span").close("a"); } visitChildren(node); html.close(tag); outputNamedAnchor = true; }
@java.lang.Override protected void applyDataRowStyle(final int row) { super.applyDataRowStyle(row); final com.google.gwt.user.client.ui.HTMLTable.CellFormatter fmt = table.getCellFormatter(); fmt.addStyleName(row, com.google.gerrit.client.changes.ChangeTable2.C_STAR, Gerrit.RESOURCES.css().iconCell()); for (int i = com.google.gerrit.client.changes.ChangeTable2.C_ID; i < (columns); i++) { fmt.addStyleName(row, i, Gerrit.RESOURCES.css().dataCell()); } if (!(showLegacyId)) { fmt.addStyleName(row, com.google.gerrit.client.changes.ChangeTable2.C_ID, Gerrit.RESOURCES.css().dataCellHidden()); } fmt.addStyleName(row, com.google.gerrit.client.changes.ChangeTable2.C_SUBJECT, Gerrit.RESOURCES.css().cSUBJECT()); fmt.addStyleName(row, com.google.gerrit.client.changes.ChangeTable2.C_STATUS, Gerrit.RESOURCES.css().cSTATUS()); fmt.addStyleName(row, com.google.gerrit.client.changes.ChangeTable2.C_OWNER, Gerrit.RESOURCES.css().cOWNER()); fmt.addStyleName(row, com.google.gerrit.client.changes.ChangeTable2.C_LAST_UPDATE, Gerrit.RESOURCES.css().cLastUpdate()); fmt.addStyleName(row, com.google.gerrit.client.changes.ChangeTable2.C_SIZE, Gerrit.RESOURCES.css().cSIZE()); for (int i = (com.google.gerrit.client.changes.ChangeTable2.C_SIZE) + 1; i < (columns); i++) { fmt.addStyleName(row, i, Gerrit.RESOURCES.css().cAPPROVAL()); } }
private com.google.gerrit.client.diff.DraftBox addDraftBox(com.google.gerrit.client.changes.CommentInfo info, boolean doSave) { com.google.gerrit.client.diff.DraftBox box = new com.google.gerrit.client.diff.DraftBox(this, revision, info, commentLinkProcessor, true, doSave); addCommentBox(info, box); if (!doSave) { box.setEdit(true); } net.codemirror.lib.CodeMirror.LineHandle handle = getCmFromSide(info.side()).getLineHandle(((info.line()) - 1)); lineActiveBoxMap.put(handle, box); return box; }
public void testOnlySkipMatching() throws com.google.gerrit.server.git.validators.CommitValidationException { java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> ret; com.googlesource.gerrit.plugins.its.base.validation.ItsValidateComment ivc = injector.getInstance(com.googlesource.gerrit.plugins.its.base.validation.ItsValidateComment.class); org.eclipse.jgit.transport.ReceiveCommand command = createMock(org.eclipse.jgit.transport.ReceiveCommand.class); org.eclipse.jgit.revwalk.RevCommit commit = createMock(org.eclipse.jgit.revwalk.RevCommit.class); com.google.gerrit.server.events.CommitReceivedEvent event = newCommitReceivedEvent(command, project, null, commit, null); expect(itsConfig.getItsAssociationPolicy()).andReturn(ItsAssociationPolicy.MANDATORY).atLeastOnce(); expect(itsConfig.getDummyIssuePattern()).andReturn(java.util.Optional.of(java.util.regex.Pattern.compile("SKIP"))).atLeastOnce(); expect(commit.getFullMessage()).andReturn("TestMessage SKIP").atLeastOnce(); expect(commit.getId()).andReturn(commit).anyTimes(); expect(commit.getName()).andReturn("TestCommit").anyTimes(); expect(issueExtractor.getIssueIds("TestMessage SKIP")).andReturn(new java.lang.String[]{ }).atLeastOnce(); replayMocks(); ret = ivc.onCommitReceived(event); assertEmptyList(ret); }
public void testDuplicateSimpleNonIndexOnlyPredicates() throws java.lang.Exception { com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> in = parse("status:new project:p file:a"); com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> out = rewrite(in); assertSame(com.google.gerrit.server.query.AndPredicate.class, out.getClass()); assertEquals(com.google.common.collect.ImmutableList.of(in.getChild(0), in.getChild(1), wrap(com.google.gerrit.server.query.Predicate.and(in.getChild(0), in.getChild(2)))), out.getChildren()); }
public void putComment(com.google.gerrit.reviewdb.client.PatchLineComment comment) { checkArgument(((psId) != null), "setPatchSetId must be called before putComment"); checkArgument(com.google.gerrit.server.notedb.CommentsInNotesUtil.getCommentPsId(comment).equals(psId), "Comment on %s doesn't match previous patch set %s", com.google.gerrit.server.notedb.CommentsInNotesUtil.getCommentPsId(comment), psId); checkArgument(((comment.getRevId()) != null)); if ((comment.getSide()) == 0) { commentsForBase.add(comment); } else { commentsForPs.add(comment); } }
static com.google.gerrit.client.projects.ProjectApi.StringMap create() { return ((com.google.gerrit.client.projects.ProjectApi.StringMap) (createObject())); }
java.util.Map<com.google.gerrit.server.account.WatchConfig.ProjectWatchKey, java.util.Set<com.google.gerrit.server.account.WatchConfig.NotifyType>> getProjectWatches() { checkLoaded(); return projectWatches; }
@org.junit.Test public void watchProjectNotifyOnDraftChange() throws java.lang.Exception { java.lang.String watchedProject = createProject("watchedProject").get(); com.google.gerrit.extensions.common.GroupInfo groupThatCanViewDrafts = gApi.groups().create("groupThatCanViewDrafts").get(); grant(Permission.VIEW_DRAFTS, new com.google.gerrit.reviewdb.client.Project.NameKey(watchedProject), "refs/*", false, new com.google.gerrit.reviewdb.client.AccountGroup.UUID(groupThatCanViewDrafts.id)); setApiUser(user); watch(watchedProject, null); com.google.gerrit.acceptance.TestAccount userThatCanViewDrafts = accounts.create("user2", "user2@test.com", "User2", groupThatCanViewDrafts.name); setApiUser(userThatCanViewDrafts); watch(watchedProject, null); setApiUser(admin); org.eclipse.jgit.junit.TestRepository<org.eclipse.jgit.internal.storage.dfs.InMemoryRepository> watchedRepo = cloneProject(new com.google.gerrit.reviewdb.client.Project.NameKey(watchedProject), admin); com.google.gerrit.acceptance.PushOneCommit.Result r = pushFactory.create(db, admin.getIdent(), watchedRepo, "TRIGGER", "a", "a1").to("refs/for/master%draft"); r.assertOkStatus(); java.util.List<com.google.gerrit.testutil.FakeEmailSender.Message> messages = sender.getMessages(); assertThat(messages).hasSize(1); com.google.gerrit.testutil.FakeEmailSender.Message m = messages.get(0); assertThat(m.rcpt()).containsExactly(userThatCanViewDrafts.emailAddress); assertThat(m.body()).contains("Change subject: TRIGGER\n"); assertThat(m.body()).contains("Gerrit-PatchSet: 1\n"); }
@org.junit.Test public void testSubmodulesParseWithSubProjectFound() throws java.lang.Exception { java.util.Map<java.lang.String, com.google.gerrit.server.util.SubmoduleSectionParserTest.SubmoduleSection> sectionsToReturn = new java.util.TreeMap<>(); sectionsToReturn.put("a/b", new com.google.gerrit.server.util.SubmoduleSectionParserTest.SubmoduleSection("ssh://localhost/a/b", "a/b", ".")); java.util.Map<java.lang.String, java.lang.String> reposToBeFound = new java.util.HashMap<>(); reposToBeFound.put("a/b", "a/b"); reposToBeFound.put("b", "b"); com.google.gerrit.reviewdb.client.Branch.NameKey superBranchNameKey = new com.google.gerrit.reviewdb.client.Branch.NameKey(new com.google.gerrit.reviewdb.client.Project.NameKey("super-project"), "refs/heads/master"); java.util.Set<com.google.gerrit.reviewdb.client.SubmoduleSubscription> expectedSubscriptions = com.google.common.collect.Sets.newHashSet(); expectedSubscriptions.add(new com.google.gerrit.reviewdb.client.SubmoduleSubscription(superBranchNameKey, new com.google.gerrit.reviewdb.client.Branch.NameKey(new com.google.gerrit.reviewdb.client.Project.NameKey("a/b"), "refs/heads/master"), "a/b")); execute(superBranchNameKey, sectionsToReturn, reposToBeFound, expectedSubscriptions); }
@java.lang.Override protected void configure() { factory(ReviewerResource.Factory.class); factory(AccountInfo.Loader.Factory.class); factory(EmailReviewComments.Factory.class); factory(ChangeInserter.Factory.class); factory(PatchSetInserter.Factory.class); }
@java.lang.Override public com.google.gerrit.server.permissions.PermissionBackend.ForRef ref(java.lang.String ref) { return controlForRef(ref).asForRef().database(db); }
private void verifyInstallPluginList(com.google.gerrit.pgm.util.ConsoleUI ui, java.util.List<com.google.gerrit.pgm.init.InitPlugins.PluginData> plugins) { if ((com.google.gerrit.pgm.Init.nullOrEmpty(installPlugins)) || (com.google.gerrit.pgm.Init.nullOrEmpty(plugins))) { return; } java.util.ArrayList<java.lang.String> copy = com.google.common.collect.Lists.newArrayList(installPlugins); java.util.List<java.lang.String> pluginNames = com.google.common.collect.Lists.transform(plugins, new com.google.common.base.Function<com.google.gerrit.pgm.init.InitPlugins.PluginData, java.lang.String>() { @java.lang.Override public java.lang.String apply(com.google.gerrit.pgm.init.InitPlugins.PluginData input) { return input.name; } }); copy.removeAll(pluginNames); if (!(copy.isEmpty())) { ui.message("Cannot find plugin(s): %s\n", com.google.common.base.Joiner.on(", ").join(copy)); listPlugins = true; } }
@java.lang.Override public void onSuccess(java.lang.Void result) { view.operation(new java.lang.Runnable() { @java.lang.Override public void run() { if (((getSelectedTheme()) == newTheme) && (isAttached())) { java.lang.String t = newTheme.name().toLowerCase(); view.getCmFromSide(DisplaySide.A).setOption("theme", t); view.getCmFromSide(DisplaySide.B).setOption("theme", t); view.setThemeStyles(newTheme.isDark()); } } }); }
private void addReviewerToReviewableChangeByOwnerCcingSelfInNoteDb(com.google.gerrit.acceptance.server.mail.AddReviewerSenderIT.Adder adder) throws java.lang.Exception { assume().that(notesMigration.readChanges()).isTrue(); com.google.gerrit.acceptance.server.mail.StagedChange sc = stageReviewableChange(); com.google.gerrit.acceptance.TestAccount reviewer = accountCreator.create("added", "added@example.com", "added"); addReviewer(adder, sc.changeId, sc.owner, reviewer.email, com.google.gerrit.acceptance.server.mail.CC_ON_OWN_COMMENTS, null); assertThat(sender).sent("newchange", sc).to(reviewer).cc(sc.owner, sc.reviewer).cc(sc.reviewerByEmail, sc.ccerByEmail).noOneElse(); }
@java.lang.Override public com.google.gerrit.extensions.registration.DynamicMap<com.google.gerrit.extensions.restapi.RestView<com.google.gerrit.server.change.FileResource>> views() { return views; }
private net.codemirror.lib.CodeMirror.RenderLineHandler resizeLinePadding(final com.google.gerrit.client.diff.DisplaySide side) { return new net.codemirror.lib.CodeMirror.RenderLineHandler() { @java.lang.Override public void handle(net.codemirror.lib.CodeMirror cm, net.codemirror.lib.CodeMirror.LineHandle lh, com.google.gwt.dom.client.Element e) { commentManager.resizePadding(lh); chunkManager.resizePadding(cm, lh, side); } }; }
private static com.google.gerrit.server.account.AccountState newState(com.google.gerrit.reviewdb.client.Account account) { return new com.google.gerrit.server.account.AccountState(account, com.google.common.collect.ImmutableSet.<com.google.gerrit.reviewdb.client.AccountGroup.UUID>of(), com.google.common.collect.ImmutableSet.<com.google.gerrit.reviewdb.client.AccountExternalId>of(), new java.util.HashMap<com.google.gerrit.server.account.WatchConfig.ProjectWatchKey, java.util.Set<com.google.gerrit.reviewdb.client.AccountProjectWatch.NotifyType>>()); }
@java.lang.Override void render(com.google.gerrit.client.diff.DiffInfo diff) { super.render(); chunks = new java.util.ArrayList(); padding = new java.util.ArrayList(); paddingDivs = new java.util.ArrayList(); java.lang.String diffColor = (((diff.metaA()) == null) || ((diff.metaB()) == null)) ? SideBySideTable.style.intralineBg() : SideBySideTable.style.diff(); for (com.google.gerrit.client.diff.DiffInfo.Region current : com.google.gerrit.client.rpc.Natives.asList(diff.content())) { if ((current.ab()) != null) { lineMapper.appendCommon(current.ab().length()); } else if ((current.skip()) > 0) { lineMapper.appendCommon(current.skip()); } else if (current.common()) { lineMapper.appendCommon(current.b().length()); } else { render(current, diffColor); } } if (paddingDivs.isEmpty()) { paddingDivs = null; } }
@java.lang.Override protected void openRow(java.lang.String projectName) { nameBox.setText(projectName); doAddNew(); }
@org.junit.Before public void setTimeForTesting() { systemTimeZone = java.lang.System.setProperty("user.timezone", "US/Eastern"); com.google.gerrit.testutil.TestTimeUtil.resetWithClockStep(1, java.util.concurrent.TimeUnit.SECONDS); }
public static java.nio.file.Path getDeveloperEclipseOut() throws java.io.FileNotFoundException { return com.google.gerrit.launcher.GerritLauncher.resolveInSourceRoot("eclipse-out"); }
private void configureMainSection() { ui.header("Main section"); java.lang.String sharedDirDefault = (ui.isBatch()) ? com.ericsson.gerrit.plugins.highavailability.Configuration.DEFAULT_SHARED_DIRECTORY : null; java.lang.String shared = promptAndSetString("Shared directory", com.ericsson.gerrit.plugins.highavailability.Configuration.MAIN_SECTION, com.ericsson.gerrit.plugins.highavailability.Configuration.SHARED_DIRECTORY_KEY, sharedDirDefault); if (!(com.google.common.base.Strings.isNullOrEmpty(shared))) { java.nio.file.Path resolved = site.site_path.resolve(java.nio.file.Paths.get(shared)); com.google.gerrit.common.FileUtil.mkdirsOrDie(resolved, ("cannot create " + resolved)); } }
private java.lang.String getImageUrl() { return ("plugins/" + (pluginName)) + "/static/readme.png"; }
@java.lang.Override public void run() throws java.lang.Exception { java.util.List<com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocResult> res = searcher.doQuery(q); for (com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocResult docResult : res) { stdout.println(java.lang.String.format("%s:\n%s%s\n", docResult.title, url, docResult.url)); } }
public java.util.List<com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocResult> doQuery(java.lang.String q) throws com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocQueryException { if (!(isAvailable())) { throw new com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocQueryException("Documentation search not available"); } try { org.apache.lucene.search.Query query = parser.parse(q); org.apache.lucene.search.TopDocs results = searcher.search(query, java.lang.Integer.MAX_VALUE); org.apache.lucene.search.ScoreDoc[] hits = results.scoreDocs; int totalHits = results.totalHits; java.util.List<com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocResult> out = com.google.common.collect.Lists.newArrayListWithCapacity(totalHits); for (int i = 0; i < totalHits; i++) { com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocResult result = new com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocResult(); org.apache.lucene.document.Document doc = searcher.doc(hits[i].doc); result.url = doc.get(Constants.URL_FIELD); result.title = doc.get(Constants.TITLE_FIELD); out.add(result); } return out; } catch (java.io.IOException | org.apache.lucene.queryparser.classic.ParseException e) { throw new com.google.gerrit.server.documentation.QueryDocumentationExecutor.DocQueryException(e); } }
public void onDelete(com.google.gerrit.server.IdentifiedUser user, com.google.gerrit.reviewdb.client.Project.NameKey project, com.googlesource.gerrit.plugins.deleteproject.DeleteProject.Input options, java.lang.Exception ex) { org.apache.log4j.spi.LoggingEvent event = new org.apache.log4j.spi.LoggingEvent(org.apache.log4j.Logger.class.getName(), com.googlesource.gerrit.plugins.deleteproject.DeleteLog.log, com.google.gerrit.common.TimeUtil.nowMs(), (ex == null ? org.apache.log4j.Level.INFO : org.apache.log4j.Level.ERROR), (ex == null ? "OK" : "FAIL"), java.lang.Thread.currentThread().getName(), null, null, null, null); event.setProperty(com.googlesource.gerrit.plugins.deleteproject.DeleteLog.ACCOUNT_ID, user.getAccountId().toString()); event.setProperty(com.googlesource.gerrit.plugins.deleteproject.DeleteLog.USER_NAME, user.getUserName()); event.setProperty(com.googlesource.gerrit.plugins.deleteproject.DeleteLog.PROJECT_NAME, project.get()); if (options != null) { event.setProperty(com.googlesource.gerrit.plugins.deleteproject.DeleteLog.OPTIONS, OutputFormat.JSON_COMPACT.newGson().toJson(options)); } if (ex != null) { event.setProperty(com.googlesource.gerrit.plugins.deleteproject.DeleteLog.ERROR, ex.toString()); } com.googlesource.gerrit.plugins.deleteproject.DeleteLog.log.callAppenders(event); }
private static java.util.Optional<com.google.gerrit.reviewdb.client.AccountGroup> getGroupFromReviewDb(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.reviewdb.client.AccountGroup.UUID groupUuid) throws com.google.gwtorm.server.OrmException { java.util.List<com.google.gerrit.reviewdb.client.AccountGroup> accountGroups = db.accountGroups().byUUID(groupUuid).toList(); if ((accountGroups.size()) == 1) { return java.util.Optional.of(com.google.common.collect.Iterables.getOnlyElement(accountGroups)); } else if (accountGroups.isEmpty()) { return java.util.Optional.empty(); } else { throw new com.google.gwtorm.server.OrmDuplicateKeyException(("Duplicate group UUID " + groupUuid)); } }
public java.lang.String getPluginName(java.io.File srcFile) throws java.io.IOException { return com.google.common.base.Objects.firstNonNull(getGerritPluginName(srcFile), com.google.gerrit.server.plugins.PluginLoader.nameOf(srcFile)); }
@java.lang.Override public void rebase(com.google.gerrit.extensions.api.changes.RebaseInput in) throws com.google.gerrit.extensions.restapi.RestApiException { try { rebase.apply(change, in); } catch (java.lang.Exception e) { throw com.google.gerrit.server.api.ApiUtil.asRestApiException("Cannot rebase change", e); } }
@java.lang.Override public void onSuccess(com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.diff.FileInfo> m) { files.set((base != null ? new com.google.gerrit.reviewdb.client.PatchSet.Id(changeId, base._number()) : null), new com.google.gerrit.reviewdb.client.PatchSet.Id(changeId, rev._number()), style, reply, fileTableMode, ((edit) != null)); files.setValue(m, myLastReply, (comments != null ? comments.get(0) : null), (drafts != null ? drafts.get(0) : null)); }
private void initEditor(com.google.gerrit.client.rpc.HttpResponse<com.google.gerrit.client.rpc.NativeString> file) { net.codemirror.mode.ModeInfo mode = null; java.lang.String content = ""; if (file != null) { content = file.getResult().asString(); if (prefs.syntaxHighlighting()) { mode = net.codemirror.mode.ModeInfo.findMode(file.getContentType(), path); } } cm = net.codemirror.lib.CodeMirror.create(editor, net.codemirror.lib.Configuration.create().set("value", content).set("readOnly", false).set("cursorBlinkRate", 0).set("cursorHeight", 0.85).set("lineNumbers", true).set("tabSize", prefs.tabSize()).set("lineWrapping", false).set("scrollbarStyle", "overlay").set("styleSelectedText", true).set("showTrailingSpace", true).set("keyMap", "default").set("theme", prefs.theme().name().toLowerCase()).set("mode", (mode != null ? mode.mode() : null))); cm.addKeyMap(net.codemirror.lib.KeyMap.create().on("Cmd-S", save()).on("Ctrl-S", save())); }
com.google.common.util.concurrent.ListenableFuture<java.lang.Void> insert(org.apache.lucene.document.Document doc) throws java.io.IOException { return new com.google.gerrit.lucene.SubIndex.NrtFuture(writer.addDocument(doc)); }
private java.lang.String getGroupName(com.google.gerrit.reviewdb.client.AccountGroup.Id groupId) { return groupCache.get(groupId).map(InternalGroup::getName).orElse(("Deleted group " + groupId)); }
@java.lang.Override public org.parboiled.Rule[] blockPluginRules() { return new org.parboiled.Rule[]{ note(), toc() }; }
private com.google.gwt.user.client.ui.Anchor createDownloadLink() { boolean isCommitMessage = Patch.COMMIT_MSG.equals(script.getNewName()); if ((isCommitMessage || (((side) == (com.google.gerrit.client.patches.PatchSetSelectBox.Side.A)) && (0 >= (script.getA().size())))) || (((side) == (com.google.gerrit.client.patches.PatchSetSelectBox.Side.B)) && (0 >= (script.getB().size())))) { return null; } com.google.gerrit.reviewdb.client.Patch.Key key = ((idSideA) == null) ? patchKey : new com.google.gerrit.reviewdb.client.Patch.Key(idSideA, patchKey.get()); java.lang.String sideURL = ((side) == (com.google.gerrit.client.patches.PatchSetSelectBox.Side.A)) ? "1" : "0"; final java.lang.String base = (com.google.gwt.core.client.GWT.getHostPageBaseURL()) + "cat/"; com.google.gwt.user.client.ui.Image image = new com.google.gwt.user.client.ui.Image(Gerrit.RESOURCES.downloadIcon()); final com.google.gwt.user.client.ui.Anchor anchor = new com.google.gwt.user.client.ui.Anchor(); anchor.setHref((((base + (com.google.gwtorm.client.KeyUtil.encode(key.toString()))) + "^") + sideURL)); anchor.setTitle(PatchUtil.C.download()); anchor.setStyleName(style.downloadLink()); com.google.gwt.user.client.DOM.insertBefore(anchor.getElement(), image.getElement(), com.google.gwt.user.client.DOM.getFirstChild(anchor.getElement())); return anchor; }
@org.junit.Test public void pushNewPatchSetForMasterWithApprovals() throws java.lang.Exception { com.google.gerrit.acceptance.PushOneCommit.Result r = pushTo("refs/for/master"); r.assertOkStatus(); com.google.gerrit.acceptance.PushOneCommit push = pushFactory.create(db, admin.getIdent(), testRepo, PushOneCommit.SUBJECT, "b.txt", "anotherContent", r.getChangeId()); r = push.to("refs/for/master/%l=Code-Review+2"); ChangeInfo ci = get(r.getChangeId(), com.google.gerrit.acceptance.git.DETAILED_LABELS, com.google.gerrit.acceptance.git.MESSAGES, com.google.gerrit.acceptance.git.DETAILED_ACCOUNTS); LabelInfo cr = ci.labels.get("Code-Review"); assertThat(com.google.common.collect.Iterables.getLast(ci.messages).message).isEqualTo("Uploaded patch set 2: Code-Review+2."); assertThatUserIsOnlyReviewer(ci, admin); assertThat(cr.all).hasSize(1); assertThat(cr.all.get(0).name).isEqualTo("Administrator"); assertThat(cr.all.get(0).value).isEqualTo(2); }
static void publish(com.google.gerrit.reviewdb.client.Change.Id id, java.lang.String revision) { com.google.gerrit.client.changes.ChangeApi.publish(id.get(), revision, com.google.gerrit.client.change.DraftActions.cs(id)); }
@java.lang.Override public void onFailure(java.lang.Throwable caught) { cbox.setEnabled(true); info.notify(type, oldVal); cbox.setValue(oldVal); super.onFailure(caught); }
protected com.google.gerrit.acceptance.AcceptanceTestRequestScope.Context setApiUser(com.google.gerrit.acceptance.TestAccount account) { return atrScope.set(newRequestContext(account)); }
com.google.gerrit.server.git.strategy.SubmitStrategy.Arguments create(com.google.gerrit.extensions.client.SubmitType submitType, com.google.gerrit.reviewdb.client.Branch.NameKey destBranch, com.google.gerrit.server.git.MergeOp.CommitStatus commits, com.google.gerrit.server.git.CodeReviewCommit.CodeReviewRevWalk rw, com.google.gerrit.server.IdentifiedUser caller, com.google.gerrit.server.git.MergeTip mergeTip, org.eclipse.jgit.lib.ObjectInserter inserter, org.eclipse.jgit.lib.Repository repo, org.eclipse.jgit.revwalk.RevFlag canMergeFlag, com.google.gerrit.reviewdb.server.ReviewDb db, java.util.Set<org.eclipse.jgit.revwalk.RevCommit> alreadyAccepted, java.lang.String submissionId, com.google.gerrit.extensions.api.changes.ReviewInput.NotifyHandling notifyHandling);
private static com.google.gitiles.Paginator newPaginator(org.eclipse.jgit.lib.Repository repo, com.google.gitiles.GitilesView view, com.google.gitiles.GitilesAccess access) throws java.io.IOException { if (view == null) { return null; } try (org.eclipse.jgit.revwalk.RevWalk walk = com.google.gitiles.LogServlet.newWalk(repo, view, access)) { if (walk == null) { return null; } com.google.common.base.Optional<org.eclipse.jgit.lib.ObjectId> start = com.google.gitiles.LogServlet.getStart(view.getParameters(), walk.getObjectReader()); if (start == null) { return null; } return new com.google.gitiles.Paginator(walk, com.google.gitiles.LogServlet.getLimit(view), start.orNull()); } }
public void setProjects(final java.util.Collection<com.google.gerrit.server.project.ProjectControl> projects) { this.projects = projects; }
@java.lang.Override protected void configure() { bind(com.ericsson.gerrit.plugins.highavailability.Configuration.class).toInstance(config); bind(org.apache.http.impl.client.CloseableHttpClient.class).toProvider(com.ericsson.gerrit.plugins.highavailability.forwarder.rest.HttpClientProvider.class).in(Scopes.SINGLETON); }
private void parseDelete(final org.eclipse.jgit.transport.ReceiveCommand cmd) { com.google.gerrit.server.project.RefControl ctl = projectControl.controlForRef(cmd.getRefName()); if (ctl.canDelete()) { cmd.execute(rp); } else { if (GitRepositoryManager.REF_CONFIG.equals(ctl.getRefName())) { reject(cmd, "cannot delete project configuration"); } else { errors.put(com.google.gerrit.server.git.ReceiveCommits.Error.DELETE, ctl.getRefName()); reject(cmd, "can not delete references"); } } }
public com.google.gerrit.extensions.restapi.Response<java.lang.String> apply(com.google.gerrit.server.IdentifiedUser user, com.google.gerrit.extensions.api.accounts.StatusInput input) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { if (input == null) { input = new com.google.gerrit.extensions.api.accounts.StatusInput(); } java.lang.String newStatus = input.status; com.google.gerrit.reviewdb.client.Account account = accountsUpdate.create().update(user.getAccountId(), ( u) -> u.setStatus(newStatus)); if (account == null) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException("account not found"); } return com.google.common.base.Strings.isNullOrEmpty(account.getStatus()) ? com.google.gerrit.extensions.restapi.Response.none() : com.google.gerrit.extensions.restapi.Response.ok(account.getStatus()); }
public S element(int index) { com.google.gerrit.acceptance.ListSubject.checkArgument((index >= 0), "index(%s) must be >= 0", index); @java.lang.SuppressWarnings("unchecked") java.util.List<E> list = ((java.util.List<E>) (com.google.gerrit.acceptance.ListSubject.actual())); com.google.gerrit.acceptance.ListSubject.isNotNull(); if (index >= (list.size())) { com.google.gerrit.acceptance.ListSubject.fail(("has an element at index " + index)); } return elementAssertThatFunction.apply(list.get(index)); }
@java.lang.Override public void build(com.google.gerrit.httpd.raw.Label label) throws com.google.gerrit.httpd.raw.BuildFailureException, java.io.IOException { com.google.gerrit.httpd.raw.BuckUtils.log.info(("buck build " + (label.fullName()))); java.util.Properties properties = com.google.gerrit.httpd.raw.BuckUtils.loadBuckProperties(sourceRoot.resolve("buck-out/gen/tools/buck/buck.properties")); java.lang.String buck = firstNonNull(properties.getProperty("buck"), "buck"); java.lang.ProcessBuilder proc = new java.lang.ProcessBuilder(buck, "build", label.fullName()).directory(sourceRoot.toFile()).redirectErrorStream(true); if (properties.containsKey("PATH")) { proc.environment().put("PATH", properties.getProperty("PATH")); } long start = com.google.gerrit.common.TimeUtil.nowMs(); java.lang.Process rebuild = proc.start(); byte[] out; try (java.io.InputStream in = rebuild.getInputStream()) { out = com.google.common.io.ByteStreams.toByteArray(in); } finally { rebuild.getOutputStream().close(); } int status; try { status = rebuild.waitFor(); } catch (java.lang.InterruptedException e) { throw new java.io.InterruptedIOException(("interrupted waiting for " + buck)); } if (status != 0) { throw new com.google.gerrit.httpd.raw.BuildFailureException(out); } long time = (com.google.gerrit.common.TimeUtil.nowMs()) - start; com.google.gerrit.httpd.raw.BuckUtils.log.info(java.lang.String.format("UPDATED %s in %.3fs", label.fullName(), (time / 1000.0))); }
@java.lang.Override public void setUp() throws java.lang.Exception { super.setUp(); final com.google.gerrit.common.data.ApprovalTypes types = new com.google.gerrit.common.data.ApprovalTypes(java.util.Arrays.asList(com.google.gerrit.rules.common.CommonRulesTest.codeReviewCategory(), com.google.gerrit.rules.common.CommonRulesTest.verifiedCategory())); load("common_rules_test.pl", new com.google.inject.AbstractModule() { @java.lang.Override protected void configure() { bind(com.google.gerrit.common.data.ApprovalTypes.class).toInstance(types); } }); }
@java.lang.Override public java.util.List<java.lang.String> queryChangeEvents(java.lang.String query) throws com.ericsson.gerrit.plugins.eventslog.MalformedQueryException, com.ericsson.gerrit.plugins.eventslog.ServiceUnavailableException { if (!(online)) { throw new com.ericsson.gerrit.plugins.eventslog.ServiceUnavailableException(); } java.util.List<java.lang.String> events = new java.util.ArrayList<>(); java.util.List<com.ericsson.gerrit.plugins.eventslog.SQLClient.SQLEntry> entries = new java.util.ArrayList<>(); com.google.gerrit.reviewdb.client.Project.NameKey project = null; for (java.util.Map.Entry<java.lang.String, java.util.Collection<com.ericsson.gerrit.plugins.eventslog.SQLClient.SQLEntry>> entry : eventsDb.getEvents(query).asMap().entrySet()) { try { project = new com.google.gerrit.reviewdb.client.Project.NameKey(entry.getKey()); if (projectControlFactory.controlFor(project, userProvider.get()).isVisible()) { entries.addAll(entry.getValue()); } } catch (com.google.gerrit.server.project.NoSuchProjectException e) { com.ericsson.gerrit.plugins.eventslog.SQLStore.log.warn((("Database contains a non-existing project, " + (project.get())) + ", removing project from database"), e); removeProjectEvents(project.get()); } catch (java.io.IOException e) { com.ericsson.gerrit.plugins.eventslog.SQLStore.log.warn((("Cannot get project visibility info for " + (project.get())) + " from cache"), e); } } java.util.Collections.sort(entries); for (com.ericsson.gerrit.plugins.eventslog.SQLClient.SQLEntry entry : entries) { events.add(entry.getEvent()); } return events; }
private static com.google.gerrit.plugin.client.rpc.RestApi change(int id) { return new com.google.gerrit.plugin.client.rpc.RestApi("/changes/").id(id); }
@java.lang.Override public void onDialogVisible(com.google.gwtexpui.user.client.DialogVisibleEvent event) { if (event.contains(this)) { if (event.isVisible()) { swf.getStyle().setVisibility(com.google.gwtexpui.clippy.client.VISIBLE); } } else { swf.getStyle().setVisibility((event.isVisible() ? HIDDEN : VISIBLE)); } }
private static java.sql.Timestamp timeForReadOnlyCheck(long skewMs) { return new java.sql.Timestamp(((com.google.gerrit.common.TimeUtil.nowMs()) - skewMs)); }
final java.util.List<com.google.gwtexpui.safehtml.client.FindReplace> commentlinks() { com.google.gwt.core.client.JsArray<com.google.gerrit.client.projects.ConfigInfo.CommentLinkInfo> cls = commentlinks0().values(); java.util.List<com.google.gwtexpui.safehtml.client.FindReplace> commentLinks = new java.util.ArrayList<com.google.gwtexpui.safehtml.client.FindReplace>(cls.length()); for (int i = 0; i < (cls.length()); i++) { com.google.gerrit.client.projects.ConfigInfo.CommentLinkInfo cl = cls.get(i); if (!(cl.enabled())) { continue; } if ((cl.link()) != null) { commentLinks.add(new com.google.gwtexpui.safehtml.client.LinkFindReplace(cl.match(), cl.link())); } else { commentLinks.add(new com.google.gwtexpui.safehtml.client.RawFindReplace(cl.match(), cl.html())); } } return commentLinks; }
@java.lang.Override public void run() { try (java.io.BufferedReader br = new java.io.BufferedReader(new java.io.InputStreamReader(in, "ISO-8859-1"))) { java.lang.String line; while ((line = br.readLine()) != null) { com.google.gerrit.httpd.gitweb.GitwebServlet.log.error(("CGI: " + line)); } } catch (java.io.IOException e) { com.google.gerrit.httpd.gitweb.GitwebServlet.log.debug("Unexpected error copying stderr from CGI", e); } }
@java.lang.SuppressWarnings("deprecation") private final org.bouncycastle.openpgp.PGPEncryptedDataGenerator cpk() throws java.security.NoSuchProviderException, org.bouncycastle.openpgp.PGPException { org.bouncycastle.openpgp.PGPEncryptedDataGenerator cpk = new org.bouncycastle.openpgp.PGPEncryptedDataGenerator(org.bouncycastle.openpgp.PGPEncryptedData.CAST5, true, prng, "BC"); cpk.addMethod(dest); return cpk; }
private java.util.Map<java.lang.String, com.google.gerrit.server.dashboard.ListDashboards.DashboardInfo> addProjectDashboards(final com.google.gerrit.server.project.ProjectState projectState, java.util.Map<java.lang.String, com.google.gerrit.server.dashboard.ListDashboards.DashboardInfo> all, final java.lang.String defaultId) { final java.util.Map<java.lang.String, com.google.gerrit.server.dashboard.ListDashboards.DashboardInfo> dashboards = projectDashboards(projectState, defaultId); dashboards.putAll(all); return dashboards; }
public java.util.List<com.google.gerrit.server.ReviewerStatusUpdate> reviewerUpdates() throws com.google.gwtorm.server.OrmException { if ((reviewerUpdates) == null) { if (!(lazyLoad)) { return java.util.Collections.emptyList(); } reviewerUpdates = approvalsUtil.getReviewerUpdates(notes()); } return reviewerUpdates; }
@java.lang.Override public com.google.gerrit.reviewdb.server.ReviewDb open() throws com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.server.ReviewDb db = delegate.open(); if ((migration.readChanges()) && (migration.disableChangeReviewDb())) { db = new com.google.gerrit.server.schema.NoChangesReviewDbWrapper(db); } if ((groupsMigration.readFromNoteDb()) && (groupsMigration.disableGroupReviewDb())) { db = new com.google.gerrit.server.schema.NoGroupsReviewDbWrapper(db); } if (migration.readChanges()) { db = new com.google.gerrit.reviewdb.server.DisallowReadFromChangesReviewDbWrapper(db); } if (groupsMigration.readFromNoteDb()) { db = new com.google.gerrit.reviewdb.server.DisallowReadFromGroupsReviewDbWrapper(db); } return db; }
@java.lang.Override public com.google.gerrit.server.change.Description getDescription(com.google.gerrit.server.change.ChangeResource rsrc) { return new com.google.gerrit.extensions.webui.UiAction.Description().setLabel("Mark Unreviewed").setTitle("Mark the change as unreviewed to highlight it in the dashboard").setVisible(isReviewed(rsrc)); }
private Account.Id createAccountOutsideRequestContext(java.lang.String username, java.lang.String fullName, java.lang.String email, boolean active) throws java.lang.Exception { try (com.google.gerrit.server.util.ManualRequestContext ctx = oneOffRequestContext.open()) { com.google.gerrit.reviewdb.client.Account.Id id = accountManager.authenticate(com.google.gerrit.server.account.AuthRequest.forUser(username)).getAccountId(); if (email != null) { accountManager.link(id, com.google.gerrit.server.account.AuthRequest.forEmail(email)); } accountsUpdate.create().update(id, ( u) -> { u.setFullName(fullName).setPreferredEmail(email).setActive(active); }); return id; } }
@java.lang.Override public com.google.gerrit.extensions.common.PureRevertInfo pureRevert() throws com.google.gerrit.extensions.restapi.RestApiException { return pureRevert(null); }
@org.junit.Test public void testVerifyAuthInfo() throws java.lang.Exception { com.googlesource.gerrit.plugins.lfs.AuthInfo info = auth.generateAuthInfo("o", zeroId(), java.time.Instant.now(), 1L); assertThat(auth.verifyAuthInfo(info.authToken(), "o", zeroId())).isTrue(); }
@java.lang.Override public void onSuggestionsReady(com.google.gerrit.client.ui.Request req, com.google.gerrit.client.ui.Response res) { if ((query) == (this)) { query = null; callback.onSuggestionsReady(req, res); } else { query.start(); } }
@java.lang.Override protected void onLoad() throws java.io.IOException, org.eclipse.jgit.errors.ConfigInvalidException { org.eclipse.jgit.lib.ObjectId rev = getRevision(); if (rev == null) { loadDefaults(); return; } org.eclipse.jgit.revwalk.RevWalk walk = new org.eclipse.jgit.revwalk.RevWalk(reader); try { com.google.gerrit.server.notedb.ChangeNotes.Parser parser = new com.google.gerrit.server.notedb.ChangeNotes.Parser(change, rev, walk, repoManager); parser.parseAll(); if ((parser.status) != null) { change.setStatus(parser.status); } approvals = parser.buildApprovals(); changeMessages = parser.buildMessages(); commentsForBase = com.google.common.collect.ImmutableListMultimap.copyOf(parser.commentsForBase); commentsForPS = com.google.common.collect.ImmutableListMultimap.copyOf(parser.commentsForPs); noteMap = parser.commentNoteMap; ImmutableSetMultimap.Builder<com.google.gerrit.server.notedb.ReviewerState, com.google.gerrit.reviewdb.client.Account.Id> reviewers = com.google.common.collect.ImmutableSetMultimap.builder(); for (java.util.Map.Entry<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.server.notedb.ReviewerState> e : parser.reviewers.entrySet()) { reviewers.put(e.getValue(), e.getKey()); } this.reviewers = reviewers.build(); submitRecords = com.google.common.collect.ImmutableList.copyOf(parser.submitRecords); } catch (java.text.ParseException e1) { throw new java.io.IOException(e1); } finally { walk.release(); } }
static org.apache.lucene.index.Term idTerm(com.google.gerrit.reviewdb.client.Change.Id id) { return com.google.gerrit.lucene.QueryBuilder.intTerm(com.google.gerrit.lucene.LEGACY_ID.getName(), id.get()); }
@java.lang.Override public void onLoad(final com.google.gerrit.plugin.client.screen.Screen screen) { java.lang.String input = screen.getToken(1); java.lang.String[] patchsetId = input.split("/"); final java.lang.String changeNumber = patchsetId[0]; final java.lang.String revisionNumber = patchsetId[1]; screen.setPageTitle(("Report History for Change " + input)); screen.show(new com.googlesource.gerrit.plugins.verifystatus.client.JobsScreen(changeNumber, revisionNumber)); }
@java.lang.Override public java.lang.Object apply(com.google.gerrit.server.account.AccountResource rsrc, com.google.gerrit.server.account.DeleteActive.Input input) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException { com.google.gerrit.reviewdb.client.Account a = dbProvider.get().accounts().get(rsrc.getUser().getAccountId()); if (a == null) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException("account not found"); } if (!(a.isActive())) { throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(); } a.setActive(false); dbProvider.get().accounts().update(java.util.Collections.singleton(a)); byIdCache.evict(a.getId()); return com.google.gerrit.extensions.restapi.Response.none(); }
public void onClick(com.google.gwt.user.client.ui.Widget sender) { sendButton.setEnabled(false); PatchUtil.DETAIL_SVC.abandonChange(psid, message.getText().trim(), new com.google.gerrit.client.rpc.GerritCallback<com.google.gwtjsonrpc.client.VoidResult>() { public void onSuccess(com.google.gwtjsonrpc.client.VoidResult result) { if ((appCallback) != null) { appCallback.onSuccess(null); } hide(); } @java.lang.Override public void onFailure(java.lang.Throwable caught) { sendButton.setEnabled(true); super.onFailure(caught); } }); }
private void assertMail(com.google.gerrit.server.mail.receive.MailMessage have, com.google.gerrit.server.mail.receive.MailMessage want) { assertThat(have.id()).isEqualTo(want.id()); assertThat(have.to()).isEqualTo(want.to()); assertThat(have.from()).isEqualTo(want.from()); assertThat(have.cc()).isEqualTo(want.cc()); assertThat(have.dateReceived().getMillis()).isEqualTo(want.dateReceived().getMillis()); assertThat(have.additionalHeaders()).isEqualTo(want.additionalHeaders()); assertThat(have.subject()).isEqualTo(want.subject()); assertThat(have.textContent()).isEqualTo(want.textContent()); assertThat(have.htmlContent()).isEqualTo(want.htmlContent()); }
@java.lang.Override public void onKeyDown(final com.google.gwt.event.dom.client.KeyDownEvent e) { on(e); }
@java.lang.Override public com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> create(com.google.gerrit.server.query.change.ChangeQueryBuilder builder, java.lang.String value) throws com.google.gerrit.server.query.QueryParseException { return new com.googlesource.gerrit.plugins.cookbook.SampleOperator.MyPredicate(Change.Id.parse(value)); }
private <T extends com.google.gwt.core.client.JavaScriptObject> void resendPost(final com.google.gwtjsonrpc.common.AsyncCallback<T> cb, java.lang.String token) { com.google.gwt.http.client.RequestBuilder req = new com.google.gwt.http.client.RequestBuilder(com.google.gwt.http.client.RequestBuilder.POST, url.toString()); req.setHeader("Accept", JsonConstants.JSON_TYPE); req.setHeader("Content-Type", JsonConstants.JSON_TYPE); req.setRequestData(token); req.setCallback(new com.google.gerrit.client.rpc.RestApi.MyRequestCallback<T>(false, cb)); try { req.send(); } catch (com.google.gwt.http.client.RequestException e) { RpcStatus.INSTANCE.onRpcComplete(); cb.onFailure(e); } }
void onExecute(com.google.gerrit.sshd.DispatchCommand dcmd, int exitValue, com.google.gerrit.sshd.SshSession sshSession) { final com.google.gerrit.sshd.SshScope.Context ctx = context.get(); ctx.finished = com.google.gerrit.common.TimeUtil.nowMs(); java.lang.String cmd = extractWhat(dcmd, true); final org.apache.log4j.spi.LoggingEvent event = log(cmd); event.setProperty(com.google.gerrit.sshd.SshLog.P_WAIT, (((ctx.started) - (ctx.created)) + "ms")); event.setProperty(com.google.gerrit.sshd.SshLog.P_EXEC, (((ctx.finished) - (ctx.started)) + "ms")); final java.lang.String status; switch (exitValue) { case BaseCommand.STATUS_CANCEL : status = "killed"; break; case BaseCommand.STATUS_NOT_FOUND : status = "not-found"; break; case BaseCommand.STATUS_NOT_ADMIN : status = "not-admin"; break; default : status = java.lang.String.valueOf(exitValue); break; } event.setProperty(com.google.gerrit.sshd.SshLog.P_STATUS, status); java.lang.String peerAgent = sshSession.getPeerAgent(); if (peerAgent != null) { event.setProperty(com.google.gerrit.sshd.SshLog.P_AGENT, peerAgent); } if ((async) != null) { async.append(event); } if (!(auditMask)) { cmd = extractWhat(dcmd, false); } audit(ctx, status, cmd, extractParameters(dcmd)); }
public com.google.gerrit.server.project.RefFilter<T> subString(java.lang.String subString) { this.matchSubstring = subString; return this; }
@org.junit.Test public void getExternalIds() throws java.lang.Exception { java.util.Collection<com.google.gerrit.server.account.externalids.ExternalId> expectedIds = getAccountState(user.getId()).getExternalIds(); java.util.List<com.google.gerrit.extensions.common.AccountExternalIdInfo> expectedIdInfos = toExternalIdInfos(expectedIds); com.google.gerrit.acceptance.RestResponse response = userRestSession.get("/accounts/self/external.ids"); response.assertOK(); java.util.List<com.google.gerrit.extensions.common.AccountExternalIdInfo> results = newGson().fromJson(response.getReader(), new com.google.gson.reflect.TypeToken<java.util.List<com.google.gerrit.extensions.common.AccountExternalIdInfo>>() {}.getType()); java.util.Collections.sort(expectedIdInfos); java.util.Collections.sort(results); assertThat(results).containsExactlyElementsIn(expectedIdInfos); }
private java.util.List<com.google.gerrit.extensions.common.CommentInfo> getRevisionComments(java.lang.String changeId, java.lang.String revId) throws java.lang.Exception { return getPublishedComments(changeId, revId).values().stream().flatMap(java.util.List::stream).collect(java.util.stream.Collectors.toList()); }
private static void addRewrites(com.google.common.collect.ListMultimap<java.lang.String, com.google.gerrit.server.notedb.NoteDbRewriter> rewriters, com.google.gerrit.server.notedb.NoteDbUpdateManager.OpenRepo openRepo) throws com.google.gwtorm.server.OrmException, java.io.IOException { for (java.util.Map.Entry<java.lang.String, java.util.Collection<com.google.gerrit.server.notedb.NoteDbRewriter>> entry : rewriters.asMap().entrySet()) { java.lang.String refName = entry.getKey(); org.eclipse.jgit.lib.ObjectId oldTip = openRepo.cmds.get(refName).orElse(org.eclipse.jgit.lib.ObjectId.zeroId()); if (oldTip.equals(org.eclipse.jgit.lib.ObjectId.zeroId())) { throw new com.google.gwtorm.server.OrmException(java.lang.String.format("Ref %s is empty", refName)); } org.eclipse.jgit.lib.ObjectId currTip = oldTip; try { for (com.google.gerrit.server.notedb.NoteDbRewriter noteDbRewriter : entry.getValue()) { org.eclipse.jgit.lib.ObjectId nextTip = noteDbRewriter.rewriteCommitHistory(openRepo.rw, openRepo.tempIns, currTip); if (nextTip != null) { currTip = nextTip; } } } catch (org.eclipse.jgit.errors.ConfigInvalidException e) { throw new com.google.gwtorm.server.OrmException("Cannot rewrite commit history", e); } if (!(oldTip.equals(currTip))) { openRepo.cmds.add(new org.eclipse.jgit.transport.ReceiveCommand(oldTip, currTip, refName)); } } }
@org.junit.Test public void byHashtagWithNotedb() throws java.lang.Exception { assume().that(notesMigration.enabled()).isTrue(); java.util.List<com.google.gerrit.reviewdb.client.Change> changes = setUpHashtagChanges(); java.util.List<com.google.gerrit.extensions.common.ChangeInfo> results = query("hashtag:foo"); assertThat(results).hasSize(2); assertResultEquals(changes.get(1), results.get(0)); assertResultEquals(changes.get(0), results.get(1)); assertResultEquals(changes.get(1), queryOne("hashtag:bar")); assertResultEquals(changes.get(1), queryOne("hashtag:\"a tag\"")); assertResultEquals(changes.get(1), queryOne("hashtag:\"a tag \"")); assertResultEquals(changes.get(1), queryOne("hashtag:\" a tag \"")); assertResultEquals(changes.get(1), queryOne("hashtag:\"#a tag\"")); assertResultEquals(changes.get(1), queryOne("hashtag:\"# #a tag\"")); }
public java.util.List<com.google.gerrit.server.git.CodeReviewCommit> sort(java.util.Collection<com.google.gerrit.server.git.CodeReviewCommit> incoming) throws java.io.IOException { final java.util.List<com.google.gerrit.server.git.CodeReviewCommit> sorted = new java.util.ArrayList<>(); final java.util.Set<com.google.gerrit.server.git.CodeReviewCommit> sort = new java.util.HashSet(incoming); while (!(sort.isEmpty())) { final com.google.gerrit.server.git.CodeReviewCommit n = com.google.gerrit.server.git.RebaseSorter.removeOne(sort); rw.resetRetain(canMergeFlag); rw.markStart(n); if ((initialTip) != null) { rw.markUninteresting(initialTip); } com.google.gerrit.server.git.CodeReviewCommit c; final java.util.List<com.google.gerrit.server.git.CodeReviewCommit> contents = new java.util.ArrayList<>(); while ((c = rw.next()) != null) { if ((!(c.has(canMergeFlag))) || (!(incoming.contains(c)))) { if ((n.missing) == null) { n.setStatusCode(CommitMergeStatus.MISSING_DEPENDENCY); n.missing = new java.util.ArrayList(); } n.missing.add(c); } else { contents.add(c); } } if ((n.getStatusCode()) == (com.google.gerrit.server.git.strategy.CommitMergeStatus.MISSING_DEPENDENCY)) { continue; } sort.removeAll(contents); java.util.Collections.reverse(contents); sorted.removeAll(contents); sorted.addAll(contents); } return sorted; }
public void fire(com.google.gerrit.reviewdb.client.Change change, com.google.gerrit.reviewdb.client.PatchSet patchSet, java.util.List<com.google.gerrit.reviewdb.client.Account.Id> reviewers, com.google.gerrit.reviewdb.client.Account adder, java.sql.Timestamp when) { if ((!(listeners.iterator().hasNext())) || (reviewers.isEmpty())) { return; } java.util.List<com.google.gerrit.extensions.common.AccountInfo> transformed = com.google.common.collect.Lists.transform(reviewers, new com.google.common.base.Function<com.google.gerrit.reviewdb.client.Account.Id, com.google.gerrit.extensions.common.AccountInfo>() { @java.lang.Override public com.google.gerrit.extensions.common.AccountInfo apply(com.google.gerrit.reviewdb.client.Account.Id account) { return util.accountInfo(account); } }); try { fire(util.changeInfo(change), util.revisionInfo(change.getProject(), patchSet), transformed, util.accountInfo(adder), when); } catch (com.google.gerrit.server.patch.PatchListNotAvailableException | com.google.gerrit.server.GpgException | java.io.IOException | com.google.gwtorm.server.OrmException e) { com.google.gerrit.server.extensions.events.ReviewerAdded.log.error("Couldn't fire event", e); } }
public static java.lang.String describe(com.google.gerrit.server.CurrentUser user) { if (user.isIdentifiedUser()) { return user.getAccountId().toString(); } if (user instanceof com.google.gerrit.server.query.change.SingleGroupUser) { return "group:" + (user.getEffectiveGroups().getKnownGroups().iterator().next().toString()); } return user.toString(); }
private void refreshKeys() { com.google.gerrit.client.account.AccountApi.self().view("gpgkeys").get(com.google.gerrit.client.rpc.NativeMap.copyKeysIntoChildren("id", new com.google.gerrit.client.rpc.GerritCallback<com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.account.GpgKeyInfo>>() { @java.lang.Override public void onSuccess(com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.account.GpgKeyInfo> result) { java.util.List<com.google.gerrit.client.account.GpgKeyInfo> list = com.google.gerrit.client.rpc.Natives.asList(result.values()); java.util.Collections.sort(list, new java.util.Comparator<com.google.gerrit.client.account.GpgKeyInfo>() { @java.lang.Override public int compare(com.google.gerrit.client.account.GpgKeyInfo a, com.google.gerrit.client.account.GpgKeyInfo b) { return a.id().compareTo(b.id()); } }); keys.clear(); keyText.setText(""); errorPanel.setVisible(false); addButton.setEnabled(true); if (!(list.isEmpty())) { keys.setVisible(true); for (com.google.gerrit.client.account.GpgKeyInfo k : list) { keys.addOneKey(k); } showKeyTable(true); showAddKeyBlock(false); } else { keys.setVisible(false); showAddKeyBlock(true); showKeyTable(false); } display(); } })); }
private void showDoc(javax.servlet.http.HttpServletRequest req, javax.servlet.http.HttpServletResponse res, com.google.gitiles.GitilesView view, org.pegdown.ast.RootNode nav, org.pegdown.ast.RootNode doc) throws java.io.IOException { java.util.Map<java.lang.String, java.lang.Object> data = new java.util.HashMap<>(); data.put("pageTitle", com.google.common.base.MoreObjects.firstNonNull(com.google.gitiles.doc.MarkdownHelper.getTitle(doc), view.getPathPart())); data.put("sourceUrl", com.google.gitiles.GitilesView.path().copyFrom(view).toUrl()); data.put("logUrl", com.google.gitiles.GitilesView.log().copyFrom(view).toUrl()); data.put("blameUrl", com.google.gitiles.GitilesView.blame().copyFrom(view).toUrl()); data.put("navbarHtml", new com.google.gitiles.doc.MarkdownToHtml(view).toSoyHtml(nav)); data.put("bodyHtml", new com.google.gitiles.doc.MarkdownToHtml(view).toSoyHtml(doc)); java.lang.String page = renderer.render(com.google.gitiles.doc.DocServlet.SOY_TEMPLATE, data); byte[] raw = page.getBytes(java.nio.charset.StandardCharsets.UTF_8); res.setContentType(FormatType.HTML.getMimeType()); res.setCharacterEncoding(java.nio.charset.StandardCharsets.UTF_8.name()); setCacheHeaders(res); if (acceptsGzipEncoding(req)) { res.setHeader(HttpHeaders.CONTENT_ENCODING, "gzip"); raw = gzip(raw); } res.setContentLength(raw.length); res.setStatus(HttpServletResponse.SC_OK); res.getOutputStream().write(raw); }
public java.util.List<com.google.gerrit.common.data.SubmitRecord> canSubmit() { java.util.List<com.googlecode.prolog_cafe.lang.Term> results; try { results = evaluateImpl("locate_submit_rule", "can_submit", "locate_submit_filter", "filter_submit_results"); } catch (com.google.gerrit.server.project.RuleEvalException e) { return ruleError(e.getMessage(), e); } if (results.isEmpty()) { return ruleError(java.lang.String.format(("Submit rule '%s' for change %s of %s has " + "no solution."), getSubmitRule(), cd.getId(), getProjectName())); } return resultsToSubmitRecord(getSubmitRule(), results); }
public final java.util.List<java.lang.String> archives() { java.util.List<java.lang.String> archives = new java.util.ArrayList<>(); for (java.lang.String f : com.google.gerrit.client.rpc.Natives.asList(_archives())) { archives.add(f); } return archives; }
@org.junit.Before public void setUp() throws java.lang.Exception { SitePaths sitePaths = new SitePaths(com.google.gerrit.testutil.TempFileUtil.createTempDirectory().toPath()); sitePath = sitePaths.site_path.toString(); gerritConfig = new org.eclipse.jgit.storage.file.FileBasedConfig(sitePaths.gerrit_config.toFile(), org.eclipse.jgit.util.FS.detect()); }
@java.lang.Override public java.lang.String generate(com.google.gwt.core.ext.TreeLogger logger, com.google.gwt.core.ext.GeneratorContext context, java.lang.String typeName) throws com.google.gwt.core.ext.UnableToCompleteException { com.google.gwt.core.ext.typeinfo.TypeOracle typeOracle = context.getTypeOracle(); com.google.gwt.core.ext.typeinfo.JClassType sourceType = typeOracle.findType(typeName); if (sourceType == null) { logger.log(TreeLogger.ERROR, "Could not find requested typeName", null); throw new com.google.gwt.core.ext.UnableToCompleteException(); } validateType(logger, sourceType); java.lang.String generatedSimpleSourceName = (sourceType.getSimpleSourceName()) + "PluginImpl"; com.google.gwt.user.rebind.ClassSourceFileComposerFactory f = new com.google.gwt.user.rebind.ClassSourceFileComposerFactory(sourceType.getPackage().getName(), generatedSimpleSourceName); f.addImport(com.google.gwt.core.client.GWT.class.getName()); f.setSuperclass(typeName); java.io.PrintWriter out = context.tryCreate(logger, sourceType.getPackage().getName(), generatedSimpleSourceName); if (out != null) { com.google.gwt.user.rebind.SourceWriter sw = f.createSourceWriter(context, out); sw.println((("public " + generatedSimpleSourceName) + "() {")); sw.indent(); sw.println("onModuleLoad();"); sw.outdent(); sw.println("}"); sw.commit(logger); } return f.getCreatedClassName(); }
@java.lang.SuppressWarnings("rawtypes") @java.lang.Override protected void configure() { bind(com.google.gerrit.reviewdb.server.ReviewDb.class).toProvider(new com.google.inject.Provider<com.google.gerrit.reviewdb.server.ReviewDb>() { @java.lang.Override public com.google.gerrit.reviewdb.server.ReviewDb get() { return dbRef.get(); } }); bind(new com.google.inject.TypeLiteral<com.google.gerrit.extensions.registration.DynamicSet<com.google.gerrit.server.cache.CacheRemovalListener>>() {}).toInstance(com.google.gerrit.extensions.registration.DynamicSet.<com.google.gerrit.server.cache.CacheRemovalListener>emptySet()); install(new com.google.gerrit.server.cache.h2.DefaultCacheFactory.Module()); }
private static boolean isLdapUUID(com.google.gerrit.reviewdb.client.AccountGroup.UUID uuid) { return uuid.get().startsWith(com.google.gerrit.server.auth.ldap.Helper.LDAP_UUID); }
@java.lang.Override public com.google.gerrit.extensions.restapi.Response<?> apply(com.google.gerrit.server.project.BranchResource rsrc, com.google.gerrit.server.project.DeleteBranch.Input input) throws com.google.gerrit.extensions.restapi.RestApiException, com.google.gwtorm.server.OrmException, java.io.IOException { if (!(rsrc.getControl().controlForRef(rsrc.getBranchKey()).canDelete())) { throw new com.google.gerrit.extensions.restapi.AuthException("Cannot delete branch"); } if (!(queryProvider.get().setLimit(1).byBranchOpen(rsrc.getBranchKey()).isEmpty())) { throw new com.google.gerrit.extensions.restapi.ResourceConflictException((("branch " + (rsrc.getBranchKey())) + " has open changes")); } deleteRefFactory.create(rsrc).ref(rsrc.getRef()).delete(); return com.google.gerrit.extensions.restapi.Response.none(); }
private void update(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.account.AuthRequest who, com.google.gerrit.reviewdb.client.AccountExternalId extId) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.IdentifiedUser user = userFactory.create(extId.getAccountId()); com.google.gerrit.reviewdb.client.Account toUpdate = null; java.lang.String newEmail = who.getEmailAddress(); java.lang.String oldEmail = extId.getEmailAddress(); if ((newEmail != null) && (!(newEmail.equals(oldEmail)))) { if ((oldEmail != null) && (oldEmail.equals(user.getAccount().getPreferredEmail()))) { toUpdate = load(toUpdate, user.getAccountId(), db); toUpdate.setPreferredEmail(newEmail); } extId.setEmailAddress(newEmail); db.accountExternalIds().update(java.util.Collections.singleton(extId)); } if (((!(realm.allowsEdit(Account.FieldName.FULL_NAME))) && (!(com.google.common.base.Strings.isNullOrEmpty(who.getDisplayName())))) && (!(com.google.gerrit.server.account.AccountManager.eq(user.getAccount().getFullName(), who.getDisplayName())))) { toUpdate = load(toUpdate, user.getAccountId(), db); toUpdate.setFullName(who.getDisplayName()); } if ((!(realm.allowsEdit(Account.FieldName.USER_NAME))) && (!(com.google.gerrit.server.account.AccountManager.eq(user.getUserName(), who.getUserName())))) { changeUserNameFactory.create(db, user, who.getUserName()); } if (toUpdate != null) { db.accounts().update(java.util.Collections.singleton(toUpdate)); } if ((newEmail != null) && (!(newEmail.equals(oldEmail)))) { byEmailCache.evict(oldEmail); byEmailCache.evict(newEmail); } if (toUpdate != null) { byIdCache.evict(toUpdate.getId()); } }
private java.lang.String getLine(com.google.gerrit.server.diff.PatchFile fileInfo, short side, int lineNbr) { try { return fileInfo.getLine(side, lineNbr); } catch (java.io.IOException err) { com.google.gerrit.server.mail.send.CommentSender.log.warn(java.lang.String.format("Failed to read file on side %d", side), err); return ""; } catch (java.lang.IndexOutOfBoundsException err) { com.google.gerrit.server.mail.send.CommentSender.log.debug(java.lang.String.format("Failed to get line number of file on side %d", side), err); return ""; } catch (com.google.gerrit.common.errors.NoSuchEntityException err) { com.google.gerrit.server.mail.send.CommentSender.log.warn(java.lang.String.format("Side %d of file didn't exist", side), err); return ""; } }
java.lang.String projectListOpen();
public boolean canSeeMember(com.google.gerrit.reviewdb.Account.Id id) { return isVisible(); }
public boolean isIdentifiedUser() { return false; }
@java.lang.Override public AccountResource.StarredChange parse(com.google.gerrit.server.account.AccountResource parent, com.google.gerrit.extensions.restapi.IdString id) throws com.google.gerrit.extensions.restapi.ResourceNotFoundException, com.google.gwtorm.server.OrmException { com.google.gerrit.server.IdentifiedUser user = parent.getUser(); try { user.asyncStarredChanges(); com.google.gerrit.server.change.ChangeResource change = changes.parse(TopLevelResource.INSTANCE, id); if (user.getStarredChanges().contains(change.getId())) { return new com.google.gerrit.server.account.AccountResource.StarredChange(user, change); } throw new com.google.gerrit.extensions.restapi.ResourceNotFoundException(id); } finally { user.abortStarredChanges(); } }
private void evictCache(com.google.common.cache.Cache<?, ?> cache, java.lang.String cacheName, java.lang.Object key) { if (Constants.PROJECT_LIST.equals(cacheName)) { cache.invalidateAll(); com.ericsson.gerrit.plugins.highavailability.forwarder.rest.CacheRestApiServlet.logger.debug("Invalidated cache {}", cacheName); } else { cache.invalidate(key); com.ericsson.gerrit.plugins.highavailability.forwarder.rest.CacheRestApiServlet.logger.debug("Invalidated cache {}[{}]", cacheName, key); } }
private static boolean isInteger(java.lang.Class<?> t) { return ((java.lang.Integer.class) == t) || ((int.class) == t); }
@java.lang.Override public com.googlesource.gerrit.plugins.lfs.LfsProjectConfigInfo apply(com.google.gerrit.server.project.ProjectResource resource) throws com.google.gerrit.extensions.restapi.RestApiException { com.googlesource.gerrit.plugins.lfs.LfsProjectConfigInfo info = new com.googlesource.gerrit.plugins.lfs.LfsProjectConfigInfo(); com.googlesource.gerrit.plugins.lfs.LfsProjectConfigSection config = lfsConfigFactory.getProjectsConfig().getForProject(resource.getNameKey()); if (config != null) { info.enabled = config.isEnabled(); info.maxObjectSize = config.getMaxObjectSize(); } return info; }
@java.lang.Override protected void migrateData(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.server.schema.UpdateUI ui) throws com.google.gwtorm.server.OrmException { com.google.gerrit.server.schema.Schema_159.DraftWorkflowMigrationStrategy strategy = com.google.gerrit.server.schema.Schema_159.DraftWorkflowMigrationStrategy.WORK_IN_PROGRESS; if (ui.yesno(false, "Migrate draft changes to private changes (default is work-in-progress)")) { strategy = com.google.gerrit.server.schema.Schema_159.DraftWorkflowMigrationStrategy.PRIVATE; } ui.message(java.lang.String.format("Replace draft changes with %s changes ...", strategy.name().toLowerCase())); try (com.google.gwtorm.server.StatementExecutor e = newExecutor(db)) { java.lang.String column = (strategy == (com.google.gerrit.server.schema.Schema_159.DraftWorkflowMigrationStrategy.PRIVATE)) ? "is_private" : "work_in_progress"; e.execute(java.lang.String.format(("UPDATE changes " + ((((((((("SET %s = 'Y', " + " status = 'n', ") + " created_on = created_on ") + "WHERE status = 'd' ") + " OR (status = 'n' ") + " AND EXISTS ") + " (SELECT * ") + " FROM patch_sets ") + " WHERE patch_sets.change_id = changes.change_id ") + " AND patch_sets.draft = 'Y')) ")), column)); } ui.message("done"); }
@java.lang.Override public java.util.Collection<com.google.gerrit.common.data.GroupReference> suggest(java.lang.String name, com.google.gerrit.server.project.ProjectControl project) { java.util.Set<com.google.gerrit.common.data.GroupReference> groups = com.google.common.collect.Sets.newTreeSet(com.google.gerrit.server.account.GroupBackends.GROUP_REF_NAME_COMPARATOR); for (com.google.gerrit.server.account.GroupBackend g : backends) { groups.addAll(g.suggest(name, project)); } return groups; }
public static byte[] asByteArray(org.eclipse.jgit.lib.ObjectLoader ldr) throws java.io.IOException, org.eclipse.jgit.errors.LargeObjectException, org.eclipse.jgit.errors.MissingObjectException { return ldr.getCachedBytes(com.google.gerrit.server.diff.Text.bigFileThreshold); }
private static com.google.gerrit.server.diff.PatchListEntry createPatchListEntry(org.eclipse.jgit.diff.RawTextComparator cmp, org.eclipse.jgit.revwalk.RevCommit aCommit, com.google.gerrit.server.diff.Text aText, com.google.gerrit.server.diff.Text bText, java.lang.String fileName) { byte[] rawHdr = com.google.gerrit.server.patch.PatchListLoader.getRawHeader((aCommit != null), fileName); byte[] aContent = aText.getContent(); byte[] bContent = bText.getContent(); long size = bContent.length; long sizeDelta = (bContent.length) - (aContent.length); org.eclipse.jgit.diff.RawText aRawText = new org.eclipse.jgit.diff.RawText(aContent); org.eclipse.jgit.diff.RawText bRawText = new org.eclipse.jgit.diff.RawText(bContent); org.eclipse.jgit.diff.EditList edits = new org.eclipse.jgit.diff.HistogramDiff().diff(cmp, aRawText, bRawText); org.eclipse.jgit.patch.FileHeader fh = new org.eclipse.jgit.patch.FileHeader(rawHdr, edits, org.eclipse.jgit.patch.FileHeader.PatchType.UNIFIED); return new com.google.gerrit.server.diff.PatchListEntry(fh, edits, com.google.common.collect.ImmutableSet.of(), size, sizeDelta); }
@java.lang.Override public com.google.gerrit.extensions.registration.DynamicMap<com.google.gerrit.extensions.restapi.RestView<com.google.gerrit.server.change.RobotCommentResource>> views() { return views; }
protected boolean isAllProjects(com.google.gerrit.server.project.ProjectResource rsrc) { return rsrc.getControl().getProject().getNameKey().equals(allProjectsName); }
@org.junit.Test public void testGetAllRelations() throws java.lang.Exception { final com.google.gwtorm.data.PhoneBookDb schema = open(); com.google.gwtorm.server.Access<?, ?>[] all = schema.allRelations(); assertNotNull(all); assertEquals(2, all.length); assertSame(schema.people(), all[0]); assertSame(schema.addresses(), all[1]); }
private void applyMaxHeight() { int header = (getTabBar().getOffsetHeight()) + 2; for (int i = 0; i < (getTabBar().getTabCount()); i++) { tabs.get(i).setMaxHeight(((maxHeightWithHeader) - header)); } }
@java.lang.Override public java.util.Optional<com.googlesource.gerrit.plugins.webhooks.EventProcessor.Request> doProcess(com.google.gerrit.server.events.ProjectEvent event, com.googlesource.gerrit.plugins.webhooks.RemoteConfig remote) { return java.util.Optional.of(new com.googlesource.gerrit.plugins.webhooks.EventProcessor.Request(com.googlesource.gerrit.plugins.webhooks.processors.GerritEventProcessor.GSON.toJson(event))); }
private boolean canCompleteImport(com.google.gerrit.server.project.ProjectResource rsrc) { return (permissionBackend.user(currentUserProvider).testOrFalse(com.googlesource.gerrit.plugins.importer.ADMINISTRATE_SERVER)) || ((permissionBackend.user(currentUserProvider).testOrFalse(new com.google.gerrit.extensions.api.access.PluginPermission(pluginName, ImportCapability.ID))) && (rsrc.getControl().isOwner())); }
@java.lang.Override protected com.google.gerrit.server.git.MergeTip _run(com.google.gerrit.server.git.CodeReviewCommit branchTip, java.util.Collection<com.google.gerrit.server.git.CodeReviewCommit> toMerge) throws com.google.gerrit.server.git.IntegrationException { java.util.List<com.google.gerrit.server.git.CodeReviewCommit> sorted = args.mergeUtil.reduceToMinimalMerge(args.mergeSorter, toMerge); com.google.gerrit.server.git.MergeTip mergeTip; if (branchTip == null) { mergeTip = new com.google.gerrit.server.git.MergeTip(sorted.get(0), toMerge); sorted.remove(0); } else { mergeTip = new com.google.gerrit.server.git.MergeTip(branchTip, toMerge); } while (!(sorted.isEmpty())) { com.google.gerrit.server.git.CodeReviewCommit mergedFrom = sorted.remove(0); org.eclipse.jgit.lib.PersonIdent serverIdent = args.serverIdent.get(); org.eclipse.jgit.lib.PersonIdent caller = args.caller.newCommitterIdent(serverIdent.getWhen(), serverIdent.getTimeZone()); com.google.gerrit.server.git.CodeReviewCommit newTip = args.mergeUtil.mergeOneCommit(caller, serverIdent, args.repo, args.rw, args.inserter, args.canMergeFlag, args.destBranch, mergeTip.getCurrentTip(), mergedFrom); mergeTip.moveTipTo(newTip, mergedFrom); } args.mergeUtil.markCleanMerges(args.rw, args.canMergeFlag, mergeTip.getCurrentTip(), args.alreadyAccepted); setRefLogIdent(); return mergeTip; }
@java.lang.Override public boolean updateChange(com.google.gerrit.server.update.ChangeContext ctx) throws com.google.gerrit.extensions.restapi.ResourceConflictException, com.google.gerrit.extensions.restapi.UnprocessableEntityException, com.google.gwtorm.server.OrmException, java.io.IOException { user = ctx.getIdentifiedUser(); notes = ctx.getNotes(); ps = psUtil.get(ctx.getDb(), ctx.getNotes(), psId); boolean dirty = false; dirty |= insertComments(ctx); dirty |= insertRobotComments(ctx); dirty |= updateLabels(projectState, ctx); dirty |= insertMessage(ctx); return dirty; }
@java.lang.Override protected void onUnload() { super.onUnload(); if ((cm) != null) { cm.getWrapperElement().removeFromParent(); } if ((resizeHandler) != null) { resizeHandler.removeHandler(); } if ((closeHandler) != null) { closeHandler.removeHandler(); } com.google.gwt.user.client.Window.enableScrolling(true); com.google.gerrit.client.Gerrit.setHeaderVisible(true); com.google.gerrit.client.JumpKeys.enable(true); }
@org.junit.Test public void testKeywords() throws java.lang.Exception { try (org.eclipse.jgit.revwalk.RevWalk rw = new org.eclipse.jgit.revwalk.RevWalk(repo)) { org.eclipse.jgit.revwalk.RevCommit c = makeCommit(rw); com.googlesource.gerrit.plugins.uploadvalidator.BlockedKeywordValidator validator = new com.googlesource.gerrit.plugins.uploadvalidator.BlockedKeywordValidator(null, new com.googlesource.gerrit.plugins.uploadvalidator.ContentTypeUtil(com.googlesource.gerrit.plugins.uploadvalidator.TestUtils.PATTERN_CACHE), com.googlesource.gerrit.plugins.uploadvalidator.TestUtils.PATTERN_CACHE, null, null, null); java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> m = validator.performValidation(repo, c, rw, com.googlesource.gerrit.plugins.uploadvalidator.BlockedKeywordValidatorTest.getPatterns().values(), com.googlesource.gerrit.plugins.uploadvalidator.TestUtils.EMPTY_PLUGIN_CONFIG); java.util.Set<java.lang.String> expected = com.google.common.collect.ImmutableSet.of(("ERROR: blocked keyword(s) found in: foo.txt (Line: 1)" + " (found: myp4ssw0rd, foobar)"), ("ERROR: blocked keyword(s) found in: bar.txt (Line: 5)" + " (found: $Id: foo bar$)"), (("ERROR: blocked keyword(s) found in: " + (com.google.gerrit.reviewdb.client.Patch.COMMIT_MSG)) + " (Line: 1) (found: foobar)")); assertThat(com.googlesource.gerrit.plugins.uploadvalidator.TestUtils.transformMessages(m)).containsExactlyElementsIn(expected); } }
private boolean canPerform(com.google.gerrit.reviewdb.ApprovalCategory.Id actionId, short level) { final java.util.Set<com.google.gerrit.reviewdb.AccountGroup.Id> groups = getCurrentUser().getEffectiveGroups(); int val = java.lang.Integer.MIN_VALUE; java.util.List<com.google.gerrit.reviewdb.RefRight> allRights = new java.util.ArrayList<com.google.gerrit.reviewdb.RefRight>(); allRights.addAll(getLocalRights(actionId)); if (actionId.canInheritFromWildProject()) { allRights.addAll(getInheritedRights(actionId)); } java.util.Collections.sort(allRights, RefRight.REF_PATTERN_ORDER); for (com.google.gerrit.reviewdb.RefRight right : com.google.gerrit.server.project.RefControl.filterMostSpecific(allRights)) { if (groups.contains(right.getAccountGroupId())) { if ((val < 0) && ((right.getMaxValue()) > 0)) { val = right.getMaxValue(); } else { val = java.lang.Math.max(right.getMaxValue(), val); } } } return val >= level; }
private final native void setPluginConfigValuesRaw(com.google.gerrit.client.rpc.NativeMap<com.google.gerrit.client.projects.ProjectApi.StringMap> v);
private boolean exists(com.google.gerrit.reviewdb.client.Account.Id id) throws com.google.gwtorm.server.OrmException { return (schema.get().accounts().get(id)) != null; }
@java.lang.Override public boolean equals(java.lang.Object obj) { if ((this) == obj) return true; if (obj == null) return false; if ((getClass()) != (obj.getClass())) return false; com.google.gerrit.audit.AuditEvent other = ((com.google.gerrit.audit.AuditEvent) (obj)); return this.uuid.equals(other.uuid); }
@java.lang.Override public java.util.List<com.google.gerrit.server.git.validators.CommitValidationMessage> onCommitReceived(com.google.gerrit.server.events.CommitReceivedEvent receiveEvent) throws com.google.gerrit.server.git.validators.CommitValidationException { if (refControl.getCurrentUser().isIdentifiedUser()) { com.google.gerrit.server.IdentifiedUser user = ((com.google.gerrit.server.IdentifiedUser) (refControl.getCurrentUser())); java.lang.String refname = receiveEvent.refName; org.eclipse.jgit.lib.ObjectId old = receiveEvent.commit.getParent(0); if (receiveEvent.command.getRefName().startsWith(com.google.gerrit.server.git.validators.REFS_CHANGES)) { refname = refname.replace(com.google.gerrit.server.git.validators.R_HEADS, "refs/for/refs/heads/"); old = org.eclipse.jgit.lib.ObjectId.zeroId(); } com.google.gerrit.common.ChangeHookRunner.HookResult result = hooks.doRefUpdateHook(receiveEvent.project, refname, user.getAccount(), old, receiveEvent.commit); if ((result != null) && ((result.getExitValue()) != 0)) { throw new com.google.gerrit.server.git.validators.CommitValidationException(result.toString().trim()); } } return java.util.Collections.emptyList(); }
@org.junit.Test public void createGroupAsServerIdent() throws java.lang.Exception { com.google.gerrit.server.group.InternalGroup group = createGroup(1, "test-group", serverIdent, null); assertThat(auditLogReader.getMembersAudit(allUsersRepo, group.getGroupUUID())).hasSize(0); }
@java.lang.Override public boolean cancel(boolean mayInterruptIfRunning) { if (task.cancel(mayInterruptIfRunning)) { if ((runnable) instanceof com.google.gerrit.server.git.WorkQueue.CancelableRunnable) { if (running.compareAndSet(false, true)) { ((com.google.gerrit.server.git.WorkQueue.CancelableRunnable) (runnable)).cancel(); } else if ((runnable) instanceof com.google.gerrit.server.git.WorkQueue.CanceledWhileRunning) { ((com.google.gerrit.server.git.WorkQueue.CanceledWhileRunning) (runnable)).setCanceledWhileRunning(); } } executor.remove(this); executor.purge(); return true; } return false; }
private static com.google.gerrit.extensions.common.GitPerson toGitPerson(com.google.gerrit.reviewdb.client.UserIdentity committer) { com.google.gerrit.extensions.common.GitPerson p = new com.google.gerrit.extensions.common.GitPerson(); p.name = committer.getName(); p.email = committer.getEmail(); p.date = committer.getDate(); p.tz = committer.getTimeZone(); return p; }
public void index(com.google.gerrit.reviewdb.server.ReviewDb db, com.google.gerrit.reviewdb.client.Project.NameKey project, com.google.gerrit.reviewdb.client.Change.Id changeId) throws com.google.gwtorm.server.OrmException, java.io.IOException { com.google.gerrit.server.query.change.ChangeData cd = newChangeData(db, project, changeId); index(cd); com.google.gerrit.server.index.change.ChangeIndexer.reindexAfterIndexUpdate(cd); }
private com.google.gerrit.httpd.raw.ResourceServlet.Resource getResource(javax.servlet.http.HttpServletRequest req) throws java.util.concurrent.ExecutionException { java.lang.String name = com.google.common.base.CharMatcher.is('/').trimFrom(req.getPathInfo()); if (com.google.gerrit.httpd.raw.ResourceServlet.isUnreasonableName(name)) { return com.google.gerrit.httpd.raw.ResourceServlet.Resource.NOT_FOUND; } java.nio.file.Path p = getResourcePath(name); if (p == null) { return com.google.gerrit.httpd.raw.ResourceServlet.Resource.NOT_FOUND; } java.util.concurrent.Callable<com.google.gerrit.httpd.raw.ResourceServlet.Resource> loader = newLoader(p); com.google.gerrit.httpd.raw.ResourceServlet.Resource r = cache.get(p, loader); if (r == (com.google.gerrit.httpd.raw.ResourceServlet.Resource.NOT_FOUND)) { return com.google.gerrit.httpd.raw.ResourceServlet.Resource.NOT_FOUND; } if ((refresh) && (r.isStale(p))) { cache.invalidate(p); r = cache.get(p, loader); } return r; }
public com.google.common.collect.ImmutableList<T> getComments() { checkParsed(); return comments; }
public com.google.gerrit.reviewdb.client.Patch.PatchType getPatchType() { return com.google.gerrit.reviewdb.client.Patch.PatchType.forCode(patchType); }
private com.google.gerrit.reviewdb.client.ChangeMessage newMessage(com.google.gerrit.server.git.BatchUpdate.ChangeContext ctx) throws com.google.gwtorm.server.OrmException { java.lang.StringBuilder msg = new java.lang.StringBuilder(); msg.append("Abandoned"); if (!(com.google.common.base.Strings.nullToEmpty(msgTxt).trim().isEmpty())) { msg.append("\n\n"); msg.append(msgTxt.trim()); } return com.google.gerrit.server.ChangeMessagesUtil.newMessage(ctx, msg.toString(), ChangeMessagesUtil.TAG_ABANDON); }
@org.junit.Test public void addReviewerToReviewableChangeByOtherInNoteDbSingly() throws java.lang.Exception { addReviewerToReviewableChangeByOtherInNoteDb(singly()); }
@java.lang.SuppressWarnings("deprecation") private static java.util.List<org.apache.solr.client.solrj.SolrQuery.SortClause> getSorts(com.google.gerrit.server.index.Schema<com.google.gerrit.server.query.change.ChangeData> schema, com.google.gerrit.server.query.Predicate<com.google.gerrit.server.query.change.ChangeData> p) { if (com.google.gerrit.server.query.change.SortKeyPredicate.hasSortKeyField(schema)) { boolean reverse = com.google.gerrit.server.query.change.ChangeQueryBuilder.hasNonTrivialSortKeyAfter(schema, p); return com.google.common.collect.ImmutableList.of(new org.apache.solr.client.solrj.SolrQuery.SortClause(ChangeField.SORTKEY.getName(), (!reverse ? SolrQuery.ORDER.desc : SolrQuery.ORDER.asc))); } else { return com.google.common.collect.ImmutableList.of(new org.apache.solr.client.solrj.SolrQuery.SortClause(ChangeField.UPDATED.getName(), SolrQuery.ORDER.desc), new org.apache.solr.client.solrj.SolrQuery.SortClause(ChangeField.LEGACY_ID.getName(), SolrQuery.ORDER.desc)); } }
@java.lang.Override public void evictAfterRename(final com.google.gerrit.reviewdb.client.AccountGroup.NameKey oldName, final com.google.gerrit.reviewdb.client.AccountGroup.NameKey newName) { if (oldName != null) { byName.invalidate(oldName.get()); } if (newName != null) { byName.invalidate(newName.get()); } }
public final com.google.gerrit.server.git.MergeTip run(final com.google.gerrit.server.git.CodeReviewCommit currentTip, final java.util.Collection<com.google.gerrit.server.git.CodeReviewCommit> toMerge) throws com.google.gerrit.server.git.IntegrationException { refLogIdent = null; checkState(((args.caller) != null)); return _run(currentTip, toMerge); }
private java.lang.Iterable<com.google.gerrit.extensions.common.ProjectInfo> filter(java.lang.Iterable<com.google.gerrit.extensions.common.ProjectInfo> infos) { final java.lang.String prefix = name(""); return com.google.common.collect.Iterables.filter(infos, new com.google.common.base.Predicate<com.google.gerrit.extensions.common.ProjectInfo>() { @java.lang.Override public boolean apply(com.google.gerrit.extensions.common.ProjectInfo in) { return ((in.name) != null) && (((in.name.equals(allProjects.get())) || (in.name.equals(allUsers.get()))) || (in.name.startsWith(prefix))); } }); }
private static com.google.common.base.Optional<org.eclipse.jgit.lib.ObjectId> getStart(com.google.common.collect.ListMultimap<java.lang.String, java.lang.String> params, org.eclipse.jgit.lib.ObjectReader reader) throws com.google.gitiles.LogServlet.InvalidStartValueException, java.io.IOException { java.util.List<java.lang.String> values = params.get(com.google.gitiles.LogServlet.START_PARAM); switch (values.size()) { case 0 : return com.google.common.base.Optional.absent(); case 1 : java.lang.String id = values.get(0); if (!(org.eclipse.jgit.lib.AbbreviatedObjectId.isId(id))) { throw new com.google.gitiles.LogServlet.InvalidStartValueException(); } java.util.Collection<org.eclipse.jgit.lib.ObjectId> ids = reader.resolve(org.eclipse.jgit.lib.AbbreviatedObjectId.fromString(id)); if ((ids.size()) != 1) { throw new com.google.gitiles.LogServlet.InvalidStartValueException(); } return com.google.common.base.Optional.of(com.google.common.collect.Iterables.getOnlyElement(ids)); default : throw new com.google.gitiles.LogServlet.InvalidStartValueException(); } }
java.lang.String image(java.lang.String dest) { if ((com.google.gitiles.doc.html.HtmlBuilder.isValidHttpUri(dest)) || (com.google.gitiles.doc.html.HtmlBuilder.isImageDataUri(dest))) { return dest; } else if ((imageLoader) != null) { return imageLoader.inline(filePath, dest); } return SoyConstants.IMAGE_URI_INNOCUOUS_OUTPUT; }
@java.lang.Override public int run() throws java.lang.Exception { mustHaveValidSite(); dbInjector = createDbInjector(com.google.gerrit.pgm.MULTI_USER); globalConfig = dbInjector.getInstance(com.google.inject.Key.get(org.eclipse.jgit.lib.Config.class, com.google.gerrit.server.config.GerritServerConfig.class)); threads = com.google.gerrit.pgm.util.ThreadLimiter.limitThreads(dbInjector, threads); checkNotSlaveMode(); disableLuceneAutomaticCommit(); disableChangeCache(); com.google.gerrit.lifecycle.LifecycleManager dbManager = new com.google.gerrit.lifecycle.LifecycleManager(); dbManager.add(dbInjector); dbManager.start(); sysInjector = createSysInjector(); com.google.gerrit.lifecycle.LifecycleManager sysManager = new com.google.gerrit.lifecycle.LifecycleManager(); sysManager.add(sysInjector); sysManager.start(); sysInjector.injectMembers(this); checkIndicesOption(); try { boolean ok = (list) ? list() : reindex(); return ok ? 0 : 1; } catch (java.lang.Exception e) { throw die(e.getMessage(), e); } finally { sysManager.stop(); dbManager.stop(); } }
public static com.google.gwtorm.server.OrmException convertError(java.lang.String op, java.sql.SQLException err) { switch (com.google.gerrit.server.schema.H2AccountPatchReviewStore.getSQLStateInt(err)) { case 23001 : case 23505 : return new com.google.gwtorm.server.OrmDuplicateKeyException("ACCOUNT_PATCH_REVIEWS", err); default : if (((err.getCause()) == null) && ((err.getNextException()) != null)) { err.initCause(err.getNextException()); } return new com.google.gwtorm.server.OrmException((op + " failure on ACCOUNT_PATCH_REVIEWS"), err); } }
public java.util.List<java.lang.String> currentFilePaths(com.google.inject.Provider<com.google.gerrit.reviewdb.server.ReviewDb> db, com.google.gerrit.server.patch.PatchListCache cache) throws com.google.gwtorm.server.OrmException { if ((currentFiles) == null) { com.google.gerrit.reviewdb.client.Change c = change(db); if (c == null) { return null; } com.google.gerrit.reviewdb.client.PatchSet ps = currentPatchSet(db); if (ps == null) { return null; } com.google.gerrit.server.patch.PatchList p; try { p = cache.get(c, ps); } catch (com.google.gerrit.server.patch.PatchListNotAvailableException e) { currentFiles = java.util.Collections.emptyList(); return currentFiles; } java.util.List<java.lang.String> r = new java.util.ArrayList<java.lang.String>(p.getPatches().size()); for (com.google.gerrit.server.patch.PatchListEntry e : p.getPatches()) { if (Patch.COMMIT_MSG.equals(e.getNewName())) { continue; } switch (e.getChangeType()) { case ADDED : case MODIFIED : case DELETED : case COPIED : r.add(e.getNewName()); break; case RENAMED : r.add(e.getOldName()); r.add(e.getNewName()); break; case REWRITE : break; } } java.util.Collections.sort(r); currentFiles = java.util.Collections.unmodifiableList(r); } return currentFiles; }